<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Email Sender - Data Analysis Insights</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }
        .panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .contact-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            cursor: pointer;
        }
        .contact-item:hover {
            background: #f8f9fa;
        }
        .contact-item.selected {
            background: #007bff;
            color: white;
        }
        .alert {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        textarea, input[type="text"], input[type="email"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px 0;
        }
        textarea {
            min-height: 300px;
            resize: vertical;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        .status.ready {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìß Bulk Email Sender</h1>
        <p>Data Analysis Insights - Professional Email Campaign Tool</p>
        <div id="status" class="status ready">‚úÖ System Ready</div>
    </div>

    <div class="main-content">
        <div class="panel">
            <h2>üìÇ Contacts & Template</h2>

            <div style="margin-bottom: 15px; padding: 15px; border: 2px dashed #007bff; border-radius: 8px; background: #f8f9fa;">
                <label for="fileUpload" style="display: block; margin-bottom: 5px; font-weight: bold; color: #007bff;">üìÅ Upload Contact Spreadsheet:</label>
                <input type="file" id="fileUpload" accept=".xlsx,.xls,.csv" onchange="handleFileUpload(event)" style="margin-bottom: 10px; width: 100%; padding: 8px;">
                <small style="color: #666; display: block;">
                    ‚úì Supports Excel (.xlsx, .xls) and CSV files<br>
                    ‚úì Each tab/sheet represents a country<br>
                    ‚úì Expected columns: firm name, address, contact number, contact person, email, website, source, category
                </small>
            </div>

            <button class="button" onclick="loadSampleData()">üìã Load Sample Data</button>

            <h3>Email Template</h3>
            <textarea id="emailTemplate" placeholder="Email template will appear here...">From: vishwas.agarwal@gmail.com
From-Name: Intex Technologies
To: {email}
Subject: Business Partnership Opportunity - Intex Technologies in {country}

Dear Valued Prospective Partner,

We are pleased to introduce Intex Technologies, a globally recognized brand with a rich legacy spanning 29 years in the consumer electronics and technology sectors.

Since our inception in 1996, we have been at the forefront of innovation, designing and manufacturing cutting-edge products that enhance the daily lives of millions of consumers worldwide. Our commitment to excellence has made us a trusted name in markets across the globe.

Our Product Portfolio:
‚Ä¢ IT Peripherals: Speakers, keyboards, mice, webcams, and computer accessories
‚Ä¢ Home Appliances: Air coolers, room heaters, water purifiers, and kitchen appliances
‚Ä¢ Mobile Accessories: Power banks, chargers, cables, and smartphone accessories
‚Ä¢ Audio Solutions: Wireless speakers, headphones, and sound systems

We are actively seeking distribution partners in {country} who share our vision of delivering high-quality, innovative products to consumers. We believe {firm}, with its established market presence and commitment to excellence, would be an ideal partner for expanding our reach in the {country} market.

Specific Opportunities for {firm} in {country}:
{businessOpportunities}

What We Offer Our Partners:
‚úì Competitive pricing with attractive profit margins
‚úì Comprehensive marketing support and co-branding opportunities
‚úì Technical training and ongoing product support
‚úì Flexible payment terms and credit facilities
‚úì Exclusive territory rights (subject to discussion)
‚úì Access to our complete product catalog and new launches

Why Partner with Intex Technologies:
- 29+ years of industry experience and innovation
- Global presence with operations in 40+ countries
- ISO certified manufacturing facilities
- Strong R&D capabilities with continuous product development
- Proven track record of successful partnerships worldwide

We would welcome the opportunity to discuss how we can work together to bring Intex Technologies' innovative products to the {country} market through {firm}. Our team is available to provide detailed product catalogs, pricing structures, and partnership terms that align with your business objectives.

Please feel free to contact us at your earliest convenience to explore this exciting business opportunity. We are confident that a partnership between Intex Technologies and {firm} will be mutually beneficial and contribute to significant growth in the {country} market.

Thank you for your time and consideration. We look forward to hearing from you soon and to the possibility of establishing a long-term, successful business relationship.

Best regards,

Vishwas Agarwal
Business Development Manager
Intex Technologies
Email: vishwas.agarwal@gmail.com
Phone: +91-11-4716-1111
Website: www.intex.in

P.S. We are also interested in exploring private label manufacturing opportunities and joint ventures for established brands in the {country} market. Please let us know if {firm} has any interest in such collaborations.</textarea>

            <h3>Contact List</h3>
            <div id="contactsList">
                <p>Click "Load Sample Data" to see contacts</p>
            </div>
        </div>

        <div class="panel">
            <h2>üì® Email Composer</h2>
            <div id="alerts"></div>

            <div style="margin-bottom: 15px;">
                <label>From:</label>
                <input type="email" id="fromEmail" value="vishwas.agarwal@gmail.com">
            </div>

            <div style="margin-bottom: 15px;">
                <label>To:</label>
                <input type="email" id="toEmail" placeholder="Select a contact first">
            </div>

            <div style="margin-bottom: 15px;">
                <label>Subject:</label>
                <input type="text" id="subject" placeholder="Email subject">
            </div>

            <div style="margin-bottom: 15px;">
                <label>Message:</label>
                <textarea id="messageBody" placeholder="Email content will appear here"></textarea>
            </div>

            <div>
                <button class="button" onclick="sendEmail()" id="sendBtn" disabled>üì§ Send Email</button>
                <button class="button" onclick="testConnection()" style="background: #28a745;">üîß Test SMTP</button>
            </div>
        </div>
    </div>

    <script>
        // Simple global variables - no classes to avoid complexity
        let contacts = [];
        let selectedContactIndex = -1;

        // Sample data - no API calls needed
        const sampleContacts = [
            {
                email: "john.smith@techsolutions.co.uk",
                contactName: "John Smith",
                firm: "Tech Solutions UK Ltd",
                country: "United Kingdom",
                phone: "+44-20-7123-4567",
                website: "www.techsolutions.co.uk",
                address: "123 Tech Street, London",
                source: "Website",
                category: "Technology",
                businessFocus: "IT peripherals and smart devices",
                marketStrength: "High"
            },
            {
                email: "sarah.jones@innovate.com",
                contactName: "Sarah Jones",
                firm: "Innovate Corp",
                country: "United States",
                phone: "+1-555-123-4567",
                website: "www.innovate.com",
                address: "456 Innovation Ave, Silicon Valley",
                source: "Referral",
                category: "Electronics",
                businessFocus: "Audio solutions and mobile accessories",
                marketStrength: "High"
            },
            {
                email: "raj.patel@globaltech.in",
                contactName: "Raj Patel",
                firm: "Global Tech Solutions",
                country: "India",
                phone: "+91-11-2345-6789",
                website: "www.globaltech.in",
                address: "789 Tech Park, Mumbai",
                source: "Trade Show",
                category: "Manufacturing",
                businessFocus: "Industrial equipment and automation",
                marketStrength: "Medium"
            }
        ];

        function showAlert(message, type = 'success') {
            const alerts = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            alerts.appendChild(alert);

            // Remove after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }

        function loadSampleData() {
            contacts = [...sampleContacts];
            renderContacts();
            showAlert('Sample contacts loaded successfully!');
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Check if XLSX library is loaded
            if (typeof XLSX === 'undefined') {
                showAlert('Error: Excel processing library not loaded. Please refresh the page.', 'error');
                return;
            }

            console.log('File selected:', file.name, file.type, file.size);
            showAlert(`Processing ${file.name}...`, 'success');

            try {
                contacts = []; // Clear existing contacts
                let totalProcessed = 0;

                // Handle CSV files differently
                if (file.name.toLowerCase().endsWith('.csv')) {
                    const text = await file.text();
                    console.log('CSV file read, length:', text.length);

                    const csvData = parseCSV(text);
                    console.log('CSV parsed, headers:', csvData.headers);

                    // Process CSV data
                    csvData.data.forEach(row => {
                        const contact = {
                            country: row.country || 'Unknown',
                            firm: row['firm name'] || row.company || row.firm || 'Unknown Company',
                            address: row.address || row.location || '',
                            phone: row['contact number'] || row.phone || row.telephone || '',
                            contactName: row['contact person'] || row.name || row.contact || 'Contact Person',
                            email: row.email || row['email address'] || '',
                            website: row.website || row.url || '',
                            source: row.source || row['lead source'] || '',
                            category: row.category || row.type || row.sector || '',
                            businessFocus: generateBusinessFocus(row.category || row.type || ''),
                            marketStrength: 'Medium'
                        };

                        if (contact.email && contact.email.includes('@')) {
                            contacts.push(contact);
                            totalProcessed++;
                        }
                    });

                    console.log(`CSV processed: ${totalProcessed} contacts`);
                } else {
                    // Handle Excel files
                    const data = await file.arrayBuffer();
                    console.log('Excel file read, size:', data.byteLength);

                    const workbook = XLSX.read(data, { type: 'array' });
                    console.log('Workbook loaded, sheets:', workbook.SheetNames);

                    // Process each worksheet (tab) as a country
                    workbook.SheetNames.forEach(sheetName => {
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (jsonData.length < 2) return; // Skip empty sheets

                    const headers = jsonData[0].map(h => h?.toString().toLowerCase().trim());
                    const rows = jsonData.slice(1);

                    // Map column indices for key parameters
                    const columnMap = {
                        firm: findColumnIndex(headers, ['firm name', 'company', 'firm', 'organization']),
                        address: findColumnIndex(headers, ['address', 'location', 'addr']),
                        phone: findColumnIndex(headers, ['contact number', 'phone', 'telephone', 'mobile']),
                        contactName: findColumnIndex(headers, ['contact person', 'name', 'contact', 'person']),
                        email: findColumnIndex(headers, ['email', 'email address', 'e-mail']),
                        website: findColumnIndex(headers, ['website', 'url', 'web', 'site']),
                        source: findColumnIndex(headers, ['source', 'lead source', 'origin']),
                        category: findColumnIndex(headers, ['category', 'type', 'sector', 'industry'])
                    };

                    // Process each row
                    rows.forEach(row => {
                        if (!row || row.length === 0) return;

                        const contact = {
                            country: sheetName, // Use sheet name as country
                            firm: getCellValue(row, columnMap.firm) || 'Unknown Company',
                            address: getCellValue(row, columnMap.address) || '',
                            phone: getCellValue(row, columnMap.phone) || '',
                            contactName: getCellValue(row, columnMap.contactName) || 'Contact Person',
                            email: getCellValue(row, columnMap.email) || '',
                            website: getCellValue(row, columnMap.website) || '',
                            source: getCellValue(row, columnMap.source) || '',
                            category: getCellValue(row, columnMap.category) || '',
                            businessFocus: generateBusinessFocus(getCellValue(row, columnMap.category)),
                            marketStrength: 'High'
                        };

                        // Only add if email exists
                        if (contact.email && contact.email.includes('@')) {
                            contacts.push(contact);
                            totalProcessed++;
                        }
                    });

                        console.log(`Processed sheet "${sheetName}": ${jsonData.length - 1} rows`);
                    });

                    console.log(`Total contacts loaded: ${contacts.length}`);
                }

                renderContacts();
                showAlert(`‚úÖ Loaded ${contacts.length} contacts${file.name.toLowerCase().endsWith('.csv') ? '' : ` from multiple countries`}!`);

            } catch (error) {
                showAlert(`Error processing file: ${error.message}`, 'error');
                console.error('File processing error:', error);
            }
        }

        function findColumnIndex(headers, possibleNames) {
            for (let name of possibleNames) {
                const index = headers.findIndex(h => h && h.includes(name));
                if (index !== -1) return index;
            }
            return -1;
        }

        function getCellValue(row, columnIndex) {
            if (columnIndex === -1 || !row[columnIndex]) return '';
            return row[columnIndex].toString().trim();
        }

        function generateBusinessFocus(category) {
            const focusMap = {
                'technology': 'IT peripherals and smart devices',
                'retail': 'Consumer electronics and home appliances',
                'electronics': 'Audio solutions and mobile accessories',
                'manufacturing': 'Industrial equipment and automation',
                'healthcare': 'Medical devices and monitoring systems',
                'education': 'Educational technology and audio-visual equipment'
            };

            const categoryLower = category.toLowerCase();
            for (let [key, focus] of Object.entries(focusMap)) {
                if (categoryLower.includes(key)) return focus;
            }
            return 'Consumer electronics and technology solutions';
        }

        function renderContacts() {
            const container = document.getElementById('contactsList');
            container.innerHTML = '';

            if (contacts.length === 0) {
                container.innerHTML = '<p>No contacts loaded. Upload a spreadsheet or load sample data.</p>';
                return;
            }

            contacts.forEach((contact, index) => {
                const div = document.createElement('div');
                div.className = 'contact-item';
                div.onclick = () => selectContact(index);

                // Enhanced display with all contact details
                div.innerHTML = `
                    <div style="display: flex; justify-content: between; align-items: start;">
                        <div style="flex: 1;">
                            <strong>${contact.firm}</strong>
                            ${contact.category ? `<span style="background: #e3f2fd; color: #1976d2; padding: 2px 6px; border-radius: 3px; font-size: 0.8em; margin-left: 8px;">${contact.category}</span>` : ''}
                            <br>
                            üë§ ${contact.contactName}<br>
                            üìß ${contact.email}<br>
                            üåç ${contact.country}
                            ${contact.phone ? `<br>üìû ${contact.phone}` : ''}
                            ${contact.website ? `<br>üåê ${contact.website}` : ''}
                            ${contact.address ? `<br>üìç ${contact.address}` : ''}
                            ${contact.source ? `<br>üìä Source: ${contact.source}` : ''}
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function selectContact(index) {
            selectedContactIndex = index;
            const contact = contacts[index];

            // Update UI
            document.querySelectorAll('.contact-item').forEach((item, i) => {
                item.classList.toggle('selected', i === index);
            });

            // Extract subject from template and populate dynamically
            const template = document.getElementById('emailTemplate').value;
            const lines = template.split('\n');
            let subjectTemplate = 'Business Partnership Opportunity - Intex Technologies in {country}';

            // Find subject line in template
            for (let line of lines) {
                if (line.startsWith('Subject: ')) {
                    subjectTemplate = line.replace('Subject: ', '').trim();
                    break;
                }
            }

            // Populate email form
            document.getElementById('toEmail').value = contact.email;
            document.getElementById('subject').value = subjectTemplate.replace(/{country}/g, contact.country)
                                                                     .replace(/{firm}/g, contact.firm)
                                                                     .replace(/{email}/g, contact.email);

            // Generate email body from template
            let body = template.replace(/{email}/g, contact.email)
                              .replace(/{contactName}/g, contact.contactName)
                              .replace(/{country}/g, contact.country)
                              .replace(/{firm}/g, contact.firm);

            // Remove email headers from body
            const lines = body.split('\n');
            let bodyStart = 0;
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].trim() === '' && i > 0) {
                    bodyStart = i + 1;
                    break;
                }
                if (!lines[i].includes(':') || lines[i].startsWith('Dear')) {
                    bodyStart = i;
                    break;
                }
            }

            document.getElementById('messageBody').value = lines.slice(bodyStart).join('\n').trim();
            document.getElementById('sendBtn').disabled = false;

            showAlert(`Selected: ${contact.contactName} from ${contact.firm}`);
        }

        async function sendEmail() {
            const fromEmail = document.getElementById('fromEmail').value;
            const toEmail = document.getElementById('toEmail').value;
            const subject = document.getElementById('subject').value;
            const body = document.getElementById('messageBody').value;

            if (!toEmail || !subject || !body) {
                showAlert('Please fill in all fields', 'error');
                return;
            }

            try {
                document.getElementById('sendBtn').textContent = 'üì§ Sending...';
                document.getElementById('sendBtn').disabled = true;

                // Try to send via simple function
                const response = await fetch('/.netlify/functions/send-email-simple', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        from_email: fromEmail,
                        to_email: toEmail,
                        subject: subject,
                        content: body
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(`‚úÖ ${result.message}`);
                } else {
                    showAlert(`‚ÑπÔ∏è ${result.message}`, 'error');
                    if (result.instructions) {
                        showAlert(result.instructions, 'error');
                    }
                }

            } catch (error) {
                showAlert(`Network error: ${error.message}`, 'error');
            } finally {
                document.getElementById('sendBtn').textContent = 'üì§ Send Email';
                document.getElementById('sendBtn').disabled = false;
            }
        }

        async function testConnection() {
            try {
                showAlert('Testing SMTP connection...', 'success');

                const response = await fetch('/.netlify/functions/health');
                const result = await response.json();

                if (result.status === 'ok') {
                    showAlert('‚úÖ Server connection successful!');
                    document.getElementById('status').textContent = '‚úÖ Server Connected';
                    document.getElementById('status').className = 'status ready';
                } else {
                    throw new Error('Health check failed');
                }
            } catch (error) {
                showAlert('‚ùå Server connection failed', 'error');
                document.getElementById('status').textContent = '‚ùå Server Issues';
                document.getElementById('status').className = 'status error';
            }
        }

        function extractTemplateHeaders() {
            const template = document.getElementById('emailTemplate').value;
            const lines = template.split('\n');

            // Extract headers from template
            for (let line of lines) {
                if (line.startsWith('From: ')) {
                    const fromEmail = line.replace('From: ', '').trim();
                    document.getElementById('fromEmail').value = fromEmail;
                }
                if (line.startsWith('From-Name: ')) {
                    const fromName = line.replace('From-Name: ', '').trim();
                    // Store from name for later use
                    window.defaultFromName = fromName;
                }
            }
        }

        function testXLSXLibrary() {
            if (typeof XLSX === 'undefined') {
                console.error('XLSX library not loaded');
                showAlert('‚ö†Ô∏è Excel processing library failed to load. File upload may not work.', 'error');
                return false;
            } else {
                console.log('XLSX library loaded successfully, version:', XLSX.version);
                return true;
            }
        }

        // Add a simple CSV processor as fallback
        function parseCSV(text) {
            const lines = text.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',');
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] ? values[index].trim() : '';
                    });
                    data.push(row);
                }
            }
            return { headers, data };
        }

        // Initialize on page load - no complex initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Simple email sender loaded');
            testXLSXLibrary(); // Test if XLSX library loaded
            extractTemplateHeaders(); // Extract and populate From field
            renderContacts(); // Initialize contact list display
            showAlert('Simple Email Sender ready! Upload a spreadsheet or click "Load Sample Data" to start.');
        });
    </script>
</body>
</html>