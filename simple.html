<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Email Sender - Data Analysis Insights</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }
        .panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .contact-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            cursor: pointer;
        }
        .contact-item:hover {
            background: #f8f9fa;
        }
        .contact-item.selected {
            background: #007bff;
            color: white;
        }
        .alert {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        textarea, input[type="text"], input[type="email"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px 0;
        }
        textarea {
            min-height: 300px;
            resize: vertical;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        .status.ready {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>📧 Bulk Email Sender</h1>
        <p>Data Analysis Insights - Professional Email Campaign Tool</p>
        <div id="status" class="status ready">✅ System Ready</div>
    </div>

    <div class="main-content">
        <div class="panel">
            <h2>📂 Contacts & Template</h2>

            <button class="button" onclick="loadSampleData()">📋 Load Sample Data</button>

            <h3>Email Template</h3>
            <textarea id="emailTemplate" placeholder="Email template will appear here...">From: info@datanalysisninsights.co.uk
From-Name: Data Analysis Insights
To: {email}
Subject: Business Partnership Opportunity - {country}

Dear {contactName},

We are pleased to introduce Data Analysis Insights, your trusted partner for comprehensive business intelligence and market research solutions.

We are actively seeking business partnerships in {country} with organizations that value data-driven insights and strategic intelligence.

Best regards,
Data Analysis Insights Team
Email: info@datanalysisninsights.co.uk</textarea>

            <h3>Contact List</h3>
            <div id="contactsList">
                <p>Click "Load Sample Data" to see contacts</p>
            </div>
        </div>

        <div class="panel">
            <h2>📨 Email Composer</h2>
            <div id="alerts"></div>

            <div style="margin-bottom: 15px;">
                <label>From:</label>
                <input type="email" id="fromEmail" value="info@datanalysisninsights.co.uk">
            </div>

            <div style="margin-bottom: 15px;">
                <label>To:</label>
                <input type="email" id="toEmail" placeholder="Select a contact first">
            </div>

            <div style="margin-bottom: 15px;">
                <label>Subject:</label>
                <input type="text" id="subject" placeholder="Email subject">
            </div>

            <div style="margin-bottom: 15px;">
                <label>Message:</label>
                <textarea id="messageBody" placeholder="Email content will appear here"></textarea>
            </div>

            <div>
                <button class="button" onclick="sendEmail()" id="sendBtn" disabled>📤 Send Email</button>
                <button class="button" onclick="testConnection()" style="background: #28a745;">🔧 Test SMTP</button>
            </div>
        </div>
    </div>

    <script>
        // Simple global variables - no classes to avoid complexity
        let contacts = [];
        let selectedContactIndex = -1;

        // Sample data - no API calls needed
        const sampleContacts = [
            {
                email: "john.smith@techsolutions.co.uk",
                contactName: "John Smith",
                firm: "Tech Solutions UK Ltd",
                country: "United Kingdom"
            },
            {
                email: "sarah.jones@innovate.com",
                contactName: "Sarah Jones",
                firm: "Innovate Corp",
                country: "United States"
            },
            {
                email: "raj.patel@globaltech.in",
                contactName: "Raj Patel",
                firm: "Global Tech Solutions",
                country: "India"
            }
        ];

        function showAlert(message, type = 'success') {
            const alerts = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            alerts.appendChild(alert);

            // Remove after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }

        function loadSampleData() {
            contacts = [...sampleContacts];
            renderContacts();
            showAlert('Sample contacts loaded successfully!');
        }

        function renderContacts() {
            const container = document.getElementById('contactsList');
            container.innerHTML = '';

            contacts.forEach((contact, index) => {
                const div = document.createElement('div');
                div.className = 'contact-item';
                div.onclick = () => selectContact(index);
                div.innerHTML = `
                    <strong>${contact.firm}</strong><br>
                    👤 ${contact.contactName}<br>
                    📧 ${contact.email}<br>
                    🌍 ${contact.country}
                `;
                container.appendChild(div);
            });
        }

        function selectContact(index) {
            selectedContactIndex = index;
            const contact = contacts[index];

            // Update UI
            document.querySelectorAll('.contact-item').forEach((item, i) => {
                item.classList.toggle('selected', i === index);
            });

            // Populate email form
            document.getElementById('toEmail').value = contact.email;
            document.getElementById('subject').value = `Business Partnership Opportunity - ${contact.country}`;

            // Generate email body from template
            let template = document.getElementById('emailTemplate').value;
            let body = template.replace(/{email}/g, contact.email)
                              .replace(/{contactName}/g, contact.contactName)
                              .replace(/{country}/g, contact.country);

            // Remove email headers from body
            const lines = body.split('\n');
            let bodyStart = 0;
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].trim() === '' && i > 0) {
                    bodyStart = i + 1;
                    break;
                }
                if (!lines[i].includes(':') || lines[i].startsWith('Dear')) {
                    bodyStart = i;
                    break;
                }
            }

            document.getElementById('messageBody').value = lines.slice(bodyStart).join('\n').trim();
            document.getElementById('sendBtn').disabled = false;

            showAlert(`Selected: ${contact.contactName} from ${contact.firm}`);
        }

        async function sendEmail() {
            const fromEmail = document.getElementById('fromEmail').value;
            const toEmail = document.getElementById('toEmail').value;
            const subject = document.getElementById('subject').value;
            const body = document.getElementById('messageBody').value;

            if (!toEmail || !subject || !body) {
                showAlert('Please fill in all fields', 'error');
                return;
            }

            try {
                document.getElementById('sendBtn').textContent = '📤 Sending...';
                document.getElementById('sendBtn').disabled = true;

                // Try to send via simple function
                const response = await fetch('/.netlify/functions/send-email-simple', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        from_email: fromEmail,
                        to_email: toEmail,
                        subject: subject,
                        content: body
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(`✅ ${result.message}`);
                } else {
                    showAlert(`ℹ️ ${result.message}`, 'error');
                    if (result.instructions) {
                        showAlert(result.instructions, 'error');
                    }
                }

            } catch (error) {
                showAlert(`Network error: ${error.message}`, 'error');
            } finally {
                document.getElementById('sendBtn').textContent = '📤 Send Email';
                document.getElementById('sendBtn').disabled = false;
            }
        }

        async function testConnection() {
            try {
                showAlert('Testing SMTP connection...', 'success');

                const response = await fetch('/.netlify/functions/health');
                const result = await response.json();

                if (result.status === 'ok') {
                    showAlert('✅ Server connection successful!');
                    document.getElementById('status').textContent = '✅ Server Connected';
                    document.getElementById('status').className = 'status ready';
                } else {
                    throw new Error('Health check failed');
                }
            } catch (error) {
                showAlert('❌ Server connection failed', 'error');
                document.getElementById('status').textContent = '❌ Server Issues';
                document.getElementById('status').className = 'status error';
            }
        }

        // Initialize on page load - no complex initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Simple email sender loaded');
            showAlert('Simple Email Sender ready! Click "Load Sample Data" to start.');
        });
    </script>
</body>
</html>