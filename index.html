<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Email Sender - Data Analysis Insights v2.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <meta name="cache-control" content="no-cache">
    <meta name="version" content="2.1-contact-enhancements">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 15px;
        }
        .panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .contact-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            cursor: pointer;
        }
        .contact-item:hover {
            background: #f8f9fa;
        }
        .contact-item.selected {
            background: #007bff;
            color: white;
        }
        .alert {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        textarea, input[type="text"], input[type="email"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px 0;
        }
        textarea {
            min-height: 300px;
            resize: vertical;
        }
        #messageBody {
            min-height: 500px !important;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            padding: 15px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        .status.ready {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div style="background: white; padding: 10px 20px; border-radius: 5px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <div>
            <h3 style="margin: 0; color: #007bff;">üìß Bulk Email Sender</h3>
            <small style="color: #666;">Data Analysis Insights - Professional Email Campaign Tool</small>
        </div>
        <div id="status" class="status ready" style="margin: 0; padding: 8px 12px; font-size: 12px;">‚úÖ System Ready</div>
    </div>

    <div class="main-content">
        <!-- LEFT PANEL: Contact Management -->
        <div class="panel">
            <h2 style="font-size: 18px; margin-bottom: 15px;">üìã Contact Management</h2>

            <!-- Upload Section -->
            <div style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; background: #f8f9fa; margin-bottom: 12px;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <span style="font-size: 12px; color: #666;">üìÅ Upload:</span>
                    <label for="fileUpload" class="button" style="background: #28a745; cursor: pointer; padding: 4px 8px; font-size: 10px;">
                        Choose File
                    </label>
                </div>
                <input type="file" id="fileUpload" accept=".xlsx,.xls,.csv" onchange="handleFileUpload(event)" style="display: none;">
                <small style="color: #666; font-size: 9px;">Excel/CSV files</small>
                <div id="uploadStats" style="margin-top: 5px; font-size: 9px; color: #007bff; display: none;"></div>
            </div>

            <!-- Contact List with Keyboard Navigation -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <h3 style="margin: 0; color: #007bff; font-size: 14px;">üìã Contact List</h3>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div id="contactCounts" style="font-size: 10px; color: #666; font-weight: bold;">
                        <span id="totalCount">0</span> |
                        <span id="sentCount" style="color: #28a745;">0‚úÖ</span> |
                        <span id="failedCount" style="color: #dc3545;">0‚ùå</span>
                    </div>
                    <button id="scrollTopBtn" class="button" onclick="scrollToTop()" style="padding: 2px 6px; font-size: 10px; display: none;">
                        ‚¨ÜÔ∏è
                    </button>
                </div>
            </div>
            <small style="color: #666; font-size: 10px; margin-bottom: 5px; display: block;">Use ‚Üë‚Üì arrows, Enter to send</small>
            <div id="contactsList" tabindex="0" style="max-height: 500px; overflow-y: auto; border: 2px solid #e3f2fd; border-radius: 6px; padding: 8px; background: #fafafa; outline: none;" onscroll="handleScroll()" onkeydown="handleKeyNavigation(event)">
                <div style="text-align: center; padding: 30px; color: #999; font-style: italic;">
                    <h4 style="color: #ccc; margin-bottom: 8px; font-size: 14px;">üìã No Contacts</h4>
                    <p style="font-size: 12px;">Upload spreadsheet to see contacts</p>
                </div>
            </div>
        </div>

        <!-- CENTER PANEL: Email Composer (Main) -->
        <div class="panel" style="padding: 25px;">
            <h2 style="color: #007bff; margin-bottom: 20px; text-align: center;">üì® Email Composer</h2>
            <div id="alerts"></div>

            <div style="margin-bottom: 15px;">
                <label style="font-size: 14px; font-weight: bold; color: #333;">From:</label>
                <input type="email" id="fromEmail" value="info@datanalysisninsights.co.uk" placeholder="Sender email" style="font-size: 14px; padding: 10px;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="font-size: 14px; font-weight: bold; color: #333;">To: <small style="color: #28a745;">(Use / or , for multiple emails)</small></label>
                <input type="text" id="toEmail" placeholder="Select contact or type emails separated by / or ," style="font-size: 14px; padding: 10px;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="font-size: 14px; font-weight: bold; color: #333;">Subject:</label>
                <input type="text" id="subject" placeholder="Email subject" style="font-size: 14px; padding: 10px;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="font-size: 14px; font-weight: bold; color: #333;">Message:</label>
                <textarea id="messageBody" placeholder="Email content" style="min-height: 400px; font-size: 14px; line-height: 1.6; padding: 15px;"></textarea>
            </div>

            <div style="text-align: center;">
                <button class="button" onclick="sendEmail()" id="sendBtn" disabled style="padding: 12px 30px; font-size: 16px; margin-right: 10px;">üì§ Send Email</button>
                <button class="button" onclick="testConnection()" style="background: #28a745; padding: 12px 20px; font-size: 14px;">üîß Test SMTP</button>
            </div>
        </div>

        <!-- RIGHT PANEL: Templates & Status -->
        <div class="panel" style="padding: 15px;">
            <!-- Email Template Section -->
            <div style="border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #f8f9fa; border-bottom: 1px solid #ddd;">
                    <h3 style="margin: 0; color: #007bff; font-size: 14px;">üìß Template</h3>
                    <button onclick="toggleTemplate()" id="templateToggle" class="button" style="padding: 3px 6px; font-size: 10px;">
                        üìù Expand
                    </button>
                </div>
                <div id="templateContainer" style="display: none; padding: 8px;">
                    <textarea id="emailTemplate" placeholder="Edit your email template..." style="min-height: 200px; width: 100%; border: 1px solid #ddd; border-radius: 4px; font-size: 10px;">From: vishwas.agarwal@gmail.com
From-Name: Intex Technologies
To: {email}
Subject: Business Partnership Opportunity - Intex Technologies in {country}

Dear Valued Prospective Partner,

We are pleased to introduce Intex Technologies, a globally recognized brand with a rich legacy spanning 29 years in the consumer electronics and technology sectors.

Since our inception in 1996, we have been at the forefront of innovation, designing and manufacturing cutting-edge products that enhance the daily lives of millions of consumers worldwide. Our commitment to excellence has made us a trusted name in markets across the globe.

Our Product Portfolio:
‚Ä¢ IT Peripherals: Speakers, keyboards, mice, webcams, and computer accessories
‚Ä¢ Home Appliances: Air coolers, room heaters, water purifiers, and kitchen appliances
‚Ä¢ Mobile Accessories: Power banks, chargers, cables, and smartphone accessories
‚Ä¢ Audio Solutions: Wireless speakers, headphones, and sound systems

We are actively seeking distribution partners in {country} who share our vision of delivering high-quality, innovative products to consumers. We believe {firm}, with its established market presence and commitment to excellence, would be an ideal partner for expanding our reach in the {country} market.

Specific Opportunities for {firm} in {country}:
{businessOpportunities}

What We Offer Our Partners:
‚úì Competitive pricing with attractive profit margins
‚úì Comprehensive marketing support and co-branding opportunities
‚úì Technical training and ongoing product support
‚úì Flexible payment terms and credit facilities
‚úì Exclusive territory rights (subject to discussion)
‚úì Access to our complete product catalog and new launches

Why Partner with Intex Technologies:
- 29+ years of industry experience and innovation
- Global presence with operations in 40+ countries
- ISO certified manufacturing facilities
- Strong R&D capabilities with continuous product development
- Proven track record of successful partnerships worldwide

We would welcome the opportunity to discuss how we can work together to bring Intex Technologies' innovative products to the {country} market through {firm}. Our team is available to provide detailed product catalogs, pricing structures, and partnership terms that align with your business objectives.

Please feel free to contact us at your earliest convenience to explore this exciting business opportunity. We are confident that a partnership between Intex Technologies and {firm} will be mutually beneficial and contribute to significant growth in the {country} market.

Thank you for your time and consideration. We look forward to hearing from you soon and to the possibility of establishing a long-term, successful business relationship.

Best regards,

Vishwas Agarwal
Business Development Manager
Intex Technologies
Email: vishwas.agarwal@gmail.com
Phone: +91-11-4716-1111
Website: www.intex.in

P.S. We are also interested in exploring private label manufacturing opportunities and joint ventures for established brands in the {country} market. Please let us know if {firm} has any interest in such collaborations.</textarea>
                </div>
            </div>

            <!-- Contact History/Status Panel -->
            <div style="border: 1px solid #ddd; border-radius: 6px;">
                <div style="padding: 8px; background: #f8f9fa; border-bottom: 1px solid #ddd;">
                    <h3 style="margin: 0; color: #007bff; font-size: 14px;">üìä Email History</h3>
                </div>
                <div id="emailHistory" style="max-height: 300px; overflow-y: auto; padding: 8px;">
                    <div style="text-align: center; color: #999; padding: 15px;">
                        <p style="font-size: 12px;">üìß Email history will appear here</p>
                        <small style="font-size: 10px;">Send emails to see status tracking</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Simple global variables - no classes to avoid complexity
        let contacts = [];
        let selectedContactIndex = -1;
        let emailStatusCounts = {
            total: 0,
            sent: 0,
            failed: 0,
            pending: 0
        };
        let emailHistory = []; // Track email sending history
        let uploadStats = { total: 0, read: 0, unread: 0 }; // Track upload statistics

        // New functionality functions
        function toggleTemplate() {
            const container = document.getElementById('templateContainer');
            const button = document.getElementById('templateToggle');

            if (container.style.display === 'none') {
                container.style.display = 'block';
                button.textContent = 'üìù Collapse';
            } else {
                container.style.display = 'none';
                button.textContent = 'üìù Expand';
            }
        }

        function handleKeyNavigation(event) {
            if (contacts.length === 0) return;

            switch(event.key) {
                case 'ArrowDown':
                    event.preventDefault();
                    if (selectedContactIndex < contacts.length - 1) {
                        selectContact(selectedContactIndex + 1);
                    }
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    if (selectedContactIndex > 0) {
                        selectContact(selectedContactIndex - 1);
                    }
                    break;
                case 'Enter':
                    event.preventDefault();
                    if (selectedContactIndex >= 0) {
                        document.getElementById('sendBtn').click();
                    }
                    break;
            }
        }

        function updateUploadStats() {
            const statsDiv = document.getElementById('uploadStats');
            if (uploadStats.total > 0) {
                statsDiv.style.display = 'block';
                statsDiv.innerHTML = `
                    üìä Total: ${uploadStats.total} |
                    ‚úÖ Read: ${uploadStats.read} |
                    ‚ùå Unread: ${uploadStats.unread}
                `;
            }
        }

        function addToEmailHistory(toEmails, subject, status, timestamp) {
            const historyItem = {
                id: Date.now(),
                toEmails: Array.isArray(toEmails) ? toEmails : [toEmails],
                subject: subject,
                status: status, // 'sent', 'failed'
                timestamp: timestamp,
                content: document.getElementById('messageBody').value.substring(0, 100) + '...'
            };
            emailHistory.unshift(historyItem); // Add to beginning
            updateEmailHistory();
        }

        function updateEmailHistory() {
            const historyDiv = document.getElementById('emailHistory');

            if (emailHistory.length === 0) {
                historyDiv.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 20px;">
                        <p>üìß Email history will appear here</p>
                        <small>Send emails to see status tracking</small>
                    </div>
                `;
                return;
            }

            let historyHTML = '';
            emailHistory.slice(0, 20).forEach(item => { // Show last 20 items
                const statusColor = item.status === 'sent' ? '#28a745' : '#dc3545';
                const statusIcon = item.status === 'sent' ? '‚úÖ' : '‚ùå';

                historyHTML += `
                    <div style="border-bottom: 1px solid #eee; padding: 8px; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: between; align-items: start;">
                            <div style="flex: 1;">
                                <strong style="color: ${statusColor};">${statusIcon} ${item.status.toUpperCase()}</strong>
                                <div style="font-size: 12px; color: #666; margin-top: 2px;">
                                    To: ${item.toEmails.join(', ')}<br>
                                    Subject: ${item.subject}<br>
                                    ${new Date(item.timestamp).toLocaleString()}<br>
                                    <small>${item.content}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            historyDiv.innerHTML = historyHTML;
        }

        function parseMultipleEmails(emailString) {
            // Handle multiple delimiters: comma, semicolon, forward slash
            return emailString
                .split(/[,;\/]/)
                .map(email => email.trim())
                .filter(email => email && email.includes('@'));
        }

        // No sample data - users must upload their own spreadsheets

        function showAlert(message, type = 'success') {
            const alerts = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            alerts.appendChild(alert);

            // Remove after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }


        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                console.log('No file selected');
                return;
            }

            // Check if XLSX library is loaded for Excel files
            if (!file.name.toLowerCase().endsWith('.csv') && typeof XLSX === 'undefined') {
                showAlert('Error: Excel processing library not loaded. Please refresh the page.', 'error');
                return;
            }

            console.log('=== FILE UPLOAD STARTED ===');
            console.log('File selected:', file.name, file.type, file.size);
            showAlert(`Processing ${file.name}...`, 'success');

            try {
                contacts = []; // Clear existing contacts
                let totalProcessed = 0;

                // Handle CSV files differently
                if (file.name.toLowerCase().endsWith('.csv')) {
                    console.log('Processing CSV file...');
                    const text = await file.text();
                    console.log('CSV file read, length:', text.length);

                    const csvData = parseCSV(text);
                    console.log('CSV parsed, headers:', csvData.headers);
                    console.log('CSV data rows:', csvData.data.length);

                    // Track total rows for statistics
                    uploadStats.total = csvData.data.length;

                    // Process CSV data
                    csvData.data.forEach((row, index) => {
                        console.log(`Processing row ${index + 1}:`, row);
                        const contact = {
                            country: row.country || 'Unknown',
                            firm: row['firm name'] || row.company || row.firm || 'Unknown Company',
                            address: row.address || row.location || '',
                            phone: row['contact number'] || row.phone || row.telephone || '',
                            contactName: row['contact person'] || row.name || row.contact || 'Contact Person',
                            email: row.email || row['email address'] || '',
                            website: row.website || row.url || '',
                            source: row.source || row['lead source'] || '',
                            category: row.category || row.type || row.sector || '',
                            businessFocus: generateBusinessFocus(row.category || row.type || ''),
                            marketStrength: 'Medium',
                            emailStatus: 'pending' // pending, sent, failed
                        };

                        console.log('Contact created:', contact);

                        if (contact.email && contact.email.includes('@')) {
                            contacts.push(contact);
                            totalProcessed++;
                            console.log(`Added contact ${totalProcessed}: ${contact.firm} - ${contact.email}`);
                        } else {
                            console.log('Skipped contact (no valid email):', contact);
                        }
                    });

                    console.log(`CSV processed: ${totalProcessed} contacts added to array`);
                    console.log('Final contacts array:', contacts);
                } else {
                    // Handle Excel files
                    const data = await file.arrayBuffer();
                    console.log('Excel file read, size:', data.byteLength);

                    const workbook = XLSX.read(data, { type: 'array' });
                    console.log('Workbook loaded, sheets:', workbook.SheetNames);

                    // Calculate total rows across all sheets
                    uploadStats.total = 0;
                    workbook.SheetNames.forEach(sheetName => {
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        if (jsonData.length > 1) {
                            uploadStats.total += jsonData.length - 1; // Exclude header row
                        }
                    });

                    // Process each worksheet (tab) as a country
                    workbook.SheetNames.forEach(sheetName => {
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (jsonData.length < 2) return; // Skip empty sheets

                    const headers = jsonData[0].map(h => h?.toString().toLowerCase().trim());
                    const rows = jsonData.slice(1);

                    // Map column indices for key parameters
                    const columnMap = {
                        firm: findColumnIndex(headers, ['firm name', 'company', 'firm', 'organization']),
                        address: findColumnIndex(headers, ['address', 'location', 'addr']),
                        phone: findColumnIndex(headers, ['contact number', 'phone', 'telephone', 'mobile']),
                        contactName: findColumnIndex(headers, ['contact person', 'name', 'contact', 'person']),
                        email: findColumnIndex(headers, ['email', 'email address', 'e-mail']),
                        website: findColumnIndex(headers, ['website', 'url', 'web', 'site']),
                        source: findColumnIndex(headers, ['source', 'lead source', 'origin']),
                        category: findColumnIndex(headers, ['category', 'type', 'sector', 'industry'])
                    };

                    // Process each row
                    rows.forEach(row => {
                        if (!row || row.length === 0) return;

                        const contact = {
                            country: sheetName, // Use sheet name as country
                            firm: getCellValue(row, columnMap.firm) || 'Unknown Company',
                            address: getCellValue(row, columnMap.address) || '',
                            phone: getCellValue(row, columnMap.phone) || '',
                            contactName: getCellValue(row, columnMap.contactName) || 'Contact Person',
                            email: getCellValue(row, columnMap.email) || '',
                            website: getCellValue(row, columnMap.website) || '',
                            source: getCellValue(row, columnMap.source) || '',
                            category: getCellValue(row, columnMap.category) || '',
                            businessFocus: generateBusinessFocus(getCellValue(row, columnMap.category)),
                            marketStrength: 'High',
                            emailStatus: 'pending' // pending, sent, failed
                        };

                        // Only add if email exists
                        if (contact.email && contact.email.includes('@')) {
                            contacts.push(contact);
                            totalProcessed++;
                        }
                    });

                        console.log(`Processed sheet "${sheetName}": ${jsonData.length - 1} rows`);
                    });

                    console.log(`Total contacts loaded: ${contacts.length}`);
                }

                // Update upload statistics
                uploadStats.read = contacts.length;
                uploadStats.unread = uploadStats.total - uploadStats.read;
                updateUploadStats();

                console.log('About to render contacts. Array length:', contacts.length);
                renderContacts();
                showAlert(`‚úÖ Loaded ${contacts.length} contacts${file.name.toLowerCase().endsWith('.csv') ? '' : ` from multiple countries`}!`);

            } catch (error) {
                showAlert(`Error processing file: ${error.message}`, 'error');
                console.error('File processing error:', error);
            }
        }

        function findColumnIndex(headers, possibleNames) {
            for (let name of possibleNames) {
                const index = headers.findIndex(h => h && h.includes(name));
                if (index !== -1) return index;
            }
            return -1;
        }

        function getCellValue(row, columnIndex) {
            if (columnIndex === -1 || !row[columnIndex]) return '';
            return row[columnIndex].toString().trim();
        }

        function generateBusinessFocus(category) {
            const focusMap = {
                'technology': 'IT peripherals and smart devices',
                'retail': 'Consumer electronics and home appliances',
                'electronics': 'Audio solutions and mobile accessories',
                'manufacturing': 'Industrial equipment and automation',
                'healthcare': 'Medical devices and monitoring systems',
                'education': 'Educational technology and audio-visual equipment'
            };

            const categoryLower = category.toLowerCase();
            for (let [key, focus] of Object.entries(focusMap)) {
                if (categoryLower.includes(key)) return focus;
            }
            return 'Consumer electronics and technology solutions';
        }

        function renderContacts() {
            console.log('=== RENDER CONTACTS CALLED ===');
            console.log('Contacts to render:', contacts.length);
            console.log('Contacts array:', contacts);

            const container = document.getElementById('contactsList');
            if (!container) {
                console.error('contactsList element not found!');
                return;
            }

            container.innerHTML = '';

            if (contacts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666; border: 2px dashed #ddd; border-radius: 8px; background: #f9f9f9;">
                        <h4 style="color: #999; margin-bottom: 10px;">üìã No Contacts Loaded</h4>
                        <p>Upload your spreadsheet above to see your contact database here</p>
                        <small>Your contacts will appear here after uploading</small>
                    </div>
                `;
                return;
            }

            console.log('Rendering individual contacts...');
            contacts.forEach((contact, index) => {
                console.log(`Rendering contact ${index + 1}:`, contact);
                const div = document.createElement('div');
                div.className = 'contact-item';
                div.onclick = () => selectContact(index);

                // Add status-based styling
                let statusColor = '';
                let statusIcon = '';
                if (contact.emailStatus === 'sent') {
                    statusColor = 'background: #d4edda; border-color: #28a745;';
                    statusIcon = '‚úÖ';
                } else if (contact.emailStatus === 'failed') {
                    statusColor = 'background: #f8d7da; border-color: #dc3545;';
                    statusIcon = '‚ùå';
                } else {
                    statusIcon = 'üìß';
                }

                div.style.cssText += statusColor;

                // Enhanced display with all contact details
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <strong>${contact.firm}</strong>
                                ${contact.category ? `<span style="background: #e3f2fd; color: #1976d2; padding: 2px 6px; border-radius: 3px; font-size: 0.8em;">${contact.category}</span>` : ''}
                            </div>
                            üë§ ${contact.contactName}<br>
                            üìß ${contact.email}<br>
                            üåç ${contact.country}
                            ${contact.phone ? `<br>üìû ${contact.phone}` : ''}
                            ${contact.website ? `<br>üåê ${contact.website}` : ''}
                            ${contact.address ? `<br>üìç ${contact.address}` : ''}
                            ${contact.source ? `<br>üìä Source: ${contact.source}` : ''}
                        </div>
                        <div style="font-size: 20px;">${statusIcon}</div>
                    </div>
                `;
                container.appendChild(div);
                console.log(`Contact ${index + 1} added to DOM`);
            });

            // Update counts
            updateContactCounts();
            console.log('=== CONTACT RENDERING COMPLETE ===');
        }

        function updateContactCounts() {
            emailStatusCounts.total = contacts.length;
            emailStatusCounts.sent = contacts.filter(c => c.emailStatus === 'sent').length;
            emailStatusCounts.failed = contacts.filter(c => c.emailStatus === 'failed').length;
            emailStatusCounts.pending = contacts.filter(c => c.emailStatus === 'pending').length;

            document.getElementById('totalCount').textContent = `${emailStatusCounts.total} contacts`;
            document.getElementById('sentCount').textContent = `${emailStatusCounts.sent} sent`;
            document.getElementById('failedCount').textContent = `${emailStatusCounts.failed} failed`;
        }

        function handleScroll() {
            const contactsList = document.getElementById('contactsList');
            const scrollTopBtn = document.getElementById('scrollTopBtn');

            // Show scroll to top button when scrolled down more than 100px
            if (contactsList.scrollTop > 100) {
                scrollTopBtn.style.display = 'block';
            } else {
                scrollTopBtn.style.display = 'none';
            }
        }

        function scrollToTop() {
            const contactsList = document.getElementById('contactsList');
            contactsList.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        function selectContact(index) {
            selectedContactIndex = index;
            const contact = contacts[index];

            // Update UI
            document.querySelectorAll('.contact-item').forEach((item, i) => {
                item.classList.toggle('selected', i === index);
            });

            // Extract subject from template and populate dynamically
            const template = document.getElementById('emailTemplate').value;
            const templateLines = template.split('\n');
            let subjectTemplate = 'Business Partnership Opportunity - Intex Technologies in {country}';

            // Find subject line in template
            for (let line of templateLines) {
                if (line.startsWith('Subject: ')) {
                    subjectTemplate = line.replace('Subject: ', '').trim();
                    break;
                }
            }

            // Populate email form
            document.getElementById('toEmail').value = contact.email;
            document.getElementById('subject').value = subjectTemplate.replace(/{country}/g, contact.country)
                                                                     .replace(/{firm}/g, contact.firm)
                                                                     .replace(/{email}/g, contact.email);

            // Generate email body from template
            let body = template.replace(/{email}/g, contact.email)
                              .replace(/{contactName}/g, contact.contactName)
                              .replace(/{country}/g, contact.country)
                              .replace(/{firm}/g, contact.firm);

            // Remove email headers from body
            const bodyLines = body.split('\n');
            let bodyStart = 0;
            for (let i = 0; i < bodyLines.length; i++) {
                if (bodyLines[i].trim() === '' && i > 0) {
                    bodyStart = i + 1;
                    break;
                }
                if (!bodyLines[i].includes(':') || bodyLines[i].startsWith('Dear')) {
                    bodyStart = i;
                    break;
                }
            }

            document.getElementById('messageBody').value = bodyLines.slice(bodyStart).join('\n').trim();
            document.getElementById('sendBtn').disabled = false;

            showAlert(`Selected: ${contact.contactName} from ${contact.firm}`);
        }

        async function sendEmail() {
            console.log('=== EMAIL SENDING STARTED ===');
            const fromEmail = document.getElementById('fromEmail').value;
            const toEmailField = document.getElementById('toEmail').value;
            const subject = document.getElementById('subject').value;
            const body = document.getElementById('messageBody').value;

            // Parse multiple emails
            const toEmails = parseMultipleEmails(toEmailField);
            console.log('Email details:', { fromEmail, toEmails, subject: subject.substring(0, 50) + '...' });

            if (toEmails.length === 0 || !subject || !body) {
                showAlert('Please fill in all fields with valid email addresses', 'error');
                return;
            }

            if (toEmails.length > 1) {
                showAlert(`Sending to ${toEmails.length} email addresses...`, 'success');
            }

            try {
                document.getElementById('sendBtn').textContent = 'üì§ Sending...';
                document.getElementById('sendBtn').disabled = true;

                // Send to each email address (for multiple emails, send individually)
                let successCount = 0;
                let failureCount = 0;

                for (const toEmail of toEmails) {
                    console.log(`Sending to: ${toEmail}`);

                    try {
                        const response = await fetch('/.netlify/functions/send-email-working', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                from_email: fromEmail,
                                from_name: 'Intex Technologies',
                                to_email: toEmail,
                                subject: subject,
                                content: body
                            })
                        });

                        const result = await response.json();
                        console.log(`Response for ${toEmail}:`, result);

                        if (result.success) {
                            successCount++;
                            addToEmailHistory(toEmail, subject, 'sent', Date.now());
                        } else {
                            failureCount++;
                            addToEmailHistory(toEmail, subject, 'failed', Date.now());
                        }
                    } catch (emailError) {
                        console.error(`Error sending to ${toEmail}:`, emailError);
                        failureCount++;
                        addToEmailHistory(toEmail, subject, 'failed', Date.now());
                    }
                }

                // Show summary results
                if (successCount > 0 && failureCount === 0) {
                    showAlert(`‚úÖ Successfully sent to all ${successCount} email(s)`);
                } else if (successCount > 0 && failureCount > 0) {
                    showAlert(`‚ö†Ô∏è Sent to ${successCount}, failed to ${failureCount} email(s)`);
                } else {
                    showAlert(`‚ùå Failed to send to all ${failureCount} email(s)`, 'error');
                }

                // Update contact status if single contact selected
                if (selectedContactIndex >= 0 && toEmails.length === 1) {
                    contacts[selectedContactIndex].emailStatus = successCount > 0 ? 'sent' : 'failed';
                    renderContacts(); // Re-render to show color
                }

            } catch (error) {
                console.error('Email sending error:', error);
                showAlert(`Network error: ${error.message}`, 'error');

                // Update contact status to failed on network error
                if (selectedContactIndex >= 0) {
                    contacts[selectedContactIndex].emailStatus = 'failed';
                    renderContacts(); // Re-render to show red color
                }
            } finally {
                document.getElementById('sendBtn').textContent = 'üì§ Send Email';
                document.getElementById('sendBtn').disabled = false;
            }
        }

        async function testConnection() {
            try {
                console.log('=== SMTP CONNECTION TEST STARTED ===');
                showAlert('Testing SMTP credentials and connection...', 'success');

                document.getElementById('status').textContent = 'üîÑ Testing SMTP...';
                document.getElementById('status').className = 'status ready';

                const response = await fetch('/.netlify/functions/test-smtp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();
                console.log('SMTP test result:', result);

                if (result.success) {
                    showAlert(`${result.message}`, 'success');
                    showAlert(`Connected to: ${result.smtp_config.server}:${result.smtp_config.port}`, 'success');
                    document.getElementById('status').textContent = '‚úÖ SMTP Ready';
                    document.getElementById('status').className = 'status ready';
                } else {
                    showAlert(`${result.message}`, 'error');

                    if (result.troubleshooting && result.troubleshooting.length > 0) {
                        showAlert(`Troubleshooting: ${result.troubleshooting.join(', ')}`, 'error');
                    }

                    if (result.instructions) {
                        console.log('SMTP Setup Instructions:', result.instructions);
                        showAlert('Check console for detailed setup instructions', 'error');
                    }

                    document.getElementById('status').textContent = '‚ùå SMTP Issues';
                    document.getElementById('status').className = 'status error';
                }
            } catch (error) {
                console.error('SMTP test error:', error);
                showAlert('‚ùå SMTP test failed - network error', 'error');
                document.getElementById('status').textContent = '‚ùå SMTP Error';
                document.getElementById('status').className = 'status error';
            }
        }

        function extractTemplateHeaders() {
            const template = document.getElementById('emailTemplate').value;
            const headerLines = template.split('\n');

            // Set default values
            document.getElementById('fromEmail').value = 'info@datanalysisninsights.co.uk';
            window.defaultFromName = 'Intex Technologies';

            // Extract headers from template if present
            for (let line of headerLines) {
                if (line.startsWith('From: ')) {
                    const fromEmail = line.replace('From: ', '').trim();
                    // Only use template email if it's a valid email address
                    if (fromEmail.includes('@')) {
                        document.getElementById('fromEmail').value = fromEmail;
                    }
                }
                if (line.startsWith('From-Name: ')) {
                    const fromName = line.replace('From-Name: ', '').trim();
                    window.defaultFromName = fromName;
                }
            }
        }

        function testXLSXLibrary() {
            if (typeof XLSX === 'undefined') {
                console.error('XLSX library not loaded');
                showAlert('‚ö†Ô∏è Excel processing library failed to load. File upload may not work.', 'error');
                return false;
            } else {
                console.log('XLSX library loaded successfully, version:', XLSX.version);
                return true;
            }
        }

        // Add a simple CSV processor as fallback
        function parseCSV(text) {
            const csvLines = text.split('\n');
            const headers = csvLines[0].split(',').map(h => h.trim().toLowerCase());
            const data = [];

            for (let i = 1; i < csvLines.length; i++) {
                if (csvLines[i].trim()) {
                    const values = csvLines[i].split(',');
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] ? values[index].trim() : '';
                    });
                    data.push(row);
                }
            }
            return { headers, data };
        }

        // Initialize on page load - no complex initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Simple email sender loaded');
            testXLSXLibrary(); // Test if XLSX library loaded
            extractTemplateHeaders(); // Extract and populate From field
            renderContacts(); // Initialize contact list display
            showAlert('üìß Email Sender Ready! Upload your contact spreadsheet to begin sending personalized emails.');
        });
    </script>
</body>
</html>