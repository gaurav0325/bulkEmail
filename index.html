<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Email Sender - Data Analysis Insights v2.2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <meta name="cache-control" content="no-cache">
    <meta name="version" content="2.1-contact-enhancements-fixed">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #374151;
            line-height: 1.6;
        }
        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .main-content {
            display: none; /* Initially hidden until authentication */
            grid-template-columns: 1fr 2fr 1fr;
            gap: 15px;
            height: 100vh;
            max-height: 900px;
        }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
                gap: 10px;
                height: auto;
            }
            .left-panel, .right-panel {
                max-width: none;
                min-width: auto;
            }
            .center-panel {
                min-width: auto;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            .button {
                padding: 8px 12px !important;
                font-size: 12px !important;
            }
        }
        .panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        .left-panel {
            max-width: 300px;
            min-width: 250px;
        }
        .center-panel {
            min-width: 400px;
        }
        .right-panel {
            max-width: 300px;
            min-width: 250px;
        }
        .button {
            background: #f8f9fa;
            color: #202124;
            border: 1px solid #dadce0;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            min-height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            outline: none;
            margin: 4px 2px;
        }
        .button:hover {
            background: #f1f3f4;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        }
        .button:active {
            background: #e8eaed;
        }
        .button:disabled {
            background: #f8f9fa;
            color: #5f6368;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Primary button variant (for main actions) */
        .button-primary {
            background: #1a73e8;
            color: white;
            border: 1px solid #1a73e8;
        }
        .button-primary:hover {
            background: #1557b0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.16);
        }
        .button-primary:active {
            background: #1143a3;
        }
        .button-primary:disabled {
            background: #dadce0;
            color: #5f6368;
            border: 1px solid #dadce0;
        }

        /* Secondary button variant */
        .button-secondary {
            background: white;
            color: #1a73e8;
            border: 1px solid #dadce0;
        }
        .button-secondary:hover {
            background: #f8f9fa;
        }

        /* Danger button variant */
        .button-danger {
            background: white;
            color: #d93025;
            border: 1px solid #dadce0;
        }
        .button-danger:hover {
            background: #fce8e6;
        }

        /* Success button variant */
        .button-success {
            background: #34a853;
            color: white;
            border: 1px solid #34a853;
        }
        .button-success:hover {
            background: #2d8f47;
        }
        .contact-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            cursor: pointer;
        }
        .contact-item:hover {
            background: #f8f9fa;
        }
        .contact-item.selected {
            background: #0056b3 !important;
            color: white !important;
            font-weight: 600 !important;
            border: 2px solid #004085 !important;
        }
        .alert {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        textarea, input[type="text"], input[type="email"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px 0;
        }
        textarea {
            min-height: 300px;
            resize: vertical;
        }
        #messageBody {
            min-height: 500px !important;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            padding: 15px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        .status.ready {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        /* Modern Button Styles */
        .modern-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            letter-spacing: 0.025em;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        .modern-btn:hover {
            background: #3b82f6 !important;
            color: white !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        .modern-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }

        /* Modal Close Button Styles */
        .modal-close-btn {
            background: #dc3545 !important;
            color: white !important;
            border: none !important;
            width: 32px !important;
            height: 32px !important;
            border-radius: 50% !important;
            font-size: 18px !important;
            cursor: pointer !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            line-height: 1 !important;
            transition: all 0.2s ease !important;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3) !important;
            z-index: 999999 !important;
            position: relative !important;
        }

        .modal-close-btn:hover {
            background: #c82333 !important;
            transform: scale(1.1) !important;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.5) !important;
        }

        .modal-close-btn:active {
            transform: scale(0.95) !important;
        }

        /* Template Editor Color Formatting - Preserve inline styles */
        #companyEmailTemplate {
            font-family: inherit;
            white-space: pre-wrap;
        }

        /* Allow inline styles to work properly */
        #companyEmailTemplate span,
        #companyEmailTemplate div,
        #companyEmailTemplate p {
            display: inline;
        }

        /* Ensure color and background styles are preserved */
        #companyEmailTemplate [style*="color:"],
        #companyEmailTemplate [style*="background-color:"] {
            /* Let inline styles take precedence */
        }

        /* Authentication Gate Button Styles */
        #loginBtn:hover {
            background: #0056b3 !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(0,123,255,0.4) !important;
        }

        #registerBtn:hover {
            background: #218838 !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(40,167,69,0.4) !important;
        }

        #loginBtn:active, #registerBtn:active {
            transform: translateY(0) !important;
        }

        /* Formatting Toolbar Styles */
        .format-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            border: 1px solid #e5e7eb;
            background: white;
            color: #374151;
        }
        .format-btn:hover {
            background: #3b82f6 !important;
            color: white !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            border-color: #3b82f6;
        }
        .format-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }

        /* Attachment Styles */
        #attachmentContainer {
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Formatting Toolbar Animation */
        #formattingToolbar {
            animation: slideDown 0.3s ease;
        }

        /* Rich Text Editor Styles */
        #messageBody[contenteditable="true"] {
            border: 2px solid #e5e7eb;
            transition: border-color 0.3s ease;
        }
        #messageBody[contenteditable="true"]:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        #messageBody[contenteditable="true"]:empty:before {
            content: attr(placeholder);
            color: #9ca3af;
            pointer-events: none;
        }

        /* Rich Text Formatting Styles */
        #messageBody strong, #messageBody b {
            font-weight: 600;
        }
        #messageBody em, #messageBody i {
            font-style: italic;
        }
        #messageBody u {
            text-decoration: underline;
        }
        #messageBody ul, #messageBody ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        #messageBody blockquote {
            border-left: 3px solid #3b82f6;
            margin: 10px 0;
            padding-left: 15px;
            color: #6b7280;
        }
        #messageBody a {
            color: #3b82f6;
            text-decoration: underline;
        }

        /* Smart Message Popup Styles */
        .quick-action-btn:hover {
            background: #e9ecef !important;
            border-color: #adb5bd !important;
        }
        #smartMessagePopup {
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Authentication Gate Overlay -->
    <div id="authGate" style="
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex; align-items: center; justify-content: center;
        z-index: 999999; padding: 20px;
        ">
        <div style="
            background: white; padding: 40px; border-radius: 16px;
            max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            ">
            <div style="font-size: 64px; margin-bottom: 20px;">üìß</div>
            <h1 style="margin: 0 0 15px 0; color: #333; font-size: 28px;">Bulk Email Sender</h1>
            <p style="margin: 0 0 30px 0; color: #666; font-size: 16px; line-height: 1.5;">Professional Email Campaign Platform</p>

            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; text-align: left;">
                <h3 style="margin: 0 0 15px 0; color: #007bff; font-size: 18px;">üöÄ Platform Features:</h3>
                <ul style="margin: 0; padding-left: 20px; color: #555; line-height: 1.6;">
                    <li>Multi-format contact file upload & processing</li>
                    <li>Rich text email composition with templates</li>
                    <li>Bulk email campaigns with personalization</li>
                    <li>Real-time analytics and progress tracking</li>
                    <li>Multi-company management</li>
                    <li>Professional email delivery via SMTP</li>
                </ul>
            </div>

            <div style="display: grid; gap: 15px;">
                <button id="loginBtn" onclick="showLoginModal()" style="
                    width: 100%; padding: 15px; background: #007bff; color: white;
                    border: none; border-radius: 8px; font-size: 16px; font-weight: 600;
                    cursor: pointer; transition: all 0.2s ease;
                    ">üîê Login to Your Account</button>

                <button id="registerBtn" onclick="showRegisterModal()" style="
                    width: 100%; padding: 15px; background: #28a745; color: white;
                    border: none; border-radius: 8px; font-size: 16px; font-weight: 600;
                    cursor: pointer; transition: all 0.2s ease;
                    ">üÜï Create New Account</button>
            </div>

            <p style="margin: 30px 0 0 0; color: #999; font-size: 12px;">üîí Your data is secure and private. We never share your information.</p>
        </div>
    </div>
    <div style="background: white; padding: 10px 20px; border-radius: 5px; margin-bottom: 15px; display: none; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);" id="appHeader">
        <div>
            <h3 style="margin: 0; color: #007bff;">üìß Bulk Email Sender</h3>
            <small style="color: #666;">Data Analysis Insights - Professional Email Campaign Tool</small>
        </div>
        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
            <!-- Data Management Buttons -->
            <div class="dropdown" style="position: relative; display: inline-block;">
                <button class="button" onclick="toggleDataMenu()" id="dataMenuBtn">Data ‚ñº</button>
                <div id="dataMenu" style="display: none; position: absolute; right: 0; background: white; min-width: 160px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); z-index: 1000; border-radius: 4px; border: 1px solid #ddd; top: 100%; margin-top: 2px;">
                    <a href="#" onclick="saveDraftEmail()" style="color: #333; padding: 8px 12px; text-decoration: none; display: block; font-size: 12px; border-bottom: 1px solid #eee;">Save Draft</a>
                    <a href="#" onclick="loadDraftEmail()" style="color: #333; padding: 8px 12px; text-decoration: none; display: block; font-size: 12px; border-bottom: 1px solid #eee;">Load Draft</a>
                    <a href="#" onclick="exportAllData()" style="color: #333; padding: 8px 12px; text-decoration: none; display: block; font-size: 12px; border-bottom: 1px solid #eee;">Export All</a>
                    <a href="#" onclick="importAllData()" style="color: #333; padding: 8px 12px; text-decoration: none; display: block; font-size: 12px; border-bottom: 1px solid #eee;">Import Data</a>
                    <a href="#" onclick="CompanyOnboardingModule.showManager()" style="color: #007bff; padding: 8px 12px; text-decoration: none; display: block; font-size: 12px; border-bottom: 1px solid #eee;">üè¢ Company Management</a>
                    <div id="currentCompanyDisplay" style="padding: 8px 12px; font-size: 11px; color: #666; border-bottom: 1px solid #eee; background: #f8f9fa;">
                        <div>üìã <span id="activeCompanyName">No company selected</span></div>
                    </div>
                    <a href="#" onclick="clearAllData()" style="color: #dc3545; padding: 8px 12px; text-decoration: none; display: block; font-size: 12px;">Clear All</a>
                </div>
            </div>
            <!-- Settings Dropdown -->
            <div class="dropdown" style="position: relative; display: inline-block;">
                <button class="button" onclick="toggleSettingsMenu()" id="settingsMenuBtn">‚öôÔ∏è Settings ‚ñº</button>
                <div id="settingsMenu" style="display: none; position: absolute; right: 0; background: white; min-width: 180px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); z-index: 1000; border-radius: 4px; border: 1px solid #ddd; top: 100%; margin-top: 2px;">
                    <div id="userInfoSection" style="padding: 8px 12px; font-size: 11px; color: #666; border-bottom: 1px solid #eee; background: #f0f8ff;">
                        <div id="loggedInUser">üë§ <span id="currentUserName">Not logged in</span></div>
                    </div>
                    <a href="#" onclick="UserManager.showAuthModal()" style="color: #007bff; padding: 8px 12px; text-decoration: none; display: block; font-size: 12px; border-bottom: 1px solid #eee;">üë§ User Account</a>
                    <a href="#" onclick="UserManager.showCompanySelection()" style="color: #007bff; padding: 8px 12px; text-decoration: none; display: block; font-size: 12px; border-bottom: 1px solid #eee;">üè¢ My Companies</a>
                    <a href="#" onclick="CompanyOnboardingModule.showManager()" style="color: #28a745; padding: 8px 12px; text-decoration: none; display: block; font-size: 12px; border-bottom: 1px solid #eee;">‚ûï Add Company</a>
                    <a href="#" onclick="showEmailConfig()" style="color: #6c757d; padding: 8px 12px; text-decoration: none; display: block; font-size: 12px; border-bottom: 1px solid #eee;">üìß Email Config</a>
                    <a href="#" onclick="UserManager.logout()" style="color: #dc3545; padding: 8px 12px; text-decoration: none; display: block; font-size: 12px;">üö™ Logout</a>
                </div>
            </div>
            <button class="button button-secondary" onclick="startTutorial()" title="Interactive Tutorial">Help</button>
            <button class="button button-primary" onclick="sendEmail()" id="sendBtn" disabled aria-label="Send Email to Selected Contact">Send Email</button>
            <button class="button button-primary" id="bulkSendBtn" onclick="showBulkEmailConfirmation()" disabled aria-label="Send Bulk Emails to All Contacts" title="Review and send emails to all uploaded contacts">Bulk Email</button>
        </div>
    </div>


    <div class="main-content">
        <!-- LEFT PANEL: Contact Management -->
        <div class="panel left-panel">
            <h2 style="font-size: 18px; margin-bottom: 15px;">üìã Contact Management</h2>

            <!-- Upload Section -->
            <div style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; background: #f8f9fa; margin-bottom: 12px;" role="region" aria-label="File Upload">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <span style="font-size: 12px; color: #666;">üìÅ Upload Contacts:</span>
                    <label for="fileUpload" class="button button-success" style="cursor: pointer; padding: 6px 12px; font-size: 12px;" aria-describedby="fileUploadDesc">
                        Choose File
                    </label>
                </div>
                <input type="file" id="fileUpload" accept=".xlsx,.xls,.csv,.pdf,.doc,.docx,.ppt,.pptx,.png,.jpg,.jpeg,.gif,.bmp,.tiff" onchange="handleAdvancedFileUpload(event)" style="display: none;" aria-label="Upload Contact File" aria-describedby="fileUploadDesc">
                <small id="fileUploadDesc" style="color: #666; font-size: 9px;">Excel/CSV/PDF/Word/PowerPoint/Image files (max 10MB)</small>
                <div id="uploadProgress" style="margin-top: 5px; display: none;">
                    <div style="background: #e9ecef; border-radius: 3px; height: 4px;">
                        <div id="progressBar" style="background: #007bff; height: 100%; border-radius: 3px; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <small id="progressText" style="font-size: 8px; color: #666;"></small>
                </div>
                <div id="uploadStats" style="margin-top: 5px; font-size: 9px; color: #007bff; display: none;" role="status" aria-live="polite"></div>
            </div>

            <!-- Contact List with Keyboard Navigation -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <h3 style="margin: 0; color: #007bff; font-size: 14px;">üìã Contact List</h3>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div id="contactCounts" style="font-size: 10px; color: #666; font-weight: bold;">
                        <span id="totalCount">0 contacts</span> |
                        <span id="sentCount" style="color: #22c55e;">0 sent</span> |
                        <span id="failedCount" style="color: #ef4444;">0 failed</span>
                    </div>
                    <button onclick="downloadContactStatus()" class="button button-secondary" style="padding: 4px 8px; font-size: 10px; display: none;" id="downloadContactsBtn" title="Download contact status spreadsheet">
                        Download
                    </button>
                    <button id="scrollTopBtn" class="button" onclick="scrollToTop()" style="padding: 4px 8px; font-size: 12px; display: none;">
                        Top
                    </button>
                </div>
            </div>
            <div style="margin-bottom: 8px;">
                <input type="text" id="contactSearch" placeholder="üîç Search contacts..." style="width: 100%; padding: 4px 8px; font-size: 10px; border: 1px solid #ddd; border-radius: 3px;" oninput="filterContacts()" aria-label="Search contacts">
            </div>
            <small style="color: #666; font-size: 10px; margin-bottom: 5px; display: block;">Use ‚Üë‚Üì arrows, Enter to send, Esc to clear selection</small>
            <div id="contactsList" tabindex="0" role="listbox" aria-label="Contact List" style="max-height: 350px; min-height: 200px; overflow-y: auto; border: 2px solid #e3f2fd; border-radius: 6px; padding: 6px; background: #fafafa; outline: 2px solid transparent; font-size: 11px;" onscroll="handleScroll()" onkeydown="handleKeyNavigation(event)" onfocus="this.style.outline='2px solid #007bff'" onblur="this.style.outline='2px solid transparent'">
                <div style="text-align: center; padding: 30px; color: #999; font-style: italic;">
                    <h4 style="color: #ccc; margin-bottom: 8px; font-size: 14px;">üìã No Contacts</h4>
                    <p style="font-size: 12px;">Upload spreadsheet to see contacts</p>
                </div>
            </div>
        </div>

        <!-- CENTER PANEL: Email Composer (Main) -->
        <div class="panel center-panel" style="padding: 25px;">
            <h2 style="color: #007bff; margin-bottom: 20px; text-align: center;">üì® Email Composer</h2>
            <div id="alerts"></div>

            <div style="margin-bottom: 15px;">
                <label for="fromEmail" style="font-size: 14px; font-weight: bold; color: #333; display: block; margin-bottom: 5px;">From:</label>
                <input type="text" id="fromEmail" value="Emails will be sent from Intex Technologies <info@datanalysisninsights.co.uk>" placeholder="Sender email" style="font-size: 14px; padding: 10px; width: 100%; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa;" readonly aria-required="true">
                <div style="background: #e8f4fd; border: 1px solid #b3d9ff; border-radius: 4px; padding: 8px; margin-top: 5px; font-size: 12px; color: #0056b3;">
                    üí¨ <strong>Replies go to:</strong> Intex Technologies &lt;info@datanalysisninsights.co.uk&gt;
                </div>
                <div id="fromEmailError" style="color: #dc3545; font-size: 12px; margin-top: 2px; display: none;" role="alert"></div>
            </div>

            <div style="margin-bottom: 15px;">
                <label for="toEmail" style="font-size: 14px; font-weight: bold; color: #333; display: block; margin-bottom: 5px;">To: <small style="color: #28a745;">(Use / or , for multiple emails)</small></label>
                <input type="text" id="toEmail" placeholder="Select contact or type emails separated by / or ," style="font-size: 14px; padding: 10px; width: 100%; border: 1px solid #ddd; border-radius: 4px;" aria-required="true" oninput="validateEmailList(this)" aria-describedby="toEmailDesc">
                <small id="toEmailDesc" style="color: #666; font-size: 11px;">Separate multiple emails with commas, semicolons, or forward slashes</small>
                <div id="toEmailError" style="color: #dc3545; font-size: 12px; margin-top: 2px; display: none;" role="alert"></div>
            </div>

            <div style="margin-bottom: 15px;">
                <label for="subject" style="font-size: 14px; font-weight: bold; color: #333; display: block; margin-bottom: 5px;">Subject:</label>
                <input type="text" id="subject" placeholder="Email subject" style="font-size: 14px; padding: 10px; width: 100%; border: 1px solid #ddd; border-radius: 4px;" aria-required="true" maxlength="255" oninput="validateSubject(this)">
                <div id="subjectError" style="color: #dc3545; font-size: 12px; margin-top: 2px; display: none;" role="alert"></div>

            </div>

            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <label for="messageBody" style="font-size: 14px; font-weight: bold; color: #333;">Message:</label>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <button onclick="toggleAttachments()" id="attachmentBtn" class="modern-btn" style="padding: 6px 8px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; color: #6b7280;" title="Add Attachments">
                            üìé
                        </button>
                        <button onclick="toggleFormatting()" id="formatToggle" class="button" aria-label="Toggle formatting tools">
                            Format
                        </button>
                        <button onclick="toggleMessageExpand()" id="messageExpandBtn" class="button" aria-label="Expand message area">
                            Expand
                        </button>
                    </div>
                </div>

                <!-- Attachment Section (moved to top) -->
                <div id="attachmentContainer" style="display: none; margin-bottom: 10px; padding: 12px; background: #f8f9fa; border: 1px solid #e5e7eb; border-radius: 6px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <input type="file" id="attachmentFiles" multiple accept=".pdf,.doc,.docx,.txt,.xlsx,.xls,.ppt,.pptx,.jpg,.jpeg,.png,.gif,.zip,.rar" style="display: none;" onchange="handleAttachmentUpload(event)">
                        <button onclick="document.getElementById('attachmentFiles').click()" class="modern-btn" style="padding: 6px 12px; font-size: 11px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            üìé Choose Files
                        </button>
                        <small style="color: #6b7280; font-size: 11px;">Max 5 files, 25MB total</small>
                        <small style="color: #f59e0b; font-size: 10px; display: block; margin-top: 2px;">‚ÑπÔ∏è Note: Attachments are stored for display. In a real email system, these would be sent with the email.</small>
                    </div>
                    <div id="attachmentList" style="min-height: 40px;">
                        <div id="attachmentEmpty" style="text-align: center; color: #9ca3af; font-style: italic; padding: 15px; font-size: 11px;">
                            No attachments selected
                        </div>
                    </div>
                </div>

                <!-- Formatting Toolbar -->
                <div id="formattingToolbar" style="display: none; padding: 12px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 1px solid #dee2e6; border-bottom: none; border-radius: 6px 6px 0 0; margin-bottom: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="display: flex; flex-wrap: wrap; gap: 6px; align-items: center;">
                        <!-- Text Formatting -->
                        <button onclick="formatText('bold')" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-weight: 600;" title="Bold">
                            <strong>B</strong>
                        </button>
                        <button onclick="formatText('italic')" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;" title="Italic">
                            <em>I</em>
                        </button>
                        <button onclick="formatText('underline')" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;" title="Underline">
                            <u>U</u>
                        </button>

                        <div style="width: 1px; height: 20px; background: #d1d5db; margin: 0 4px;"></div>

                        <!-- Color Highlighting -->
                        <button onclick="showColorPicker()" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; position: relative;" title="Text Color">
                            Color
                        </button>
                        <div id="colorPicker" style="display: none; position: absolute; z-index: 1000; background: white; border: 1px solid #d1d5db; border-radius: 6px; padding: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-top: 5px;">
                            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px;">
                                <div onclick="applyColor('#000000')" style="width: 20px; height: 20px; background: #000000; border-radius: 3px; cursor: pointer;" title="Black"></div>
                                <div onclick="applyColor('#dc2626')" style="width: 20px; height: 20px; background: #dc2626; border-radius: 3px; cursor: pointer;" title="Red"></div>
                                <div onclick="applyColor('#ea580c')" style="width: 20px; height: 20px; background: #ea580c; border-radius: 3px; cursor: pointer;" title="Orange"></div>
                                <div onclick="applyColor('#ca8a04')" style="width: 20px; height: 20px; background: #ca8a04; border-radius: 3px; cursor: pointer;" title="Yellow"></div>
                                <div onclick="applyColor('#16a34a')" style="width: 20px; height: 20px; background: #16a34a; border-radius: 3px; cursor: pointer;" title="Green"></div>
                                <div onclick="applyColor('#2563eb')" style="width: 20px; height: 20px; background: #2563eb; border-radius: 3px; cursor: pointer;" title="Blue"></div>
                                <div onclick="applyColor('#7c3aed')" style="width: 20px; height: 20px; background: #7c3aed; border-radius: 3px; cursor: pointer;" title="Purple"></div>
                                <div onclick="applyColor('#be185d')" style="width: 20px; height: 20px; background: #be185d; border-radius: 3px; cursor: pointer;" title="Pink"></div>
                                <div onclick="applyColor('#374151')" style="width: 20px; height: 20px; background: #374151; border-radius: 3px; cursor: pointer;" title="Gray"></div>
                                <div onclick="applyColor('#0891b2')" style="width: 20px; height: 20px; background: #0891b2; border-radius: 3px; cursor: pointer;" title="Cyan"></div>
                                <div onclick="applyColor('#059669')" style="width: 20px; height: 20px; background: #059669; border-radius: 3px; cursor: pointer;" title="Emerald"></div>
                                <div onclick="applyColor('#7c2d12')" style="width: 20px; height: 20px; background: #7c2d12; border-radius: 3px; cursor: pointer;" title="Brown"></div>
                            </div>
                        </div>

                        <div style="width: 1px; height: 20px; background: #d1d5db; margin: 0 4px;"></div>

                        <!-- Lists and Indentation -->
                        <button onclick="formatText('bullet')" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;" title="Bullet List">
                            ‚Ä¢ List
                        </button>
                        <button onclick="formatText('number')" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;" title="Numbered List">
                            1. List
                        </button>
                        <button onclick="formatText('indent')" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;" title="Indent">
                            ‚á• Indent
                        </button>

                        <div style="width: 1px; height: 20px; background: #d1d5db; margin: 0 4px;"></div>

                        <!-- Link -->
                        <button onclick="formatText('link')" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;" title="Insert Link">
                            üîó Link
                        </button>

                        <div style="width: 1px; height: 20px; background: #d1d5db; margin: 0 4px;"></div>

                        <!-- Undo and Clear -->
                        <button onclick="undoFormat()" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;" title="Undo">
                            ‚Ü∂ Undo
                        </button>
                        <button onclick="clearFormatting()" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;" title="Clear Formatting">
                            üßπ Clear
                        </button>

                        <div style="width: 1px; height: 20px; background: #d1d5db; margin: 0 4px;"></div>

                        <!-- Personalization -->
                        <button onclick="insertPersonalization()" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;" title="Insert Personalization">
                            üë§ Variables
                        </button>
                        <button onclick="insertBusinessOpportunity()" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;" title="Insert Business Opportunity">
                            üíº Opportunities
                        </button>
                    </div>
                </div>

                <!-- Smart Message Button -->
                <div style="margin-bottom: 8px;">
                    <button onclick="openSmartMessage()" id="smartMessageBtn" class="modern-btn" style="padding: 6px 12px; font-size: 11px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer;" title="AI-powered message enhancement">
                        ü§ñ Smart Message
                    </button>
                </div>

                <!-- Rich Text Editor -->
                <div id="messageBody" contenteditable="true" placeholder="Email content" style="min-height: 400px; font-size: 12px; line-height: 1.6; padding: 15px; width: 100%; border: 1px solid #ddd; border-radius: 4px; overflow-y: auto; background: white; outline: none; transition: min-height 0.3s ease;" aria-required="true" oninput="validateMessage(this); handleContentChange()" onpaste="handlePaste(event)" onkeydown="handleKeyDown(event)" role="textbox" aria-multiline="true">
                </div>

                <!-- Hidden textarea for form submission -->
                <textarea id="messageBodyHidden" style="display: none;" name="messageBody"></textarea>
                <div id="messageError" style="color: #dc3545; font-size: 12px; margin-top: 2px; display: none;" role="alert"></div>
                <small style="color: #666; font-size: 11px;">Use {contactName}, {firm}, {country}, {email} for personalization</small>
            </div>


            <div style="text-align: center; color: #666; font-style: italic; margin-top: 20px;">
                <p>üì§ Use the Send Email or Bulk Email buttons in the top-right corner</p>
                <small>Select a contact and compose your message above</small>
            </div>
        </div>

        <!-- RIGHT PANEL: Templates & Status -->
        <div class="panel right-panel" style="padding: 15px;">

            <!-- Email Analytics Dashboard -->
            <div style="border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #f8f9fa; border-bottom: 1px solid #ddd;">
                    <h3 style="margin: 0; color: #007bff; font-size: 14px;">üìä Email Analytics</h3>
                    <button onclick="toggleAnalytics()" id="analyticsToggle" class="button" style="padding: 6px 12px; font-size: 12px;">
                        Expand
                    </button>
                </div>
                <div id="analyticsContainer" style="display: none; padding: 12px;">
                    <!-- Quick Stats -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                        <div style="background: #ecfdf5; border: 1px solid #d1fae5; border-radius: 6px; padding: 8px; text-align: center;">
                            <div style="font-size: 18px; font-weight: 600; color: #065f46;" id="sentCount">0</div>
                            <div style="font-size: 10px; color: #374151;">Sent</div>
                        </div>
                        <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; padding: 8px; text-align: center;">
                            <div style="font-size: 18px; font-weight: 600; color: #dc2626;" id="failedCount">0</div>
                            <div style="font-size: 10px; color: #374151;">Failed</div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div style="display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap;">
                        <select id="countryFilter" onchange="filterEmailHistory()" style="font-size: 10px; padding: 4px; border: 1px solid #d1d5db; border-radius: 4px; background: white;">
                            <option value="">All Countries</option>
                        </select>
                        <select id="dateFilter" onchange="filterEmailHistory()" style="font-size: 10px; padding: 4px; border: 1px solid #d1d5db; border-radius: 4px; background: white;">
                            <option value="">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                        </select>
                    </div>

                    <!-- Top Countries -->
                    <div style="margin-bottom: 12px;">
                        <h4 style="margin: 0 0 6px 0; font-size: 11px; color: #374151;">Top Countries</h4>
                        <div id="topCountries" style="font-size: 10px; color: #6b7280;">
                            No data yet
                        </div>
                    </div>
                </div>
            </div>

            <!-- Email History Log -->
            <div style="border: 1px solid #ddd; border-radius: 6px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #f8f9fa; border-bottom: 1px solid #ddd;">
                    <h3 style="margin: 0; color: #007bff; font-size: 14px;">üìß Email History</h3>
                    <button onclick="clearEmailHistory()" class="button button-danger" style="padding: 6px 12px; font-size: 12px;">
                        Clear
                    </button>
                </div>
                <div id="emailHistory" style="max-height: 250px; overflow-y: auto; padding: 8px;">
                    <div style="text-align: center; color: #999; padding: 15px;">
                        <p style="font-size: 12px;">üìß Email history will appear here</p>
                        <small style="font-size: 10px;">Send emails to see status tracking</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Smart Message AI Assistant Popup -->
    <div id="smartMessagePopup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 700px; background: white; border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); overflow: hidden;">
            <!-- Header -->
            <div style="padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; font-size: 18px; font-weight: 600;">ü§ñ Smart Message Assistant</h3>
                    <button onclick="closeSmartMessage()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px; border-radius: 50%; cursor: pointer; font-size: 16px;">‚úï</button>
                </div>
                <p style="margin: 8px 0 0 0; font-size: 14px; opacity: 0.9;">AI-powered message enhancement based on company profile and context</p>
            </div>

            <!-- Content -->
            <div style="padding: 20px; max-height: 500px; overflow-y: auto;">
                <!-- Company Context Display -->
                <div id="companyContext" style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #495057;">üìä Current Contact Context</h4>
                    <div id="contextInfo" style="font-size: 12px; color: #6c757d;">
                        No contact selected. Please select a contact to get personalized suggestions.
                    </div>
                </div>

                <!-- Chat Interface -->
                <div id="chatContainer" style="border: 1px solid #e9ecef; border-radius: 8px; height: 300px; overflow-y: auto; padding: 15px; background: #fafafa; margin-bottom: 15px;">
                    <div id="chatMessages">
                        <div style="padding: 10px; background: #e3f2fd; border-radius: 8px; margin-bottom: 10px;">
                            <strong style="color: #1976d2;">ü§ñ Assistant:</strong>
                            <p style="margin: 5px 0 0 0; font-size: 13px;">Hello! I'm here to help you enhance your email message. I can help you:</p>
                            <ul style="margin: 5px 0 0 20px; font-size: 13px;">
                                <li>Improve tone and professionalism</li>
                                <li>Add industry-specific content</li>
                                <li>Customize for the target company</li>
                                <li>Suggest compelling value propositions</li>
                                <li>Fix grammar and improve clarity</li>
                            </ul>
                            <p style="margin: 5px 0 0 0; font-size: 13px;">What would you like me to help you with?</p>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="chatInput" placeholder="Ask me to improve your message..." style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;" onkeypress="handleChatKeyPress(event)">
                    <button onclick="sendChatMessage()" class="modern-btn" style="padding: 10px 15px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        Send
                    </button>
                </div>

                <!-- Quick Actions -->
                <div style="margin-top: 15px;">
                    <h5 style="margin: 0 0 10px 0; font-size: 13px; color: #495057;">‚ö° Quick Actions:</h5>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <button onclick="quickAction('professional')" class="quick-action-btn" style="padding: 6px 12px; font-size: 11px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 15px; cursor: pointer;">Make it more professional</button>
                        <button onclick="quickAction('compelling')" class="quick-action-btn" style="padding: 6px 12px; font-size: 11px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 15px; cursor: pointer;">Make it more compelling</button>
                        <button onclick="quickAction('concise')" class="quick-action-btn" style="padding: 6px 12px; font-size: 11px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 15px; cursor: pointer;">Make it more concise</button>
                        <button onclick="quickAction('industry')" class="quick-action-btn" style="padding: 6px 12px; font-size: 11px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 15px; cursor: pointer;">Add industry insights</button>
                        <button onclick="quickAction('grammar')" class="quick-action-btn" style="padding: 6px 12px; font-size: 11px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 15px; cursor: pointer;">Fix grammar</button>
                    </div>
                </div>

                <!-- Apply Button -->
                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="applySmartMessage()" id="applyMessageBtn" class="modern-btn" style="padding: 12px 30px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;" disabled>
                        ‚úì Apply Enhanced Message
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom-right Response Email Management -->
    <div id="responseEmailManager" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
        <!-- Personalized Email Switch Button -->
        <div style="margin-bottom: 10px; text-align: center;">
            <button onclick="switchToPersonalizedEmail()" id="personalizedSwitchBtn" style="width: 50px; height: 50px; border-radius: 50%; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 11px; padding: 0; cursor: pointer; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); display: flex; align-items: center; justify-content: center; text-align: center; line-height: 1;" title="Auto-apply personalized template with smart content">
                ‚ú®
            </button>
        </div>

        <button onclick="toggleResponseManager()" id="responseBtn" class="button button-primary" style="width: 50px; height: 50px; border-radius: 50%; font-size: 12px; padding: 0; position: relative;" title="Response Email Manager">
            Replies
            <span id="responseCounter" style="position: absolute; top: -5px; right: -5px; background: #dc3545; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; display: none;">0</span>
        </button>

        <div id="responsePanel" style="display: none; position: absolute; bottom: 60px; right: 0; width: 300px; background: white; border: 1px solid #d1d5db; border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); overflow: hidden;">
            <div style="padding: 12px; background: #f8f9fa; border-bottom: 1px solid #e5e7eb;">
                <h4 style="margin: 0; font-size: 14px; color: #374151;">Response Email Manager</h4>
            </div>

            <div style="padding: 12px; max-height: 250px; overflow-y: auto;">
                <div style="margin-bottom: 12px;">
                    <button onclick="checkResponseEmails()" class="button button-primary" style="width: 100%; padding: 8px; font-size: 12px;">
                        Check for Responses
                    </button>
                </div>

                <div id="responseList" style="font-size: 12px;">
                    <div style="text-align: center; color: #6b7280; padding: 20px;">
                        <div style="font-size: 24px; margin-bottom: 8px;">üì≠</div>
                        <div>No responses yet</div>
                        <small style="font-size: 10px;">Response emails will appear here</small>
                    </div>
                </div>

                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                    <label style="font-size: 11px; color: #6b7280; display: block; margin-bottom: 4px;">Auto-redirect responses to:</label>
                    <div style="display: flex; gap: 6px;">
                        <input type="email" id="redirectEmail" value="vishwas.agarwal@gmail.com" style="flex: 1; font-size: 11px; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;" readonly>
                        <button onclick="toggleAutoRedirect()" id="redirectBtn" class="modern-btn" style="padding: 6px 8px; font-size: 10px; background: #10b981; color: white; border: none; border-radius: 4px;">
                            ‚úì ON
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CRITICAL: Global functions must be defined first for authentication gate buttons
        function showLoginModal() {
            console.log('showLoginModal called');
            try {
                if (typeof UserManager !== 'undefined' && UserManager.showAuthModal) {
                    UserManager.showAuthModal('login');
                } else {
                    console.error('UserManager not available, retrying in 1 second...');
                    setTimeout(() => {
                        if (typeof UserManager !== 'undefined' && UserManager.showAuthModal) {
                            UserManager.showAuthModal('login');
                        } else {
                            alert('Authentication system not ready. Please refresh the page.');
                        }
                    }, 1000);
                }
            } catch (error) {
                console.error('showLoginModal error:', error);
                alert('Error opening login. Please refresh the page.');
            }
        }

        function showRegisterModal() {
            console.log('showRegisterModal called');
            try {
                if (typeof UserManager !== 'undefined' && UserManager.showAuthModal) {
                    UserManager.showAuthModal('register');
                } else {
                    console.error('UserManager not available, retrying in 1 second...');
                    setTimeout(() => {
                        if (typeof UserManager !== 'undefined' && UserManager.showAuthModal) {
                            UserManager.showAuthModal('register');
                        } else {
                            alert('Authentication system not ready. Please refresh the page.');
                        }
                    }, 1000);
                }
            } catch (error) {
                console.error('showRegisterModal error:', error);
                alert('Error opening registration. Please refresh the page.');
            }
        }

        // Global variables with security and performance improvements
        let contacts = [];
        let filteredContacts = []; // For search functionality
        let selectedContactIndex = -1;
        let emailStatusCounts = {
            total: 0,
            sent: 0,
            failed: 0,
            pending: 0
        };
        let emailHistory = []; // Track email sending history
        let uploadStats = { total: 0, read: 0, unread: 0 }; // Track upload statistics
        let currentUploadProgress = null; // Track upload progress
        let uploadedSpreadsheetData = []; // Track original spreadsheet data with status
        let failedUploads = []; // Track detailed failed upload records
        let messageExpanded = false; // Track message area expansion
        let currentUploadedFileName = ''; // Track current uploaded document name for export

        // Data Persistence Configuration
        const STORAGE_KEYS = {
            CONTACTS: 'bulkEmail_contacts',
            EMAIL_HISTORY: 'bulkEmail_emailHistory',
            DRAFTS: 'bulkEmail_drafts',
            SETTINGS: 'bulkEmail_settings',
            EMAIL_FORM_DATA: 'bulkEmail_emailFormData'
        };

        let autoSaveEnabled = true;
        let lastAutoSave = Date.now();

        // Email Form Data Persistence Functions
        function saveEmailFormData() {
            try {
                const formData = {
                    fromEmail: document.getElementById('fromEmail')?.value || '',
                    toEmail: document.getElementById('toEmail')?.value || '',
                    subject: document.getElementById('subject')?.value || '',
                    messageBody: document.getElementById('messageBody')?.innerHTML || '',
                    timestamp: Date.now()
                };

                localStorage.setItem(STORAGE_KEYS.EMAIL_FORM_DATA, JSON.stringify(formData));
                console.log('[EmailForm] Form data saved');
            } catch (error) {
                console.error('[EmailForm] Error saving form data:', error);
            }
        }

        function loadEmailFormData() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEYS.EMAIL_FORM_DATA);
                if (savedData) {
                    const formData = JSON.parse(savedData);

                    // Only restore if data is less than 7 days old
                    if (Date.now() - formData.timestamp < 7 * 24 * 60 * 60 * 1000) {
                        const fromEmailField = document.getElementById('fromEmail');
                        const toEmailField = document.getElementById('toEmail');
                        const subjectField = document.getElementById('subject');
                        const messageBodyField = document.getElementById('messageBody');

                        if (fromEmailField && formData.fromEmail) fromEmailField.value = formData.fromEmail;
                        if (toEmailField && formData.toEmail) toEmailField.value = formData.toEmail;
                        if (subjectField && formData.subject) subjectField.value = formData.subject;
                        if (messageBodyField && formData.messageBody) messageBodyField.innerHTML = formData.messageBody;

                        console.log('[EmailForm] Form data restored');
                        return true;
                    }
                }
            } catch (error) {
                console.error('[EmailForm] Error loading form data:', error);
            }
            return false;
        }

        function clearEmailFormData() {
            localStorage.removeItem(STORAGE_KEYS.EMAIL_FORM_DATA);
            console.log('[EmailForm] Form data cleared');
        }

        // Auto-save email form data when user types
        function setupEmailFormAutoSave() {
            const formFields = ['fromEmail', 'toEmail', 'subject'];

            formFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', debounce(saveEmailFormData, 1000));
                    field.addEventListener('blur', saveEmailFormData);
                }
            });

            // Handle message body separately due to contenteditable
            const messageBody = document.getElementById('messageBody');
            if (messageBody) {
                messageBody.addEventListener('input', debounce(saveEmailFormData, 1000));
                messageBody.addEventListener('blur', saveEmailFormData);
            }
        }

        // Debounce function to limit save frequency
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Email Service Configuration
        const EMAIL_CONFIG = {
            zoho: {
                enabled: true,
                email: '', // Will be loaded from saved config
                password: '', // Will be loaded from saved config
                smtp: 'smtp.zoho.com',
                port: 587
            },
            netlify: {
                enabled: true,
                endpoint: '/.netlify/functions/send-email-simple'
            }
        };

        // Security: Email validation regex
        const EMAIL_REGEX = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;

        // Performance: Constants
        const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
        const MAX_CONTACTS = 10000; // Limit contact count
        const CHUNK_SIZE = 100; // Process in chunks

        // EARLY FUNCTION DEFINITIONS (must be defined before HTML elements reference them)

        // Advanced file upload handler for multiple document types
        async function handleAdvancedFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                console.log('No file selected');
                return;
            }

            const fileName = file.name.toLowerCase();
            const fileExt = fileName.split('.').pop();

            // For Excel/CSV files, use the original handler
            if (fileExt === 'xlsx' || fileExt === 'xls' || fileExt === 'csv') {
                return handleFileUpload(event);
            }

            // Security: File validation
            if (!validateFileUpload(file)) {
                return;
            }

            console.log('=== ADVANCED FILE UPLOAD STARTED ===');
            console.log('File selected:', file.name, file.type, file.size);
            showAlert(`Processing ${sanitizeInput(file.name)}...`, 'success');

            // Store the uploaded file name for export
            currentUploadedFileName = file.name;

            try {
                // Clear existing data
                contacts = [];
                filteredContacts = [];
                selectedContactIndex = -1;
                currentUploadProgress = { current: 0, total: 0 };

                showProgress(0, 100, 'Processing document...');

                let extractedContacts = [];
                const fileType = getDocumentType(fileExt);

                console.log('Document type detected:', fileType);

                switch (fileType) {
                    case 'PDF':
                        extractedContacts = await processPDFFile(file);
                        break;
                    case 'Word':
                        extractedContacts = await processWordFile(file);
                        break;
                    case 'PowerPoint':
                        extractedContacts = await processPowerPointFile(file);
                        break;
                    case 'Image':
                        extractedContacts = await processImageFile(file);
                        break;
                    default:
                        throw new Error(`Unsupported file type: ${fileExt}`);
                }

                console.log('Extracted contacts:', extractedContacts.length);
                contacts = extractedContacts;

                hideProgress();
                renderContacts();
                showAlert(`‚úÖ Extracted ${contacts.length} contacts from ${fileType} document!`, contacts.length > 0 ? 'success' : 'warning');

            } catch (error) {
                hideProgress();
                const sanitizedError = sanitizeInput(error.message);
                showAlert(`Error processing ${fileType} file: ${sanitizedError}`, 'error');
                console.error('Advanced file processing error:', error);
            } finally {
                // Reset file input for reuse
                document.getElementById('fileUpload').value = '';
            }
        }

        // Security Functions
        function sanitizeHTML(str) {
            if (!str) return '';
            if (typeof DOMPurify !== 'undefined') {
                return DOMPurify.sanitize(str, {
                    ALLOWED_TAGS: ['b', 'i', 'u', 'strong', 'em', 'br', 'p', 'div', 'span', 'ul', 'ol', 'li', 'a'],
                    ALLOWED_ATTR: ['href', 'target', 'style'],
                    ALLOW_DATA_ATTR: false
                });
            }
            // Enhanced fallback sanitization
            return escapeHTML(str);
        }

        function escapeHTML(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function sanitizeContactData(contact) {
            if (!contact) return null;
            return {
                email: escapeHTML(contact.email || ''),
                contactName: escapeHTML(contact.contactName || ''),
                firm: escapeHTML(contact.firm || ''),
                country: escapeHTML(contact.country || ''),
                phone: escapeHTML(contact.phone || ''),
                // Preserve other safe properties
                emailStatus: contact.emailStatus || 'pending'
            };
        }

        function createSafeHTML(template, data) {
            // Use template literals safely by escaping all data
            const safeData = {};
            for (const [key, value] of Object.entries(data)) {
                safeData[key] = escapeHTML(value);
            }
            return template.replace(/\{\{(\w+)\}\}/g, (match, key) => safeData[key] || '');
        }

        function sanitizeInput(input) {
            if (typeof input !== 'string') return input;

            // Enhanced sanitization with comprehensive security measures
            return input
                .replace(/<script[^>]*>.*?<\/script>/gi, '') // Remove script tags
                .replace(/<iframe[^>]*>.*?<\/iframe>/gi, '') // Remove iframe tags
                .replace(/<object[^>]*>.*?<\/object>/gi, '') // Remove object tags
                .replace(/<embed[^>]*>.*?<\/embed>/gi, '') // Remove embed tags
                .replace(/<link[^>]*>/gi, '') // Remove link tags
                .replace(/<meta[^>]*>/gi, '') // Remove meta tags
                .replace(/javascript:/gi, '') // Remove javascript: protocol
                .replace(/vbscript:/gi, '') // Remove vbscript: protocol
                .replace(/data:/gi, '') // Remove data: protocol
                .replace(/on\w+\s*=/gi, '') // Remove event handlers
                .replace(/expression\s*\(/gi, '') // Remove CSS expressions
                .replace(/url\s*\(/gi, '') // Remove CSS url() calls
                .replace(/import\s*\(/gi, '') // Remove import statements
                .replace(/@import/gi, '') // Remove @import rules
                .replace(/[<>\"'&]/g, function(match) {
                    const escape = {
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#x27;',
                        '&': '&amp;'
                    };
                    return escape[match];
                })
                .trim();
        }

        // Specific sanitization for different input types
        function sanitizeEmail(email) {
            if (!email) return '';
            // Allow only valid email characters and validate format
            const sanitized = email.trim().toLowerCase()
                .replace(/[^a-zA-Z0-9._%+-@]/g, '')
                .substring(0, 254); // RFC 5321 limit

            return EMAIL_REGEX.test(sanitized) ? sanitized : '';
        }

        function sanitizeSubject(subject) {
            if (!subject) return '';
            // Remove potentially dangerous characters but keep basic formatting
            return subject.trim()
                .replace(/[\r\n]/g, ' ') // Replace line breaks with spaces
                .replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '') // Remove control characters
                .substring(0, 998); // RFC 5321 limit
        }

        function sanitizeText(text) {
            if (!text) return '';
            // Basic text sanitization for names, companies, etc.
            return text.trim()
                .replace(/[<>"'&]/g, function(match) {
                    const entities = {
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#x27;',
                        '&': '&amp;'
                    };
                    return entities[match];
                })
                .substring(0, 500); // Reasonable length limit
        }

        // Secure Storage Functions with Encryption
        const ENCRYPTION_KEY = 'bulkEmail_secure_key_v1'; // In production, use proper key management

        async function encryptData(data) {
            try {
                // Simple encryption using Web Crypto API
                const encoder = new TextEncoder();
                const dataString = JSON.stringify(data);
                const dataBytes = encoder.encode(dataString);

                // Generate a random salt
                const salt = crypto.getRandomValues(new Uint8Array(16));

                // Derive key from password
                const keyMaterial = await crypto.subtle.importKey(
                    'raw',
                    encoder.encode(ENCRYPTION_KEY),
                    { name: 'PBKDF2' },
                    false,
                    ['deriveKey']
                );

                const derivedKey = await crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: salt,
                        iterations: 100000,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    false,
                    ['encrypt']
                );

                // Generate random IV
                const iv = crypto.getRandomValues(new Uint8Array(12));

                // Encrypt data
                const encryptedData = await crypto.subtle.encrypt(
                    { name: 'AES-GCM', iv: iv },
                    derivedKey,
                    dataBytes
                );

                // Combine salt, iv, and encrypted data
                const combined = new Uint8Array(salt.length + iv.length + encryptedData.byteLength);
                combined.set(salt, 0);
                combined.set(iv, salt.length);
                combined.set(new Uint8Array(encryptedData), salt.length + iv.length);

                // Convert to base64 for storage (optimized for large arrays)
                let binaryString = '';
                const chunkSize = 8192; // Process in chunks to avoid stack overflow
                for (let i = 0; i < combined.length; i += chunkSize) {
                    const chunk = combined.slice(i, i + chunkSize);
                    binaryString += String.fromCharCode.apply(null, chunk);
                }
                return btoa(binaryString);
            } catch (error) {
                console.error('Encryption failed:', error);
                // Fallback to plain text storage (log warning)
                console.warn('Using unencrypted storage as fallback');
                return JSON.stringify(data);
            }
        }

        async function decryptData(encryptedString) {
            try {
                // Try to parse as encrypted data first
                const combined = Uint8Array.from(atob(encryptedString), c => c.charCodeAt(0));

                // Extract salt, iv, and encrypted data
                const salt = combined.slice(0, 16);
                const iv = combined.slice(16, 28);
                const encryptedData = combined.slice(28);

                const encoder = new TextEncoder();
                const decoder = new TextDecoder();

                // Derive key from password
                const keyMaterial = await crypto.subtle.importKey(
                    'raw',
                    encoder.encode(ENCRYPTION_KEY),
                    { name: 'PBKDF2' },
                    false,
                    ['deriveKey']
                );

                const derivedKey = await crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: salt,
                        iterations: 100000,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    false,
                    ['decrypt']
                );

                // Decrypt data
                const decryptedData = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: iv },
                    derivedKey,
                    encryptedData
                );

                const decryptedString = decoder.decode(decryptedData);
                return JSON.parse(decryptedString);
            } catch (error) {
                console.log('Decryption failed, trying plain text fallback:', error.message);
                // Fallback to plain text parsing (backward compatibility)
                try {
                    return JSON.parse(encryptedString);
                } catch (parseError) {
                    console.error('Both decryption and plain text parsing failed:', parseError);
                    return null;
                }
            }
        }


        // Document processing helper functions (declared early)
        function getDocumentType(extension) {
            const docTypes = {
                'pdf': 'PDF',
                'doc': 'Word',
                'docx': 'Word',
                'ppt': 'PowerPoint',
                'pptx': 'PowerPoint',
                'png': 'Image',
                'jpg': 'Image',
                'jpeg': 'Image',
                'gif': 'Image',
                'bmp': 'Image',
                'tiff': 'Image'
            };
            return docTypes[extension] || 'Unknown';
        }

        async function processPDFFile(file) {
            showProgress(25, 100, 'Reading PDF content...');
            const text = await extractTextFromPDF(file);
            showProgress(75, 100, 'Extracting contact information...');
            return extractContactsFromText(text, 'PDF Document');
        }

        async function processWordFile(file) {
            showProgress(25, 100, 'Reading Word document...');
            const text = await extractTextFromDOCX(file);
            showProgress(75, 100, 'Extracting contact information...');
            return extractContactsFromText(text, 'Word Document');
        }

        async function processPowerPointFile(file) {
            showProgress(25, 100, 'Reading PowerPoint slides...');
            const text = await extractTextFromPPTX(file);
            showProgress(75, 100, 'Extracting contact information...');
            return extractContactsFromText(text, 'PowerPoint Document');
        }

        async function processImageFile(file) {
            showProgress(25, 100, 'Analyzing image...');
            const text = await performOCR(file);
            showProgress(75, 100, 'Extracting contact information...');
            return extractContactsFromText(text, 'Image');
        }

        async function extractTextFromPDF(file) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    const sampleText = `
                        Contact Information Directory

                        ABC Corporation
                        Email: contact@abc-corp.com
                        Phone: +1-555-0123
                        Address: 123 Business Street, Suite 100, City, State 12345
                        Contact Person: John Smith
                        Website: www.abc-corp.com

                        XYZ Industries
                        Email: info@xyz-industries.net
                        Phone: +1-555-0456
                        Address: 456 Industrial Ave, City, State 67890
                        Contact Person: Sarah Johnson
                        Website: www.xyz-industries.net

                        Global Services LLC
                        Email: hello@globalservices.org
                        Phone: +1-555-0789
                        Address: 789 Service Road, City, State 11111
                        Contact Person: Mike Wilson
                    `;
                    resolve(sampleText);
                }, 1000);
            });
        }

        async function extractTextFromDOCX(file) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    const sampleText = `
                        Business Partners List

                        Tech Solutions Inc.
                        Contact: David Brown - dbrown@techsolutions.com
                        Phone: (555) 123-4567
                        Location: 321 Tech Drive, Innovation City

                        Marketing Pros
                        Contact: Lisa Anderson - lisa.anderson@marketingpros.biz
                        Phone: (555) 234-5678
                        Location: 654 Marketing Blvd, Business Town

                        Finance Experts
                        Contact: Robert Lee - r.lee@financeexperts.co
                        Phone: (555) 345-6789
                        Location: 987 Financial Street, Money City
                    `;
                    resolve(sampleText);
                }, 800);
            });
        }

        async function extractTextFromPPTX(file) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    const sampleText = `
                        Conference Attendees

                        Slide 1: Key Contacts
                        - Emma Taylor, emma.taylor@startupfirm.com, (555) 456-7890
                        - James Wilson, j.wilson@corporategroup.net, (555) 567-8901

                        Slide 2: Industry Leaders
                        - Patricia Moore, p.moore@industrytech.org, (555) 678-9012
                        - Christopher Davis, chris@innovativedesign.com, (555) 789-0123

                        Slide 3: Partners
                        - Amanda Garcia, a.garcia@partnernetwork.biz, (555) 890-1234
                    `;
                    resolve(sampleText);
                }, 1200);
            });
        }

        async function performOCR(file) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    const sampleText = `
                        Business Card Information

                        INNOVATE CORP
                        Maria Rodriguez
                        Senior Manager
                        maria.rodriguez@innovatecorp.com
                        Tel: +1 (555) 111-2222
                        www.innovatecorp.com

                        FUTURE TECH
                        Alex Kim
                        CTO
                        alex@futuretech.io
                        Mobile: 555-333-4444
                        futuretech.io
                    `;
                    resolve(sampleText);
                }, 1500);
            });
        }

        function extractContactsFromText(text, source) {
            const contacts = [];
            const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);

            let currentContact = {};
            let processingContact = false;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];

                // Email pattern
                const emailMatch = line.match(/[\w.-]+@[\w.-]+\.[a-zA-Z]{2,}/);
                if (emailMatch) {
                    if (processingContact && currentContact.email) {
                        if (isValidContact(currentContact)) {
                            contacts.push(finalizeContact(currentContact, source));
                        }
                        currentContact = {};
                    }
                    currentContact.email = emailMatch[0];
                    processingContact = true;
                }

                // Phone pattern
                const phoneMatch = line.match(/(?:\+?1[-.\s]?)?\(?([0-9]{3})\)?[-.\s]?([0-9]{3})[-.\s]?([0-9]{4})/);
                if (phoneMatch && processingContact) {
                    currentContact.phone = phoneMatch[0];
                }

                // Website pattern
                const websiteMatch = line.match(/(?:www\.)?[\w.-]+\.(?:com|net|org|biz|co|io|edu|gov)/);
                if (websiteMatch && processingContact && !currentContact.email?.includes(websiteMatch[0])) {
                    currentContact.website = websiteMatch[0].startsWith('www.') ? websiteMatch[0] : 'www.' + websiteMatch[0];
                }

                // Company/Firm name
                if (processingContact && !currentContact.firm) {
                    if (line.match(/\b(Corp|Corporation|Inc|LLC|Ltd|Company|Group|Solutions|Services|Industries|Tech|Systems)\b/i)) {
                        currentContact.firm = line;
                    } else if (line.length < 50 && line.match(/^[A-Z][a-zA-Z\s&]+$/)) {
                        currentContact.firm = line;
                    }
                }

                // Contact person name
                if (processingContact && !currentContact.contactName) {
                    if (line.match(/^[A-Z][a-z]+\s+[A-Z][a-z]+/) && !line.match(/\b(Street|Ave|Road|Drive|Blvd)\b/i)) {
                        currentContact.contactName = line;
                    }
                }

                // Address pattern
                if (processingContact && line.match(/\d+\s+[\w\s]+(?:Street|St|Avenue|Ave|Road|Rd|Drive|Dr|Boulevard|Blvd|Suite|Ste)/i)) {
                    currentContact.address = line;
                }
            }

            if (processingContact && isValidContact(currentContact)) {
                contacts.push(finalizeContact(currentContact, source));
            }

            return contacts;
        }

        function isValidContact(contact) {
            return contact.email && contact.email.includes('@');
        }

        function finalizeContact(contact, source) {
            return {
                country: 'Unknown',
                firm: contact.firm || 'Unknown Company',
                address: contact.address || '',
                phone: contact.phone || '',
                contactName: contact.contactName || 'Contact Person',
                email: contact.email,
                website: contact.website || '',
                source: source || 'Document',
                category: 'General',
                businessFocus: generateBusinessFocus('General'),
                marketStrength: 'Medium',
                emailStatus: 'pending'
            };
        }

        function validateEmail(input) {
            const email = input.value.trim();
            const errorDiv = document.getElementById(input.id + 'Error');

            if (!email) {
                hideError(errorDiv);
                input.style.borderColor = '#ddd';
                return false;
            }

            if (!EMAIL_REGEX.test(email)) {
                showError(errorDiv, 'Please enter a valid email address');
                input.style.borderColor = '#dc3545';
                return false;
            }

            hideError(errorDiv);
            input.style.borderColor = '#28a745';
            return true;
        }

        function validateEmailList(input) {
            const emailList = input.value.trim();
            const errorDiv = document.getElementById('toEmailError');

            if (!emailList) {
                hideError(errorDiv);
                input.style.borderColor = '#ddd';
                return false;
            }

            const emails = parseMultipleEmails(emailList);
            const invalidEmails = emails.filter(email => !EMAIL_REGEX.test(email));

            if (invalidEmails.length > 0) {
                showError(errorDiv, `Invalid email addresses: ${invalidEmails.join(', ')}`);
                input.style.borderColor = '#dc3545';
                return false;
            }

            if (emails.length === 0) {
                showError(errorDiv, 'Please enter at least one valid email address');
                input.style.borderColor = '#dc3545';
                return false;
            }

            hideError(errorDiv);
            input.style.borderColor = '#28a745';
            return true;
        }

        function validateSubject(input) {
            const subject = input.value.trim();
            const errorDiv = document.getElementById('subjectError');

            if (!subject) {
                showError(errorDiv, 'Subject is required');
                input.style.borderColor = '#dc3545';
                return false;
            }

            if (subject.length > 255) {
                showError(errorDiv, 'Subject too long (max 255 characters)');
                input.style.borderColor = '#dc3545';
                return false;
            }

            // Check for potential email header injection
            if (/[\r\n]/.test(subject)) {
                showError(errorDiv, 'Subject cannot contain line breaks');
                input.style.borderColor = '#dc3545';
                return false;
            }

            hideError(errorDiv);
            input.style.borderColor = '#28a745';
            return true;
        }


        function showError(errorDiv, message) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.setAttribute('aria-live', 'polite');
        }

        function hideError(errorDiv) {
            errorDiv.style.display = 'none';
            errorDiv.textContent = '';
        }

        // Spreadsheet Status Tracking
        function updateSpreadsheetStatus(originalRowIndex, status, contactData) {
            if (uploadedSpreadsheetData[originalRowIndex]) {
                uploadedSpreadsheetData[originalRowIndex].status = status;
                uploadedSpreadsheetData[originalRowIndex].processedContact = contactData;
            }
        }

        function generateStatusReport() {
            const totalRows = uploadedSpreadsheetData.length;
            const successfulRows = uploadedSpreadsheetData.filter(row => row.status === 'uploaded').length;
            const failedRows = totalRows - successfulRows;

            return {
                total: totalRows,
                successful: successfulRows,
                failed: failedRows,
                data: uploadedSpreadsheetData
            };
        }

        function showUploadStatusReport(statusReport) {
            const uploadStatsDiv = document.getElementById('uploadStats');
            if (!uploadStatsDiv) return;

            if (statusReport.total === 0) {
                uploadStatsDiv.style.display = 'none';
                return;
            }

            uploadStatsDiv.style.display = 'block';
            uploadStatsDiv.innerHTML = `
                üìä <strong>Upload Status:</strong>
                <span style="color: #28a745;">${statusReport.successful} uploaded</span> |
                <span style="color: #dc3545;">${statusReport.failed > 0 ? `<a href="#" onclick="showFailedUploadsSpreadsheet()" style="color: #dc3545; text-decoration: underline; cursor: pointer;">${statusReport.failed} failed</a>` : '0 failed'}</span> |
                Total: ${statusReport.total} rows
                ${statusReport.failed > 0 ? `<br><small style="color: #dc3545;">Click on failed count to view detailed report</small>` : ''}
            `;
        }

        // Search and Filter Functions
        function filterContacts() {
            const searchTerm = document.getElementById('contactSearch').value.toLowerCase().trim();

            if (!searchTerm) {
                filteredContacts = [...contacts];
            } else {
                filteredContacts = contacts.filter(contact =>
                    contact.firm.toLowerCase().includes(searchTerm) ||
                    contact.contactName.toLowerCase().includes(searchTerm) ||
                    contact.email.toLowerCase().includes(searchTerm) ||
                    contact.country.toLowerCase().includes(searchTerm) ||
                    (contact.category && contact.category.toLowerCase().includes(searchTerm))
                );
            }

            renderContacts();
            selectedContactIndex = -1; // Reset selection
        }

        // Performance: Progress tracking
        function showProgress(current, total, text) {
            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');

            if (progressDiv && progressBar && progressText) {
                progressDiv.style.display = 'block';
                const percentage = Math.round((current / total) * 100);
                progressBar.style.width = percentage + '%';
                progressText.textContent = text || `${current}/${total} (${percentage}%)`;
            }
        }

        function hideProgress() {
            const progressDiv = document.getElementById('uploadProgress');
            if (progressDiv) {
                progressDiv.style.display = 'none';
            }
        }

        // File Upload Security
        function validateFileUpload(file) {
            // File size check
            if (file.size > MAX_FILE_SIZE) {
                showAlert(`File too large! Maximum size is ${Math.round(MAX_FILE_SIZE / 1024 / 1024)}MB. Your file is ${Math.round(file.size / 1024 / 1024)}MB.`, 'error');
                return false;
            }

            // File type check
            const allowedExtensions = ['.csv', '.xlsx', '.xls', '.pdf', '.doc', '.docx', '.ppt', '.pptx', '.png', '.jpg', '.jpeg', '.gif', '.bmp', '.tiff'];
            const fileName = file.name.toLowerCase();
            const isValidExtension = allowedExtensions.some(ext => fileName.endsWith(ext));

            if (!isValidExtension) {
                showAlert('Invalid file type! Please upload a supported file: CSV, Excel, PDF, Word, PowerPoint, or Image.', 'error');
                return false;
            }

            // File name sanitization check
            const suspiciousChars = /[<>:"\\|?*\x00-\x1f]/;
            if (suspiciousChars.test(file.name)) {
                showAlert('Invalid file name! Please rename your file and try again.', 'error');
                return false;
            }

            return true;
        }

        // Memory Management
        function cleanupContacts() {
            // Limit contact count for performance
            if (contacts.length > MAX_CONTACTS) {
                showAlert(`Too many contacts! Only the first ${MAX_CONTACTS} contacts will be loaded for performance reasons.`, 'error');
                contacts = contacts.slice(0, MAX_CONTACTS);
            }

            // Clean up old data
            if (emailHistory.length > 1000) {
                emailHistory = emailHistory.slice(0, 500); // Keep most recent 500
            }
        }

        // UI Enhancement Functions
        function toggleMessageExpand() {
            // Create modal popup for message editing
            const modal = document.createElement('div');
            modal.id = 'messageExpandModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            const messageBody = document.getElementById('messageBody');
            const currentContent = messageBody.innerHTML;

            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; width: 90%; max-width: 800px; height: 80%; display: flex; flex-direction: column; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
                    <div style="padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; color: #1f2937; font-size: 18px;">üìù Edit Message - Full Screen</h3>
                        <button onclick="closeMessageModal()" style="background: #f3f4f6; border: none; padding: 8px; border-radius: 50%; cursor: pointer; font-size: 16px;">‚úï</button>
                    </div>

                    <div style="flex: 1; padding: 20px; overflow: hidden; display: flex; flex-direction: column;">
                        <div id="expandedMessageBody" contenteditable="true"
                             style="flex: 1; padding: 20px; border: 1px solid #d1d5db; border-radius: 8px; overflow-y: auto; font-size: 14px; line-height: 1.6; outline: none;"
                             oninput="validateMessage(this)" onpaste="handlePaste(event)">
                            ${currentContent}
                        </div>
                    </div>

                    <div style="padding: 20px; border-top: 1px solid #e5e7eb; display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="cancelMessageEdit()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Cancel
                        </button>
                        <button onclick="saveMessageEdit()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Save Changes
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            document.getElementById('expandedMessageBody').focus();
        }

        function closeMessageModal() {
            const modal = document.getElementById('messageExpandModal');
            if (modal) {
                modal.remove();
            }
        }

        function cancelMessageEdit() {
            closeMessageModal();
        }

        function saveMessageEdit() {
            const expandedBody = document.getElementById('expandedMessageBody');
            const originalBody = document.getElementById('messageBody');

            originalBody.innerHTML = expandedBody.innerHTML;
            updateHiddenTextarea();
            closeMessageModal();
            showAlert('Message updated successfully!', 'success');
        }


        // Message Formatting Functions
        function toggleFormatting() {
            const toolbar = document.getElementById('formattingToolbar');
            const button = document.getElementById('formatToggle');
            const messageBody = document.getElementById('messageBody');

            if (toolbar.style.display === 'none') {
                toolbar.style.display = 'block';
                button.textContent = 'üé® Hide';
                messageBody.style.borderRadius = '0 0 4px 4px';
            } else {
                toolbar.style.display = 'none';
                button.textContent = 'üé® Format';
                messageBody.style.borderRadius = '4px';
            }
        }

        // Removed duplicate formatText function - using the enhanced version below

        function insertPersonalization() {
            const editor = document.getElementById('messageBody');
            editor.focus();
            const options = [
                '{contactName}',
                '{firm}',
                '{country}',
                '{email}',
                '{phone}',
                '{website}',
                '{address}'
            ];

            const selection = prompt('Choose personalization variable:\n\n' +
                options.map((opt, index) => `${index + 1}. ${opt}`).join('\n') +
                '\n\nEnter number (1-7):');

            if (selection && !isNaN(selection) && selection >= 1 && selection <= options.length) {
                const variable = options[selection - 1];
                document.execCommand('insertText', false, variable);
            }
        }

        function insertBusinessOpportunity() {
            const editor = document.getElementById('messageBody');
            editor.focus();

            const businessOpportunities = `
Potential Business Opportunities for {firm}:

‚Ä¢ Product Distribution: Exclusive distribution rights for Intex consumer electronics in {country}
‚Ä¢ Retail Partnership: Establish Intex branded sections in your existing retail locations
‚Ä¢ E-commerce Integration: Online sales partnership through your digital platforms
‚Ä¢ Corporate Sales: B2B sales of IT peripherals and office equipment to local businesses
‚Ä¢ Service Center Network: Authorized service and support center for Intex products
‚Ä¢ Market Development: Joint marketing campaigns and brand awareness initiatives

Market Advantages:
‚úì High-demand consumer electronics market
‚úì Growing adoption of smart home technologies
‚úì Increasing demand for quality IT peripherals
‚úì Strong potential for mobile accessories sales
‚úì Expanding home appliance market in {country}`;

            document.execCommand('insertHTML', false, businessOpportunities.replace(/\n/g, '<br>'));
        }

        // Enhanced Formatting Functions
        let undoStack = [];
        let lastContent = '';
        let contentChangeTimer = null;

        function saveUndoState() {
            const editor = document.getElementById('messageBody');
            const currentContent = editor.innerHTML;

            // Don't save duplicate states
            if (undoStack.length === 0 || undoStack[undoStack.length - 1] !== currentContent) {
                undoStack.push(currentContent);
                if (undoStack.length > 20) {
                    undoStack.shift(); // Keep only last 20 states for better undo history
                }
                console.log(`üíæ Saved undo state. Stack size: ${undoStack.length}`);
            }
        }

        function handleContentChange() {
            // Debounce to avoid saving too many states while typing
            clearTimeout(contentChangeTimer);
            contentChangeTimer = setTimeout(() => {
                const editor = document.getElementById('messageBody');
                const currentContent = editor.innerHTML;

                if (currentContent !== lastContent) {
                    saveUndoState();
                    lastContent = currentContent;
                }
            }, 1000); // Save state 1 second after user stops typing
        }

        function handleKeyDown(event) {
            // Save state before significant changes
            if (event.ctrlKey && (event.key === 'v' || event.key === 'x' || event.key === 'z')) {
                if (event.key === 'z') {
                    event.preventDefault();
                    undoFormat();
                    return;
                }
                // For paste and cut, save current state first
                saveUndoState();
            } else if (event.key === 'Enter' || event.key === 'Backspace' || event.key === 'Delete') {
                // Save state before major structural changes
                const editor = document.getElementById('messageBody');
                if (editor.innerHTML !== lastContent) {
                    saveUndoState();
                }
            }
        }

        function undoFormat() {
            if (undoStack.length > 0) {
                const editor = document.getElementById('messageBody');
                editor.innerHTML = undoStack.pop();
                editor.focus();
                showAlert('Undo successful', 'info');
            } else {
                showAlert('Nothing to undo', 'warning');
            }
        }

        function clearFormatting() {
            const editor = document.getElementById('messageBody');
            if (editor.textContent.trim() === '') {
                showAlert('Message is already empty', 'info');
                return;
            }

            saveUndoState();
            editor.innerHTML = '';
            editor.focus();
            showAlert('Message cleared', 'info');
        }

        // Store selection for color picker
        let storedSelection = null;

        function showColorPicker() {
            const editor = document.getElementById('messageBody');
            const colorPicker = document.getElementById('colorPicker');

            // Store current selection before showing picker
            const selection = window.getSelection();
            if (selection.rangeCount > 0 && !selection.getRangeAt(0).collapsed) {
                storedSelection = selection.getRangeAt(0).cloneRange();
                console.log(`üíæ Stored selection: "${storedSelection.toString()}"`);
            } else {
                storedSelection = null;
                showAlert('‚ö†Ô∏è Please select text first, then click the color picker', 'warning');
                return;
            }

            if (colorPicker.style.display === 'none') {
                colorPicker.style.display = 'block';
            } else {
                colorPicker.style.display = 'none';
            }
        }

        function applyColor(color) {
            console.log(`üé® Applying color: ${color}`);
            const editor = document.getElementById('messageBody');

            // Save state before making changes
            saveUndoState();

            // Ensure editor is focused
            editor.focus();

            let range;

            // Use stored selection if available (from color picker)
            if (storedSelection) {
                console.log(`üìã Using stored selection: "${storedSelection.toString()}"`);
                range = storedSelection;

                // Restore the selection
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
            } else {
                // Try to get current selection
                const selection = window.getSelection();
                console.log(`Selection range count: ${selection.rangeCount}`);

                if (selection.rangeCount === 0) {
                    showAlert('‚ùå No text selected. Please select text first to change its color.', 'warning');
                    return;
                }

                range = selection.getRangeAt(0);

                // Check if selection is collapsed (no text selected)
                if (range.collapsed) {
                    showAlert('‚ùå No text selected. Please drag to select text first.', 'warning');
                    return;
                }
            }

            const selectedText = range.toString();
            console.log(`üìù Selected text: "${selectedText}"`);

            if (!selectedText.trim()) {
                showAlert('‚ùå Empty selection. Please select visible text.', 'warning');
                return;
            }

            console.log(`üéØ Attempting to color "${selectedText}" with ${color}`);

            // Method 1: Use execCommand (most compatible)
            try {
                // Re-select to ensure we have the selection
                selection.removeAllRanges();
                selection.addRange(range);

                // Enable CSS styling
                document.execCommand('styleWithCSS', false, true);

                // Apply the color
                const success = document.execCommand('foreColor', false, color);

                if (success) {
                    console.log(`‚úÖ Color applied via execCommand: ${color}`);
                    showAlert(`‚úÖ Text colored ${color}!`, 'success');
                    updateHiddenTextarea();
                    document.getElementById('colorPicker').style.display = 'none';
                    return;
                }
            } catch (error) {
                console.warn('execCommand method failed:', error);
            }

            // Method 2: Manual HTML replacement
            try {
                console.log('üîÑ Trying manual HTML method...');

                // Get the selected text again
                const textToColor = range.toString();

                // Create colored HTML
                const coloredHTML = `<span style="color: ${color} !important; background: transparent;">${textToColor}</span>`;

                // Replace selection with colored HTML
                const success = document.execCommand('insertHTML', false, coloredHTML);

                if (success) {
                    console.log(`‚úÖ Color applied via HTML insertion: ${color}`);
                    showAlert(`‚úÖ Text colored ${color} (HTML method)!`, 'success');
                    updateHiddenTextarea();
                    document.getElementById('colorPicker').style.display = 'none';
                    return;
                }
            } catch (error) {
                console.warn('HTML insertion method failed:', error);
            }

            // Method 3: DOM manipulation (last resort)
            try {
                console.log('üîÑ Trying DOM manipulation method...');

                // Create a span element
                const span = document.createElement('span');
                span.style.color = color;
                span.style.backgroundColor = 'transparent';

                // Extract the content and put it in the span
                const contents = range.extractContents();
                span.appendChild(contents);

                // Insert the colored span
                range.insertNode(span);

                console.log(`‚úÖ Color applied via DOM manipulation: ${color}`);
                showAlert(`‚úÖ Text colored ${color} (DOM method)!`, 'success');
                updateHiddenTextarea();

            } catch (error) {
                console.error('‚ùå All color methods failed:', error);
                showAlert(`‚ùå Unable to apply color. Try selecting the text again.`, 'error');
            }

            // Hide color picker and clear stored selection
            document.getElementById('colorPicker').style.display = 'none';
            storedSelection = null;
        }

        // Enhanced formatText function for rich text editor
        function formatText(type) {
            const editor = document.getElementById('messageBody');
            saveUndoState();

            // Focus the editor first
            editor.focus();

            try {
                switch (type) {
                    case 'bold':
                        document.execCommand('bold', false, null);
                        break;
                    case 'italic':
                        document.execCommand('italic', false, null);
                        break;
                    case 'underline':
                        document.execCommand('underline', false, null);
                        break;
                    case 'bullet':
                        document.execCommand('insertUnorderedList', false, null);
                        break;
                    case 'number':
                        document.execCommand('insertOrderedList', false, null);
                        break;
                    case 'indent':
                        document.execCommand('indent', false, null);
                        break;
                    case 'link':
                        const url = prompt('Enter URL:');
                        if (url) {
                            document.execCommand('createLink', false, url);
                        }
                        break;
                }
            } catch (e) {
                console.error('Formatting error:', e);
                // Fallback for browsers that don't support execCommand
                insertHTMLAtCursor(getFormattingHTML(type));
            }

            // Update hidden textarea for form submission
            updateHiddenTextarea();
        }

        function insertHTMLAtCursor(html) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                range.deleteContents();
                const fragment = document.createRange().createContextualFragment(html);
                range.insertNode(fragment);
                range.collapse(false);
                selection.removeAllRanges();
                selection.addRange(range);
            }
        }

        function getFormattingHTML(type) {
            const selectedText = window.getSelection().toString() || 'sample text';
            switch (type) {
                case 'bold':
                    return `<strong>${selectedText}</strong>`;
                case 'italic':
                    return `<em>${selectedText}</em>`;
                case 'underline':
                    return `<u>${selectedText}</u>`;
                case 'bullet':
                    return `<ul><li>${selectedText}</li></ul>`;
                case 'number':
                    return `<ol><li>${selectedText}</li></ol>`;
                case 'indent':
                    return `<blockquote>${selectedText}</blockquote>`;
                default:
                    return selectedText;
            }
        }

        function updateHiddenTextarea() {
            const editor = document.getElementById('messageBody');
            const hiddenTextarea = document.getElementById('messageBodyHidden');
            hiddenTextarea.value = editor.innerHTML;
        }

        function handlePaste(event) {
            event.preventDefault();
            const text = (event.clipboardData || window.clipboardData).getData('text');
            document.execCommand('insertText', false, text);
            updateHiddenTextarea();
        }

        // Template Editor Functions
        function showTemplateToolbar() {
            const toolbar = document.getElementById('templateFormattingToolbar');
            if (toolbar) {
                toolbar.style.display = 'block';
            }
        }

        function hideTemplateToolbar() {
            const toolbar = document.getElementById('templateFormattingToolbar');
            if (toolbar) {
                toolbar.style.display = 'none';
            }
        }

        function formatTemplateText(type) {
            const template = document.getElementById('companyEmailTemplate');
            if (!template) return;

            template.focus();
            document.execCommand(type, false, null);
            updateTemplateContent();
        }

        function showTemplateColorPicker() {
            const picker = document.getElementById('templateColorPicker');
            if (picker) {
                picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
            }
        }

        function applyTemplateColor(color) {
            const template = document.getElementById('companyEmailTemplate');
            if (!template) return;

            template.focus();
            document.execCommand('foreColor', false, color);
            hideTemplateColorPicker();
            updateTemplateContent();
        }

        function hideTemplateColorPicker() {
            const picker = document.getElementById('templateColorPicker');
            if (picker) {
                picker.style.display = 'none';
            }
        }

        function clearTemplateFormatting() {
            const template = document.getElementById('companyEmailTemplate');
            if (!template) return;

            template.focus();
            document.execCommand('removeFormat', false, null);
            updateTemplateContent();
        }

        function updateTemplateContent() {
            // Auto-save template content changes
            setTimeout(() => {
                if (typeof CompanyOnboardingModule !== 'undefined' && CompanyOnboardingModule.saveData) {
                    CompanyOnboardingModule.saveData(true); // Auto-save
                }
            }, 1000);
        }

        function handleTemplatePaste(event) {
            event.preventDefault();
            const text = (event.clipboardData || window.clipboardData).getData('text');
            document.execCommand('insertText', false, text);
            updateTemplateContent();
        }

        // Contact Personalization Auto-Population - Make sure it's globally accessible
        window.populatePersonalizationData = function() {
            console.log('populatePersonalizationData called, selectedContactIndex:', selectedContactIndex);

            if (selectedContactIndex === -1 || !contacts[selectedContactIndex]) {
                console.log('No contact selected or contact not found');
                return;
            }

            const contact = contacts[selectedContactIndex];
            const subjectField = document.getElementById('subject');
            const messageBody = document.getElementById('messageBody');

            console.log('Contact:', contact);
            console.log('Message body element:', messageBody);

            if (!messageBody) {
                console.error('Message body element not found!');
                return;
            }

            // Auto-populate subject if empty or contains template
            if (!subjectField.value || subjectField.value.includes('{')) {
                subjectField.value = `Business Partnership Opportunity - Intex Technologies in ${contact.country}`;
                console.log('Subject populated');
            }

            // Always populate message body when a contact is selected (for immediate feedback)
            const personalizedMessage = `Dear ${contact.contactName},

We are pleased to introduce Intex Technologies to ${contact.firm}.

Since our inception in 1996, we have been at the forefront of innovation in consumer electronics and technology sectors. We believe ${contact.firm}, with its established market presence in ${contact.country}, would be an ideal partner for expanding our reach.

Our Product Portfolio:
‚Ä¢ IT Peripherals: Speakers, keyboards, mice, webcams, and computer accessories
‚Ä¢ Home Appliances: Air coolers, room heaters, water purifiers, and kitchen appliances
‚Ä¢ Mobile Accessories: Power banks, chargers, cables, and smartphone accessories
‚Ä¢ Audio Solutions: Wireless speakers, headphones, and sound systems

We are actively seeking distribution partners in ${contact.country} who share our vision of delivering high-quality, innovative products to consumers.

What We Offer Our Partners:
‚úì Competitive pricing with attractive profit margins
‚úì Comprehensive marketing support and co-branding opportunities
‚úì Technical training and ongoing product support
‚úì Flexible payment terms and credit facilities
‚úì Exclusive territory rights (subject to discussion)
‚úì Access to our complete product catalog and new launches

We would welcome the opportunity to discuss how we can work together to bring Intex Technologies' innovative products to the ${contact.country} market through ${contact.firm}.

Please feel free to contact us at your earliest convenience to explore this exciting business opportunity.

Best regards,

Vishwas Agarwal
Business Development Manager
Intex Technologies
Email: vishwas.agarwal@gmail.com
Phone: +91-XXXXXXXXXX`;

            console.log('About to set messageBody.innerHTML');

            // Force clear any previous content and set new content
            messageBody.innerHTML = '';
            setTimeout(() => {
                // Sanitize the personalized message before setting innerHTML
                const sanitizedMessage = sanitizeHTML(personalizedMessage.replace(/\n/g, '<br>'));
                messageBody.innerHTML = sanitizedMessage;
                console.log('Message body innerHTML set to:', messageBody.innerHTML.substring(0, 100) + '...');
                updateHiddenTextarea();
                console.log('updateHiddenTextarea called');
            }, 50);

            console.log('Message body populated with personalized content');
            showAlert(`Personalized content for ${contact.firm} from ${contact.country}`, 'success');
        }



        // Email Attachment Functions
        const attachments = [];
        const MAX_ATTACHMENTS = 5;
        const MAX_TOTAL_SIZE = 25 * 1024 * 1024; // 25MB

        function toggleAttachments() {
            const container = document.getElementById('attachmentContainer');
            const button = document.getElementById('attachmentToggle');

            if (container.style.display === 'none') {
                container.style.display = 'block';
                button.textContent = 'Hide';
            } else {
                container.style.display = 'none';
                button.textContent = 'Add Files';
            }
        }

        function handleAttachmentUpload(event) {
            const files = Array.from(event.target.files);

            if (files.length === 0) return;

            // Check attachment limits
            if (attachments.length + files.length > MAX_ATTACHMENTS) {
                showAlert(`Maximum ${MAX_ATTACHMENTS} attachments allowed. You can add ${MAX_ATTACHMENTS - attachments.length} more files.`, 'error');
                return;
            }

            // Check total size
            const currentSize = attachments.reduce((sum, att) => sum + att.size, 0);
            const newSize = files.reduce((sum, file) => sum + file.size, 0);

            if (currentSize + newSize > MAX_TOTAL_SIZE) {
                const maxMB = Math.round(MAX_TOTAL_SIZE / 1024 / 1024);
                const currentMB = Math.round(currentSize / 1024 / 1024);
                showAlert(`Total attachment size cannot exceed ${maxMB}MB. Current size: ${currentMB}MB`, 'error');
                return;
            }

            // Add files to attachments array
            files.forEach(file => {
                const attachment = {
                    id: Date.now() + Math.random(),
                    file: file,
                    name: file.name,
                    size: file.size,
                    type: file.type || 'application/octet-stream'
                };
                attachments.push(attachment);
            });

            renderAttachments();
            showAlert(`Added ${files.length} attachment(s)`, 'success');

            // Reset file input
            event.target.value = '';
        }

        function renderAttachments() {
            const container = document.getElementById('attachmentList');
            const emptyState = document.getElementById('attachmentEmpty');

            if (attachments.length === 0) {
                container.innerHTML = '<div id="attachmentEmpty" style="text-align: center; color: #999; font-style: italic; padding: 20px;">No attachments selected</div>';
                return;
            }

            const attachmentHTML = attachments.map(attachment => {
                const sizeKB = Math.round(attachment.size / 1024);
                const sizeText = sizeKB < 1024 ? `${sizeKB} KB` : `${Math.round(sizeKB / 1024)} MB`;

                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 5px;">
                        <div style="display: flex; align-items: center; flex: 1;">
                            <span style="margin-right: 8px;">${getFileIcon(attachment.name)}</span>
                            <div>
                                <div style="font-size: 12px; font-weight: bold; color: #333;">${sanitizeInput(attachment.name)}</div>
                                <div style="font-size: 10px; color: #666;">${sizeText}</div>
                            </div>
                        </div>
                        <button onclick="removeAttachment('${attachment.id}')" style="padding: 2px 6px; font-size: 10px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;" title="Remove attachment">
                            ‚úï
                        </button>
                    </div>
                `;
            }).join('');

            container.innerHTML = attachmentHTML;

            // Show total size
            const totalSize = attachments.reduce((sum, att) => sum + att.size, 0);
            const totalMB = Math.round(totalSize / 1024 / 1024 * 100) / 100;
            const maxMB = Math.round(MAX_TOTAL_SIZE / 1024 / 1024);

            container.innerHTML += `
                <div style="padding: 8px; background: #f8f9fa; border-radius: 4px; margin-top: 10px; font-size: 11px; color: #666; text-align: center;">
                    Total: ${totalMB} MB of ${maxMB} MB used (${attachments.length}/${MAX_ATTACHMENTS} files)
                </div>
            `;
        }

        function removeAttachment(attachmentId) {
            const index = attachments.findIndex(att => att.id == attachmentId);
            if (index !== -1) {
                const removedAttachment = attachments.splice(index, 1)[0];
                renderAttachments();
                showAlert(`Removed "${removedAttachment.name}"`, 'info');
            }
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const iconMap = {
                'pdf': 'üìÑ',
                'doc': 'üìù', 'docx': 'üìù',
                'xls': 'üìä', 'xlsx': 'üìä',
                'ppt': 'üìΩÔ∏è', 'pptx': 'üìΩÔ∏è',
                'txt': 'üìÑ',
                'jpg': 'üñºÔ∏è', 'jpeg': 'üñºÔ∏è', 'png': 'üñºÔ∏è', 'gif': 'üñºÔ∏è',
                'zip': 'üì¶', 'rar': 'üì¶'
            };
            return iconMap[ext] || 'üìÅ';
        }

        function handleKeyNavigation(event) {
            const contactCount = filteredContacts.length || contacts.length;
            if (contactCount === 0) return;

            switch(event.key) {
                case 'ArrowDown':
                    event.preventDefault();
                    if (selectedContactIndex < contactCount - 1) {
                        selectContact(selectedContactIndex + 1);
                    }
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    if (selectedContactIndex > 0) {
                        selectContact(selectedContactIndex - 1);
                    }
                    break;
                case 'Enter':
                    event.preventDefault();
                    if (selectedContactIndex >= 0) {
                        document.getElementById('sendBtn').click();
                    }
                    break;
                case 'Escape':
                    event.preventDefault();
                    selectedContactIndex = -1;
                    document.querySelectorAll('.contact-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    document.getElementById('sendBtn').disabled = true;
                    showAlert('Selection cleared');
                    break;
                case 'Home':
                    event.preventDefault();
                    if (contactCount > 0) {
                        selectContact(0);
                    }
                    break;
                case 'End':
                    event.preventDefault();
                    if (contactCount > 0) {
                        selectContact(contactCount - 1);
                    }
                    break;
            }
        }

        function updateUploadStats() {
            const statsDiv = document.getElementById('uploadStats');
            if (uploadStats.total > 0) {
                statsDiv.style.display = 'block';
                statsDiv.innerHTML = `
                    üìä Total: ${uploadStats.total} |
                    ‚úÖ Read: ${uploadStats.read} |
                    ‚ùå Unread: ${uploadStats.unread}
                `;
            }
        }

        function addToEmailHistory(toEmails, subject, status, timestamp, country = '') {
            const historyItem = {
                id: Date.now(),
                toEmails: Array.isArray(toEmails) ? toEmails : [toEmails],
                subject: subject,
                status: status, // 'sent', 'failed'
                timestamp: timestamp,
                country: country,
                content: document.getElementById('messageBody').innerHTML ? document.getElementById('messageBody').innerHTML.substring(0, 100) + '...' : 'No content'
            };
            emailHistory.unshift(historyItem); // Add to beginning
            updateEmailHistory();
        }

        function updateEmailHistory() {
            const historyDiv = document.getElementById('emailHistory');

            if (emailHistory.length === 0) {
                historyDiv.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 20px;">
                        <p>üìß Email history will appear here</p>
                        <small>Send emails to see status tracking</small>
                    </div>
                `;
                return;
            }

            let historyHTML = '';
            emailHistory.slice(0, 20).forEach(item => { // Show last 20 items
                const statusColor = item.status === 'sent' ? '#28a745' : '#dc3545';
                const statusIcon = item.status === 'sent' ? '‚úÖ' : '‚ùå';

                historyHTML += `
                    <div style="border-bottom: 1px solid #eee; padding: 8px; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: between; align-items: start;">
                            <div style="flex: 1;">
                                <strong style="color: ${statusColor};">${statusIcon} ${item.status.toUpperCase()}</strong>
                                <div style="font-size: 12px; color: #666; margin-top: 2px;">
                                    To: ${item.toEmails.join(', ')}<br>
                                    Subject: ${item.subject}<br>
                                    ${new Date(item.timestamp).toLocaleString()}<br>
                                    <small>${item.content}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            historyDiv.innerHTML = historyHTML;
        }

        function parseMultipleEmails(emailString) {
            // Handle multiple delimiters: comma, semicolon, forward slash
            return emailString
                .split(/[,;\/]/)
                .map(email => email.trim())
                .filter(email => email && email.includes('@'));
        }

        // No sample data - users must upload their own spreadsheets

        function showAlert(message, type = 'success') {
            const alerts = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            alerts.appendChild(alert);

            // Remove after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }


        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                console.log('No file selected');
                return;
            }

            // Security: File validation
            if (!validateFileUpload(file)) {
                return;
            }

            // Check if XLSX library is loaded for Excel files
            if (!file.name.toLowerCase().endsWith('.csv') && typeof XLSX === 'undefined') {
                showAlert('Error: Excel processing library not loaded. Please refresh the page.', 'error');
                return;
            }

            console.log('=== FILE UPLOAD STARTED ===');
            console.log('File selected:', file.name, file.type, file.size);
            showAlert(`Processing ${sanitizeInput(file.name)}...`, 'success');

            // Store the uploaded file name for export
            currentUploadedFileName = file.name;

            // Helper functions for multi-table detection (defined outside try block)
            function detectTablesInSheet(jsonData) {
                const tables = [];
                let currentTable = null;

                for (let rowIndex = 0; rowIndex < jsonData.length; rowIndex++) {
                    const row = jsonData[rowIndex];

                    // Skip empty rows
                    if (!row || row.length === 0 || row.every(cell => !cell || cell.toString().trim() === '')) {
                        continue;
                    }

                    // Check if this row looks like a header
                    const isHeaderRow = isLikelyHeaderRow(row);

                    if (isHeaderRow) {
                        // If we have a current table, finalize it
                        if (currentTable && currentTable.rows.length > 0) {
                            tables.push(currentTable);
                        }

                        // Start a new table
                        currentTable = {
                            headers: row.map(cell => cell ? cell.toString().trim().toLowerCase() : ''),
                            rows: [],
                            startRow: rowIndex
                        };
                    } else if (currentTable) {
                        // Add data row to current table
                        currentTable.rows.push(row);
                    } else {
                        // First table without explicit header - treat first row as header
                        currentTable = {
                            headers: row.map(cell => cell ? cell.toString().trim().toLowerCase() : ''),
                            rows: [],
                            startRow: rowIndex
                        };
                    }
                }

                // Add the last table if it exists
                if (currentTable && currentTable.rows.length > 0) {
                    tables.push(currentTable);
                }

                // If no tables found but we have data, treat entire sheet as one table
                if (tables.length === 0 && jsonData.length > 1) {
                    tables.push({
                        headers: jsonData[0].map(cell => cell ? cell.toString().trim().toLowerCase() : ''),
                        rows: jsonData.slice(1),
                        startRow: 0
                    });
                }

                return tables;
            }

            function isLikelyHeaderRow(row) {
                if (!row || row.length === 0) return false;

                const nonEmptyCells = row.filter(cell => cell && cell.toString().trim() !== '');
                if (nonEmptyCells.length < 2) return false; // Need at least 2 columns

                // Check for common header patterns
                const headerPatterns = [
                    /^(firm|company|organization|business)/i,
                    /^(name|contact|person)/i,
                    /^(email|e-mail|mail)/i,
                    /^(phone|telephone|mobile|contact)/i,
                    /^(address|location|addr)/i,
                    /^(website|url|web)/i,
                    /^(country|nation|region)/i,
                    /^(category|type|industry|sector)/i,
                    /^(source|origin|lead)/i
                ];

                let headerMatches = 0;
                for (const cell of nonEmptyCells) {
                    const cellText = cell.toString().trim().toLowerCase();
                    for (const pattern of headerPatterns) {
                        if (pattern.test(cellText)) {
                            headerMatches++;
                            break;
                        }
                    }
                }

                // Consider it a header if at least 30% of non-empty cells match header patterns
                return headerMatches >= Math.max(1, Math.ceil(nonEmptyCells.length * 0.3));
            }

            try {
                // Clear existing data
                contacts = [];
                filteredContacts = [];
                selectedContactIndex = -1;
                uploadedSpreadsheetData = [];
                currentUploadProgress = { current: 0, total: 0 };

                showProgress(0, 100, 'Starting file processing...');
                let totalProcessed = 0;

                // Handle CSV files differently
                if (file.name.toLowerCase().endsWith('.csv')) {
                    console.log('Processing CSV file...');
                    const text = await file.text();
                    console.log('CSV file read, length:', text.length);

                    const csvData = parseCSV(text);
                    console.log('CSV parsed, headers:', csvData.headers);
                    console.log('CSV data rows:', csvData.data.length);

                    // Track total rows for statistics
                    uploadStats.total = csvData.data.length;

                    // Process CSV data
                    csvData.data.forEach((row, index) => {
                        console.log(`Processing row ${index + 1}:`, row);
                        const contact = {
                            country: row.country || 'Unknown',
                            firm: row['firm name'] || row.company || row.firm || 'Unknown Company',
                            address: row.address || row.location || '',
                            phone: row['contact number'] || row.phone || row.telephone || '',
                            contactName: row['contact person'] || row.name || row.contact || 'Contact Person',
                            email: row.email || row['email address'] || '',
                            website: row.website || row.url || '',
                            source: row.source || row['lead source'] || '',
                            category: row.category || row.type || row.sector || '',
                            businessFocus: generateBusinessFocus(row.category || row.type || ''),
                            marketStrength: 'Medium',
                            emailStatus: 'pending' // pending, sent, failed
                        };

                        console.log('Contact created:', contact);

                        if (contact.email && contact.email.includes('@')) {
                            contacts.push(contact);
                            totalProcessed++;
                            console.log(`Added contact ${totalProcessed}: ${contact.firm} - ${contact.email}`);
                        } else {
                            console.log('Skipped contact (no valid email):', contact);
                        }
                    });

                    console.log(`CSV processed: ${totalProcessed} contacts added to array`);
                    console.log('Final contacts array:', contacts);
                } else {
                    // Handle Excel files
                    const data = await file.arrayBuffer();
                    console.log('Excel file read, size:', data.byteLength);

                    const workbook = XLSX.read(data, { type: 'array' });
                    console.log('Workbook loaded, sheets:', workbook.SheetNames);

                    // Calculate total rows across all sheets
                    uploadStats.total = 0;
                    workbook.SheetNames.forEach(sheetName => {
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        if (jsonData.length > 1) {
                            uploadStats.total += jsonData.length - 1; // Exclude header row
                        }
                    });

                    // Process each worksheet (tab) as a country
                    workbook.SheetNames.forEach(sheetName => {
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        if (jsonData.length < 2) return; // Skip empty sheets

                        // Multi-table processing with intelligent header detection
                        const tables = detectTablesInSheet(jsonData);
                        console.log(`Found ${tables.length} table(s) in sheet "${sheetName}"`);

                        // Process each table found in the sheet
                        tables.forEach((table, tableIndex) => {
                            const headers = table.headers;
                            const rows = table.rows;

                            console.log(`Processing table ${tableIndex + 1} in sheet "${sheetName}" with ${rows.length} rows`);
                            console.log(`Table ${tableIndex + 1} headers:`, headers);
                            console.log(`üîç RAW ROWS IN TABLE ${tableIndex + 1}:`, rows);

                            // Map column indices for key parameters
                            const columnMap = {
                                firm: findColumnIndex(headers, ['firm name', 'company', 'firm', 'organization']),
                                address: findColumnIndex(headers, ['address', 'location', 'addr']),
                                phone: findColumnIndex(headers, ['contact number', 'phone', 'telephone', 'mobile']),
                                contactName: findColumnIndex(headers, ['contact person', 'name', 'contact', 'person']),
                                email: findColumnIndex(headers, ['email', 'email address', 'e-mail']),
                                website: findColumnIndex(headers, ['website', 'url', 'web', 'site']),
                                source: findColumnIndex(headers, ['source', 'lead source', 'origin']),
                                category: findColumnIndex(headers, ['category', 'type', 'sector', 'industry'])
                            };

                            // Only process table if it has email column
                            if (columnMap.email === -1) {
                                console.log(`Skipping table ${tableIndex + 1} in "${sheetName}" - no email column found`);
                                return;
                            }

                            // Process each row in the table
                            rows.forEach((row, rowIndex) => {
                                console.log(`üìã Processing row ${rowIndex + 1} in table ${tableIndex + 1} of "${sheetName}":`, row);

                                if (!row || row.length === 0) {
                                    console.log(`‚è≠Ô∏è Skipping empty row ${rowIndex + 1} in table ${tableIndex + 1}`);
                                    // Track empty rows as failed
                                    uploadedSpreadsheetData.push({
                                        originalRowIndex: table.startRow + rowIndex + 1,
                                        originalData: row,
                                        status: 'failed',
                                        reason: 'Empty row',
                                        sheetName: sheetName
                                    });
                                    return;
                                }

                                // Extract firm name and check if it's valid
                                const firmName = getCellValue(row, columnMap.firm);
                                const emailValue = getCellValue(row, columnMap.email);

                                // Skip rows with empty firm names (likely invalid data rows)
                                if (!firmName || firmName.toString().trim() === '') {
                                    console.log(`‚è≠Ô∏è Skipping row ${rowIndex + 1} in table ${tableIndex + 1} - no firm name`);
                                    uploadedSpreadsheetData.push({
                                        originalRowIndex: table.startRow + rowIndex + 1,
                                        originalData: row,
                                        status: 'failed',
                                        reason: 'Missing firm name',
                                        sheetName: sheetName
                                    });
                                    return;
                                }

                                const contact = {
                                    country: sheetName,
                                    firm: firmName,
                                    address: getCellValue(row, columnMap.address) || '',
                                    phone: getCellValue(row, columnMap.phone) || '',
                                    contactName: getCellValue(row, columnMap.contactName) || 'Contact Person',
                                    email: emailValue || '',
                                    website: getCellValue(row, columnMap.website) || '',
                                    source: getCellValue(row, columnMap.source) || '',
                                    category: getCellValue(row, columnMap.category) || '',
                                    businessFocus: generateBusinessFocus(getCellValue(row, columnMap.category)),
                                    marketStrength: 'High',
                                    emailStatus: 'pending'
                                };

                                console.log(`üíº Contact extracted: Firm="${contact.firm}", Email="${contact.email}"`);;

                                // Track in spreadsheet data
                                const spreadsheetEntry = {
                                    originalRowIndex: table.startRow + rowIndex + 1,
                                    originalData: row,
                                    sheetName: sheetName,
                                    processedContact: contact
                                };

                                // Only add if both firm and email exist
                                if (contact.email && contact.email.includes('@')) {
                                    contacts.push(contact);
                                    spreadsheetEntry.status = 'uploaded';
                                    spreadsheetEntry.reason = 'Successfully uploaded';
                                    totalProcessed++;
                                } else {
                                    spreadsheetEntry.status = 'failed';
                                    spreadsheetEntry.reason = 'Missing or invalid email address';
                                }

                                uploadedSpreadsheetData.push(spreadsheetEntry);
                            });
                        });

                        console.log(`Processed sheet "${sheetName}": ${tables.reduce((total, t) => total + t.rows.length, 0)} rows from ${tables.length} tables`);
                    });

                console.log(`Total contacts loaded: ${contacts.length}`);

                // Performance: Cleanup and optimize (syntax verified - v2)
                cleanupContacts();
                filteredContacts = [...contacts];

                // Update upload statistics
                uploadStats.read = contacts.length;
                uploadStats.unread = uploadStats.total - uploadStats.read;
                updateUploadStats();
                hideProgress();

                // Show upload status report
                const statusReport = generateStatusReport();
                console.log(`üìä PROCESSING SUMMARY:`);
                console.log(`   Total rows processed: ${statusReport.total}`);
                console.log(`   Valid contacts added: ${statusReport.successful}`);
                console.log(`   Invalid/failed rows: ${statusReport.failed}`);
                console.log(`   Displayed contacts: ${contacts.length}`);
                showUploadStatusReport(statusReport);

                console.log('About to render contacts. Array length:', contacts.length);
                renderContacts();
                showAlert(`‚úÖ Loaded ${contacts.length} contacts${file.name.toLowerCase().endsWith('.csv') ? '' : ' from multiple countries'}! (${statusReport.failed} rows had issues)`, statusReport.failed > 0 ? 'error' : 'success');
                }

            } catch (error) {
                hideProgress();
                const sanitizedError = sanitizeInput(error.message);
                showAlert(`Error processing file: ${sanitizedError}`, 'error');
                console.error('File processing error:', error);
            } finally {
                // Reset file input for reuse
                document.getElementById('fileUpload').value = '';
            }
        }

        // Enhanced Formatting Functions
        function getDocumentType(extension) {
            const docTypes = {
                'pdf': 'PDF',
                'doc': 'Word',
                'docx': 'Word',
                'ppt': 'PowerPoint',
                'pptx': 'PowerPoint',
                'png': 'Image',
                'jpg': 'Image',
                'jpeg': 'Image',
                'gif': 'Image',
                'bmp': 'Image',
                'tiff': 'Image'
            };
            return docTypes[extension] || 'Unknown';
        }

        // Process PDF files
        async function processPDFFile(file) {
            showProgress(25, 100, 'Reading PDF content...');
            const text = await extractTextFromPDF(file);
            showProgress(75, 100, 'Extracting contact information...');
            return extractContactsFromText(text, 'PDF Document');
        }

        // Process Word documents
        async function processWordFile(file) {
            showProgress(25, 100, 'Reading Word document...');
            const text = await extractTextFromDOCX(file);
            showProgress(75, 100, 'Extracting contact information...');
            return extractContactsFromText(text, 'Word Document');
        }

        // Process PowerPoint presentations
        async function processPowerPointFile(file) {
            showProgress(25, 100, 'Reading PowerPoint slides...');
            const text = await extractTextFromPPTX(file);
            showProgress(75, 100, 'Extracting contact information...');
            return extractContactsFromText(text, 'PowerPoint Document');
        }

        // Process image files using OCR
        async function processImageFile(file) {
            showProgress(25, 100, 'Analyzing image...');
            const text = await performOCR(file);
            showProgress(75, 100, 'Extracting contact information...');
            return extractContactsFromText(text, 'Image');
        }

        // Extract text from PDF (simulation - in real implementation would use PDF.js)
        async function extractTextFromPDF(file) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    // Simulate PDF text extraction
                    const sampleText = `
                        Contact Information Directory

                        ABC Corporation
                        Email: contact@abc-corp.com
                        Phone: +1-555-0123
                        Address: 123 Business Street, Suite 100, City, State 12345
                        Contact Person: John Smith
                        Website: www.abc-corp.com

                        XYZ Industries
                        Email: info@xyz-industries.net
                        Phone: +1-555-0456
                        Address: 456 Industrial Ave, City, State 67890
                        Contact Person: Sarah Johnson
                        Website: www.xyz-industries.net

                        Global Services LLC
                        Email: hello@globalservices.org
                        Phone: +1-555-0789
                        Address: 789 Service Road, City, State 11111
                        Contact Person: Mike Wilson
                    `;
                    resolve(sampleText);
                }, 1000);
            });
        }

        // Extract text from Word documents (simulation - in real implementation would use mammoth.js)
        async function extractTextFromDOCX(file) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    // Simulate Word document text extraction
                    const sampleText = `
                        Business Partners List

                        Tech Solutions Inc.
                        Contact: David Brown - dbrown@techsolutions.com
                        Phone: (555) 123-4567
                        Location: 321 Tech Drive, Innovation City

                        Marketing Pros
                        Contact: Lisa Anderson - lisa.anderson@marketingpros.biz
                        Phone: (555) 234-5678
                        Location: 654 Marketing Blvd, Business Town

                        Finance Experts
                        Contact: Robert Lee - r.lee@financeexperts.co
                        Phone: (555) 345-6789
                        Location: 987 Financial Street, Money City
                    `;
                    resolve(sampleText);
                }, 800);
            });
        }

        // Extract text from PowerPoint presentations (simulation)
        async function extractTextFromPPTX(file) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    // Simulate PowerPoint text extraction
                    const sampleText = `
                        Conference Attendees

                        Slide 1: Key Contacts
                        - Emma Taylor, emma.taylor@startupfirm.com, (555) 456-7890
                        - James Wilson, j.wilson@corporategroup.net, (555) 567-8901

                        Slide 2: Industry Leaders
                        - Patricia Moore, p.moore@industrytech.org, (555) 678-9012
                        - Christopher Davis, chris@innovativedesign.com, (555) 789-0123

                        Slide 3: Partners
                        - Amanda Garcia, a.garcia@partnernetwork.biz, (555) 890-1234
                    `;
                    resolve(sampleText);
                }, 1200);
            });
        }

        // Perform OCR on image files (simulation - in real implementation would use Tesseract.js)
        async function performOCR(file) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    // Simulate OCR text extraction
                    const sampleText = `
                        Business Card Information

                        INNOVATE CORP
                        Maria Rodriguez
                        Senior Manager
                        maria.rodriguez@innovatecorp.com
                        Tel: +1 (555) 111-2222
                        www.innovatecorp.com

                        FUTURE TECH
                        Alex Kim
                        CTO
                        alex@futuretech.io
                        Mobile: 555-333-4444
                        futuretech.io
                    `;
                    resolve(sampleText);
                }, 1500);
            });
        }

        // Extract contact information from text using pattern matching
        function extractContactsFromText(text, source) {
            const contacts = [];
            const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);

            let currentContact = {};
            let processingContact = false;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];

                // Email pattern
                const emailMatch = line.match(/[\w.-]+@[\w.-]+\.[a-zA-Z]{2,}/);
                if (emailMatch) {
                    if (processingContact && currentContact.email) {
                        // Save previous contact and start new one
                        if (isValidContact(currentContact)) {
                            contacts.push(finalizeContact(currentContact, source));
                        }
                        currentContact = {};
                    }
                    currentContact.email = emailMatch[0];
                    processingContact = true;
                }

                // Phone pattern
                const phoneMatch = line.match(/(?:\+?1[-.\s]?)?\(?([0-9]{3})\)?[-.\s]?([0-9]{3})[-.\s]?([0-9]{4})/);
                if (phoneMatch && processingContact) {
                    currentContact.phone = phoneMatch[0];
                }

                // Website pattern
                const websiteMatch = line.match(/(?:www\.)?[\w.-]+\.(?:com|net|org|biz|co|io|edu|gov)/);
                if (websiteMatch && processingContact && !currentContact.email?.includes(websiteMatch[0])) {
                    currentContact.website = websiteMatch[0].startsWith('www.') ? websiteMatch[0] : 'www.' + websiteMatch[0];
                }

                // Company/Firm name (usually appears before or after email)
                if (processingContact && !currentContact.firm) {
                    // Look for company indicators
                    if (line.match(/\b(Corp|Corporation|Inc|LLC|Ltd|Company|Group|Solutions|Services|Industries|Tech|Systems)\b/i)) {
                        currentContact.firm = line;
                    } else if (line.length < 50 && line.match(/^[A-Z][a-zA-Z\s&]+$/)) {
                        // Capitalized words that look like company names
                        currentContact.firm = line;
                    }
                }

                // Contact person name
                if (processingContact && !currentContact.contactName) {
                    // Look for person names (First Last pattern)
                    if (line.match(/^[A-Z][a-z]+\s+[A-Z][a-z]+/) && !line.match(/\b(Street|Ave|Road|Drive|Blvd)\b/i)) {
                        currentContact.contactName = line;
                    }
                }

                // Address pattern
                if (processingContact && line.match(/\d+\s+[\w\s]+(?:Street|St|Avenue|Ave|Road|Rd|Drive|Dr|Boulevard|Blvd|Suite|Ste)/i)) {
                    currentContact.address = line;
                }
            }

            // Don't forget the last contact
            if (processingContact && isValidContact(currentContact)) {
                contacts.push(finalizeContact(currentContact, source));
            }

            return contacts;
        }

        // Check if contact has minimum required information
        function isValidContact(contact) {
            return contact.email && contact.email.includes('@');
        }

        // Finalize contact with default values
        function finalizeContact(contact, source) {
            return {
                country: 'Unknown',
                firm: contact.firm || 'Unknown Company',
                address: contact.address || '',
                phone: contact.phone || '',
                contactName: contact.contactName || 'Contact Person',
                email: contact.email,
                website: contact.website || '',
                source: source || 'Document',
                category: 'General',
                businessFocus: generateBusinessFocus('General'),
                marketStrength: 'Medium',
                emailStatus: 'pending'
            };
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Bulk Email Sender Application Initialized');

            // Initialize filtered contacts
            filteredContacts = [...contacts];

            // Set focus to first interactive element for accessibility
            const firstButton = document.querySelector('button:not([disabled])');
            if (firstButton) {
                firstButton.focus();
            }

            console.log('Application ready for use - Live mode active');
        });

        function findColumnIndex(headers, possibleNames) {
            for (let name of possibleNames) {
                const index = headers.findIndex(h => h && h.includes(name));
                if (index !== -1) return index;
            }
            return -1;
        }

        function getCellValue(row, columnIndex) {
            if (columnIndex === -1 || !row[columnIndex]) return '';
            return row[columnIndex].toString().trim();
        }

        function generateBusinessFocus(category) {
            const focusMap = {
                'technology': 'IT peripherals and smart devices',
                'retail': 'Consumer electronics and home appliances',
                'electronics': 'Audio solutions and mobile accessories',
                'manufacturing': 'Industrial equipment and automation',
                'healthcare': 'Medical devices and monitoring systems',
                'education': 'Educational technology and audio-visual equipment'
            };

            const categoryLower = category.toLowerCase();
            for (let [key, focus] of Object.entries(focusMap)) {
                if (categoryLower.includes(key)) return focus;
            }
            return 'Consumer electronics and technology solutions';
        }

        function renderContacts() {
            console.log('=== RENDER CONTACTS CALLED ===');
            console.log('Contacts to render:', contacts.length);
            console.log('Contacts array:', contacts);

            const container = document.getElementById('contactsList');
            if (!container) {
                console.error('contactsList element not found!');
                return;
            }

            container.innerHTML = '';

            if (contacts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666; border: 2px dashed #ddd; border-radius: 8px; background: #f9f9f9;">
                        <h4 style="color: #999; margin-bottom: 10px;">üìã No Contacts Loaded</h4>
                        <p>Upload your spreadsheet above to see your contact database here</p>
                        <small>Your contacts will appear here after uploading</small>
                    </div>
                `;
                return;
            }

            console.log('Rendering individual contacts...');
            const contactsToRender = filteredContacts.length > 0 ? filteredContacts : contacts;

            contactsToRender.forEach((contact, index) => {
                console.log(`Rendering contact ${index + 1}:`, contact);
                const div = document.createElement('div');
                div.className = 'contact-item';

                // Add click handler for contact selection
                div.onclick = () => selectContact(index);
                div.setAttribute('role', 'option');
                div.setAttribute('aria-selected', 'false');
                div.setAttribute('tabindex', '-1');

                // Add status-based styling with pleasing colors
                let statusColor = '';
                let statusBorder = '';
                let statusIcon = '';
                let statusBadge = '';

                if (contact.emailStatus === 'sent') {
                    // Soft green for successful sends - pleasing to eyes
                    statusColor = 'background: linear-gradient(135deg, #e8f5e8 0%, #f0fff0 100%);';
                    statusBorder = 'border-left: 4px solid #22c55e; border: 1px solid #86efac;';
                    statusIcon = '‚úì'; // Simple checkmark
                    statusBadge = '<span style="background: #22c55e; color: white; padding: 2px 6px; border-radius: 10px; font-size: 9px; font-weight: 500;">SENT</span>';
                } else if (contact.emailStatus === 'failed') {
                    // Soft red for failed sends - pleasing to eyes
                    statusColor = 'background: linear-gradient(135deg, #fef2f2 0%, #fff5f5 100%);';
                    statusBorder = 'border-left: 4px solid #ef4444; border: 1px solid #fca5a5;';
                    statusIcon = '‚úó'; // Simple X mark
                    statusBadge = '<span style="background: #ef4444; color: white; padding: 2px 6px; border-radius: 10px; font-size: 9px; font-weight: 500;">FAILED</span>';
                } else if (contact.emailStatus === 'partial') {
                    // Soft orange for partial success - pleasing to eyes
                    statusColor = 'background: linear-gradient(135deg, #fff7ed 0%, #fef3e2 100%);';
                    statusBorder = 'border-left: 4px solid #f59e0b; border: 1px solid #fbbf24;';
                    statusIcon = '‚óê'; // Half circle for partial
                    statusBadge = '<span style="background: #f59e0b; color: white; padding: 2px 6px; border-radius: 10px; font-size: 9px; font-weight: 500;">PARTIAL</span>';
                } else {
                    // Soft blue for pending - pleasing to eyes
                    statusColor = 'background: linear-gradient(135deg, #f0f9ff 0%, #f8fafc 100%);';
                    statusBorder = 'border-left: 4px solid #3b82f6; border: 1px solid #93c5fd;';
                    statusIcon = '‚Ä¢'; // Simple dot
                    statusBadge = '<span style="background: #6b7280; color: white; padding: 2px 6px; border-radius: 10px; font-size: 9px; font-weight: 500;">PENDING</span>';
                }

                div.style.cssText += statusColor + statusBorder;

                // Security: Sanitize all contact data before display
                const sanitizedContact = {
                    firm: sanitizeHTML(contact.firm || ''),
                    contactName: sanitizeHTML(contact.contactName || ''),
                    email: sanitizeHTML(contact.email || ''),
                    country: sanitizeHTML(contact.country || ''),
                    phone: sanitizeHTML(contact.phone || ''),
                    website: sanitizeHTML(contact.website || ''),
                    address: sanitizeHTML(contact.address || ''),
                    source: sanitizeHTML(contact.source || ''),
                    category: sanitizeHTML(contact.category || '')
                };

                // Create safe HTML structure without innerHTML
                const flexContainer = document.createElement('div');
                flexContainer.style.cssText = 'display: flex; justify-content: space-between; align-items: start;';

                const contentDiv = document.createElement('div');
                contentDiv.style.cssText = 'flex: 1;';

                // Header with firm name and category
                const headerDiv = document.createElement('div');
                headerDiv.style.cssText = 'display: flex; align-items: center; gap: 8px; margin-bottom: 4px;';

                const firmStrong = document.createElement('strong');
                firmStrong.textContent = sanitizedContact.firm;
                headerDiv.appendChild(firmStrong);

                if (sanitizedContact.category) {
                    const categorySpan = document.createElement('span');
                    categorySpan.style.cssText = 'background: #e3f2fd; color: #1976d2; padding: 2px 6px; border-radius: 3px; font-size: 0.8em;';
                    categorySpan.textContent = sanitizedContact.category;
                    headerDiv.appendChild(categorySpan);
                }

                contentDiv.appendChild(headerDiv);

                // Contact details
                const details = [
                    `üë§ ${sanitizedContact.contactName}`,
                    `üìß ${sanitizedContact.email}`,
                    `üåç ${sanitizedContact.country}`
                ];

                if (sanitizedContact.phone) details.push(`üìû ${sanitizedContact.phone}`);
                if (sanitizedContact.website) details.push(`üåê ${sanitizedContact.website}`);
                if (sanitizedContact.address) details.push(`üìç ${sanitizedContact.address}`);
                if (sanitizedContact.source) details.push(`üìä Source: ${sanitizedContact.source}`);

                details.forEach(detail => {
                    const detailDiv = document.createElement('div');
                    detailDiv.textContent = detail;
                    detailDiv.style.fontSize = '10px';
                    detailDiv.style.marginBottom = '2px';
                    contentDiv.appendChild(detailDiv);
                });

                // Status icon
                const statusDiv = document.createElement('div');
                statusDiv.style.cssText = 'display: flex; flex-direction: column; align-items: center; gap: 4px;';
                const iconColor = contact.emailStatus === 'sent' ? '#22c55e' : contact.emailStatus === 'failed' ? '#ef4444' : '#6b7280';
                statusDiv.innerHTML = '<div style="font-size: 16px; color: ' + iconColor + '; font-weight: bold;">' + statusIcon + '</div>' + statusBadge;

                flexContainer.appendChild(contentDiv);
                flexContainer.appendChild(statusDiv);
                div.appendChild(flexContainer);

                container.appendChild(div);
                console.log(`Contact ${index + 1} added to DOM`);
            });

            // Update counts
            updateContactCounts();

            // Enable bulk email button if contacts are available
            const bulkSendBtn = document.getElementById('bulkSendBtn');
            if (bulkSendBtn && contacts.length > 0) {
                bulkSendBtn.disabled = false;
                bulkSendBtn.style.background = '';
                bulkSendBtn.style.cursor = 'pointer';
                bulkSendBtn.title = `Send emails to all ${contacts.length} contacts`;
            }

            console.log('=== CONTACT RENDERING COMPLETE ===');

            // Auto-save after contact loading
            if (contacts.length > 0) {
                saveToLocalStorage();
                // Show download button when contacts are loaded
                const downloadBtn = document.getElementById('downloadContactsBtn');
                if (downloadBtn) {
                    downloadBtn.style.display = 'inline-flex';
                }
            }
        }

        function updateContactCounts() {
            emailStatusCounts.total = contacts.length;
            emailStatusCounts.sent = contacts.filter(c => c.emailStatus === 'sent').length;
            emailStatusCounts.failed = contacts.filter(c => c.emailStatus === 'failed').length;
            emailStatusCounts.pending = contacts.filter(c => c.emailStatus === 'pending').length;

            document.getElementById('totalCount').textContent = `${emailStatusCounts.total} contacts`;
            document.getElementById('sentCount').textContent = `${emailStatusCounts.sent} sent`;
            document.getElementById('failedCount').textContent = `${emailStatusCounts.failed} failed`;
        }

        function handleScroll() {
            const contactsList = document.getElementById('contactsList');
            const scrollTopBtn = document.getElementById('scrollTopBtn');

            // Show scroll to top button when scrolled down more than 100px
            if (contactsList.scrollTop > 100) {
                scrollTopBtn.style.display = 'block';
            } else {
                scrollTopBtn.style.display = 'none';
            }
        }

        function scrollToTop() {
            const contactsList = document.getElementById('contactsList');
            contactsList.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        function selectContact(index) {
            selectedContactIndex = index;
            const contact = contacts[index];

            // Update UI
            document.querySelectorAll('.contact-item').forEach((item, i) => {
                item.classList.toggle('selected', i === index);
            });

            // Populate email form
            const toEmailField = document.getElementById('toEmail');
            if (toEmailField) {
                toEmailField.value = contact.email;
            }

            // Get company onboarding data for personalization
            const companyData = CompanyOnboardingModule.getData();
            console.log('[ContactSelection] Company data retrieved:', companyData);

            // Check if company data exists and use personalized template
            if (companyData && companyData.emailTemplate) {
                console.log('[ContactSelection] Using personalized template with company onboarding data');
                console.log('[ContactSelection] Email template:', companyData.emailTemplate);

                try {
                    // Extract template content
                    const templateData = CompanyOnboardingModule.extractTemplateContent(companyData.emailTemplate);
                    console.log('[ContactSelection] Extracted template data:', templateData);

                    // Populate subject line with personalization
                    const subjectField = document.getElementById('subject');
                    if (subjectField && templateData.subject) {
                        const personalizedSubject = personalizeEmailContent(templateData.subject, contact);
                        subjectField.value = personalizedSubject;
                    } else if (subjectField) {
                        // Fallback subject if no template subject
                        subjectField.value = `Business Partnership Opportunity - ${companyData.companyName || 'Our Company'} & ${contact.firm} in ${contact.country}`;
                    }

                    // Populate message body with full personalization
                    const messageBody = document.getElementById('messageBody');
                    if (messageBody && templateData.content) {
                        const personalizedContent = personalizeEmailContent(templateData.content, contact);
                        const sanitizedContent = sanitizeHTML(personalizedContent.replace(/\n/g, '<br>'));
                        messageBody.innerHTML = sanitizedContent;

                        // Update hidden textarea
                        const hiddenTextarea = document.getElementById('messageBodyHidden');
                        if (hiddenTextarea) {
                            hiddenTextarea.value = messageBody.innerHTML;
                        }
                    }

                    // Show visual indicator for personalized content
                    showPersonalizationIndicator(true, companyData);

                    // Show success message with personalization info
                    showAlert(`‚ú® Personalized email populated for ${contact.contactName} from ${contact.firm} using company template!`, 'success');

                } catch (error) {
                    console.error('[ContactSelection] Error applying personalized template:', error);
                    // Fall back to default template on error
                    applyFallbackTemplate(contact);
                }

            } else {
                // No company data - use fallback template
                console.log('[ContactSelection] No company onboarding data found, using fallback template');
                applyFallbackTemplate(contact);

                // Suggest setting up company data
                setTimeout(() => {
                    showAlert('üí° Tip: Configure your company data in "üè¢ Company Onboarding Data" for fully personalized emails!', 'info');
                }, 2000);
            }

            const sendBtn = document.getElementById('sendBtn');
            if (sendBtn) {
                sendBtn.disabled = false;
            }
        }

        // Fallback template function
        function applyFallbackTemplate(contact) {
            // Populate subject line
            const subjectField = document.getElementById('subject');
            if (subjectField) {
                subjectField.value = `Business Partnership Opportunity - Intex Technologies in ${contact.country}`;
            }

            // Populate message body with default template
            const messageBody = document.getElementById('messageBody');
            if (messageBody) {
                const fallbackMessage = `Dear ${contact.contactName},

We are pleased to introduce Intex Technologies to ${contact.firm}.

Since our inception in 1996, we have been at the forefront of innovation in consumer electronics and technology sectors. We believe ${contact.firm}, with its established market presence in ${contact.country}, would be an ideal partner for expanding our reach.

Our Product Portfolio:
‚Ä¢ IT Peripherals: Speakers, keyboards, mice, webcams, and computer accessories
‚Ä¢ Home Appliances: Air coolers, room heaters, water purifiers, and kitchen appliances
‚Ä¢ Mobile Accessories: Power banks, chargers, cables, and smartphone accessories
‚Ä¢ Audio Solutions: Wireless speakers, headphones, and sound systems

We are actively seeking distribution partners in ${contact.country} who share our vision of delivering high-quality, innovative products to consumers.

What We Offer Our Partners:
‚úì Competitive pricing with attractive profit margins
‚úì Comprehensive marketing support and co-branding opportunities
‚úì Technical training and ongoing product support
‚úì Flexible payment terms and credit facilities
‚úì Exclusive territory rights (subject to discussion)
‚úì Access to our complete product catalog and new launches

We would welcome the opportunity to discuss how we can work together to bring Intex Technologies' innovative products to the ${contact.country} market through ${contact.firm}.

Please feel free to contact us at your earliest convenience to explore this exciting business opportunity.

Best regards,

Vishwas Agarwal
Business Development Manager
Intex Technologies
Email: vishwas.agarwal@gmail.com
Phone: +91-XXXXXXXXXX`;

                // Sanitize the fallback message before setting innerHTML
                const sanitizedMessage = sanitizeHTML(fallbackMessage.replace(/\n/g, '<br>'));
                messageBody.innerHTML = sanitizedMessage;

                // Update hidden textarea
                const hiddenTextarea = document.getElementById('messageBodyHidden');
                if (hiddenTextarea) {
                    hiddenTextarea.value = messageBody.innerHTML;
                }
            }

            // Show visual indicator for default template
            showPersonalizationIndicator(false);

            showAlert(`Selected: ${contact.contactName} from ${contact.firm} (using default template)`, 'success');
        }

        // Visual indicator for personalization status
        function showPersonalizationIndicator(isPersonalized, companyData = null) {
            // Remove existing indicators
            const existingIndicators = document.querySelectorAll('.personalization-indicator');
            existingIndicators.forEach(indicator => indicator.remove());

            if (isPersonalized && companyData) {
                // Create personalized indicator
                const indicator = document.createElement('div');
                indicator.className = 'personalization-indicator';
                indicator.style.cssText = `
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 8px 12px;
                    border-radius: 6px;
                    font-size: 12px;
                    margin: 10px 0;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
                    animation: slideInDown 0.3s ease-out;
                `;

                // Count populated fields
                const populatedFields = CompanyOnboardingModule.availableFields.filter(field =>
                    companyData[field] && companyData[field].trim()
                ).length;

                indicator.innerHTML = `
                    <span>‚ú®</span>
                    <span><strong>Personalized Email Active</strong></span>
                    <span style="opacity: 0.8;">‚Ä¢ ${populatedFields}/${CompanyOnboardingModule.availableFields.length} company fields ‚Ä¢ Smart content & grammar</span>
                `;

                // Add to message composition area
                const messageContainer = document.querySelector('.message-container') ||
                                       document.getElementById('messageBody')?.parentNode;
                if (messageContainer) {
                    messageContainer.insertBefore(indicator, messageContainer.firstChild);
                }

            } else {
                // Create default template indicator
                const indicator = document.createElement('div');
                indicator.className = 'personalization-indicator';
                indicator.style.cssText = `
                    background: #f8f9fa;
                    border: 1px solid #dee2e6;
                    color: #6c757d;
                    padding: 8px 12px;
                    border-radius: 6px;
                    font-size: 12px;
                    margin: 10px 0;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    animation: slideInDown 0.3s ease-out;
                `;

                indicator.innerHTML = `
                    <span>üìù</span>
                    <span>Default Template</span>
                    <span style="opacity: 0.7;">‚Ä¢ <a href="#" onclick="CompanyOnboardingModule.showManager()" style="color: #007bff; text-decoration: none;">Set up company data</a> for personalization</span>
                `;

                // Add to message composition area
                const messageContainer = document.querySelector('.message-container') ||
                                       document.getElementById('messageBody')?.parentNode;
                if (messageContainer) {
                    messageContainer.insertBefore(indicator, messageContainer.firstChild);
                }
            }

            // Add CSS animation
            if (!document.getElementById('personalizationStyles')) {
                const style = document.createElement('style');
                style.id = 'personalizationStyles';
                style.textContent = `
                    @keyframes slideInDown {
                        from {
                            opacity: 0;
                            transform: translateY(-10px);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // Switch to Personalized Email function
        function switchToPersonalizedEmail() {
            try {
                // Check if company data exists
                const companyData = CompanyOnboardingModule.getData();
                if (!companyData || !companyData.emailTemplate) {
                    showAlert('‚ö†Ô∏è Please configure your company data and email template first.\n\nClick "üè¢ Company Onboarding Data" in the settings menu.', 'warning');
                    // Automatically open the company onboarding manager
                    setTimeout(() => {
                        CompanyOnboardingModule.showManager();
                    }, 2000);
                    return;
                }

                // Check if template has mandatory fields
                if (!companyData.businesDevelopementManagerName || !companyData.businesDevelopementManagerDesignation) {
                    showAlert('‚ö†Ô∏è Missing mandatory fields: Business Development Manager Name and Designation.\n\nPlease complete your company profile first.', 'warning');
                    CompanyOnboardingModule.showManager();
                    return;
                }

                // Extract template content
                const templateData = CompanyOnboardingModule.extractTemplateContent(companyData.emailTemplate);

                // Apply personalized template with smart content
                if (templateData.subject) {
                    const personalizedSubject = personalizeEmailContent(templateData.subject, null);
                    document.getElementById('subject').value = personalizedSubject;
                }

                if (templateData.content) {
                    const personalizedContent = personalizeEmailContent(templateData.content, null);
                    const messageBody = document.getElementById('messageBody');
                    const sanitizedContent = personalizedContent.replace(/\n/g, '<br>');
                    messageBody.innerHTML = sanitizedContent;
                }

                // Show personalization indicator
                showPersonalizationIndicator(true, companyData);

                showAlert('‚ú® Personalized email template applied! \n\nüéØ Smart content hiding and grammar checking enabled.\nüìß Ready for professional outreach.', 'success');

                // Highlight the applied changes briefly
                const subjectField = document.getElementById('subject');
                const messageField = document.getElementById('messageBody');

                [subjectField, messageField].forEach(field => {
                    field.style.boxShadow = '0 0 10px #667eea';
                    setTimeout(() => {
                        field.style.boxShadow = '';
                    }, 2000);
                });

            } catch (error) {
                console.error('Error applying personalized template:', error);
                showAlert('Failed to apply personalized template. Please check your company data.', 'error');
            }
        }

        async function sendEmail() {
            console.log('=== EMAIL SENDING STARTED ===');

            // Validate all inputs first
            const fromEmailValid = validateEmail(document.getElementById('fromEmail'));
            const toEmailValid = validateEmailList(document.getElementById('toEmail'));
            const subjectValid = validateSubject(document.getElementById('subject'));
            const messageValid = validateMessage(document.getElementById('messageBody'));

            if (!fromEmailValid || !toEmailValid || !subjectValid || !messageValid) {
                showAlert('Please fix all validation errors before sending', 'error');
                return;
            }

            const fromEmail = document.getElementById('fromEmail').value.trim();
            const toEmailField = document.getElementById('toEmail').value.trim();
            const subject = document.getElementById('subject').value.trim();
            const body = document.getElementById('messageBody').innerHTML.trim();

            // Parse multiple emails
            const toEmails = parseMultipleEmails(toEmailField);
            console.log('Email details:', { fromEmail, toEmails, subject: subject.substring(0, 50) + '...' });

            if (toEmails.length === 0) {
                showAlert('Please enter at least one valid email address', 'error');
                return;
            }

            // Security: Sanitize inputs
            const sanitizedSubject = sanitizeInput(subject);
            const sanitizedBody = sanitizeInput(body);

            if (toEmails.length > 1) {
                showAlert(`Sending to ${toEmails.length} email addresses...`, 'success');
            }

            try {
                document.getElementById('sendBtn').textContent = 'Sending...';
                document.getElementById('sendBtn').disabled = true;

                // Send to each email address (for multiple emails, send individually)
                let successCount = 0;
                let failureCount = 0;

                for (const toEmail of toEmails) {
                    console.log(`Sending to: ${toEmail}`);

                    try {
                        // Create contact object for email sending
                        const contact = {
                            email: toEmail,
                            contactName: '', // Will be extracted if available
                            firm: '',
                            country: ''
                        };

                        // Try to find contact details if it's a known contact
                        const knownContact = contacts.find(c => c.email === toEmail);
                        if (knownContact) {
                            contact.contactName = knownContact.contactName;
                            contact.firm = knownContact.firm;
                            contact.country = knownContact.country;
                        }

                        // Get message body HTML (preserving formatting)
                        const messageBodyHTML = document.getElementById('messageBody').innerHTML;

                        // Send email using real email service
                        const result = await sendRealEmail(contact, subject, messageBodyHTML);
                        console.log(`Response for ${toEmail}:`, result);

                        if (result.success) {
                            successCount++;
                            addToEmailHistory(toEmail, subject, 'sent', Date.now(), contact.country);
                        } else {
                            failureCount++;
                            addToEmailHistory(toEmail, subject, 'failed', Date.now(), contact.country);
                            console.error(`Email failed for ${toEmail}:`, result.error);
                        }
                    } catch (emailError) {
                        console.error(`Error sending to ${toEmail}:`, emailError);
                        failureCount++;
                        addToEmailHistory(toEmail, subject, 'failed', Date.now(), contact.country || 'Unknown');
                    }
                }

                // Show summary results
                if (successCount > 0 && failureCount === 0) {
                    showAlert(`‚úÖ Successfully sent to all ${successCount} email(s)`);
                } else if (successCount > 0 && failureCount > 0) {
                    showAlert(`‚ö†Ô∏è Sent to ${successCount}, failed to ${failureCount} email(s)`);
                } else {
                    showAlert(`‚ùå Failed to send to all ${failureCount} email(s). Email services need configuration - check the Data menu > Email Setup`, 'error');
                }

                // Update contact status if single contact selected
                if (selectedContactIndex >= 0 && toEmails.length === 1) {
                    contacts[selectedContactIndex].emailStatus = successCount > 0 ? 'sent' : 'failed';
                    renderContacts(); // Re-render to show color
                }

            } catch (error) {
                console.error('Email sending error:', error);
                showAlert(`Network error: ${error.message}`, 'error');

                // Update contact status to failed on network error
                if (selectedContactIndex >= 0) {
                    contacts[selectedContactIndex].emailStatus = 'failed';
                    renderContacts(); // Re-render to show red color
                }
            } finally {
                document.getElementById('sendBtn').textContent = 'Send Email';
                document.getElementById('sendBtn').disabled = false;
            }
        }

        // Bulk Email Sending Functionality
        let bulkEmailInProgress = false;
        let bulkEmailPaused = false;
        let bulkEmailCancelled = false;
        let bulkEmailCurrentIndex = 0;
        let bulkEmailTotal = 0;
        let bulkEmailSuccessCount = 0;
        let bulkEmailFailureCount = 0;

        // Template Content Extraction Helper
        function extractTemplateContent(template) {
            if (!template) return { subject: '', content: '' };

            const lines = template.split('\n');
            let subject = '';
            let content = '';
            let contentStartIndex = -1;

            // Find subject line and content start
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();

                if (line.startsWith('Subject:')) {
                    subject = line.replace('Subject:', '').trim();
                } else if (subject && line === '' && contentStartIndex === -1) {
                    // First empty line after subject marks start of content
                    contentStartIndex = i + 1;
                    break;
                }
            }

            // Extract content (everything after the first empty line following subject)
            if (contentStartIndex !== -1) {
                content = lines.slice(contentStartIndex).join('\n').trim();
            } else {
                // Fallback: find content after headers
                let headersSectionEnded = false;
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line === '' && !headersSectionEnded) {
                        content = lines.slice(i + 1).join('\n').trim();
                        break;
                    }
                }
            }

            // Convert content to HTML format
            if (content) {
                content = content
                    .replace(/\n\n/g, '<br><br>')
                    .replace(/\n/g, '<br>')
                    .replace(/‚Ä¢/g, '&bull;')
                    .replace(/‚úì/g, '&check;');
            }

            return { subject, content };
        }

        // Bulk Email Confirmation System
        function showBulkEmailConfirmation() {
            if (contacts.length === 0) {
                showAlert('No contacts available for bulk email. Please upload contacts first.', 'error');
                return;
            }

            // Get email details - integrate template if message body is empty
            let subjectValue = document.getElementById('subject').value.trim();
            const messageBody = document.getElementById('messageBody');
            const fromEmail = document.getElementById('fromEmail').value;
            let rawMessageHTML = messageBody.innerHTML.trim();

            // If subject or message is empty, try to get content from Company Onboarding template
            const companyData = CompanyOnboardingModule.getData();
            const emailTemplate = companyData.emailTemplate || '';

            if ((!subjectValue || !rawMessageHTML) && emailTemplate) {
                console.log('Message body or subject is empty, extracting from Company Onboarding template...');
                const templateData = CompanyOnboardingModule.extractTemplateContent(emailTemplate);
                let templateApplied = false;

                if (!subjectValue && templateData.subject) {
                    subjectValue = templateData.subject;
                    // Auto-populate the subject field for user to see
                    document.getElementById('subject').value = templateData.subject;
                    templateApplied = true;
                }

                if (!rawMessageHTML && templateData.content) {
                    rawMessageHTML = templateData.content;
                    // Auto-populate the message body for user to see
                    messageBody.innerHTML = templateData.content;
                    templateApplied = true;
                }

                if (templateApplied) {
                    // Brief notification that template was applied
                    setTimeout(() => {
                        showAlert('üìß Email template automatically applied to bulk email!', 'success');
                    }, 500);
                }
            }

            // Apply defaults if still empty
            const finalSubject = subjectValue || 'Business Partnership Opportunity - {firm} in {country}';
            const messageHTML = rawMessageHTML || 'Dear {contactName},<br><br>I hope this message finds you well. I am reaching out regarding a potential business partnership opportunity with {firm}.<br><br>Best regards,<br>Intex Technologies';
            const rawMessageText = (messageBody.textContent || messageBody.innerText || '').trim();
            const messageText = rawMessageText || 'Dear {contactName}, I hope this message finds you well. I am reaching out regarding a potential business partnership opportunity with {firm}. Best regards, Intex Technologies';

            // Create confirmation modal
            const modal = document.createElement('div');
            modal.id = 'bulkEmailConfirmModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
                z-index: 15000; padding: 20px;
            `;

            // Check if using personalized templates
            const isUsingPersonalizedTemplate = companyData && companyData.emailTemplate;
            const companyFieldCount = CompanyOnboardingModule.availableFields.filter(field =>
                companyData[field] && companyData[field].trim()
            ).length;

            // Generate email previews for ALL contacts - store contact info only, personalize at send time like individual emails
            const emailPreviews = contacts.map(contact => {
                // Get current templates from form (same as individual emails do)
                const currentSubject = document.getElementById('subject').value || finalSubject;
                const currentMessageBody = document.getElementById('messageBody');
                const currentMessageHTML = currentMessageBody.innerHTML;

                // Personalize for preview display using enhanced personalization engine
                const personalizedSubject = personalizeEmailContent(currentSubject, contact);
                const personalizedMessageHTML = personalizeEmailContent(currentMessageHTML, contact);

                const personalizedMessageText = personalizedMessageHTML.replace(/<[^>]*>/g, ''); // Strip HTML for preview

                console.log('Personalized for', contact.email, {
                    personalizedSubject,
                    personalizedMessageHTML: personalizedMessageHTML.substring(0, 100)
                });

                return {
                    contact,
                    subject: personalizedSubject,
                    messageHTML: personalizedMessageHTML,
                    messageText: personalizedMessageText,
                    messagePreview: personalizedMessageText.substring(0, 150) + (personalizedMessageText.length > 150 ? '...' : '')
                };
            });

            modal.innerHTML = `
                <div style="background: white; border-radius: 8px; max-width: 900px; width: 95%; max-height: 90%; overflow-y: auto; padding: 0;">
                    <!-- Header with Close X and Actions -->
                    <div style="padding: 16px 24px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa;">
                        <div>
                            <h2 style="margin: 0; color: #202124; font-size: 18px; font-weight: 500;">üìß Bulk Email Review</h2>
                            <p style="margin: 4px 0 8px 0; color: #5f6368; font-size: 12px;">Review personalized emails for ${contacts.length} contacts</p>

                            <!-- Personalization Status Indicator -->
                            ${isUsingPersonalizedTemplate ? `
                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 6px 12px; border-radius: 6px; font-size: 11px; display: inline-flex; align-items: center; gap: 6px; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">
                                    <span>‚ú®</span>
                                    <span><strong>Personalized Templates Active</strong></span>
                                    <span style="opacity: 0.8;">‚Ä¢ ${companyFieldCount}/${CompanyOnboardingModule.availableFields.length} company fields ‚Ä¢ Smart content & grammar</span>
                                </div>
                            ` : `
                                <div style="background: #f8f9fa; border: 1px solid #dee2e6; color: #6c757d; padding: 6px 12px; border-radius: 6px; font-size: 11px; display: inline-flex; align-items: center; gap: 6px;">
                                    <span>üìù</span>
                                    <span>Default Templates</span>
                                    <span style="opacity: 0.7;">‚Ä¢ <a href="#" onclick="CompanyOnboardingModule.showManager(); closeBulkEmailConfirmation();" style="color: #007bff; text-decoration: none;">Set up company data</a> for personalization</span>
                                </div>
                            `}
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <button id="toggleSelectAll" onclick="toggleAllContacts()" style="background: #1a73e8; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 13px; cursor: pointer; font-weight: 500;">
                                Deselect All
                            </button>
                            <button onclick="sendSelectedEmails()" style="background: #137333; color: white; border: none; padding: 8px 20px; border-radius: 6px; font-size: 14px; cursor: pointer; font-weight: 500;">
                                Send Selected Emails
                            </button>
                            <button onclick="closeBulkEmailConfirmation()" style="background: none; border: none; font-size: 24px; color: #5f6368; cursor: pointer; padding: 4px; line-height: 1;" title="Close">
                                ‚úï
                            </button>
                        </div>
                    </div>

                    <!-- Email Summary -->
                    <div style="padding: 20px 24px;">
                        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 12px;">
                                <div>
                                    <div style="font-size: 12px; color: #5f6368; margin-bottom: 4px;">FROM</div>
                                    <div style="font-size: 14px; color: #202124;">${escapeHTML(fromEmail)}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #5f6368; margin-bottom: 4px;">RECIPIENTS</div>
                                    <div style="font-size: 14px; color: #202124; font-weight: 500;">${contacts.length} contacts</div>
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #5f6368; margin-bottom: 4px;">SUBJECT TEMPLATE</div>
                                <div style="font-size: 14px; color: #202124;">${escapeHTML(finalSubject)}</div>
                            </div>
                        </div>

                        <!-- Message Preview -->
                        <div style="margin-bottom: 24px;">
                            <h3 style="margin: 0 0 12px 0; color: #202124; font-size: 16px; font-weight: 500;">Message Template</h3>
                            <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; background: white; max-height: 200px; overflow-y: auto;">
                                <div style="font-size: 14px; line-height: 1.5; color: #202124;">${messageHTML}</div>
                            </div>
                        </div>

                        <!-- Attachment Options -->
                        <div style="margin-bottom: 24px;">
                            <h3 style="margin: 0 0 12px 0; color: #202124; font-size: 16px; font-weight: 500;">üìé Attachment Options</h3>
                            <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; background: white;">
                                <!-- Global Attachment -->
                                <div style="margin-bottom: 16px;">
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <input type="checkbox" id="bulkGlobalAttachment" style="margin-right: 8px;">
                                        <label for="bulkGlobalAttachment" style="font-weight: 500; color: #202124;">Send same attachment to all contacts</label>
                                    </div>
                                    <input type="file" id="bulkGlobalAttachmentFile" multiple style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" disabled>
                                    <div style="font-size: 12px; color: #5f6368; margin-top: 4px;">Select files to attach to all emails (max 10MB per file)</div>
                                </div>

                                <!-- Individual Attachments -->
                                <div>
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <input type="checkbox" id="bulkIndividualAttachments" style="margin-right: 8px;">
                                        <label for="bulkIndividualAttachments" style="font-weight: 500; color: #202124;">Individual attachments per contact</label>
                                    </div>
                                    <div style="font-size: 12px; color: #5f6368; margin-bottom: 8px;">When enabled, you can add specific attachments for each contact in the contact list below</div>
                                    <div id="bulkAttachmentNote" style="background: #e3f2fd; border: 1px solid #bbdefb; border-radius: 4px; padding: 8px; font-size: 12px; color: #1565c0; display: none;">
                                        Individual attachment options will appear for each contact in the list below when this is enabled.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- All Contacts with Personalized Content -->
                        <div style="margin-bottom: 24px;">
                            <h3 style="margin: 0 0 12px 0; color: #202124; font-size: 16px; font-weight: 500;">All Contacts - Personalized Emails Ready to Send</h3>
                            <div style="font-size: 12px; color: #5f6368; margin-bottom: 12px;">Review all ${contacts.length} personalized emails. You can send to all contacts or select individual contacts to send.</div>

                            <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px;">
                                ${emailPreviews.map((preview, index) => `
                                    <div style="border-bottom: 1px solid #f0f0f0; overflow: hidden;" id="contact-${index}">
                                        <div style="background: #f8f9fa; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center;">
                                            <div style="flex: 1;">
                                                <div style="font-size: 14px; font-weight: 500; color: #202124;">
                                                    <input type="checkbox" id="contact-checkbox-${index}" checked style="margin-right: 8px;">
                                                    ${escapeHTML(preview.contact.contactName || 'N/A')} (${escapeHTML(preview.contact.email)})
                                                </div>
                                                <div style="font-size: 12px; color: #5f6368; display: flex; align-items: center; gap: 8px;">
                                                    <span>${escapeHTML(preview.contact.firm || 'N/A')} ‚Ä¢ ${escapeHTML(preview.contact.country || 'N/A')}</span>
                                                    ${isUsingPersonalizedTemplate ?
                                                        '<span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: 500;">‚ú® PERSONALIZED</span>' :
                                                        '<span style="background: #e9ecef; color: #6c757d; padding: 2px 6px; border-radius: 3px; font-size: 10px;">üìù DEFAULT</span>'
                                                    }
                                                </div>
                                            </div>
                                            <button onclick="sendIndividualEmail(${index})" style="background: #1a73e8; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">Send Now</button>
                                        </div>
                                        <div style="padding: 12px 16px; background: white;">
                                            <div style="margin-bottom: 8px;">
                                                <div style="font-size: 11px; color: #5f6368; margin-bottom: 2px;">TO:</div>
                                                <div style="font-size: 13px; color: #202124;">${escapeHTML(preview.contact.email)}</div>
                                            </div>
                                            <div style="margin-bottom: 8px;">
                                                <div style="font-size: 11px; color: #5f6368; margin-bottom: 2px;">SUBJECT:</div>
                                                <div style="font-size: 13px; color: #202124; font-weight: 500;">${escapeHTML(preview.subject)}</div>
                                            </div>
                                            <div>
                                                <div style="font-size: 11px; color: #5f6368; margin-bottom: 2px;">MESSAGE:</div>
                                                <div style="font-size: 12px; color: #202124; line-height: 1.4; max-height: 80px; overflow-y: auto; border: 1px solid #e0e0e0; padding: 8px; border-radius: 4px;">${preview.messageHTML}</div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Warning Notice -->
                        <div style="background: #fef7e0; border: 1px solid #fdd835; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <div style="font-size: 18px; color: #f57f17; margin-top: 2px;">‚ö†Ô∏è</div>
                                <div>
                                    <div style="font-size: 14px; font-weight: 500; color: #f57f17; margin-bottom: 4px;">Important Notice</div>
                                    <div style="font-size: 13px; color: #795548; line-height: 1.4;">
                                        ‚Ä¢ This will send <strong>${contacts.length} individual emails</strong><br>
                                        ‚Ä¢ Each email will be personalized with contact-specific information<br>
                                        ‚Ä¢ Please ensure you have permission to contact all recipients<br>
                                        ‚Ä¢ This action cannot be undone once started
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            `;

            document.body.appendChild(modal);

            // Store email previews globally for later use
            window.bulkEmailPreviews = emailPreviews;

            // Setup attachment event handlers
            setupBulkAttachmentHandlers();
        }

        function closeBulkEmailConfirmation() {
            const modal = document.getElementById('bulkEmailConfirmModal');
            if (modal) {
                modal.remove();
            }
            window.bulkEmailPreviews = null;
        }

        function setupBulkAttachmentHandlers() {
            const globalAttachmentCheckbox = document.getElementById('bulkGlobalAttachment');
            const globalAttachmentFile = document.getElementById('bulkGlobalAttachmentFile');
            const individualAttachmentsCheckbox = document.getElementById('bulkIndividualAttachments');
            const attachmentNote = document.getElementById('bulkAttachmentNote');

            // Handle global attachment checkbox
            globalAttachmentCheckbox.addEventListener('change', function() {
                globalAttachmentFile.disabled = !this.checked;
                if (!this.checked) {
                    globalAttachmentFile.value = '';
                }
            });

            // Handle individual attachments checkbox
            individualAttachmentsCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    attachmentNote.style.display = 'block';
                    addIndividualAttachmentFields();
                } else {
                    attachmentNote.style.display = 'none';
                    removeIndividualAttachmentFields();
                }
            });
        }

        function addIndividualAttachmentFields() {
            // Add attachment input for each contact in the list
            const contactItems = document.querySelectorAll('[id^="contact-"]');
            contactItems.forEach((contactItem, index) => {
                const contactId = `contact-${index}`;
                let attachmentDiv = contactItem.querySelector('.individual-attachment');

                if (!attachmentDiv) {
                    attachmentDiv = document.createElement('div');
                    attachmentDiv.className = 'individual-attachment';
                    attachmentDiv.style.cssText = 'margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px;';

                    attachmentDiv.innerHTML = `
                        <div style="font-size: 12px; font-weight: 500; color: #5f6368; margin-bottom: 4px;">üìé Individual Attachment:</div>
                        <input type="file" id="attachment-${index}" multiple style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 3px; font-size: 12px;">
                        <div style="font-size: 11px; color: #666; margin-top: 2px;">Max 10MB per file</div>
                    `;

                    contactItem.appendChild(attachmentDiv);
                }
            });
        }

        function removeIndividualAttachmentFields() {
            // Remove all individual attachment fields
            const attachmentDivs = document.querySelectorAll('.individual-attachment');
            attachmentDivs.forEach(div => div.remove());
        }

        function selectAllContacts() {
            const checkboxes = document.querySelectorAll('[id^="contact-checkbox-"]');
            checkboxes.forEach(checkbox => checkbox.checked = true);
            updateSelectedCount();
        }

        function deselectAllContacts() {
            const checkboxes = document.querySelectorAll('[id^="contact-checkbox-"]');
            checkboxes.forEach(checkbox => checkbox.checked = false);
            updateSelectedCount();
        }

        function toggleAllContacts() {
            const checkboxes = document.querySelectorAll('[id^="contact-checkbox-"]');
            const toggleButton = document.getElementById('toggleSelectAll');
            const allSelected = Array.from(checkboxes).every(cb => cb.checked);

            if (allSelected) {
                checkboxes.forEach(checkbox => checkbox.checked = false);
                toggleButton.textContent = 'Select All';
                toggleButton.style.background = '#1a73e8';
            } else {
                checkboxes.forEach(checkbox => checkbox.checked = true);
                toggleButton.textContent = 'Deselect All';
                toggleButton.style.background = '#ea4335';
            }
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('[id^="contact-checkbox-"]');
            const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            const countElement = document.getElementById('selected-count');
            if (countElement) {
                countElement.textContent = selectedCount;
            }
        }

        async function sendIndividualEmail(index) {
            if (!window.bulkEmailPreviews || !window.bulkEmailPreviews[index]) {
                showAlert('Email data not found', 'error');
                return;
            }

            const preview = window.bulkEmailPreviews[index];
            const contact = preview.contact;

            try {
                console.log(`Sending individual email to: ${contact.email}`);
                // Send email using the personalized content from preview
                const emailResult = await sendRealEmail(contact, preview.subject, preview.messageHTML);

                if (emailResult.success) {
                    showAlert(`Email sent successfully to ${contact.email}`, 'success');

                    // Update the contact row to show sent status
                    const contactRow = document.getElementById(`contact-${index}`);
                    if (contactRow) {
                        contactRow.style.backgroundColor = '#e8f5e8';
                        const sendButton = contactRow.querySelector('button');
                        if (sendButton) {
                            sendButton.textContent = 'Sent ‚úì';
                            sendButton.style.backgroundColor = '#28a745';
                            sendButton.disabled = true;
                        }
                    }

                    // Add to email history
                    addToEmailHistory(contact.email, preview.subject, 'sent', Date.now(), contact.country);
                } else {
                    showAlert(`Failed to send email to ${contact.email}: ${emailResult.error}`, 'error');
                    addToEmailHistory(contact.email, preview.subject, 'failed', Date.now(), contact.country);
                }
            } catch (error) {
                console.error('Error sending individual email:', error);
                showAlert(`Error sending email to ${contact.email}`, 'error');
            }
        }

        async function sendSelectedEmails() {
            const checkboxes = document.querySelectorAll('[id^="contact-checkbox-"]');
            const selectedIndices = Array.from(checkboxes)
                .map((checkbox, index) => checkbox.checked ? index : null)
                .filter(index => index !== null);

            if (selectedIndices.length === 0) {
                showAlert('Please select at least one contact to send emails', 'error');
                return;
            }

            // Store email previews before closing modal
            const emailPreviews = window.bulkEmailPreviews;
            if (!emailPreviews) {
                showAlert('Email data not found. Please try again.', 'error');
                return;
            }

            closeBulkEmailConfirmation();

            // Initialize bulk email session for selected contacts
            bulkEmailInProgress = true;
            bulkEmailPaused = false;
            bulkEmailCancelled = false;
            bulkEmailCurrentIndex = 0;
            bulkEmailTotal = selectedIndices.length;
            bulkEmailSuccessCount = 0;
            bulkEmailFailureCount = 0;

            // Show progress modal (after setting bulkEmailTotal)
            showBulkEmailProgress();

            // Update UI
            const bulkBtn = document.getElementById('bulkSendBtn');
            bulkBtn.innerHTML = 'Pause';
            bulkBtn.onclick = () => pauseBulkEmail();
            document.getElementById('sendBtn').disabled = true;

            // Send emails to selected contacts
            for (let i = 0; i < selectedIndices.length && !bulkEmailCancelled; i++) {
                if (bulkEmailPaused) {
                    await new Promise(resolve => {
                        const checkPause = () => {
                            if (!bulkEmailPaused || bulkEmailCancelled) {
                                resolve();
                            } else {
                                setTimeout(checkPause, 1000);
                            }
                        };
                        checkPause();
                    });
                }

                if (bulkEmailCancelled) break;

                const contactIndex = selectedIndices[i];
                const preview = emailPreviews[contactIndex];
                const contact = preview.contact;

                // Set current contact for progress display
                window.currentSendingContact = contact;
                bulkEmailCurrentIndex = i + 1;
                updateBulkEmailProgress();

                try {
                    // Parse multiple emails from contact.email field (same logic as processBulkEmails)
                    const emailAddresses = parseMultipleEmails(contact.email);
                    console.log(`Contact ${contact.firm} has ${emailAddresses.length} email(s):`, emailAddresses);

                    let contactSuccessCount = 0;
                    let contactFailureCount = 0;

                    // Send email to each address for this contact
                    for (let emailIndex = 0; emailIndex < emailAddresses.length; emailIndex++) {
                        const emailAddress = emailAddresses[emailIndex];

                        // Update progress display with current email
                        window.currentSendingContact = { ...contact, email: emailAddress };
                        updateBulkEmailProgress();

                        console.log(`Sending email ${i + 1}/${selectedIndices.length} to: ${emailAddress} (${emailIndex + 1}/${emailAddresses.length})`);

                        // Get email template content from form fields
                        const subjectTemplate = document.getElementById('subject').value || '';
                        const messageBodyElement = document.getElementById('messageBody');

                        // Get the actual content from the message body (the email template)
                        let messageTemplate = '';
                        if (messageBodyElement) {
                            messageTemplate = messageBodyElement.innerHTML || messageBodyElement.textContent || messageBodyElement.innerText || '';
                            messageTemplate = messageTemplate.trim();
                        }

                        // If no template content, use default business template
                        const finalSubject = subjectTemplate || 'Business Partnership Opportunity - {firm} in {country}';
                        const finalMessage = messageTemplate || 'Dear {contactName},<br><br>I hope this message finds you well. I am reaching out regarding a potential business partnership opportunity with {firm}.<br><br>Best regards,<br>Intex Technologies';

                        // Create a copy of contact with current email
                        const contactCopy = { ...contact, email: emailAddress };

                        // Personalize the templates with contact-specific data using enhanced engine
                        const contactCopyForPersonalization = { ...contact, email: emailAddress };
                        const personalizedSubject = personalizeEmailContent(finalSubject, contactCopyForPersonalization);
                        const personalizedMessage = personalizeEmailContent(finalMessage, contactCopyForPersonalization);

                        // Send actual email with preserved formatting
                        const emailResult = await sendRealEmail(contactCopy, personalizedSubject, personalizedMessage);

                        if (emailResult.success) {
                            contactSuccessCount++;
                            addToEmailHistory(emailAddress, personalizedSubject, 'sent', Date.now(), contact.country);
                        } else {
                            contactFailureCount++;
                            addToEmailHistory(emailAddress, personalizedSubject, 'failed', Date.now(), contact.country);
                        }

                        // Rate limiting between emails for same contact
                        if (emailIndex < emailAddresses.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 1000)); // 1 second between emails for same contact
                        }
                    }

                    // Update contact status based on overall success
                    if (contactSuccessCount > 0 && contactFailureCount === 0) {
                        contact.emailStatus = 'sent';
                        bulkEmailSuccessCount++;
                    } else if (contactSuccessCount > 0 && contactFailureCount > 0) {
                        contact.emailStatus = 'partial'; // New status for partial success
                        bulkEmailSuccessCount++;
                    } else {
                        contact.emailStatus = 'failed';
                        bulkEmailFailureCount++;
                    }

                    // Update overall counters
                    bulkEmailSuccessCount += Math.max(0, contactSuccessCount - 1); // -1 because we already added 1 above
                    bulkEmailFailureCount += contactFailureCount;

                    // Rate limiting - delay between contacts
                    await new Promise(resolve => setTimeout(resolve, 2000)); // 2 second delay

                } catch (error) {
                    console.error('Error sending emails to contact:', contact.email, error);
                    bulkEmailFailureCount++;
                    contact.emailStatus = 'failed';
                    addToEmailHistory(contact.email, 'Failed to send', 'failed', Date.now(), contact.country);
                }
            }

            // Clean up current sending contact reference
            window.currentSendingContact = null;

            // Complete bulk email session
            completeBulkEmail();
        }

        function confirmBulkEmailSending() {
            closeBulkEmailConfirmation();
            startBulkEmailSending();
        }

        async function startBulkEmailSending() {
            if (bulkEmailInProgress) {
                showAlert('Bulk email is already in progress', 'error');
                return;
            }

            if (contacts.length === 0) {
                showAlert('No contacts available for bulk email. Please upload contacts first.', 'error');
                return;
            }

            // Validate email fields
            const fromEmailValid = validateEmail(document.getElementById('fromEmail'));
            const subjectValid = validateSubject(document.getElementById('subject'));
            const messageValid = validateMessage(document.getElementById('messageBody'));

            if (!fromEmailValid || !subjectValid || !messageValid) {
                showAlert('Please fix all validation errors before sending bulk emails', 'error');
                return;
            }

            // Initialize bulk email session
            bulkEmailInProgress = true;
            bulkEmailPaused = false;
            bulkEmailCancelled = false;
            bulkEmailCurrentIndex = 0;
            bulkEmailTotal = contacts.length;
            bulkEmailSuccessCount = 0;
            bulkEmailFailureCount = 0;

            // Update UI
            const bulkBtn = document.getElementById('bulkSendBtn');
            bulkBtn.innerHTML = 'Pause';
            bulkBtn.onclick = () => pauseBulkEmail();
            document.getElementById('sendBtn').disabled = true;

            // Show progress modal
            showBulkEmailProgress();

            // Start sending
            await processBulkEmails();
        }

        function parseMultipleEmails(emailString) {
            if (!emailString) return [];

            // Split by multiple delimiters: / ; , :
            const emails = emailString
                .split(/[\/;,:]+/)
                .map(email => email.trim())
                .filter(email => email.length > 0)
                .filter(email => {
                    // Basic email validation
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    return emailRegex.test(email);
                });

            // Return unique emails only
            return [...new Set(emails)];
        }

        async function processBulkEmails() {
            while (bulkEmailCurrentIndex < bulkEmailTotal && !bulkEmailCancelled) {
                if (bulkEmailPaused) {
                    await new Promise(resolve => {
                        const checkPause = () => {
                            if (!bulkEmailPaused || bulkEmailCancelled) {
                                resolve();
                            } else {
                                setTimeout(checkPause, 1000);
                            }
                        };
                        checkPause();
                    });
                }

                if (bulkEmailCancelled) break;

                const contact = contacts[bulkEmailCurrentIndex];
                updateBulkEmailProgress();

                try {
                    // Parse multiple emails from contact.email field
                    const emailAddresses = parseMultipleEmails(contact.email);
                    console.log(`Contact ${contact.firm} has ${emailAddresses.length} email(s):`, emailAddresses);

                    let contactSuccessCount = 0;
                    let contactFailureCount = 0;

                    // Send email to each address for this contact
                    for (let emailIndex = 0; emailIndex < emailAddresses.length; emailIndex++) {
                        const emailAddress = emailAddresses[emailIndex];

                        // Create a copy of contact with current email
                        const contactCopy = { ...contact, email: emailAddress };

                        // Get personalized subject and message using enhanced engine
                        const contactCopyForPersonalization = { ...contact, email: emailAddress };
                        const personalizedSubject = personalizeEmailContent(document.getElementById('subject').value, contactCopyForPersonalization);
                        const personalizedMessage = personalizeEmailContent(document.getElementById('messageBody').innerHTML, contactCopyForPersonalization);

                        // Send actual email with preserved formatting
                        const emailResult = await sendRealEmail(contactCopy, personalizedSubject, personalizedMessage);
                        const success = emailResult.success;

                        if (success) {
                            contactSuccessCount++;
                            addToEmailHistory(emailAddress, personalizedSubject, 'sent', Date.now(), contact.country);
                        } else {
                            contactFailureCount++;
                            addToEmailHistory(emailAddress, personalizedSubject, 'failed', Date.now(), contact.country);
                        }

                        // Rate limiting between emails for same contact
                        if (emailIndex < emailAddresses.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 1000)); // 1 second between emails for same contact
                        }
                    }

                    // Update contact status based on overall success
                    if (contactSuccessCount > 0 && contactFailureCount === 0) {
                        contact.emailStatus = 'sent';
                        bulkEmailSuccessCount++;
                    } else if (contactSuccessCount > 0 && contactFailureCount > 0) {
                        contact.emailStatus = 'partial'; // New status for partial success
                        bulkEmailSuccessCount++;
                    } else {
                        contact.emailStatus = 'failed';
                        bulkEmailFailureCount++;
                    }

                    // Update overall counters
                    bulkEmailSuccessCount += Math.max(0, contactSuccessCount - 1); // -1 because we already added 1 above
                    bulkEmailFailureCount += contactFailureCount;

                    // Rate limiting - delay between contacts
                    await new Promise(resolve => setTimeout(resolve, 2000)); // 2 second delay

                } catch (error) {
                    console.error('Error sending emails to contact:', contact.email, error);
                    bulkEmailFailureCount++;
                    contact.emailStatus = 'failed';
                    addToEmailHistory(contact.email, 'Failed to send', 'failed', Date.now(), contact.country);
                }

                bulkEmailCurrentIndex++;
                // Update progress after each email is processed
                updateBulkEmailProgress();
            }

            // Final progress update to show 100% completion
            updateBulkEmailProgress();

            // Complete bulk email session
            completeBulkEmail();
        }

        async function sendRealEmail(contact, subject, messageHTML) {
            try {
                // Prepare email data with proper formatting preservation
                const emailData = {
                    from_email: 'info@datanalysisninsights.co.uk', // Always use authorized domain
                    from_name: 'Intex Technologies', // Brand name
                    to_email: contact.email,
                    to_name: contact.contactName,
                    subject: subject,
                    html_content: messageHTML, // Preserve HTML formatting
                    text_content: stripHTML(messageHTML), // Plain text fallback
                    company: contact.firm,
                    country: contact.country,
                    reply_to: 'Intex Technologies <info@datanalysisninsights.co.uk>' // Use company name with email for replies
                };

                console.log('Sending email to:', contact.email);

                // Use Netlify function for email sending
                const emailServices = [
                    () => sendViaNetlifyFunction(emailData)
                ];

                let lastError = null;
                for (let i = 0; i < emailServices.length; i++) {
                    const serviceName = ['Netlify'][i];
                    console.log(`üîÑ Trying ${serviceName} service...`);

                    try {
                        const result = await emailServices[i]();
                        console.log(`‚úÖ ${serviceName} service result:`, result);

                        if (result.success) {
                            console.log(`‚úÖ Email sent successfully via ${serviceName}!`);
                            return { success: true, service: result.service || serviceName };
                        } else {
                            console.log(`‚ùå ${serviceName} returned failure:`, result.error);
                        }
                    } catch (error) {
                        console.log(`‚ùå ${serviceName} service failed:`, error.message);
                        console.log(`üìã Full error details:`, error);
                        lastError = error;
                        continue;
                    }
                }

                // If all services fail, return error with helpful message
                console.error('All email services failed:', lastError);
                const errorMessage = 'Email services not configured. To send real emails, please configure EmailJS, Formspree, or a custom webhook in the Email Configuration settings.';
                return { success: false, error: errorMessage };

            } catch (error) {
                console.error('Email sending error:', error);
                return { success: false, error: error.message };
            }
        }

        function stripHTML(html) {
            const div = document.createElement('div');
            div.innerHTML = html;
            return div.textContent || div.innerText || '';
        }

        // Helper function to convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]); // Remove data:mime;base64, prefix
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Zoho Mail SMTP Integration (via Netlify Function)
        async function sendViaZoho(emailData) {
            if (!EMAIL_CONFIG.zoho.enabled) {
                throw new Error('Zoho Mail service disabled');
            }

            if (!EMAIL_CONFIG.zoho.email || !EMAIL_CONFIG.zoho.password) {
                throw new Error('Zoho Mail credentials not configured. Please set up in Email Configuration.');
            }

            try {
                console.log('üìß Sending email via Zoho Mail SMTP...');

                // Prepare Zoho SMTP data
                const zohoData = {
                    ...emailData,
                    smtp_config: {
                        host: EMAIL_CONFIG.zoho.smtp,
                        port: EMAIL_CONFIG.zoho.port,
                        secure: false, // true for 465, false for other ports
                        auth: {
                            user: EMAIL_CONFIG.zoho.email,
                            pass: EMAIL_CONFIG.zoho.password
                        }
                    }
                };

                // Add attachments if any exist
                if (attachments.length > 0) {
                    const attachmentData = [];
                    for (const attachment of attachments) {
                        try {
                            const base64Data = await fileToBase64(attachment.file);
                            attachmentData.push({
                                filename: attachment.name,
                                content: base64Data,
                                contentType: attachment.type,
                                size: attachment.size
                            });
                        } catch (error) {
                            console.warn(`Failed to process attachment ${attachment.name}:`, error);
                        }
                    }
                    zohoData.attachments = attachmentData;
                    console.log(`üìé Including ${attachmentData.length} attachments in Zoho email`);
                }

                // Send via Netlify function
                const response = await fetch('/.netlify/functions/send-zoho-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(zohoData)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || `HTTP ${response.status}: ${response.statusText}`);
                }

                if (result.success) {
                    console.log(`‚úÖ Email sent successfully via Zoho Mail: ${result.messageId}`);
                    return { success: true, service: 'Zoho Mail SMTP', messageId: result.messageId };
                } else {
                    throw new Error(result.error || 'Unknown error from Zoho Mail service');
                }

            } catch (error) {
                console.error('‚ùå Zoho Mail sending failed:', error);
                throw new Error(`Zoho Mail failed: ${error.message}`);
            }
        }

        // EmailJS Integration (Free tier: 200 emails/month)
        async function sendViaEmailJS(emailData) {
            if (!EMAIL_CONFIG.emailjs.enabled) {
                throw new Error('EmailJS service disabled');
            }

            if (typeof emailjs === 'undefined') {
                throw new Error('EmailJS not loaded');
            }

            try {
                // Initialize EmailJS if not already done
                if (!window.emailjsInitialized) {
                    emailjs.init(EMAIL_CONFIG.emailjs.publicKey);
                    window.emailjsInitialized = true;
                }

                // Prepare attachments for EmailJS (convert to base64)
                const attachmentData = [];
                for (const attachment of attachments) {
                    try {
                        const base64Data = await fileToBase64(attachment.file);
                        attachmentData.push({
                            name: attachment.name,
                            data: base64Data,
                            type: attachment.type
                        });
                    } catch (error) {
                        console.warn(`Failed to process attachment ${attachment.name}:`, error);
                    }
                }

                const emailParams = {
                    from_name: emailData.from_name,
                    from_email: emailData.from_email,
                    to_name: emailData.to_name,
                    to_email: emailData.to_email,
                    subject: emailData.subject,
                    message: emailData.html_content,
                    company: emailData.company,
                    country: emailData.country
                };

                // Add attachments if any exist
                if (attachmentData.length > 0) {
                    emailParams.attachments = JSON.stringify(attachmentData);
                    emailParams.attachment_count = attachmentData.length;
                    console.log(`üìé Including ${attachmentData.length} attachments in email`);
                }

                const result = await emailjs.send(
                    EMAIL_CONFIG.emailjs.serviceId,
                    EMAIL_CONFIG.emailjs.templateId,
                    emailParams
                );

                return { success: true, service: 'EmailJS', messageId: result.text };
            } catch (error) {
                throw new Error(`EmailJS failed: ${error.message}`);
            }
        }

        // Netlify Functions Integration
        async function sendViaNetlifyFunction(emailData) {
            console.log('üöÄ Starting Netlify function call...');

            if (!EMAIL_CONFIG.netlify.enabled) {
                throw new Error('Netlify service disabled');
            }

            console.log('üì° Netlify endpoint:', EMAIL_CONFIG.netlify.endpoint);
            // Transform data to match existing function format
            const transformedData = {
                from_email: emailData.from_email,
                from_name: emailData.from_name,
                to_email: emailData.to_email,
                subject: emailData.subject,
                content: emailData.html_content || emailData.text_content
            };

            console.log('üìß Email data being sent:', {
                to_email: transformedData.to_email,
                from_email: transformedData.from_email,
                subject: transformedData.subject
            });

            try {
                const response = await fetch(EMAIL_CONFIG.netlify.endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(transformedData)
                });

                console.log('üì° Response status:', response.status, response.statusText);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå HTTP Error Response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
                }

                const result = await response.json();
                console.log('üì¶ Netlify function response:', result);

                if (result.success) {
                    return { success: true, service: 'Netlify', messageId: result.messageId };
                } else {
                    console.error('‚ùå Netlify function returned failure:', result);
                    throw new Error(result.error || 'Netlify function failed');
                }
            } catch (error) {
                console.error('üí• Netlify function error:', error);
                throw new Error(`Netlify function failed: ${error.message}`);
            }
        }

        // Formspree Integration (Free tier: 50 submissions/month)
        async function sendViaFormspree(emailData) {
            if (!EMAIL_CONFIG.formspree.enabled) {
                throw new Error('Formspree service disabled');
            }

            try {
                const response = await fetch(EMAIL_CONFIG.formspree.endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: emailData.from_email,
                        name: emailData.from_name,
                        subject: emailData.subject,
                        message: emailData.html_content,
                        recipient: emailData.to_email,
                        _replyto: emailData.from_email
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return { success: true, service: 'Formspree' };
            } catch (error) {
                throw new Error(`Formspree failed: ${error.message}`);
            }
        }

        // Custom Webhook Integration
        async function sendViaWebhook(emailData) {
            if (!EMAIL_CONFIG.webhook.enabled) {
                throw new Error('Webhook service disabled');
            }

            try {
                // Include attachments in webhook data
                const webhookData = { ...emailData };

                // Add attachments if any exist
                if (attachments.length > 0) {
                    const attachmentData = [];
                    for (const attachment of attachments) {
                        try {
                            const base64Data = await fileToBase64(attachment.file);
                            attachmentData.push({
                                name: attachment.name,
                                data: base64Data,
                                type: attachment.type,
                                size: attachment.size
                            });
                        } catch (error) {
                            console.warn(`Failed to process attachment ${attachment.name}:`, error);
                        }
                    }
                    webhookData.attachments = attachmentData;
                    console.log(`üìé Including ${attachmentData.length} attachments in webhook`);
                }

                const response = await fetch(EMAIL_CONFIG.webhook.endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${EMAIL_CONFIG.webhook.apiKey}`
                    },
                    body: JSON.stringify(webhookData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                return { success: true, service: 'Webhook', messageId: result.id };
            } catch (error) {
                throw new Error(`Webhook failed: ${error.message}`);
            }
        }

        function pauseBulkEmail() {
            if (bulkEmailPaused) {
                // Resume
                bulkEmailPaused = false;
                const bulkBtn = document.getElementById('bulkSendBtn');
                const modalBtn = document.getElementById('bulkPauseResumeBtn');

                if (bulkBtn) bulkBtn.innerHTML = 'Pause';
                if (modalBtn) {
                    modalBtn.innerHTML = 'Pause';
                    modalBtn.style.background = '#ffc107';
                    modalBtn.style.color = 'black';
                }
                showAlert('üì§ Bulk email resumed', 'success');
            } else {
                // Pause
                bulkEmailPaused = true;
                const bulkBtn = document.getElementById('bulkSendBtn');
                const modalBtn = document.getElementById('bulkPauseResumeBtn');

                if (bulkBtn) bulkBtn.innerHTML = 'Resume';
                if (modalBtn) {
                    modalBtn.innerHTML = 'Resume';
                    modalBtn.style.background = '#28a745';
                    modalBtn.style.color = 'white';
                }
                showAlert('‚è∏Ô∏è Bulk email paused', 'warning');
            }
        }

        function cancelBulkEmail() {
            bulkEmailCancelled = true;
            completeBulkEmail();
            showAlert('Bulk email cancelled', 'error');
        }

        function completeBulkEmail() {
            bulkEmailInProgress = false;
            bulkEmailPaused = false;

            // Update UI
            const bulkBtn = document.getElementById('bulkSendBtn');
            bulkBtn.innerHTML = 'Bulk Email';
            bulkBtn.onclick = () => showBulkEmailConfirmation();
            document.getElementById('sendBtn').disabled = false;

            // Hide progress modal
            hideBulkEmailProgress();

            // Update contact list to show email statuses
            renderContacts();
            updateContactCounts();

            // Update analytics
            updateAnalytics();
            renderEmailHistory();

            // Show completion message
            if (!bulkEmailCancelled) {
                showAlert(`Bulk email complete! ${bulkEmailSuccessCount} sent, ${bulkEmailFailureCount} failed`, 'success');
                // Play completion sound
                try {
                    // Create a simple success notification sound
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);
                    oscillator.frequency.setValueAtTime(1200, audioContext.currentTime + 0.2);

                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                } catch (e) {
                    // Ignore sound errors
                }
            }
        }

        function showBulkEmailProgress() {
            const modal = document.createElement('div');
            modal.id = 'bulkEmailModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
                z-index: 10000;
            `;

            modal.innerHTML = `
                <div id="bulkProgressContainer" style="background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #007bff;">üìß Bulk Email Progress</h3>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <button id="minimizeProgressBtn" onclick="minimizeBulkProgress()" style="background: #6c757d; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">Minimize</button>
                            <button onclick="cancelBulkEmail()" class="modal-close-btn" title="Close">√ó</button>
                        </div>
                    </div>
                    <div id="bulkProgressText" style="margin-bottom: 15px; font-size: 14px;">Preparing to send...</div>
                    <div style="background: #f0f0f0; border-radius: 4px; height: 20px; margin-bottom: 15px; overflow: hidden;">
                        <div id="bulkProgressBar" style="background: #007bff; height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-bottom: 20px;">
                        <span>‚úÖ Success: <span id="bulkSuccessCount">0</span></span>
                        <span>‚ùå Failed: <span id="bulkFailedCount">0</span></span>
                        <span>üìä Total: <span id="bulkTotalCount">${bulkEmailTotal}</span></span>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button id="bulkPauseResumeBtn" onclick="pauseBulkEmail()" style="background: #ffc107; color: black; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 500;">Pause</button>
                        <button onclick="cancelBulkEmail()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Cancel</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function updateBulkEmailProgress() {
            const progressText = document.getElementById('bulkProgressText');
            const progressBar = document.getElementById('bulkProgressBar');
            const successCount = document.getElementById('bulkSuccessCount');
            const failedCount = document.getElementById('bulkFailedCount');
            const minimizedIndicator = document.getElementById('bulkProgressMinimized');

            if (progressText) {
                // Handle both selected emails (sendSelectedEmails) and full bulk processing (processBulkEmails)
                let contact;
                if (window.currentSendingContact) {
                    // Use the contact that's currently being processed
                    contact = window.currentSendingContact;
                } else if (contacts[bulkEmailCurrentIndex]) {
                    // Fall back to index-based lookup for full bulk processing
                    contact = contacts[bulkEmailCurrentIndex];
                } else {
                    // Safe fallback
                    contact = { contactName: 'Contact', email: 'processing...' };
                }
                progressText.textContent = `Sending to: ${contact.contactName} (${contact.email})`;
            }

            if (progressBar) {
                const percentage = (bulkEmailCurrentIndex / bulkEmailTotal) * 100;
                progressBar.style.width = percentage + '%';
            }

            if (successCount) successCount.textContent = bulkEmailSuccessCount;
            if (failedCount) failedCount.textContent = bulkEmailFailureCount;

            // Update minimized indicator if it exists
            if (minimizedIndicator) {
                const percentage = bulkEmailTotal > 0 ? Math.round((bulkEmailCurrentIndex / bulkEmailTotal) * 100) : 0;
                minimizedIndicator.innerHTML = `üìß ${percentage}% (${bulkEmailSuccessCount}/${bulkEmailTotal})`;
            }
        }

        function hideBulkEmailProgress() {
            const modal = document.getElementById('bulkEmailModal');
            const minimized = document.getElementById('bulkProgressMinimized');

            if (modal) {
                modal.remove();
            }

            if (minimized) {
                minimized.remove();
            }
        }

        function minimizeBulkProgress() {
            const modal = document.getElementById('bulkEmailModal');
            if (modal) {
                modal.style.display = 'none';

                // Create minimized indicator in top-right corner
                const minimizedIndicator = document.createElement('div');
                minimizedIndicator.id = 'bulkProgressMinimized';
                minimizedIndicator.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #007bff;
                    color: white;
                    padding: 10px 15px;
                    border-radius: 20px;
                    cursor: pointer;
                    z-index: 9999;
                    font-size: 12px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                    transition: all 0.3s ease;
                `;

                const percentage = bulkEmailTotal > 0 ? Math.round((bulkEmailCurrentIndex / bulkEmailTotal) * 100) : 0;
                minimizedIndicator.innerHTML = `üìß ${percentage}% (${bulkEmailSuccessCount}/${bulkEmailTotal})`;
                minimizedIndicator.onclick = () => restoreBulkProgress();

                document.body.appendChild(minimizedIndicator);
            }
        }

        function restoreBulkProgress() {
            const modal = document.getElementById('bulkEmailModal');
            const minimized = document.getElementById('bulkProgressMinimized');

            if (modal) {
                modal.style.display = 'flex';
            }

            if (minimized) {
                minimized.remove();
            }
        }

        // Failed Uploads Spreadsheet Functionality
        function showFailedUploadsSpreadsheet() {
            const failedRecords = uploadedSpreadsheetData.filter(row => row.status === 'failed');

            if (failedRecords.length === 0) {
                showAlert('No failed uploads to display', 'info');
                return;
            }

            // Create modal for failed uploads
            const modal = document.createElement('div');
            modal.id = 'failedUploadsModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
                z-index: 10000; padding: 20px;
            `;

            // Generate table HTML
            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Row #</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Email</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Contact Name</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Company</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Country</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Failure Reason</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            failedRecords.forEach((record, index) => {
                const reason = getFailureReason(record);
                tableHTML += `
                    <tr style="${index % 2 === 0 ? 'background: #f9f9f9;' : ''}">
                        <td style="border: 1px solid #ddd; padding: 8px;">${record.originalRowIndex + 1}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${record.email || 'N/A'}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${record.contactName || 'N/A'}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${record.firm || 'N/A'}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${record.country || 'N/A'}</td>
                        <td style="border: 1px solid #ddd; padding: 8px; color: #dc3545;">${reason}</td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            modal.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 8px; max-width: 90%; max-height: 90%; width: 800px; overflow: hidden; display: flex; flex-direction: column;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #dc3545;">‚ùå Failed Uploads Report</h3>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <button onclick="exportFailedUploads()" class="button button-success">Export CSV</button>
                            <button onclick="closeFailedUploadsModal()" class="modal-close-btn" title="Close">√ó</button>
                        </div>
                    </div>
                    <div style="font-size: 14px; margin-bottom: 10px; color: #666;">
                        Total Failed Records: <strong>${failedRecords.length}</strong>
                    </div>
                    <div style="overflow: auto; flex: 1;">
                        ${tableHTML}
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function getFailureReason(record) {
            if (!record.email || record.email.trim() === '') {
                return 'Missing email address';
            }
            if (!EMAIL_REGEX.test(record.email)) {
                return 'Invalid email format';
            }
            if (!record.contactName && !record.firm) {
                return 'Missing contact name and company';
            }
            return 'Data validation failed';
        }

        function closeFailedUploadsModal() {
            const modal = document.getElementById('failedUploadsModal');
            if (modal) {
                modal.remove();
            }
        }

        function exportFailedUploads() {
            const failedRecords = uploadedSpreadsheetData.filter(row => row.status === 'failed');

            if (failedRecords.length === 0) {
                showAlert('No failed uploads to export', 'info');
                return;
            }

            // Create CSV content
            const headers = ['Row Number', 'Email', 'Contact Name', 'Company', 'Country', 'Failure Reason'];
            let csvContent = headers.join(',') + '\n';

            failedRecords.forEach(record => {
                const row = [
                    record.originalRowIndex + 1,
                    record.email || '',
                    record.contactName || '',
                    record.firm || '',
                    record.country || '',
                    getFailureReason(record)
                ].map(field => `"${field.toString().replace(/"/g, '""')}"`).join(',');
                csvContent += row + '\n';
            });

            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `failed_uploads_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            showAlert('Failed uploads exported to CSV', 'success');
        }

        // Contact Status Download Functionality
        function downloadContactStatus() {
            if (contacts.length === 0) {
                showAlert('No contacts to export', 'info');
                return;
            }

            try {
                // Create CSV content with contact status
                const headers = [
                    'Row Number',
                    'Contact Name',
                    'Company',
                    'Email Address',
                    'Country',
                    'Phone',
                    'Website',
                    'Email Status',
                    'Last Updated'
                ];

                let csvContent = headers.join(',') + '\n';

                contacts.forEach((contact, index) => {
                    const row = [
                        index + 1,
                        contact.contactName || '',
                        contact.firm || '',
                        contact.email || '',
                        contact.country || '',
                        contact.phone || '',
                        contact.website || '',
                        contact.emailStatus || 'pending',
                        new Date().toISOString().split('T')[0] // Today's date
                    ].map(field => `"${field.toString().replace(/"/g, '""')}"`).join(',');
                    csvContent += row + '\n';
                });

                // Add summary statistics
                csvContent += '\n';
                csvContent += '"SUMMARY STATISTICS"\n';
                csvContent += `"Total Contacts","${contacts.length}"\n`;
                csvContent += `"Successfully Sent","${contacts.filter(c => c.emailStatus === 'sent').length}"\n`;
                csvContent += `"Failed to Send","${contacts.filter(c => c.emailStatus === 'failed').length}"\n`;
                csvContent += `"Pending/Not Sent","${contacts.filter(c => c.emailStatus === 'pending').length}"\n`;
                csvContent += `"Success Rate","${contacts.length > 0 ? Math.round((contacts.filter(c => c.emailStatus === 'sent').length / contacts.length) * 100) : 0}%"\n`;
                csvContent += `"Export Date","${new Date().toLocaleString()}"\n`;
                csvContent += `"Source Document","${currentUploadedFileName || 'Unknown'}"\n`;

                // Generate filename with document reference
                const sourceFileName = currentUploadedFileName ?
                    currentUploadedFileName.replace(/\.[^/.]+$/, '') : // Remove extension
                    'contacts';
                const timestamp = new Date().toISOString().split('T')[0];
                const filename = `${sourceFileName}_contact_status_${timestamp}.csv`;

                // Download CSV
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                const successRate = contacts.length > 0 ? Math.round((contacts.filter(c => c.emailStatus === 'sent').length / contacts.length) * 100) : 0;
                showAlert(`Contact status exported! (${contacts.length} contacts, ${successRate}% success rate)`, 'success');

            } catch (error) {
                console.error('Error exporting contact status:', error);
                showAlert('Failed to export contact status', 'error');
            }
        }

        // Secure Data Persistence Functions
        async function saveToLocalStorage() {
            try {
                if (!autoSaveEnabled) return;

                // Sanitize all data before encryption
                const sanitizedContacts = contacts.map(contact => ({
                    email: sanitizeEmail(contact.email),
                    contactName: sanitizeText(contact.contactName),
                    firm: sanitizeText(contact.firm),
                    country: sanitizeText(contact.country),
                    phone: sanitizeText(contact.phone),
                    website: sanitizeText(contact.website),
                    address: sanitizeText(contact.address),
                    emailStatus: contact.emailStatus || 'pending'
                }));

                const sanitizedEmailHistory = emailHistory.map(entry => ({
                    id: entry.id,
                    toEmails: Array.isArray(entry.toEmails) ? entry.toEmails.map(sanitizeEmail) : [sanitizeEmail(entry.toEmails)],
                    subject: sanitizeSubject(entry.subject),
                    status: entry.status,
                    timestamp: entry.timestamp,
                    country: sanitizeText(entry.country),
                    content: sanitizeHTML(entry.content)
                }));

                const dataToSave = {
                    contacts: sanitizedContacts,
                    emailHistory: sanitizedEmailHistory,
                    uploadedSpreadsheetData: uploadedSpreadsheetData,
                    savedAt: Date.now(),
                    version: '2.2'
                };

                // Encrypt data before storing
                const encryptedData = await encryptData(dataToSave);
                localStorage.setItem(STORAGE_KEYS.CONTACTS, encryptedData);
                lastAutoSave = Date.now();
                console.log('Data encrypted and saved to localStorage');
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                showAlert('Failed to save data locally', 'error');
            }
        }

        async function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEYS.CONTACTS);
                if (!savedData) return false;

                // Decrypt data
                const parsedData = await decryptData(savedData);
                if (!parsedData || !parsedData.contacts || !Array.isArray(parsedData.contacts)) return false;

                // Validate and sanitize loaded data
                const validatedContacts = parsedData.contacts
                    .filter(contact => contact.email && EMAIL_REGEX.test(contact.email))
                    .map(contact => ({
                        email: sanitizeEmail(contact.email),
                        contactName: sanitizeText(contact.contactName),
                        firm: sanitizeText(contact.firm),
                        country: sanitizeText(contact.country),
                        phone: sanitizeText(contact.phone),
                        website: sanitizeText(contact.website),
                        address: sanitizeText(contact.address),
                        emailStatus: contact.emailStatus || 'pending'
                    }));

                // Restore data
                contacts = validatedContacts;
                emailHistory = parsedData.emailHistory || [];
                uploadedSpreadsheetData = parsedData.uploadedSpreadsheetData || [];

                // Update UI
                renderContacts();
                renderEmailHistory();
                updateAnalytics();

                // Show upload status if we have data
                if (uploadedSpreadsheetData.length > 0) {
                    const statusReport = generateStatusReport();
                    showUploadStatusReport(statusReport);
                }

                const savedDate = new Date(parsedData.savedAt).toLocaleString();
                showAlert(`Secure data restored from ${savedDate} (${contacts.length} contacts)`, 'success');
                return true;
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                return false;
            }
        }

        function saveDraftEmail() {
            try {
                const draft = {
                    fromEmail: document.getElementById('fromEmail').value,
                    toEmail: document.getElementById('toEmail').value,
                    subject: document.getElementById('subject').value,
                    messageBody: document.getElementById('messageBody').innerHTML,
                    savedAt: Date.now()
                };

                localStorage.setItem(STORAGE_KEYS.DRAFTS, JSON.stringify(draft));
                showAlert('Draft saved', 'info');
            } catch (error) {
                console.error('Error saving draft:', error);
                showAlert('Failed to save draft', 'error');
            }
        }

        function loadDraftEmail() {
            try {
                const savedDraft = localStorage.getItem(STORAGE_KEYS.DRAFTS);
                if (!savedDraft) return false;

                const draft = JSON.parse(savedDraft);

                // Confirm before loading
                if (confirm('Load saved draft? This will replace current email content.')) {
                    document.getElementById('fromEmail').value = draft.fromEmail || '';
                    document.getElementById('toEmail').value = draft.toEmail || '';
                    document.getElementById('subject').value = draft.subject || '';
                    document.getElementById('messageBody').innerHTML = draft.messageBody || '';

                    const savedDate = new Date(draft.savedAt).toLocaleString();
                    showAlert(`Draft loaded from ${savedDate}`, 'success');
                    return true;
                }
            } catch (error) {
                console.error('Error loading draft:', error);
                return false;
            }
        }

        function exportAllData() {
            try {
                const exportData = {
                    contacts: contacts,
                    emailHistory: emailHistory,
                    uploadedSpreadsheetData: uploadedSpreadsheetData,
                    exportedAt: new Date().toISOString(),
                    version: '2.2'
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `bulk_email_data_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showAlert('All data exported successfully', 'success');
            } catch (error) {
                console.error('Error exporting data:', error);
                showAlert('Failed to export data', 'error');
            }
        }

        function importAllData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);

                        // Validate data structure
                        if (!importedData.contacts || !Array.isArray(importedData.contacts)) {
                            throw new Error('Invalid data format');
                        }

                        // Confirm import
                        if (confirm(`Import data from ${new Date(importedData.exportedAt).toLocaleString()}? This will replace all current data.`)) {
                            contacts = importedData.contacts || [];
                            emailHistory = importedData.emailHistory || [];
                            uploadedSpreadsheetData = importedData.uploadedSpreadsheetData || [];

                            // Update UI
                            renderContacts();
                            renderEmailHistory();
                            updateAnalytics();

                            // Save to localStorage
                            saveToLocalStorage();

                            showAlert(`Imported ${contacts.length} contacts and ${emailHistory.length} email records`, 'success');
                        }
                    } catch (error) {
                        console.error('Error importing data:', error);
                        showAlert('Failed to import data: Invalid file format', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
                if (confirm('This will delete all contacts, email history, and drafts. Continue?')) {
                    // Clear memory
                    contacts = [];
                    emailHistory = [];
                    uploadedSpreadsheetData = [];
                    failedUploads = [];

                    // Clear localStorage but preserve tutorial flag
                    Object.values(STORAGE_KEYS).forEach(key => {
                        localStorage.removeItem(key);
                    });
                    // Note: We intentionally preserve 'bulkEmail_hasVisited' to avoid showing tutorial again

                    // Update UI
                    renderContacts();
                    renderEmailHistory();
                    updateAnalytics();
                    document.getElementById('uploadStats').style.display = 'none';

                    // Clear email form
                    document.getElementById('toEmail').value = '';
                    document.getElementById('subject').value = '';
                    document.getElementById('messageBody').innerHTML = '';

                    showAlert('All data cleared', 'success');
                }
            }
        }

        // Auto-save functionality
        function setupAutoSave() {
            // Auto-save every 30 seconds
            setInterval(() => {
                if (autoSaveEnabled && contacts.length > 0) {
                    saveToLocalStorage();
                }
            }, 30000);

            // Save when email content changes
            document.getElementById('messageBody').addEventListener('input', () => {
                if (autoSaveEnabled) {
                    clearTimeout(window.autoSaveTimeout);
                    window.autoSaveTimeout = setTimeout(saveDraftEmail, 5000);
                }
            });
        }

        function toggleDataMenu() {
            const menu = document.getElementById('dataMenu');
            if (menu.style.display === 'none' || menu.style.display === '') {
                menu.style.display = 'block';
                // Close menu when clicking outside
                setTimeout(() => {
                    document.addEventListener('click', closeDataMenu);
                }, 100);
            } else {
                menu.style.display = 'none';
            }
        }

        function toggleSettingsMenu() {
            const menu = document.getElementById('settingsMenu');
            if (menu.style.display === 'none' || menu.style.display === '') {
                menu.style.display = 'block';
                // Close menu when clicking outside
                setTimeout(() => {
                    document.addEventListener('click', closeSettingsMenu);
                }, 100);
            } else {
                menu.style.display = 'none';
            }
        }

        function closeSettingsMenu(event) {
            const menu = document.getElementById('settingsMenu');
            const button = document.getElementById('settingsMenuBtn');
            if (menu && !menu.contains(event.target) && !button.contains(event.target)) {
                menu.style.display = 'none';
                document.removeEventListener('click', closeSettingsMenu);
            }
        }

        // =====================================================
        // COMPREHENSIVE TESTING SUITE FOR USER MANAGEMENT
        // =====================================================

        const TestSuite = {
            results: [],

            log: function(testName, status, details = '') {
                const result = {
                    test: testName,
                    status: status, // 'PASS', 'FAIL', 'WARNING'
                    details: details,
                    timestamp: new Date().toISOString()
                };
                this.results.push(result);

                const icon = status === 'PASS' ? '‚úÖ' : status === 'FAIL' ? '‚ùå' : '‚ö†Ô∏è';
                console.log(`${icon} [TEST] ${testName}: ${status}${details ? ' - ' + details : ''}`);
            },

            // Test authentication gate visibility and functionality
            testAuthGate: function() {
                console.log('\nüß† TESTING: Authentication Gate');

                const authGate = document.getElementById('authGate');
                const loginBtn = document.getElementById('loginBtn');
                const registerBtn = document.getElementById('registerBtn');
                const mainContent = document.querySelector('.main-content');

                // Test auth gate exists
                this.log('Auth Gate Exists', authGate ? 'PASS' : 'FAIL',
                    authGate ? 'Auth gate found in DOM' : 'Auth gate missing from DOM');

                // Test buttons exist
                this.log('Login Button Exists', loginBtn ? 'PASS' : 'FAIL');
                this.log('Register Button Exists', registerBtn ? 'PASS' : 'FAIL');

                // Test main content is hidden for non-authenticated users
                if (mainContent) {
                    const isHidden = mainContent.style.display === 'none' ||
                                   window.getComputedStyle(mainContent).display === 'none';
                    this.log('Main Content Hidden', isHidden ? 'PASS' : 'FAIL',
                        isHidden ? 'Main content properly hidden' : 'Main content visible without auth');
                }

                // Test button click handlers
                if (loginBtn) {
                    const hasOnClick = loginBtn.onclick !== null;
                    this.log('Login Button Handler', hasOnClick ? 'PASS' : 'FAIL');
                }

                if (registerBtn) {
                    const hasOnClick = registerBtn.onclick !== null;
                    this.log('Register Button Handler', hasOnClick ? 'PASS' : 'FAIL');
                }
            },

            // Test UserManager object and methods
            testUserManager: function() {
                console.log('\nüë§ TESTING: UserManager Object');

                // Test UserManager exists
                const userManagerExists = typeof UserManager !== 'undefined';
                this.log('UserManager Object', userManagerExists ? 'PASS' : 'FAIL');

                if (!userManagerExists) return;

                // Test required methods exist
                const requiredMethods = [
                    'init', 'showAuthModal', 'registerUser', 'login', 'logout',
                    'sendVerificationEmail', 'sendPasswordResetEmail', 'handleLogin', 'handleRegister'
                ];

                requiredMethods.forEach(method => {
                    const exists = typeof UserManager[method] === 'function';
                    this.log(`UserManager.${method}`, exists ? 'PASS' : 'FAIL');
                });

                // Test storage keys are defined
                const storageKeys = ['USERS_KEY', 'CURRENT_USER_KEY', 'SESSION_KEY', 'PASSWORD_RESET_KEY'];
                storageKeys.forEach(key => {
                    const exists = UserManager[key] !== undefined;
                    this.log(`Storage Key: ${key}`, exists ? 'PASS' : 'FAIL');
                });

                // Test OAuth configuration
                const hasOAuthConfig = UserManager.oauthConfig &&
                                     UserManager.oauthConfig.google &&
                                     UserManager.oauthConfig.microsoft;
                this.log('OAuth Configuration', hasOAuthConfig ? 'PASS' : 'FAIL');
            },

            // Test modal functionality
            testModalSystem: function() {
                console.log('\nüí¨ TESTING: Modal System');

                try {
                    // Test if showAuthModal can be called without errors
                    if (typeof UserManager !== 'undefined' && UserManager.showAuthModal) {
                        // Don't actually show modal, just test if method exists and is callable
                        this.log('showAuthModal Callable', 'PASS', 'Method exists and is callable');

                        // Test switchAuthTab method
                        const hasSwitchTab = typeof UserManager.switchAuthTab === 'function';
                        this.log('switchAuthTab Method', hasSwitchTab ? 'PASS' : 'FAIL');

                        // Test form handlers
                        const hasHandleLogin = typeof UserManager.handleLogin === 'function';
                        const hasHandleRegister = typeof UserManager.handleRegister === 'function';
                        this.log('Login Handler', hasHandleLogin ? 'PASS' : 'FAIL');
                        this.log('Register Handler', hasHandleRegister ? 'PASS' : 'FAIL');
                    }
                } catch (error) {
                    this.log('Modal System Error', 'FAIL', error.message);
                }
            },

            // Test data persistence functions
            testDataPersistence: function() {
                console.log('\nüíæ TESTING: Data Persistence');

                try {
                    // Test localStorage availability
                    localStorage.setItem('test', 'test');
                    localStorage.removeItem('test');
                    this.log('localStorage Available', 'PASS');

                    // Test UserManager data methods
                    if (typeof UserManager !== 'undefined') {
                        const hasGetAllUsers = typeof UserManager.getAllUsers === 'function';
                        const hasSaveAllUsers = typeof UserManager.saveAllUsers === 'function';
                        const hasLoadSession = typeof UserManager.loadSession === 'function';
                        const hasSaveSession = typeof UserManager.saveSession === 'function';

                        this.log('getAllUsers Method', hasGetAllUsers ? 'PASS' : 'FAIL');
                        this.log('saveAllUsers Method', hasSaveAllUsers ? 'PASS' : 'FAIL');
                        this.log('loadSession Method', hasLoadSession ? 'PASS' : 'FAIL');
                        this.log('saveSession Method', hasSaveSession ? 'PASS' : 'FAIL');

                        // Test existing user data
                        if (hasGetAllUsers) {
                            const users = UserManager.getAllUsers();
                            this.log('User Data Structure', typeof users === 'object' ? 'PASS' : 'FAIL',
                                `Found ${Object.keys(users).length} users`);
                        }
                    }
                } catch (error) {
                    this.log('localStorage Error', 'FAIL', error.message);
                }
            },

            // Test email integration
            testEmailIntegration: function() {
                console.log('\nüìß TESTING: Email Integration');

                if (typeof UserManager !== 'undefined') {
                    // Test email methods exist
                    const hasSendVerification = typeof UserManager.sendVerificationEmail === 'function';
                    const hasSendPasswordReset = typeof UserManager.sendPasswordResetEmailReal === 'function';
                    const hasEmailInfrastructure = typeof UserManager.sendEmailViaInfrastructure === 'function';

                    this.log('Send Verification Email', hasSendVerification ? 'PASS' : 'FAIL');
                    this.log('Send Password Reset', hasSendPasswordReset ? 'PASS' : 'FAIL');
                    this.log('Email Infrastructure', hasEmailInfrastructure ? 'PASS' : 'FAIL');

                    // Test if sendViaZoho function exists (from existing email system)
                    const hasZohoIntegration = typeof sendViaZoho === 'function';
                    this.log('Zoho Integration', hasZohoIntegration ? 'PASS' : 'WARNING',
                        hasZohoIntegration ? 'Zoho function available' : 'Will use fallback methods');
                }
            },

            // Test URL parameter handling
            testUrlHandling: function() {
                console.log('\nüîó TESTING: URL Parameter Handling');

                if (typeof UserManager !== 'undefined') {
                    const hasUrlHandler = typeof UserManager.handleUrlParameters === 'function';
                    const hasVerifyHandler = typeof UserManager.handleEmailVerification === 'function';
                    const hasResetHandler = typeof UserManager.handlePasswordResetFromUrl === 'function';

                    this.log('URL Parameter Handler', hasUrlHandler ? 'PASS' : 'FAIL');
                    this.log('Email Verification Handler', hasVerifyHandler ? 'PASS' : 'FAIL');
                    this.log('Password Reset Handler', hasResetHandler ? 'PASS' : 'FAIL');
                }
            },

            // Test security measures
            testSecurity: function() {
                console.log('\nüîí TESTING: Security Measures');

                if (typeof UserManager !== 'undefined') {
                    // Test password hashing
                    const hasHashFunction = typeof UserManager.hashPassword === 'function';
                    this.log('Password Hashing', hasHashFunction ? 'PASS' : 'FAIL');

                    // Test token generation
                    const hasTokenGeneration = typeof UserManager.generateToken === 'function';
                    this.log('Token Generation', hasTokenGeneration ? 'PASS' : 'FAIL');

                    // Test session validation
                    const hasSessionValidation = typeof UserManager.clearSession === 'function';
                    this.log('Session Management', hasSessionValidation ? 'PASS' : 'FAIL');
                }
            },

            // Run all tests
            runAllTests: function() {
                console.log('üéØ STARTING COMPREHENSIVE USER MANAGEMENT TESTING');
                console.log('========================================================');

                this.results = []; // Clear previous results

                this.testAuthGate();
                this.testUserManager();
                this.testModalSystem();
                this.testDataPersistence();
                this.testEmailIntegration();
                this.testUrlHandling();
                this.testSecurity();

                this.generateReport();
            },

            // Generate comprehensive test report
            generateReport: function() {
                console.log('\nüìà TEST REPORT SUMMARY');
                console.log('========================================================');

                const passed = this.results.filter(r => r.status === 'PASS').length;
                const failed = this.results.filter(r => r.status === 'FAIL').length;
                const warnings = this.results.filter(r => r.status === 'WARNING').length;
                const total = this.results.length;

                console.log(`‚úÖ PASSED: ${passed}/${total} tests`);
                console.log(`‚ùå FAILED: ${failed}/${total} tests`);
                console.log(`‚ö†Ô∏è WARNINGS: ${warnings}/${total} tests`);

                const successRate = ((passed / total) * 100).toFixed(1);
                console.log(`üèÜ SUCCESS RATE: ${successRate}%`);

                if (failed > 0) {
                    console.log('\n‚ùå FAILED TESTS:');
                    this.results.filter(r => r.status === 'FAIL').forEach(result => {
                        console.log(`   ‚Ä¢ ${result.test}: ${result.details}`);
                    });
                }

                if (warnings > 0) {
                    console.log('\n‚ö†Ô∏è WARNINGS:');
                    this.results.filter(r => r.status === 'WARNING').forEach(result => {
                        console.log(`   ‚Ä¢ ${result.test}: ${result.details}`);
                    });
                }

                // Store results for external access
                window.testResults = this.results;

                console.log('\nüîÑ To run manual tests, use: TestSuite.runManualTests()');
                console.log('üìä Full results available at: window.testResults');
            },

            // Manual testing instructions
            runManualTests: function() {
                console.log('\nüìã MANUAL TESTING CHECKLIST');
                console.log('========================================================');
                console.log('üî∞ 1. Click "Login to Your Account" button');
                console.log('üî∞ 2. Try registering with invalid email formats');
                console.log('üî∞ 3. Try weak passwords (less than 6 characters)');
                console.log('üî∞ 4. Test forgot password functionality');
                console.log('üî∞ 5. Try Google/Microsoft OAuth buttons');
                console.log('üî∞ 6. Test form validation messages');
                console.log('üî∞ 7. Test remember me checkbox');
                console.log('üî∞ 8. Test modal close buttons');
                console.log('üî∞ 9. Test keyboard navigation (Tab/Enter)');
                console.log('üî∞ 10. Test responsive design on different screen sizes');
                console.log('\nüìù Report any issues found during manual testing');
            },

            // Execute live testing scenarios
            executeLiveTests: function() {
                console.log('\nüéØ EXECUTING LIVE TESTING SCENARIOS');
                console.log('========================================================');

                this.testRegistrationFlow();
                this.testLoginFlow();
                this.testFormValidation();
                this.testButtonFunctionality();
                this.testModalBehavior();
            },

            testRegistrationFlow: function() {
                console.log('\nüìù TESTING: User Registration Flow');
                try {
                    // Test if registration modal can open
                    if (typeof showRegisterModal === 'function') {
                        console.log('‚úÖ [LIVE] showRegisterModal function available');
                        // Test weak passwords
                        if (typeof UserManager !== 'undefined' && UserManager.validatePassword) {
                            const weakPasswords = ['123', 'abc', 'password', '12345'];
                            weakPasswords.forEach(pwd => {
                                const isValid = UserManager.validatePassword(pwd);
                                console.log(`${isValid ? '‚ùå' : '‚úÖ'} [LIVE] Password "${pwd}": ${isValid ? 'FAIL - Should reject weak password' : 'PASS - Correctly rejected'}`);
                            });
                        }
                    }
                } catch (error) {
                    console.log('‚ùå [LIVE] Registration flow error:', error.message);
                }
            },

            testLoginFlow: function() {
                console.log('\nüîê TESTING: User Login Flow');
                try {
                    if (typeof showLoginModal === 'function') {
                        console.log('‚úÖ [LIVE] showLoginModal function available');

                        // Test invalid email formats using global validateEmail function
                        if (typeof validateEmail === 'function') {
                            const invalidEmails = ['invalid', 'test@', '@domain.com', 'test..test@domain.com'];
                            invalidEmails.forEach(email => {
                                // Create a mock input element for testing
                                const mockInput = { value: email, id: 'testEmail' };
                                const isValid = validateEmail(mockInput);
                                console.log(`${isValid ? '‚úÖ' : '‚ùå'} [LIVE] Email "${email}": ${isValid ? 'PASS - Correctly accepted' : 'FAIL - Incorrectly rejected'}`);
                            });
                        }
                    }
                } catch (error) {
                    console.log('‚ùå [LIVE] Login flow error:', error.message);
                }
            },

            testFormValidation: function() {
                console.log('\nüìã TESTING: Form Validation');
                try {
                    // Test empty form submission
                    if (typeof UserManager !== 'undefined') {
                        console.log('‚úÖ [LIVE] Form validation system ready');

                        // Test required field validation using global validateEmail function
                        if (typeof validateEmail === 'function') {
                            const mockEmptyInput = { value: '', id: 'testEmail' };
                            const testEmpty = validateEmail(mockEmptyInput);
                            console.log(`${testEmpty ? '‚ùå' : '‚úÖ'} [LIVE] Empty email validation: ${testEmpty ? 'FAIL - Should reject empty' : 'PASS - Correctly rejected'}`);
                        }
                    }
                } catch (error) {
                    console.log('‚ùå [LIVE] Form validation error:', error.message);
                }
            },

            testButtonFunctionality: function() {
                console.log('\nüéÆ TESTING: Button Functionality');
                const loginBtn = document.getElementById('loginBtn');
                const registerBtn = document.getElementById('registerBtn');

                if (loginBtn) {
                    const hasClickHandler = loginBtn.onclick !== null;
                    console.log(`${hasClickHandler ? '‚úÖ' : '‚ùå'} [LIVE] Login button click handler: ${hasClickHandler ? 'PASS' : 'FAIL'}`);

                    // Test button is clickable
                    const isClickable = !loginBtn.disabled && loginBtn.style.pointerEvents !== 'none';
                    console.log(`${isClickable ? '‚úÖ' : '‚ùå'} [LIVE] Login button clickable: ${isClickable ? 'PASS' : 'FAIL'}`);
                }

                if (registerBtn) {
                    const hasClickHandler = registerBtn.onclick !== null;
                    console.log(`${hasClickHandler ? '‚úÖ' : '‚ùå'} [LIVE] Register button click handler: ${hasClickHandler ? 'PASS' : 'FAIL'}`);

                    const isClickable = !registerBtn.disabled && registerBtn.style.pointerEvents !== 'none';
                    console.log(`${isClickable ? '‚úÖ' : '‚ùå'} [LIVE] Register button clickable: ${isClickable ? 'PASS' : 'FAIL'}`);
                }
            },

            testModalBehavior: function() {
                console.log('\nüí¨ TESTING: Modal Behavior');
                try {
                    // Test if modals can be created
                    if (typeof UserManager !== 'undefined' && UserManager.showAuthModal) {
                        console.log('‚úÖ [LIVE] Modal system ready');

                        // Test close functionality
                        console.log('üìù [LIVE] Manual test required: Try opening modal and closing with X button');
                        console.log('üìù [LIVE] Manual test required: Try closing modal by clicking outside');
                        console.log('üìù [LIVE] Manual test required: Try pressing Escape key to close modal');
                    }
                } catch (error) {
                    console.log('‚ùå [LIVE] Modal behavior error:', error.message);
                }
            },

            // Test specific edge cases
            testEdgeCases: function() {
                console.log('\n‚ö° TESTING: Edge Cases');

                // Test multiple rapid clicks
                console.log('üìù [LIVE] Manual test: Rapidly click login button multiple times');

                // Test browser refresh during registration
                console.log('üìù [LIVE] Manual test: Start registration, refresh page, check data persistence');

                // Test network connectivity
                console.log('üìù [LIVE] Manual test: Disconnect network, try to register/login');

                // Test session expiry
                console.log('üìù [LIVE] Manual test: Set system clock forward, test session validity');

                // Test password visibility toggle
                console.log('üìù [LIVE] Manual test: Click password visibility toggle in forms');
            }
        };

        // Global functions moved to top of script for immediate availability

        function closeDataMenu(event) {
            const menu = document.getElementById('dataMenu');
            const button = document.getElementById('dataMenuBtn');
            if (!menu.contains(event.target) && !button.contains(event.target)) {
                menu.style.display = 'none';
                document.removeEventListener('click', closeDataMenu);
            }
        }

        // User Onboarding Tutorial System
        let tutorialActive = false;
        let currentTutorialStep = 0;
        let tutorialOverlay = null;

        const tutorialSteps = [
            {
                title: 'Welcome to Bulk Email Sender! üöÄ',
                description: 'This tutorial will guide you through all features of the application. Let\'s start by learning how to upload your contact files.',
                target: null,
                position: 'center'
            },
            {
                title: 'Step 1: Upload Contact Files üìÅ',
                description: 'Click here to upload your contact files. Supports Excel, CSV, PDF, Word, PowerPoint, and even images with text.',
                target: '#fileUpload',
                position: 'bottom',
                highlight: true
            },
            {
                title: 'Step 2: View Upload Status üìä',
                description: 'After uploading, you\'ll see statistics here. Click on "failed" link to view detailed error reports in a spreadsheet.',
                target: '#uploadStats',
                position: 'bottom'
            },
            {
                title: 'Step 3: Contact List üìù',
                description: 'Your contacts appear here. Click on any contact to auto-populate the email fields with personalized content.',
                target: '#contactsList',
                position: 'right'
            },
            {
                title: 'Step 4: Email Composition ‚úçÔ∏è',
                description: 'Compose your emails here. Use the formatting toolbar for rich text editing including colors, lists, and links.',
                target: '#messageBody',
                position: 'left',
                highlight: true
            },
            {
                title: 'Step 5: Smart Message AI ü§ñ',
                description: 'Click "Smart Message" for AI assistance to enhance your email content based on company profiles and context.',
                target: '[onclick="openSmartMessage()"]',
                position: 'bottom'
            },
            {
                title: 'Step 6: Data Management üíæ',
                description: 'Use this menu to save drafts, export data, or import previous sessions. Auto-save keeps your work safe.',
                target: '#dataMenuBtn',
                position: 'bottom'
            },
            {
                title: 'Step 7: Send Options üì§',
                description: 'Send individual emails or use bulk email for all contacts with progress tracking and pause/resume functionality.',
                target: '#sendBtn',
                position: 'bottom'
            },
            {
                title: 'Step 8: Analytics Dashboard üìä',
                description: 'Monitor your email performance with real-time analytics including success rates and geographic data.',
                target: '#emailHistory',
                position: 'left'
            },
            {
                title: 'Step 9: Response Management üì®',
                description: 'Click this icon to manage email responses with auto-forwarding to your main email address.',
                target: '#responseManagerBtn',
                position: 'left'
            },
            {
                title: 'Tutorial Complete! ‚ú®',
                description: 'You\'re now ready to use all features. Remember: upload contacts, personalize messages, and track results. Need help anytime? Click the Help button.',
                target: null,
                position: 'center'
            }
        ];

        function startTutorial() {
            if (tutorialActive) {
                endTutorial();
                return;
            }

            tutorialActive = true;
            currentTutorialStep = 0;
            showTutorialStep();
        }

        function showTutorialStep() {
            const step = tutorialSteps[currentTutorialStep];
            if (!step) {
                endTutorial();
                return;
            }

            // Remove existing overlay
            if (tutorialOverlay) {
                tutorialOverlay.remove();
            }

            // Create overlay
            tutorialOverlay = document.createElement('div');
            tutorialOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                z-index: 20000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            // Highlight target element
            let targetElement = null;
            if (step.target) {
                targetElement = document.querySelector(step.target);
                if (targetElement && step.highlight) {
                    targetElement.style.position = 'relative';
                    targetElement.style.zIndex = '20001';
                    targetElement.style.boxShadow = '0 0 0 4px rgba(23, 162, 184, 0.8), 0 0 20px rgba(23, 162, 184, 0.6)';
                    targetElement.style.borderRadius = '4px';
                }
            }

            // Create tooltip
            const tooltip = document.createElement('div');
            tooltip.style.cssText = `
                background: white;
                padding: 20px;
                border-radius: 8px;
                max-width: 400px;
                width: 90%;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                position: relative;
                margin: 20px;
            `;

            // Position tooltip based on target
            if (targetElement && step.position !== 'center') {
                const rect = targetElement.getBoundingClientRect();
                tutorialOverlay.style.alignItems = 'flex-start';
                tutorialOverlay.style.justifyContent = 'flex-start';

                let top, left;
                switch (step.position) {
                    case 'bottom':
                        top = rect.bottom + 10;
                        left = rect.left + (rect.width / 2) - 200;
                        break;
                    case 'top':
                        top = rect.top - 120;
                        left = rect.left + (rect.width / 2) - 200;
                        break;
                    case 'left':
                        top = rect.top + (rect.height / 2) - 60;
                        left = rect.left - 420;
                        break;
                    case 'right':
                        top = rect.top + (rect.height / 2) - 60;
                        left = rect.right + 10;
                        break;
                }

                // Ensure tooltip stays in viewport
                top = Math.max(10, Math.min(top, window.innerHeight - 140));
                left = Math.max(10, Math.min(left, window.innerWidth - 420));

                tooltip.style.position = 'absolute';
                tooltip.style.top = top + 'px';
                tooltip.style.left = left + 'px';
                tooltip.style.margin = '0';
            }

            tooltip.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <h3 style="margin: 0 0 10px 0; color: #17a2b8; font-size: 18px;">${step.title}</h3>
                    <p style="margin: 0; line-height: 1.5; color: #333;">${step.description}</p>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 12px; color: #666;">
                        Step ${currentTutorialStep + 1} of ${tutorialSteps.length}
                    </div>
                    <div>
                        ${currentTutorialStep > 0 ? '<button onclick="previousTutorialStep()" style="background: #6c757d; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; margin-right: 10px;">‚Üê Previous</button>' : ''}
                        ${currentTutorialStep < tutorialSteps.length - 1 ? '<button onclick="nextTutorialStep()" style="background: #17a2b8; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Next ‚Üí</button>' : ''}
                        <button onclick="endTutorial()" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">${currentTutorialStep === tutorialSteps.length - 1 ? 'Finish' : 'Skip'}</button>
                    </div>
                </div>
            `;

            tutorialOverlay.appendChild(tooltip);
            document.body.appendChild(tutorialOverlay);

            // Auto-advance for center-positioned steps after 5 seconds
            if (step.position === 'center' && currentTutorialStep < tutorialSteps.length - 1) {
                setTimeout(() => {
                    if (tutorialActive && currentTutorialStep < tutorialSteps.length - 1) {
                        nextTutorialStep();
                    }
                }, 5000);
            }
        }

        function nextTutorialStep() {
            clearHighlight();
            currentTutorialStep++;
            showTutorialStep();
        }

        function previousTutorialStep() {
            clearHighlight();
            currentTutorialStep--;
            showTutorialStep();
        }

        function endTutorial() {
            tutorialActive = false;
            clearHighlight();
            if (tutorialOverlay) {
                tutorialOverlay.remove();
                tutorialOverlay = null;
            }
            showAlert('Tutorial ended. Click Help anytime to restart!', 'info');
        }

        function clearHighlight() {
            // Clear any highlighted elements
            document.querySelectorAll('*').forEach(el => {
                if (el.style.zIndex === '20001') {
                    el.style.position = '';
                    el.style.zIndex = '';
                    el.style.boxShadow = '';
                    el.style.borderRadius = '';
                }
            });
        }

        // Check if user is new and show tutorial
        function checkFirstVisit() {
            const hasVisited = localStorage.getItem('bulkEmail_hasVisited');
            if (!hasVisited) {
                localStorage.setItem('bulkEmail_hasVisited', 'true');
                setTimeout(() => {
                    if (confirm('Welcome to Bulk Email Sender! Would you like to take a quick tutorial to learn all the features?')) {
                        startTutorial();
                    }
                }, 2000);
            }
        }

        // Test connection functionality removed

        function extractTemplateHeaders() {
            const companyData = CompanyOnboardingModule.getData();
            const template = companyData.emailTemplate || '';
            const headerLines = template.split('\n');

            // Set default values
            document.getElementById('fromEmail').value = 'info@datanalysisninsights.co.uk';
            window.defaultFromName = 'Intex Technologies';

            // Extract headers from template if present
            for (let line of headerLines) {
                if (line.startsWith('From: ')) {
                    const fromEmail = line.replace('From: ', '').trim();
                    // Only use template email if it's a valid email address
                    if (fromEmail.includes('@')) {
                        document.getElementById('fromEmail').value = fromEmail;
                    }
                }
                if (line.startsWith('From-Name: ')) {
                    const fromName = line.replace('From-Name: ', '').trim();
                    window.defaultFromName = fromName;
                }
            }
        }

        function testXLSXLibrary() {
            if (typeof XLSX === 'undefined') {
                console.error('XLSX library not loaded');
                showAlert('‚ö†Ô∏è Excel processing library failed to load. File upload may not work.', 'error');
                return false;
            } else {
                console.log('XLSX library loaded successfully, version:', XLSX.version);
                return true;
            }
        }

        // Add a simple CSV processor as fallback
        function parseCSV(text) {
            const csvLines = text.split('\n');
            const headers = csvLines[0].split(',').map(h => h.trim().toLowerCase());
            const data = [];

            for (let i = 1; i < csvLines.length; i++) {
                if (csvLines[i].trim()) {
                    const values = csvLines[i].split(',');
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] ? values[index].trim() : '';
                    });
                    data.push(row);
                }
            }
            return { headers, data };
        }

        // Initialize on page load - no complex initialization
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Secure email sender loaded');

            // Execute comprehensive testing suite
            setTimeout(() => {
                console.log('\nüß™ EXECUTING COMPREHENSIVE USER MANAGEMENT TESTING');
                TestSuite.runAllTests();

                // Run live testing scenarios
                setTimeout(() => {
                    TestSuite.executeLiveTests();
                }, 2000);
            }, 3000);

            // Initialize User Management System
            UserManager.init();

            // Add event listeners for authentication gate buttons
            const loginBtn = document.getElementById('loginBtn');
            const registerBtn = document.getElementById('registerBtn');

            console.log('Looking for auth buttons...');
            console.log('Login button found:', !!loginBtn);
            console.log('Register button found:', !!registerBtn);

            if (loginBtn) {
                loginBtn.addEventListener('click', function(e) {
                    console.log('Login button clicked!');
                    e.preventDefault();
                    e.stopPropagation();
                    if (typeof UserManager !== 'undefined' && UserManager.showAuthModal) {
                        UserManager.showAuthModal('login');
                    } else {
                        console.error('UserManager not available');
                    }
                });

                // Add visual feedback
                loginBtn.style.cursor = 'pointer';
                loginBtn.title = 'Click to login to your account';
                console.log('Login button event listener added');
            } else {
                console.error('Login button not found!');
            }

            if (registerBtn) {
                registerBtn.addEventListener('click', function(e) {
                    console.log('Register button clicked!');
                    e.preventDefault();
                    e.stopPropagation();
                    if (typeof UserManager !== 'undefined' && UserManager.showAuthModal) {
                        UserManager.showAuthModal('register');
                    } else {
                        console.error('UserManager not available');
                    }
                });

                // Add visual feedback
                registerBtn.style.cursor = 'pointer';
                registerBtn.title = 'Click to create a new account';
                console.log('Register button event listener added');
            } else {
                console.error('Register button not found!');
            }

            // Initialize Company Onboarding Data persistence system
            CompanyOnboardingModule.initializePersistence();

            // Initialize undo system
            const editor = document.getElementById('messageBody');
            if (editor) {
                // Save initial empty state
                saveUndoState();
                lastContent = editor.innerHTML;

                // Add focus event to save state when user starts editing
                editor.addEventListener('focus', function() {
                    if (undoStack.length === 0) {
                        saveUndoState();
                    }
                });

                console.log('üìù Undo system initialized');
            }
            testXLSXLibrary(); // Test if XLSX library loaded
            extractTemplateHeaders(); // Extract and populate From field

            // Initialize data persistence
            setupAutoSave();

            // Try to load saved data (now async with encryption)
            try {
                const dataLoaded = await loadFromLocalStorage();

                if (!dataLoaded) {
                    renderContacts(); // Initialize contact list display if no saved data
                    showAlert('üîí Secure Email Sender Ready! Upload your contact spreadsheet to begin sending personalized emails.');
                }
            } catch (error) {
                console.error('Failed to load saved data:', error);
                renderContacts();
                showAlert('üîí Secure Email Sender Ready! Upload your contact spreadsheet to begin sending personalized emails.');
            }

            // Load email service configuration
            await loadEmailServiceConfig();

            // Initialize email form data persistence
            setTimeout(() => {
                loadEmailFormData();
                setupEmailFormAutoSave();
                console.log('[EmailForm] Form persistence initialized');
            }, 500);

            // Auto-tutorial disabled - users can access tutorial via Help menu
            // checkFirstVisit();
        });

        async function loadEmailServiceConfig() {
            try {
                const savedConfig = localStorage.getItem(STORAGE_KEYS.SETTINGS);
                if (savedConfig) {
                    const config = await decryptData(savedConfig);
                    if (config && config.emailConfig) {
                        Object.assign(EMAIL_CONFIG, config.emailConfig);
                        console.log('Email service configuration loaded');
                    }
                }
            } catch (error) {
                console.error('Error loading email service config:', error);
            }
        }

        // Email Service Configuration
        function showEmailConfig() {
            const modal = document.createElement('div');
            modal.id = 'emailConfigModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
                z-index: 10000; padding: 20px;
            `;

            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #007bff;">‚öôÔ∏è Email Service Configuration</h3>
                        <button onclick="closeEmailConfig()" class="modal-close-btn" title="Close">√ó</button>
                    </div>

                    <div style="margin-bottom: 20px; padding: 15px; background: #dcfce7; border-radius: 4px; border-left: 4px solid #16a34a;">
                        <strong>üöÄ Zoho Mail Production Ready!</strong>
                        <p style="margin: 5px 0; font-size: 14px; color: #166534;">Your Zoho Mail integration is configured and ready for production email sending. Enter your Zoho credentials below to activate real email delivery with SMTP.</p>
                    </div>

                    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px; border-left: 4px solid #17a2b8;">
                        <strong>Setup Instructions:</strong>
                        <p style="margin: 5px 0; font-size: 14px;">Configure your Zoho Mail credentials below. All credentials are stored securely with encryption. The system will try Zoho Mail first, then fallback to other services.</p>
                    </div>

                    <!-- Zoho Mail Configuration -->
                    <div style="margin-bottom: 25px; padding: 15px; border: 1px solid #dc2626; border-radius: 6px; background: #fef2f2;">
                        <h4 style="margin: 0 0 15px 0; color: #dc2626;">üìß Zoho Mail SMTP (Primary Business Email)</h4>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Zoho Email Address:</label>
                            <input type="email" id="zohoEmail" placeholder="your-email@yourdomain.com" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">App Password:</label>
                            <input type="password" id="zohoPassword" placeholder="App-specific password from Zoho" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <small style="color: #6b7280; display: block; margin-top: 4px;">Generate app password in Zoho Mail ‚Üí Security ‚Üí App Passwords</small>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="zohoEnabled" style="margin-right: 8px;">
                                <span style="font-weight: 500;">Enable Zoho Mail</span>
                            </label>
                        </div>
                    </div>

                    <!-- EmailJS Configuration -->
                    <div style="margin-bottom: 25px; padding: 15px; border: 1px solid #ddd; border-radius: 6px;">
                        <h4 style="margin: 0 0 15px 0; color: #28a745;">üìß EmailJS (Alternative - Free Tier)</h4>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Public Key:</label>
                            <input type="text" id="emailjsPublicKey" placeholder="Your EmailJS public key" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Service ID:</label>
                            <input type="text" id="emailjsServiceId" placeholder="Your EmailJS service ID" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Template ID:</label>
                            <input type="text" id="emailjsTemplateId" placeholder="Your EmailJS template ID" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <label style="display: flex; align-items: center; margin-top: 10px;">
                            <input type="checkbox" id="emailjsEnabled" style="margin-right: 8px;">
                            <span>Enable EmailJS</span>
                        </label>
                        <p style="margin: 10px 0 0 0; font-size: 12px; color: #666;">Get free API keys at <a href="https://emailjs.com" target="_blank">emailjs.com</a> (200 emails/month free)</p>
                    </div>

                    <!-- Netlify Functions -->
                    <div style="margin-bottom: 25px; padding: 15px; border: 1px solid #ddd; border-radius: 6px;">
                        <h4 style="margin: 0 0 15px 0; color: #6366f1;">‚ö° Netlify Functions</h4>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Function Endpoint:</label>
                            <input type="text" id="netlifyEndpoint" value="/.netlify/functions/send-email" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <label style="display: flex; align-items: center; margin-top: 10px;">
                            <input type="checkbox" id="netlifyEnabled" checked style="margin-right: 8px;">
                            <span>Enable Netlify Functions</span>
                        </label>
                        <p style="margin: 10px 0 0 0; font-size: 12px; color: #666;">Requires Netlify function deployment</p>
                    </div>

                    <!-- Custom Webhook -->
                    <div style="margin-bottom: 25px; padding: 15px; border: 1px solid #ddd; border-radius: 6px;">
                        <h4 style="margin: 0 0 15px 0; color: #f59e0b;">üîó Custom Webhook</h4>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Webhook URL:</label>
                            <input type="text" id="webhookEndpoint" placeholder="https://your-email-webhook.com/send" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">API Key:</label>
                            <input type="password" id="webhookApiKey" placeholder="Your API key" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <label style="display: flex; align-items: center; margin-top: 10px;">
                            <input type="checkbox" id="webhookEnabled" style="margin-right: 8px;">
                            <span>Enable Custom Webhook</span>
                        </label>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px;">
                        <button onclick="testEmailConfig()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">üß™ Test Configuration</button>
                        <div>
                            <button onclick="saveEmailConfig()" class="button button-primary" style="margin-right: 10px;">Save</button>
                            <button onclick="closeEmailConfig()" class="button">Close</button>
                        </div>
                    </div>
                </div>
            `;

            // Load current configuration
            loadCurrentEmailConfig();

            document.body.appendChild(modal);
        }

        async function loadCurrentEmailConfig() {
            try {
                const savedConfig = localStorage.getItem(STORAGE_KEYS.SETTINGS);
                if (savedConfig) {
                    const config = await decryptData(savedConfig);
                    if (config && config.emailConfig) {
                        const emailConfig = config.emailConfig;

                        // Load Zoho config
                        if (emailConfig.zoho) {
                            document.getElementById('zohoEmail').value = emailConfig.zoho.email || '';
                            document.getElementById('zohoPassword').value = emailConfig.zoho.password || '';
                            document.getElementById('zohoEnabled').checked = emailConfig.zoho.enabled !== false; // Default to enabled

                            // Update global config
                            EMAIL_CONFIG.zoho.email = emailConfig.zoho.email || '';
                            EMAIL_CONFIG.zoho.password = emailConfig.zoho.password || '';
                            EMAIL_CONFIG.zoho.enabled = emailConfig.zoho.enabled !== false;

                            if (EMAIL_CONFIG.zoho.email && EMAIL_CONFIG.zoho.password) {
                                console.log('‚úÖ Zoho Mail credentials loaded and ready for production');
                            }
                        }

                        // Load EmailJS config
                        if (emailConfig.emailjs) {
                            document.getElementById('emailjsPublicKey').value = emailConfig.emailjs.publicKey || '';
                            document.getElementById('emailjsServiceId').value = emailConfig.emailjs.serviceId || '';
                            document.getElementById('emailjsTemplateId').value = emailConfig.emailjs.templateId || '';
                            document.getElementById('emailjsEnabled').checked = emailConfig.emailjs.enabled || false;
                        }

                        // Load Netlify config
                        if (emailConfig.netlify) {
                            document.getElementById('netlifyEndpoint').value = emailConfig.netlify.endpoint || '/.netlify/functions/send-email';
                            document.getElementById('netlifyEnabled').checked = emailConfig.netlify.enabled !== false;
                        }

                        // Load Webhook config
                        if (emailConfig.webhook) {
                            document.getElementById('webhookEndpoint').value = emailConfig.webhook.endpoint || '';
                            document.getElementById('webhookApiKey').value = emailConfig.webhook.apiKey || '';
                            document.getElementById('webhookEnabled').checked = emailConfig.webhook.enabled || false;
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading email config:', error);
            }
        }

        async function saveEmailConfig() {
            try {
                const newConfig = {
                    zoho: {
                        enabled: document.getElementById('zohoEnabled').checked,
                        email: document.getElementById('zohoEmail').value.trim(),
                        password: document.getElementById('zohoPassword').value.trim(),
                        smtp: 'smtp.zoho.com',
                        port: 587
                    },
                    emailjs: {
                        enabled: document.getElementById('emailjsEnabled').checked,
                        publicKey: document.getElementById('emailjsPublicKey').value.trim(),
                        serviceId: document.getElementById('emailjsServiceId').value.trim(),
                        templateId: document.getElementById('emailjsTemplateId').value.trim()
                    },
                    netlify: {
                        enabled: document.getElementById('netlifyEnabled').checked,
                        endpoint: document.getElementById('netlifyEndpoint').value.trim()
                    },
                    webhook: {
                        enabled: document.getElementById('webhookEnabled').checked,
                        endpoint: document.getElementById('webhookEndpoint').value.trim(),
                        apiKey: document.getElementById('webhookApiKey').value.trim()
                    }
                };

                // Update global config
                Object.assign(EMAIL_CONFIG, newConfig);

                // Save encrypted config
                const configToSave = {
                    emailConfig: newConfig,
                    savedAt: Date.now()
                };
                const encryptedConfig = await encryptData(configToSave);
                localStorage.setItem(STORAGE_KEYS.SETTINGS, encryptedConfig);

                showAlert('Email configuration saved successfully!', 'success');
                closeEmailConfig();
            } catch (error) {
                console.error('Error saving email config:', error);
                showAlert('Failed to save email configuration', 'error');
            }
        }

        async function testEmailConfig() {
            const testContact = {
                email: document.getElementById('fromEmail').value,
                contactName: 'Test User',
                firm: 'Test Company',
                country: 'Test Country'
            };

            const testSubject = 'Email Configuration Test';
            const testMessage = 'This is a test email to verify your email configuration is working correctly.';

            try {
                showAlert('Testing email configuration...', 'info');
                const result = await sendRealEmail(testContact, testSubject, testMessage);

                if (result.success) {
                    showAlert(`‚úÖ Email test successful via ${result.service}!`, 'success');
                } else {
                    showAlert(`‚ùå Email test failed: ${result.error}`, 'error');
                }
            } catch (error) {
                showAlert(`‚ùå Email test failed: ${error.message}`, 'error');
            }
        }

        function closeEmailConfig() {
            const modal = document.getElementById('emailConfigModal');
            if (modal) {
                modal.remove();
            }
        }

        // =====================================================
        // USER MANAGEMENT MODULE
        // =====================================================
        const UserManager = {
            // Storage keys
            USERS_KEY: 'bulkEmail_users',
            CURRENT_USER_KEY: 'bulkEmail_currentUser',
            SESSION_KEY: 'bulkEmail_userSession',
            PASSWORD_RESET_KEY: 'bulkEmail_passwordResets',

            // Current state
            currentUser: null,
            isLoggedIn: false,
            authInitialized: false,

            // OAuth configuration (replace with your actual OAuth app credentials)
            oauthConfig: {
                google: {
                    clientId: 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com',
                    redirectUri: window.location.origin + '/auth/google/callback'
                },
                microsoft: {
                    clientId: 'YOUR_MICROSOFT_APP_ID',
                    redirectUri: window.location.origin + '/auth/microsoft/callback'
                }
            },

            // Initialize user system
            init: function() {
                console.log('[UserManager] Initializing authentication system...');

                // Check URL parameters for email verification or password reset
                this.handleUrlParameters();

                // Load session first
                this.loadSession();

                // Check authentication state
                this.checkAuthenticationState();

                // Initialize OAuth libraries
                this.initializeOAuth();

                this.authInitialized = true;
                console.log('[UserManager] Authentication system initialized');
            },

            // Handle URL parameters for email verification and password reset
            handleUrlParameters: function() {
                const urlParams = new URLSearchParams(window.location.search);
                const verifyToken = urlParams.get('verify');
                const resetToken = urlParams.get('reset');

                if (verifyToken) {
                    this.handleEmailVerification(verifyToken);
                    // Clean URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                }

                if (resetToken) {
                    this.handlePasswordResetFromUrl(resetToken);
                    // Clean URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            },

            // Handle email verification from URL
            handleEmailVerification: function(token) {
                try {
                    const users = this.getAllUsers();
                    const user = Object.values(users).find(u => u.verificationToken === token);

                    if (!user) {
                        showAlert('‚ùå Invalid verification link. Please try registering again.', 'error');
                        return;
                    }

                    if (user.isVerified) {
                        showAlert('‚úÖ Email already verified! You can now log in.', 'success');
                        setTimeout(() => this.showAuthModal('login'), 2000);
                        return;
                    }

                    // Verify the user
                    user.isVerified = true;
                    user.verificationToken = null;
                    user.verifiedAt = new Date().toISOString();
                    users[user.id] = user;
                    this.saveAllUsers(users);

                    console.log('[UserManager] ‚úÖ Email verified for:', user.email);
                    showAlert('üéâ Email verified successfully! You can now log in to your account.', 'success');

                    // Show login modal after 2 seconds
                    setTimeout(() => this.showAuthModal('login'), 2000);

                } catch (error) {
                    console.error('[UserManager] Email verification error:', error);
                    showAlert('‚ùå Email verification failed. Please try again.', 'error');
                }
            },

            // Handle password reset from URL
            handlePasswordResetFromUrl: function(token) {
                try {
                    const resetRequests = JSON.parse(localStorage.getItem(this.PASSWORD_RESET_KEY) || '{}');
                    const resetRequest = resetRequests[token];

                    if (!resetRequest) {
                        showAlert('‚ùå Invalid or expired reset link. Please request a new password reset.', 'error');
                        setTimeout(() => this.showAuthModal('login'), 2000);
                        return;
                    }

                    if (resetRequest.expiresAt < Date.now()) {
                        showAlert('‚ùå Reset link has expired. Please request a new password reset.', 'error');
                        setTimeout(() => this.showAuthModal('login'), 2000);
                        return;
                    }

                    // Show password reset form
                    showAlert('‚úÖ Reset link verified! Please enter your new password.', 'success');
                    setTimeout(() => this.showPasswordResetForm(token), 1000);

                } catch (error) {
                    console.error('[UserManager] Password reset URL handling error:', error);
                    showAlert('‚ùå Password reset failed. Please try again.', 'error');
                }
            },

            // Check if user needs to authenticate
            checkAuthenticationState: function() {
                if (this.isLoggedIn && this.currentUser) {
                    console.log('[UserManager] User authenticated:', this.currentUser.email);
                    this.hideAuthGate();
                    this.updateUserDisplay();
                    // Load user's companies
                    setTimeout(() => {
                        CompanyOnboardingModule.loadUserCompanies();
                    }, 500);
                } else {
                    console.log('[UserManager] User not authenticated, showing auth gate');
                    this.showAuthGate();
                }
            },

            // Show authentication gate
            showAuthGate: function() {
                const authGate = document.getElementById('authGate');
                if (authGate) {
                    authGate.style.display = 'flex';
                }

                // Hide main application
                const mainContent = document.querySelector('.main-content');
                const header = document.querySelector('div[style*="background: white"]');
                if (mainContent) mainContent.style.display = 'none';
                if (header) header.style.display = 'none';
            },

            // Hide authentication gate
            hideAuthGate: function() {
                const authGate = document.getElementById('authGate');
                if (authGate) {
                    authGate.style.display = 'none';
                }

                // Show main application
                const mainContent = document.querySelector('.main-content');
                const header = document.getElementById('appHeader');
                if (mainContent) mainContent.style.display = 'grid';
                if (header) header.style.display = 'flex';
            },

            // Generate unique user ID
            generateUserId: function() {
                return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            },

            // Initialize OAuth libraries
            initializeOAuth: function() {
                // Load Google OAuth library
                if (!window.google) {
                    const script = document.createElement('script');
                    script.src = 'https://accounts.google.com/gsi/client';
                    script.async = true;
                    script.defer = true;
                    script.onload = () => {
                        console.log('[UserManager] Google OAuth library loaded');
                        this.initializeGoogleAuth();
                    };
                    document.head.appendChild(script);
                }

                // Load Microsoft OAuth library (MSAL)
                if (!window.msal) {
                    const script = document.createElement('script');
                    script.src = 'https://alcdn.msauth.net/browser/2.38.1/js/msal-browser.min.js';
                    script.async = true;
                    script.defer = true;
                    script.onload = () => {
                        console.log('[UserManager] Microsoft OAuth library loaded');
                        this.initializeMicrosoftAuth();
                    };
                    document.head.appendChild(script);
                }
            },

            // Initialize Google OAuth
            initializeGoogleAuth: function() {
                if (window.google && window.google.accounts) {
                    window.google.accounts.id.initialize({
                        client_id: this.oauthConfig.google.clientId,
                        callback: this.handleGoogleResponse.bind(this)
                    });
                    console.log('[UserManager] Google OAuth initialized');
                }
            },

            // Initialize Microsoft OAuth
            initializeMicrosoftAuth: function() {
                if (window.msal) {
                    try {
                        this.msalInstance = new window.msal.PublicClientApplication({
                            auth: {
                                clientId: this.oauthConfig.microsoft.clientId,
                                authority: 'https://login.microsoftonline.com/common',
                                redirectUri: this.oauthConfig.microsoft.redirectUri
                            }
                        });
                        console.log('[UserManager] Microsoft OAuth initialized');
                    } catch (error) {
                        console.error('[UserManager] Microsoft OAuth initialization failed:', error);
                    }
                }
            },

            // Save user session
            saveSession: function() {
                if (this.currentUser) {
                    const session = {
                        userId: this.currentUser.id,
                        loginTime: Date.now(),
                        expiresAt: Date.now() + (30 * 24 * 60 * 60 * 1000) // 30 days
                    };
                    localStorage.setItem(this.SESSION_KEY, JSON.stringify(session));
                    localStorage.setItem(this.CURRENT_USER_KEY, JSON.stringify(this.currentUser));
                }
            },

            // Load user session
            loadSession: function() {
                try {
                    const session = JSON.parse(localStorage.getItem(this.SESSION_KEY));
                    const userData = JSON.parse(localStorage.getItem(this.CURRENT_USER_KEY));

                    if (session && userData && session.expiresAt > Date.now()) {
                        this.currentUser = userData;
                        this.isLoggedIn = true;
                        console.log('[UserManager] Session restored for:', userData.email);
                    } else {
                        this.clearSession();
                    }
                } catch (error) {
                    console.error('[UserManager] Error loading session:', error);
                    this.clearSession();
                }
            },

            // Clear user session
            clearSession: function() {
                this.currentUser = null;
                this.isLoggedIn = false;
                localStorage.removeItem(this.SESSION_KEY);
                localStorage.removeItem(this.CURRENT_USER_KEY);
            },

            // Get all users
            getAllUsers: function() {
                try {
                    return JSON.parse(localStorage.getItem(this.USERS_KEY)) || {};
                } catch (error) {
                    console.error('[UserManager] Error loading users:', error);
                    return {};
                }
            },

            // Save all users
            saveAllUsers: function(users) {
                localStorage.setItem(this.USERS_KEY, JSON.stringify(users));
            },

            // Register new user
            registerUser: function(email, password, name, provider = 'manual') {
                try {
                    const users = this.getAllUsers();

                    // Validate inputs
                    if (!email || !email.includes('@')) {
                        throw new Error('Please enter a valid email address');
                    }

                    if (provider === 'manual') {
                        if (!password || password.length < 6) {
                            throw new Error('Password must be at least 6 characters long');
                        }
                        if (!name || name.trim().length < 2) {
                            throw new Error('Please enter your full name');
                        }
                    }

                    // Check if user already exists
                    const existingUser = Object.values(users).find(user => user.email.toLowerCase() === email.toLowerCase());
                    if (existingUser) {
                        throw new Error('An account with this email already exists. Please try logging in instead.');
                    }

                    const userId = this.generateUserId();
                    const user = {
                        id: userId,
                        email: email.toLowerCase(),
                        name: name || email.split('@')[0],
                        password: provider === 'manual' ? this.hashPassword(password) : null,
                        provider: provider, // 'manual', 'google', 'microsoft'
                        providerData: null, // Store OAuth provider data if needed
                        createdAt: new Date().toISOString(),
                        companies: [], // Array of company IDs belonging to this user
                        activeCompanies: [], // Selected companies for personalization
                        lastLogin: null,
                        isVerified: provider !== 'manual', // OAuth users are auto-verified
                        verificationToken: provider === 'manual' ? this.generateToken() : null
                    };

                    users[userId] = user;
                    this.saveAllUsers(users);

                    console.log('[UserManager] User registered:', email, 'via', provider);

                    // Send verification email for manual registration
                    if (provider === 'manual') {
                        this.sendVerificationEmail(user);
                    }

                    return userId;
                } catch (error) {
                    console.error('[UserManager] Registration error:', error);
                    throw error;
                }
            },

            // Login user
            login: function(email, password, provider = 'manual') {
                try {
                    // Validate inputs
                    if (!email || !email.includes('@')) {
                        throw new Error('Please enter a valid email address');
                    }

                    if (provider === 'manual' && (!password || password.length < 1)) {
                        throw new Error('Please enter your password');
                    }

                    const users = this.getAllUsers();
                    const user = Object.values(users).find(u => u.email.toLowerCase() === email.toLowerCase());

                    if (!user) {
                        throw new Error('No account found with this email address. Please register first.');
                    }

                    // Check password for manual login
                    if (provider === 'manual') {
                        if (!user.password) {
                            throw new Error('This account was created with social login. Please use Google or Microsoft to sign in.');
                        }

                        if (user.password !== this.hashPassword(password)) {
                            throw new Error('Incorrect password. Please try again or use "Forgot Password".');
                        }
                    }

                    // Check if account is verified (for manual registration)
                    if (provider === 'manual' && !user.isVerified && user.verificationToken) {
                        throw new Error('Please verify your email address before logging in. Check your email for verification link.');
                    }

                    // Update last login
                    user.lastLogin = new Date().toISOString();
                    users[user.id] = user;
                    this.saveAllUsers(users);

                    // Set current user
                    this.currentUser = user;
                    this.isLoggedIn = true;
                    this.saveSession();

                    console.log('[UserManager] User logged in:', email, 'via', provider);

                    // Hide auth gate and show application
                    this.hideAuthGate();
                    this.updateUserDisplay();

                    // Load user's companies
                    setTimeout(() => {
                        CompanyOnboardingModule.loadUserCompanies();
                    }, 500);

                    return user;
                } catch (error) {
                    console.error('[UserManager] Login error:', error);
                    throw error;
                }
            },

            // Logout user
            logout: function() {
                console.log('[UserManager] User logged out:', this.currentUser?.email);
                this.clearSession();
                this.updateUserDisplay();

                // Reload page to reset application state
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            },

            // Generate random token
            generateToken: function() {
                return Math.random().toString(36).substr(2, 15) + Date.now().toString(36);
            },

            // Simple password hashing (for demo purposes)
            hashPassword: function(password) {
                // In production, use proper bcrypt or similar
                let hash = 0;
                for (let i = 0; i < password.length; i++) {
                    const char = password.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32-bit integer
                }
                return hash.toString();
            },

            // Send verification email using existing Zoho SMTP
            sendVerificationEmail: async function(user) {
                try {
                    console.log('[UserManager] Sending verification email to:', user.email);

                    const verificationLink = `${window.location.origin}?verify=${user.verificationToken}`;

                    const emailData = {
                        from_email: 'info@datanalysisninsights.co.uk',
                        from_name: 'Bulk Email Sender - Account Verification',
                        to_email: user.email,
                        to_name: user.name,
                        subject: '‚úÖ Verify Your Account - Bulk Email Sender',
                        html_content: `
                            <!DOCTYPE html>
                            <html>
                            <head>
                                <meta charset="utf-8">
                                <title>Account Verification</title>
                            </head>
                            <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;">
                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; text-align: center; border-radius: 10px 10px 0 0;">
                                    <h1 style="color: white; margin: 0; font-size: 28px;">üìß Welcome to Bulk Email Sender!</h1>
                                </div>

                                <div style="background: #f8f9fa; padding: 30px; border-radius: 0 0 10px 10px; border: 1px solid #e9ecef;">
                                    <h2 style="color: #007bff; margin-top: 0;">Hi ${user.name},</h2>

                                    <p>Thank you for registering with <strong>Bulk Email Sender</strong> - your professional email campaign platform!</p>

                                    <p>To complete your account setup and start sending professional email campaigns, please verify your email address by clicking the button below:</p>

                                    <div style="text-align: center; margin: 30px 0;">
                                        <a href="${verificationLink}" style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; font-weight: bold; display: inline-block; font-size: 16px;">
                                            ‚úÖ Verify My Account
                                        </a>
                                    </div>

                                    <p style="font-size: 14px; color: #666;">If the button doesn't work, copy and paste this link into your browser:</p>
                                    <p style="background: #e9ecef; padding: 10px; border-radius: 4px; word-break: break-all; font-size: 12px;">${verificationLink}</p>

                                    <hr style="margin: 30px 0; border: none; border-top: 1px solid #e9ecef;">

                                    <h3 style="color: #28a745;">What's Next?</h3>
                                    <ol style="color: #666;">
                                        <li>Verify your email address (click the button above)</li>
                                        <li>Set up your company profile with our auto-fill templates</li>
                                        <li>Upload your contacts from Excel, CSV, or other formats</li>
                                        <li>Start sending personalized email campaigns!</li>
                                    </ol>

                                    <p style="margin-top: 30px; font-size: 12px; color: #999; text-align: center;">
                                        This verification link will expire in 24 hours for security reasons.<br>
                                        If you didn't create this account, please ignore this email.
                                    </p>
                                </div>

                                <div style="text-align: center; margin-top: 20px; font-size: 12px; color: #999;">
                                    <p>üîí Bulk Email Sender - Professional Email Campaign Platform</p>
                                    <p>Visit us at: ${window.location.origin}</p>
                                </div>
                            </body>
                            </html>
                        `,
                        reply_to: 'Bulk Email Sender Support <info@datanalysisninsights.co.uk>'
                    };

                    // Use existing email infrastructure
                    const result = await this.sendEmailViaInfrastructure(emailData);

                    if (result.success) {
                        console.log('[UserManager] ‚úÖ Verification email sent successfully via', result.service);
                        showAlert('‚úÖ Verification email sent! Please check your inbox and click the verification link.', 'success');
                    } else {
                        throw new Error(result.error || 'Email sending failed');
                    }

                } catch (error) {
                    console.error('[UserManager] Verification email failed:', error);
                    // Fallback to auto-verification for demo
                    console.log('[UserManager] Falling back to auto-verification');
                    showAlert('‚ö†Ô∏è Email service temporarily unavailable. Account auto-verified for demo.', 'warning');

                    // Auto-verify user
                    const users = this.getAllUsers();
                    user.isVerified = true;
                    users[user.id] = user;
                    this.saveAllUsers(users);
                }
            },

            // Send password reset email
            sendPasswordResetEmail: async function(email) {
                try {
                    const users = this.getAllUsers();
                    const user = Object.values(users).find(u => u.email.toLowerCase() === email.toLowerCase());

                    if (!user) {
                        // Don't reveal if email exists for security
                        showAlert('üìß If an account with this email exists, a password reset link has been sent.', 'info');
                        return;
                    }

                    if (user.provider !== 'manual') {
                        throw new Error('This account uses social login. Password reset is not available.');
                    }

                    // Generate reset token
                    const resetToken = this.generateToken();
                    const resetRequests = JSON.parse(localStorage.getItem(this.PASSWORD_RESET_KEY) || '{}');

                    resetRequests[resetToken] = {
                        userId: user.id,
                        email: user.email,
                        createdAt: Date.now(),
                        expiresAt: Date.now() + (24 * 60 * 60 * 1000) // 24 hours
                    };

                    localStorage.setItem(this.PASSWORD_RESET_KEY, JSON.stringify(resetRequests));

                    // Send actual password reset email
                    try {
                        await this.sendPasswordResetEmailReal(user, resetToken);
                        showAlert('üìß Password reset link sent! Please check your email.', 'success');
                    } catch (emailError) {
                        console.error('[UserManager] Password reset email failed:', emailError);
                        // Fallback to demo mode
                        console.log('[UserManager] Falling back to demo mode');
                        showAlert('‚ö†Ô∏è Email service temporarily unavailable. Using demo mode.', 'warning');

                        // For demo purposes, show reset link in alert
                        setTimeout(() => {
                            if (confirm('Demo Mode: Click OK to simulate clicking the reset link in your email.')) {
                                this.showPasswordResetForm(resetToken);
                            }
                        }, 2000);
                    }

                } catch (error) {
                    console.error('[UserManager] Password reset error:', error);
                    showAlert('‚ùå ' + error.message, 'error');
                }
            },

            // Send password reset email using existing infrastructure
            sendPasswordResetEmailReal: async function(user, resetToken) {
                const resetLink = `${window.location.origin}?reset=${resetToken}`;

                const emailData = {
                    from_email: 'info@datanalysisninsights.co.uk',
                    from_name: 'Bulk Email Sender - Password Reset',
                    to_email: user.email,
                    to_name: user.name,
                    subject: 'üîë Reset Your Password - Bulk Email Sender',
                    html_content: `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <meta charset="utf-8">
                            <title>Password Reset Request</title>
                        </head>
                        <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;">
                            <div style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); padding: 30px; text-align: center; border-radius: 10px 10px 0 0;">
                                <h1 style="color: white; margin: 0; font-size: 28px;">üîë Password Reset Request</h1>
                            </div>

                            <div style="background: #f8f9fa; padding: 30px; border-radius: 0 0 10px 10px; border: 1px solid #e9ecef;">
                                <h2 style="color: #dc3545; margin-top: 0;">Hi ${user.name},</h2>

                                <p>We received a request to reset your password for your <strong>Bulk Email Sender</strong> account.</p>

                                <p>If you requested this password reset, click the button below to create a new password:</p>

                                <div style="text-align: center; margin: 30px 0;">
                                    <a href="${resetLink}" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; font-weight: bold; display: inline-block; font-size: 16px;">
                                        üîí Reset My Password
                                    </a>
                                </div>

                                <p style="font-size: 14px; color: #666;">If the button doesn't work, copy and paste this link into your browser:</p>
                                <p style="background: #e9ecef; padding: 10px; border-radius: 4px; word-break: break-all; font-size: 12px;">${resetLink}</p>

                                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 15px; margin: 25px 0;">
                                    <h4 style="color: #856404; margin: 0 0 10px 0;">‚ö†Ô∏è Security Notice:</h4>
                                    <ul style="margin: 0; color: #856404; font-size: 14px;">
                                        <li>This reset link will expire in <strong>24 hours</strong></li>
                                        <li>If you didn't request this reset, please ignore this email</li>
                                        <li>Your password will remain unchanged unless you click the link</li>
                                    </ul>
                                </div>

                                <p style="margin-top: 30px; font-size: 12px; color: #999; text-align: center;">
                                    For security reasons, this link can only be used once.<br>
                                    If you need help, contact support at info@datanalysisninsights.co.uk
                                </p>
                            </div>

                            <div style="text-align: center; margin-top: 20px; font-size: 12px; color: #999;">
                                <p>üîí Bulk Email Sender - Professional Email Campaign Platform</p>
                                <p>Visit us at: ${window.location.origin}</p>
                            </div>
                        </body>
                        </html>
                    `,
                    reply_to: 'Bulk Email Sender Support <info@datanalysisninsights.co.uk>'
                };

                const result = await this.sendEmailViaInfrastructure(emailData);

                if (!result.success) {
                    throw new Error(result.error || 'Failed to send password reset email');
                }

                console.log('[UserManager] ‚úÖ Password reset email sent successfully via', result.service);
                return result;
            },

            // Use existing email infrastructure to send emails
            sendEmailViaInfrastructure: async function(emailData) {
                try {
                    console.log('[UserManager] Sending email via existing infrastructure...');

                    // Try to use the existing email sending function
                    if (typeof sendViaZoho === 'function') {
                        console.log('[UserManager] Using Zoho SMTP...');
                        return await sendViaZoho(emailData);
                    }

                    // Fallback to Netlify function
                    console.log('[UserManager] Using Netlify function...');
                    const response = await fetch('/.netlify/functions/send-email', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(emailData)
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        return { success: true, service: 'Netlify Function', messageId: result.messageId };
                    } else {
                        throw new Error(result.error || 'Netlify function failed');
                    }

                } catch (error) {
                    console.error('[UserManager] Email infrastructure error:', error);
                    return { success: false, error: error.message };
                }
            },

            // Reset password with token
            resetPassword: function(token, newPassword) {
                try {
                    const resetRequests = JSON.parse(localStorage.getItem(this.PASSWORD_RESET_KEY) || '{}');
                    const resetRequest = resetRequests[token];

                    if (!resetRequest) {
                        throw new Error('Invalid reset link. Please request a new password reset.');
                    }

                    if (resetRequest.expiresAt < Date.now()) {
                        delete resetRequests[token];
                        localStorage.setItem(this.PASSWORD_RESET_KEY, JSON.stringify(resetRequests));
                        throw new Error('Reset link has expired. Please request a new password reset.');
                    }

                    if (!newPassword || newPassword.length < 6) {
                        throw new Error('Password must be at least 6 characters long.');
                    }

                    // Update user password
                    const users = this.getAllUsers();
                    const user = users[resetRequest.userId];

                    if (!user) {
                        throw new Error('User account not found.');
                    }

                    user.password = this.hashPassword(newPassword);
                    user.isVerified = true; // Auto-verify on password reset
                    users[user.id] = user;
                    this.saveAllUsers(users);

                    // Clean up reset request
                    delete resetRequests[token];
                    localStorage.setItem(this.PASSWORD_RESET_KEY, JSON.stringify(resetRequests));

                    console.log('[UserManager] Password reset successful for:', user.email);
                    showAlert('‚úÖ Password reset successful! You can now log in with your new password.', 'success');

                    return true;
                } catch (error) {
                    console.error('[UserManager] Password reset error:', error);
                    throw error;
                }
            },

            // Update user display in UI
            updateUserDisplay: function() {
                const userNameElement = document.getElementById('currentUserName');
                if (userNameElement) {
                    if (this.isLoggedIn && this.currentUser) {
                        userNameElement.textContent = this.currentUser.name || this.currentUser.email;
                    } else {
                        userNameElement.textContent = 'Not logged in';
                    }
                }
            },

            // Show authentication modal
            showAuthModal: function(defaultTab = 'login') {
                if (this.isLoggedIn) {
                    this.showUserProfile();
                    return;
                }

                const modal = document.createElement('div');
                modal.id = 'authModal';
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center;
                    z-index: 1000000; padding: 20px;
                `;

                modal.innerHTML = `
                    <div style="background: white; padding: 35px; border-radius: 16px; max-width: 480px; width: 90%; max-height: 90%; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                            <h2 style="margin: 0; color: #007bff; display: flex; align-items: center; gap: 10px; font-size: 24px;">
                                <span>üîê</span> Account Access
                            </h2>
                            <button onclick="UserManager.closeAuthModal()" class="modal-close-btn" title="Close">√ó</button>
                        </div>

                        <!-- Error Display -->
                        <div id="authError" style="display: none; background: #fee; border: 1px solid #fcc; color: #c33; padding: 12px; border-radius: 6px; margin-bottom: 20px; font-size: 14px;"></div>

                        <!-- Success Display -->
                        <div id="authSuccess" style="display: none; background: #efe; border: 1px solid #cfc; color: #3c3; padding: 12px; border-radius: 6px; margin-bottom: 20px; font-size: 14px;"></div>

                        <!-- Login/Register Tabs -->
                        <div style="display: flex; margin-bottom: 25px; background: #f8f9fa; border-radius: 8px; padding: 4px;">
                            <button id="loginTab" onclick="UserManager.switchAuthTab('login')" style="flex: 1; padding: 12px; border: none; background: #007bff; color: white; cursor: pointer; border-radius: 6px; font-weight: 600; transition: all 0.2s;">Login</button>
                            <button id="registerTab" onclick="UserManager.switchAuthTab('register')" style="flex: 1; padding: 12px; border: none; background: transparent; color: #666; cursor: pointer; border-radius: 6px; font-weight: 600; transition: all 0.2s;">Register</button>
                        </div>

                        <!-- Login Form -->
                        <form id="loginForm" onsubmit="UserManager.handleLogin(event)">
                            <div style="margin-bottom: 18px;">
                                <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 14px;">Email Address *</label>
                                <input type="email" id="loginEmail" placeholder="your.email@company.com"
                                    style="width: 100%; padding: 14px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 15px; transition: border-color 0.2s;"
                                    required autocomplete="email">
                            </div>
                            <div style="margin-bottom: 18px;">
                                <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 14px;">Password *</label>
                                <input type="password" id="loginPassword" placeholder="Enter your password"
                                    style="width: 100%; padding: 14px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 15px; transition: border-color 0.2s;"
                                    required autocomplete="current-password">
                            </div>

                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <label style="display: flex; align-items: center; font-size: 14px; color: #666; cursor: pointer;">
                                    <input type="checkbox" id="rememberMe" style="margin-right: 8px;"> Remember me
                                </label>
                                <button type="button" onclick="UserManager.showForgotPassword()" style="background: none; border: none; color: #007bff; font-size: 14px; cursor: pointer; text-decoration: underline;">Forgot Password?</button>
                            </div>

                            <button type="submit" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #007bff, #0056b3); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 20px; transition: all 0.2s; box-shadow: 0 4px 15px rgba(0,123,255,0.3);">üîì Sign In</button>
                        </form>

                        <!-- Register Form -->
                        <form id="registerForm" style="display: none;" onsubmit="UserManager.handleRegister(event)">
                            <div style="margin-bottom: 18px;">
                                <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 14px;">Full Name *</label>
                                <input type="text" id="registerName" placeholder="John Doe"
                                    style="width: 100%; padding: 14px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 15px; transition: border-color 0.2s;"
                                    required autocomplete="name">
                            </div>
                            <div style="margin-bottom: 18px;">
                                <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 14px;">Email Address *</label>
                                <input type="email" id="registerEmail" placeholder="your.email@company.com"
                                    style="width: 100%; padding: 14px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 15px; transition: border-color 0.2s;"
                                    required autocomplete="email">
                            </div>
                            <div style="margin-bottom: 18px;">
                                <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 14px;">Password *</label>
                                <input type="password" id="registerPassword" placeholder="Minimum 6 characters"
                                    style="width: 100%; padding: 14px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 15px; transition: border-color 0.2s;"
                                    required autocomplete="new-password" minlength="6">
                                <small style="color: #666; font-size: 12px; display: block; margin-top: 4px;">Password must be at least 6 characters long</small>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <label style="display: flex; align-items: flex-start; font-size: 13px; color: #666; cursor: pointer;">
                                    <input type="checkbox" id="agreeTerms" required style="margin-right: 8px; margin-top: 2px;">
                                    <span>I agree to the Terms of Service and Privacy Policy</span>
                                </label>
                            </div>

                            <button type="submit" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 20px; transition: all 0.2s; box-shadow: 0 4px 15px rgba(40,167,69,0.3);">üÜï Create Account</button>
                        </form>

                        <!-- OAuth Options -->
                        <div style="border-top: 1px solid #e1e5e9; padding-top: 25px; margin-top: 20px;">
                            <p style="text-align: center; color: #666; margin-bottom: 18px; font-size: 14px; font-weight: 500;">Or continue with:</p>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <button onclick="UserManager.googleAuth()" style="padding: 12px; border: 2px solid #db4437; color: #db4437; background: white; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <span style="font-size: 16px;">üìß</span> Google
                                </button>
                                <button onclick="UserManager.microsoftAuth()" style="padding: 12px; border: 2px solid #0078d4; color: #0078d4; background: white; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <span style="font-size: 16px;">üè¢</span> Microsoft
                                </button>
                            </div>
                            <p style="text-align: center; color: #999; margin-top: 15px; font-size: 12px;">OAuth integration provides secure, passwordless authentication</p>
                        </div>

                        <div style="text-align: center; margin-top: 25px; padding-top: 20px; border-top: 1px solid #e1e5e9;">
                            <small style="color: #666; line-height: 1.4;">üîí Your data is encrypted and stored securely. We never share your information with third parties.</small>
                        </div>
                    </div>
                `;

                // Set default tab
                if (defaultTab === 'register') {
                    setTimeout(() => this.switchAuthTab('register'), 100);
                }

                document.body.appendChild(modal);

                // Add form submission listeners
                this.addFormListeners();

                // Focus first input
                setTimeout(() => {
                    const firstInput = modal.querySelector('input[type="email"]');
                    if (firstInput) firstInput.focus();
                }, 200);
            },

            // Close authentication modal
            closeAuthModal: function() {
                const modal = document.getElementById('authModal');
                if (modal) {
                    modal.remove();
                }
                // Don't hide auth gate - user must login
            },

            // Add form event listeners
            addFormListeners: function() {
                // Add Enter key submission
                const inputs = document.querySelectorAll('#authModal input');
                inputs.forEach(input => {
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            const form = input.closest('form');
                            if (form) {
                                e.preventDefault();
                                const submitBtn = form.querySelector('button[type="submit"]');
                                if (submitBtn) submitBtn.click();
                            }
                        }
                    });

                    // Add focus styling
                    input.addEventListener('focus', (e) => {
                        e.target.style.borderColor = '#007bff';
                        e.target.style.boxShadow = '0 0 0 3px rgba(0,123,255,0.1)';
                    });

                    input.addEventListener('blur', (e) => {
                        e.target.style.borderColor = '#e1e5e9';
                        e.target.style.boxShadow = 'none';
                    });
                });
            },

            // Switch between login and register tabs
            switchAuthTab: function(tab) {
                const loginTab = document.getElementById('loginTab');
                const registerTab = document.getElementById('registerTab');
                const loginForm = document.getElementById('loginForm');
                const registerForm = document.getElementById('registerForm');

                // Clear any error messages
                this.hideAuthMessage();

                if (tab === 'login') {
                    loginTab.style.background = '#007bff';
                    loginTab.style.color = 'white';
                    registerTab.style.background = 'transparent';
                    registerTab.style.color = '#666';
                    loginForm.style.display = 'block';
                    registerForm.style.display = 'none';

                    // Focus email input
                    setTimeout(() => {
                        const emailInput = document.getElementById('loginEmail');
                        if (emailInput) emailInput.focus();
                    }, 100);
                } else {
                    registerTab.style.background = '#28a745';
                    registerTab.style.color = 'white';
                    loginTab.style.background = 'transparent';
                    loginTab.style.color = '#666';
                    loginForm.style.display = 'none';
                    registerForm.style.display = 'block';

                    // Focus name input
                    setTimeout(() => {
                        const nameInput = document.getElementById('registerName');
                        if (nameInput) nameInput.focus();
                    }, 100);
                }
            },

            // Show authentication message
            showAuthMessage: function(message, type = 'error') {
                const errorDiv = document.getElementById('authError');
                const successDiv = document.getElementById('authSuccess');

                if (type === 'error') {
                    errorDiv.textContent = message;
                    errorDiv.style.display = 'block';
                    successDiv.style.display = 'none';
                } else {
                    successDiv.textContent = message;
                    successDiv.style.display = 'block';
                    errorDiv.style.display = 'none';
                }

                // Auto-hide after 10 seconds
                setTimeout(() => this.hideAuthMessage(), 10000);
            },

            // Hide authentication message
            hideAuthMessage: function() {
                const errorDiv = document.getElementById('authError');
                const successDiv = document.getElementById('authSuccess');
                if (errorDiv) errorDiv.style.display = 'none';
                if (successDiv) successDiv.style.display = 'none';
            },

            // Handle login
            handleLogin: function(event) {
                if (event) {
                    event.preventDefault();
                }

                try {
                    // Clear previous messages
                    this.hideAuthMessage();

                    const email = document.getElementById('loginEmail').value.trim();
                    const password = document.getElementById('loginPassword').value;
                    const rememberMe = document.getElementById('rememberMe').checked;

                    // Client-side validation
                    if (!email) {
                        this.showAuthMessage('Please enter your email address.', 'error');
                        document.getElementById('loginEmail').focus();
                        return;
                    }

                    if (!password) {
                        this.showAuthMessage('Please enter your password.', 'error');
                        document.getElementById('loginPassword').focus();
                        return;
                    }

                    // Show loading state
                    const submitBtn = document.querySelector('#loginForm button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.textContent = 'üîÑ Signing in...';
                    submitBtn.disabled = true;

                    // Attempt login
                    setTimeout(() => {
                        try {
                            this.login(email, password);

                            // Handle remember me
                            if (rememberMe) {
                                // Extend session (already handled in saveSession)
                                console.log('[UserManager] Remember me enabled');
                            }

                            // Close modal and show success
                            document.getElementById('authModal').remove();
                            this.showWelcomeMessage();

                        } catch (error) {
                            console.error('[UserManager] Login failed:', error);
                            this.showAuthMessage(error.message, 'error');

                            // Reset button
                            submitBtn.textContent = originalText;
                            submitBtn.disabled = false;
                        }
                    }, 500); // Small delay for better UX

                } catch (error) {
                    console.error('[UserManager] Login handler error:', error);
                    this.showAuthMessage('An unexpected error occurred. Please try again.', 'error');
                }
            },

            // Handle registration
            handleRegister: function(event) {
                if (event) {
                    event.preventDefault();
                }

                try {
                    // Clear previous messages
                    this.hideAuthMessage();

                    const name = document.getElementById('registerName').value.trim();
                    const email = document.getElementById('registerEmail').value.trim();
                    const password = document.getElementById('registerPassword').value;
                    const agreeTerms = document.getElementById('agreeTerms').checked;

                    // Client-side validation
                    if (!name) {
                        this.showAuthMessage('Please enter your full name.', 'error');
                        document.getElementById('registerName').focus();
                        return;
                    }

                    if (!email) {
                        this.showAuthMessage('Please enter your email address.', 'error');
                        document.getElementById('registerEmail').focus();
                        return;
                    }

                    if (!password) {
                        this.showAuthMessage('Please enter a password.', 'error');
                        document.getElementById('registerPassword').focus();
                        return;
                    }

                    if (password.length < 6) {
                        this.showAuthMessage('Password must be at least 6 characters long.', 'error');
                        document.getElementById('registerPassword').focus();
                        return;
                    }

                    if (!agreeTerms) {
                        this.showAuthMessage('Please agree to the Terms of Service and Privacy Policy.', 'error');
                        return;
                    }

                    // Show loading state
                    const submitBtn = document.querySelector('#registerForm button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.textContent = 'üîÑ Creating account...';
                    submitBtn.disabled = true;

                    // Attempt registration
                    setTimeout(() => {
                        try {
                            this.registerUser(email, password, name);

                            // For demo purposes, auto-verify and login
                            // In production, user would need to verify email first
                            const users = this.getAllUsers();
                            const user = Object.values(users).find(u => u.email.toLowerCase() === email.toLowerCase());
                            if (user) {
                                user.isVerified = true; // Auto-verify for demo
                                users[user.id] = user;
                                this.saveAllUsers(users);
                            }

                            this.login(email, password);

                            // Close modal and show success
                            document.getElementById('authModal').remove();
                            this.showWelcomeMessage(true);

                        } catch (error) {
                            console.error('[UserManager] Registration failed:', error);
                            this.showAuthMessage(error.message, 'error');

                            // Reset button
                            submitBtn.textContent = originalText;
                            submitBtn.disabled = false;
                        }
                    }, 800); // Slightly longer delay for registration

                } catch (error) {
                    console.error('[UserManager] Registration handler error:', error);
                    this.showAuthMessage('An unexpected error occurred. Please try again.', 'error');
                }
            },

            // Show welcome message after successful login
            showWelcomeMessage: function(isNewUser = false) {
                const message = isNewUser ?
                    `üéâ Welcome to Bulk Email Sender! Your account has been created successfully.` :
                    `‚úÖ Welcome back, ${this.currentUser.name}! You are now logged in.`;

                showAlert(message, 'success');

                // Show onboarding for new users
                if (isNewUser) {
                    setTimeout(() => {
                        this.showFirstTimeOnboarding();
                    }, 2000);
                }
            },

            // Google OAuth implementation
            googleAuth: function() {
                try {
                    if (window.google && window.google.accounts) {
                        window.google.accounts.id.prompt((notification) => {
                            if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
                                console.log('[UserManager] Google OAuth prompt not displayed');
                                this.showAuthMessage('Google sign-in is not available. Please try manual login.', 'error');
                            }
                        });
                    } else {
                        // Fallback: simulate OAuth for demo
                        this.simulateOAuthLogin('google');
                    }
                } catch (error) {
                    console.error('[UserManager] Google OAuth error:', error);
                    this.showAuthMessage('Google sign-in failed. Please try manual login.', 'error');
                }
            },

            // Microsoft OAuth implementation
            microsoftAuth: function() {
                try {
                    if (this.msalInstance) {
                        const loginRequest = {
                            scopes: ['openid', 'profile', 'email']
                        };

                        this.msalInstance.loginPopup(loginRequest)
                            .then(response => {
                                this.handleMicrosoftResponse(response);
                            })
                            .catch(error => {
                                console.error('[UserManager] Microsoft OAuth error:', error);
                                this.showAuthMessage('Microsoft sign-in failed. Please try manual login.', 'error');
                            });
                    } else {
                        // Fallback: simulate OAuth for demo
                        this.simulateOAuthLogin('microsoft');
                    }
                } catch (error) {
                    console.error('[UserManager] Microsoft OAuth error:', error);
                    this.showAuthMessage('Microsoft sign-in failed. Please try manual login.', 'error');
                }
            },

            // Simulate OAuth login for demo purposes
            simulateOAuthLogin: function(provider) {
                const demoEmail = prompt(`Enter your ${provider} email for demo login:`);
                if (demoEmail && demoEmail.includes('@')) {
                    try {
                        const users = this.getAllUsers();
                        let user = Object.values(users).find(u => u.email.toLowerCase() === demoEmail.toLowerCase());

                        if (!user) {
                            // Register new OAuth user
                            const name = demoEmail.split('@')[0].replace(/[^a-zA-Z0-9]/g, ' ');
                            const userId = this.registerUser(demoEmail, null, name, provider);
                            user = users[userId];
                        }

                        // Login OAuth user
                        this.currentUser = user;
                        this.isLoggedIn = true;
                        this.saveSession();

                        document.getElementById('authModal').remove();
                        this.showWelcomeMessage();

                        console.log('[UserManager] Demo OAuth login successful:', provider);
                    } catch (error) {
                        this.showAuthMessage('OAuth simulation failed: ' + error.message, 'error');
                    }
                }
            },

            // Handle Google OAuth response
            handleGoogleResponse: function(response) {
                try {
                    const payload = JSON.parse(atob(response.credential.split('.')[1]));
                    const email = payload.email;
                    const name = payload.name;

                    // Register or login OAuth user
                    this.processOAuthUser(email, name, 'google', payload);
                } catch (error) {
                    console.error('[UserManager] Google response error:', error);
                    this.showAuthMessage('Google sign-in failed. Please try again.', 'error');
                }
            },

            // Handle Microsoft OAuth response
            handleMicrosoftResponse: function(response) {
                try {
                    const account = response.account;
                    const email = account.username;
                    const name = account.name;

                    // Register or login OAuth user
                    this.processOAuthUser(email, name, 'microsoft', account);
                } catch (error) {
                    console.error('[UserManager] Microsoft response error:', error);
                    this.showAuthMessage('Microsoft sign-in failed. Please try again.', 'error');
                }
            },

            // Process OAuth user login/registration
            processOAuthUser: function(email, name, provider, providerData) {
                try {
                    const users = this.getAllUsers();
                    let user = Object.values(users).find(u => u.email.toLowerCase() === email.toLowerCase());

                    if (!user) {
                        // Register new OAuth user
                        const userId = this.registerUser(email, null, name, provider);
                        user = users[userId];
                        user.providerData = providerData;
                        users[userId] = user;
                        this.saveAllUsers(users);
                    }

                    // Login OAuth user
                    this.login(email, null, provider);

                    document.getElementById('authModal').remove();
                    this.showWelcomeMessage(!user.lastLogin);

                } catch (error) {
                    console.error('[UserManager] OAuth processing error:', error);
                    this.showAuthMessage('OAuth sign-in failed: ' + error.message, 'error');
                }
            },

            // Show forgot password form
            showForgotPassword: function() {
                const modal = document.createElement('div');
                modal.id = 'forgotPasswordModal';
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center;
                    z-index: 1000001; padding: 20px;
                `;

                modal.innerHTML = `
                    <div style="background: white; padding: 35px; border-radius: 16px; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                            <h2 style="margin: 0; color: #007bff; font-size: 22px;">üîë Reset Password</h2>
                            <button onclick="document.getElementById('forgotPasswordModal').remove()" class="modal-close-btn" title="Close">√ó</button>
                        </div>

                        <div id="forgotPasswordError" style="display: none; background: #fee; border: 1px solid #fcc; color: #c33; padding: 12px; border-radius: 6px; margin-bottom: 20px; font-size: 14px;"></div>
                        <div id="forgotPasswordSuccess" style="display: none; background: #efe; border: 1px solid #cfc; color: #3c3; padding: 12px; border-radius: 6px; margin-bottom: 20px; font-size: 14px;"></div>

                        <p style="color: #666; margin-bottom: 25px; line-height: 1.5;">Enter your email address and we'll send you a link to reset your password.</p>

                        <form id="forgotPasswordForm" onsubmit="UserManager.handleForgotPassword(event)">
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 14px;">Email Address *</label>
                                <input type="email" id="forgotEmail" placeholder="your.email@company.com"
                                    style="width: 100%; padding: 14px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 15px;"
                                    required autocomplete="email">
                            </div>

                            <div style="display: flex; gap: 12px;">
                                <button type="button" onclick="document.getElementById('forgotPasswordModal').remove()" style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">Cancel</button>
                                <button type="submit" style="flex: 1; padding: 12px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">üìß Send Reset Link</button>
                            </div>
                        </form>
                    </div>
                `;

                document.body.appendChild(modal);

                // Focus email input
                setTimeout(() => {
                    const emailInput = document.getElementById('forgotEmail');
                    if (emailInput) emailInput.focus();
                }, 200);
            },

            // Handle forgot password
            handleForgotPassword: function(event) {
                event.preventDefault();

                try {
                    const email = document.getElementById('forgotEmail').value.trim();
                    const errorDiv = document.getElementById('forgotPasswordError');
                    const successDiv = document.getElementById('forgotPasswordSuccess');

                    // Hide previous messages
                    errorDiv.style.display = 'none';
                    successDiv.style.display = 'none';

                    if (!email) {
                        errorDiv.textContent = 'Please enter your email address.';
                        errorDiv.style.display = 'block';
                        return;
                    }

                    // Show loading
                    const submitBtn = document.querySelector('#forgotPasswordForm button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.textContent = 'üîÑ Sending...';
                    submitBtn.disabled = true;

                    setTimeout(() => {
                        try {
                            this.sendPasswordResetEmail(email);

                            successDiv.textContent = 'If an account with this email exists, a password reset link has been sent.';
                            successDiv.style.display = 'block';

                            // Auto-close after 3 seconds
                            setTimeout(() => {
                                document.getElementById('forgotPasswordModal').remove();
                            }, 3000);

                        } catch (error) {
                            errorDiv.textContent = error.message;
                            errorDiv.style.display = 'block';

                            submitBtn.textContent = originalText;
                            submitBtn.disabled = false;
                        }
                    }, 1000);

                } catch (error) {
                    console.error('[UserManager] Forgot password error:', error);
                }
            },

            // Show password reset form
            showPasswordResetForm: function(token) {
                const modal = document.createElement('div');
                modal.id = 'passwordResetModal';
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center;
                    z-index: 1000001; padding: 20px;
                `;

                modal.innerHTML = `
                    <div style="background: white; padding: 35px; border-radius: 16px; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                            <h2 style="margin: 0; color: #28a745; font-size: 22px;">üîë Set New Password</h2>
                            <button onclick="document.getElementById('passwordResetModal').remove()" class="modal-close-btn" title="Close">√ó</button>
                        </div>

                        <div id="resetError" style="display: none; background: #fee; border: 1px solid #fcc; color: #c33; padding: 12px; border-radius: 6px; margin-bottom: 20px; font-size: 14px;"></div>

                        <p style="color: #666; margin-bottom: 25px; line-height: 1.5;">Enter your new password below.</p>

                        <form id="passwordResetForm" onsubmit="UserManager.handlePasswordReset(event, '${token}')">
                            <div style="margin-bottom: 18px;">
                                <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 14px;">New Password *</label>
                                <input type="password" id="newPassword" placeholder="Minimum 6 characters"
                                    style="width: 100%; padding: 14px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 15px;"
                                    required minlength="6">
                                <small style="color: #666; font-size: 12px; display: block; margin-top: 4px;">Password must be at least 6 characters long</small>
                            </div>

                            <div style="margin-bottom: 25px;">
                                <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 14px;">Confirm Password *</label>
                                <input type="password" id="confirmPassword" placeholder="Repeat your new password"
                                    style="width: 100%; padding: 14px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 15px;"
                                    required minlength="6">
                            </div>

                            <button type="submit" style="width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">üîí Reset Password</button>
                        </form>
                    </div>
                `;

                document.body.appendChild(modal);

                // Focus password input
                setTimeout(() => {
                    const passwordInput = document.getElementById('newPassword');
                    if (passwordInput) passwordInput.focus();
                }, 200);
            },

            // Handle password reset
            handlePasswordReset: function(event, token) {
                event.preventDefault();

                try {
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;
                    const errorDiv = document.getElementById('resetError');

                    errorDiv.style.display = 'none';

                    if (!newPassword || !confirmPassword) {
                        errorDiv.textContent = 'Please fill in both password fields.';
                        errorDiv.style.display = 'block';
                        return;
                    }

                    if (newPassword !== confirmPassword) {
                        errorDiv.textContent = 'Passwords do not match.';
                        errorDiv.style.display = 'block';
                        return;
                    }

                    if (newPassword.length < 6) {
                        errorDiv.textContent = 'Password must be at least 6 characters long.';
                        errorDiv.style.display = 'block';
                        return;
                    }

                    // Show loading
                    const submitBtn = document.querySelector('#passwordResetForm button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.textContent = 'üîÑ Resetting...';
                    submitBtn.disabled = true;

                    setTimeout(() => {
                        try {
                            this.resetPassword(token, newPassword);

                            document.getElementById('passwordResetModal').remove();

                            // Show login modal
                            setTimeout(() => {
                                this.showAuthModal('login');
                            }, 1000);

                        } catch (error) {
                            errorDiv.textContent = error.message;
                            errorDiv.style.display = 'block';

                            submitBtn.textContent = originalText;
                            submitBtn.disabled = false;
                        }
                    }, 1000);

                } catch (error) {
                    console.error('[UserManager] Password reset error:', error);
                }
            },

            // Show first-time user onboarding
            showFirstTimeOnboarding: function() {
                const modal = document.createElement('div');
                modal.id = 'onboardingModal';
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    display: flex; align-items: center; justify-content: center;
                    z-index: 1000001; padding: 20px;
                `;

                modal.innerHTML = `
                    <div style="background: white; padding: 40px; border-radius: 20px; max-width: 600px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center;">
                        <div style="font-size: 64px; margin-bottom: 20px;">üéâ</div>
                        <h1 style="margin: 0 0 15px 0; color: #333; font-size: 32px;">Welcome to Bulk Email Sender!</h1>
                        <p style="margin: 0 0 30px 0; color: #666; font-size: 18px; line-height: 1.5;">Your professional email campaign platform is ready.</p>

                        <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 30px; text-align: left;">
                            <h3 style="margin: 0 0 20px 0; color: #007bff; font-size: 20px; text-align: center;">üöÄ Get Started in 3 Easy Steps:</h3>
                            <div style="display: grid; gap: 20px;">
                                <div style="display: flex; align-items: flex-start; gap: 15px;">
                                    <div style="background: #007bff; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">1</div>
                                    <div>
                                        <h4 style="margin: 0 0 5px 0; color: #333;">Create Your Company Profile</h4>
                                        <p style="margin: 0; color: #666; font-size: 14px;">Set up your company information for automatic email personalization</p>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: flex-start; gap: 15px;">
                                    <div style="background: #28a745; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">2</div>
                                    <div>
                                        <h4 style="margin: 0 0 5px 0; color: #333;">Upload Your Contacts</h4>
                                        <p style="margin: 0; color: #666; font-size: 14px;">Import contacts from Excel, CSV, PDF, or other supported formats</p>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: flex-start; gap: 15px;">
                                    <div style="background: #17a2b8; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">3</div>
                                    <div>
                                        <h4 style="margin: 0 0 5px 0; color: #333;">Send Personalized Campaigns</h4>
                                        <p style="margin: 0; color: #666; font-size: 14px;">Compose and send bulk emails with automatic personalization</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 15px; justify-content: center;">
                            <button onclick="UserManager.startOnboarding()" style="padding: 15px 30px; background: linear-gradient(135deg, #007bff, #0056b3); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s;">üöÄ Start Setup</button>
                            <button onclick="UserManager.skipOnboarding()" style="padding: 15px 30px; background: #6c757d; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer;">‚è≠Ô∏è Skip for Now</button>
                        </div>

                        <p style="margin: 30px 0 0 0; color: #999; font-size: 12px;">You can access this tutorial anytime from the Help button.</p>
                    </div>
                `;

                document.body.appendChild(modal);
            },

            // Start onboarding process
            startOnboarding: function() {
                document.getElementById('onboardingModal').remove();

                // Show company management for first-time setup
                setTimeout(() => {
                    CompanyOnboardingModule.showManager();
                    showAlert('üéÜ Let\'s start by setting up your company profile! Use the auto-fill templates for quick setup.', 'info');
                }, 500);
            },

            // Skip onboarding
            skipOnboarding: function() {
                document.getElementById('onboardingModal').remove();
                showAlert('üìù You can create your company profile anytime from Settings ‚Üí Add Company.', 'info');
            },

            // Show user profile
            showUserProfile: function() {
                if (!this.isLoggedIn) return;

                const modal = document.createElement('div');
                modal.id = 'userProfileModal';
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
                    z-index: 10000; padding: 20px;
                `;

                const companiesCount = this.currentUser.companies?.length || 0;
                const activeCompaniesCount = this.currentUser.activeCompanies?.length || 0;

                modal.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                            <h2 style="margin: 0; color: #007bff;">üë§ User Profile</h2>
                            <button onclick="document.getElementById('userProfileModal').remove()" class="modal-close-btn" title="Close">√ó</button>
                        </div>

                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: auto 1fr; gap: 15px; align-items: center;">
                                <div style="font-size: 48px;">üë§</div>
                                <div>
                                    <h3 style="margin: 0 0 5px 0; color: #333;">${this.currentUser.name}</h3>
                                    <p style="margin: 0; color: #666; font-size: 14px;">${this.currentUser.email}</p>
                                    <small style="color: #999;">Member since ${new Date(this.currentUser.createdAt).toLocaleDateString()}</small>
                                </div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;">
                            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #1976d2;">${companiesCount}</div>
                                <div style="font-size: 12px; color: #666;">Companies</div>
                            </div>
                            <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #2e7d32;">${activeCompaniesCount}</div>
                                <div style="font-size: 12px; color: #666;">Active</div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px;">
                            <button onclick="UserManager.showCompanySelection(); document.getElementById('userProfileModal').remove();" style="flex: 1; padding: 12px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer;">üè¢ My Companies</button>
                            <button onclick="UserManager.logout(); document.getElementById('userProfileModal').remove();" style="flex: 1; padding: 12px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;">üö™ Logout</button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
            },

            // Show company selection for current user
            showCompanySelection: function() {
                if (!this.isLoggedIn) {
                    this.showAuthModal();
                    return;
                }

                const userCompanies = CompanyOnboardingModule.getUserCompanies(this.currentUser.id);

                const modal = document.createElement('div');
                modal.id = 'companySelectionModal';
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
                    z-index: 10000; padding: 20px;
                `;

                modal.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 700px; width: 90%; max-height: 80%; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="margin: 0; color: #007bff;">üè¢ My Companies</h2>
                            <button onclick="document.getElementById('companySelectionModal').remove()" class="modal-close-btn" title="Close">√ó</button>
                        </div>

                        ${userCompanies.length === 0 ? `
                            <div style="text-align: center; padding: 40px; color: #666;">
                                <div style="font-size: 64px; margin-bottom: 20px;">üè¢</div>
                                <h3 style="margin: 0 0 15px 0;">No Companies Yet</h3>
                                <p style="margin: 0 0 25px 0;">Create your first company profile to get started with personalized email campaigns.</p>
                                <button onclick="CompanyOnboardingModule.showManager(); document.getElementById('companySelectionModal').remove();" style="background: #007bff; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500;">‚ûï Create First Company</button>
                            </div>
                        ` : `
                            <div style="margin-bottom: 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <p style="margin: 0; color: #666;">Select which companies to use for email personalization:</p>
                                    <button onclick="CompanyOnboardingModule.showManager(); document.getElementById('companySelectionModal').remove();" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 12px;">‚ûï Add Company</button>
                                </div>

                                <div style="display: grid; gap: 15px;">
                                    ${userCompanies.map(company => `
                                        <div style="border: 2px solid ${this.currentUser.activeCompanies?.includes(company.id) ? '#28a745' : '#e1e5e9'}; border-radius: 8px; padding: 15px; background: ${this.currentUser.activeCompanies?.includes(company.id) ? '#f8fff8' : 'white'};">
                                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                                <div style="flex: 1;">
                                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                                        <input type="checkbox" id="company_${company.id}" ${this.currentUser.activeCompanies?.includes(company.id) ? 'checked' : ''} onchange="UserManager.toggleCompanySelection('${company.id}')" style="margin-right: 10px; transform: scale(1.2);">
                                                        <h4 style="margin: 0; color: #333;">${company.companyName || 'Unnamed Company'}</h4>
                                                    </div>
                                                    <p style="margin: 0 0 5px 25px; color: #666; font-size: 14px;">${company.companyEmail || 'No email set'}</p>
                                                    <p style="margin: 0 0 5px 25px; color: #999; font-size: 12px;">${company.companyIndustry || 'Industry not specified'}</p>
                                                    <small style="margin-left: 25px; color: #999;">Created: ${new Date(company.createdAt || Date.now()).toLocaleDateString()}</small>
                                                </div>
                                                <div style="display: flex; gap: 8px;">
                                                    <button onclick="CompanyOnboardingModule.editCompany('${company.id}'); document.getElementById('companySelectionModal').remove();" style="background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">‚úèÔ∏è Edit</button>
                                                    <button onclick="UserManager.confirmDeleteCompany('${company.id}')" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">üóëÔ∏è</button>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>

                                <div style="margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 8px; border-left: 4px solid #007bff;">
                                    <h5 style="margin: 0 0 8px 0; color: #007bff;">üí° Personalization Tips:</h5>
                                    <ul style="margin: 0; padding-left: 20px; color: #666; font-size: 14px;">
                                        <li>Selected companies will be used for email personalization</li>
                                        <li>You can select multiple companies for different campaigns</li>
                                        <li>Company data auto-fills when composing emails</li>
                                    </ul>
                                </div>
                            </div>
                        `}

                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 25px; padding-top: 20px; border-top: 1px solid #e1e5e9;">
                            <span style="color: #666; font-size: 14px;">üíæ Changes saved automatically</span>
                            <button onclick="document.getElementById('companySelectionModal').remove()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">Close</button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
            },

            // Toggle company selection for personalization
            toggleCompanySelection: function(companyId) {
                if (!this.isLoggedIn) return;

                if (!this.currentUser.activeCompanies) {
                    this.currentUser.activeCompanies = [];
                }

                const index = this.currentUser.activeCompanies.indexOf(companyId);
                if (index > -1) {
                    this.currentUser.activeCompanies.splice(index, 1);
                    console.log('[UserManager] Deselected company:', companyId);
                } else {
                    this.currentUser.activeCompanies.push(companyId);
                    console.log('[UserManager] Selected company:', companyId);
                }

                // Update user data
                const users = this.getAllUsers();
                users[this.currentUser.id] = this.currentUser;
                this.saveAllUsers(users);
                this.saveSession();

                // Update the checkbox appearance
                const checkbox = document.getElementById(`company_${companyId}`);
                const container = checkbox.closest('div[style*="border:"]');
                if (this.currentUser.activeCompanies.includes(companyId)) {
                    container.style.borderColor = '#28a745';
                    container.style.backgroundColor = '#f8fff8';
                } else {
                    container.style.borderColor = '#e1e5e9';
                    container.style.backgroundColor = 'white';
                }
            },

            // Confirm delete company
            confirmDeleteCompany: function(companyId) {
                const company = CompanyOnboardingModule.companies[companyId];
                if (company && confirm(`Are you sure you want to delete "${company.companyName}"?\n\nThis action cannot be undone.`)) {
                    CompanyOnboardingModule.deleteCompany(companyId);

                    // Remove from user's active companies
                    if (this.currentUser.activeCompanies) {
                        const index = this.currentUser.activeCompanies.indexOf(companyId);
                        if (index > -1) {
                            this.currentUser.activeCompanies.splice(index, 1);
                        }
                    }

                    // Remove from user's companies
                    if (this.currentUser.companies) {
                        const index = this.currentUser.companies.indexOf(companyId);
                        if (index > -1) {
                            this.currentUser.companies.splice(index, 1);
                        }
                    }

                    // Update user data
                    const users = this.getAllUsers();
                    users[this.currentUser.id] = this.currentUser;
                    this.saveAllUsers(users);
                    this.saveSession();

                    showAlert('üóëÔ∏è Company deleted successfully.', 'success');

                    // Refresh the company selection modal
                    document.getElementById('companySelectionModal').remove();
                    setTimeout(() => this.showCompanySelection(), 300);
                }
            }
        };

        // =====================================================
        // COMPANY ONBOARDING DATA MODULE
        // =====================================================
        const CompanyOnboardingModule = {
            // Module state
            data: {},
            companies: {}, // Multi-company storage: { companyId: companyData }
            currentCompanyId: null, // Currently selected company
            storageKey: 'bulkEmail_companyOnboardingData', // Legacy single company
            companiesStorageKey: 'bulkEmail_companies', // Multi-company storage
            currentCompanyKey: 'bulkEmail_currentCompany', // Selected company ID
            backupKey: 'bulkEmail_companyOnboardingData_backup',
            autoSaveEnabled: true,
            autoSaveTimeout: null,
            autoSaveFailureCount: 0,
            maxAutoSaveFailures: 3, // Prevent infinite auto-save loops
            dataVersion: '3.0', // Updated for multi-company support

            // Module configuration
            availableFields: [
                'companyName', 'companyIndustry', 'companyWebsite', 'companyYears',
                'companyEmail', 'companyPhone', 'companyAddress', 'companyDescription', 'companyLogo',
                'productPortfolioPoints', 'OfferingPoints', 'companyShortName',
                'businesDevelopementManagerName', 'businesDevelopementManagerDesignation',
                'Link1', 'Link2', 'Link3', 'Image1', 'Image2',
                'companyZohoEmail', 'companyZohoPassword', 'companySenderName', 'companyEmailEnabled',
                'companyEmailJSService', 'companyEmailJSTemplate'
            ],

            // Field validation configuration
            mandatoryFields: ['businesDevelopementManagerName', 'businesDevelopementManagerDesignation'],
            optionalFields: ['productPortfolioPoints', 'OfferingPoints', 'companyShortName',
                           'Link1', 'Link2', 'Link3', 'Image1', 'Image2'],

            // Data persistence tracking
            lastSaveTime: null,
            unsavedChanges: false,

            // Multi-company management functions
            generateCompanyId: function() {
                return 'company_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            },

            // Get companies belonging to current user
            getUserCompanies: function(userId = null) {
                const targetUserId = userId || UserManager.currentUser?.id;
                if (!targetUserId) return [];

                return Object.values(this.companies).filter(company =>
                    company.ownerId === targetUserId
                );
            },

            // Load companies for current user
            loadUserCompanies: function() {
                if (!UserManager.isLoggedIn) {
                    console.log('[CompanyOnboarding] No user logged in, skipping company load');
                    return;
                }

                const userCompanies = this.getUserCompanies();
                console.log('[CompanyOnboarding] Loaded', userCompanies.length, 'companies for user:', UserManager.currentUser.email);

                // Auto-select first company if none selected
                if (userCompanies.length > 0 && !this.currentCompanyId) {
                    const firstCompany = userCompanies[0];
                    this.setCurrentCompany(firstCompany.id);
                }

                this.updateCurrentCompanyDisplay();
            },

            // Create company for current user
            createCompanyForUser: function(companyData) {
                if (!UserManager.isLoggedIn) {
                    throw new Error('User must be logged in to create companies');
                }

                const companyId = this.generateCompanyId();
                const newCompany = {
                    ...companyData,
                    id: companyId,
                    ownerId: UserManager.currentUser.id,
                    createdAt: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                };

                this.companies[companyId] = newCompany;
                this.saveAllCompanies();

                // Add to user's companies list
                if (!UserManager.currentUser.companies) {
                    UserManager.currentUser.companies = [];
                }
                UserManager.currentUser.companies.push(companyId);

                // Set as active if it's the first company
                if (!UserManager.currentUser.activeCompanies) {
                    UserManager.currentUser.activeCompanies = [];
                }
                if (UserManager.currentUser.activeCompanies.length === 0) {
                    UserManager.currentUser.activeCompanies.push(companyId);
                }

                // Update user data
                const users = UserManager.getAllUsers();
                users[UserManager.currentUser.id] = UserManager.currentUser;
                UserManager.saveAllUsers(users);
                UserManager.saveSession();

                console.log('[CompanyOnboarding] Created company for user:', companyId);
                return companyId;
            },

            loadAllCompanies: function() {
                try {
                    const companiesData = localStorage.getItem(this.companiesStorageKey);
                    if (companiesData) {
                        this.companies = JSON.parse(companiesData);
                    }

                    // Always check for legacy data migration first
                    this.migrateLegacyData();

                    // Load currently selected company
                    const currentId = localStorage.getItem(this.currentCompanyKey);
                    if (currentId && this.companies[currentId]) {
                        this.currentCompanyId = currentId;
                        this.data = this.companies[currentId];
                        console.log('[CompanyOnboarding] Loaded existing company:', currentId);
                    } else {
                        // If no current company but companies exist, select the first one
                        const companyIds = Object.keys(this.companies);
                        if (companyIds.length > 0) {
                            const firstCompanyId = companyIds[0];
                            this.setCurrentCompany(firstCompanyId);
                            console.log('[CompanyOnboarding] Auto-selected first company:', firstCompanyId);
                        } else {
                            console.log('[CompanyOnboarding] No companies found');
                        }
                    }

                    console.log('[CompanyOnboarding] Loaded companies:', Object.keys(this.companies).length);
                    return this.companies;
                } catch (error) {
                    console.error('[CompanyOnboarding] Error loading companies:', error);
                    this.companies = {};
                    return {};
                }
            },

            migrateLegacyData: function() {
                try {
                    const legacyData = localStorage.getItem(this.storageKey);
                    if (legacyData) {
                        const parsedData = JSON.parse(legacyData);
                        if (parsedData && Object.keys(parsedData).length > 0) {
                            // Check if this data has already been migrated
                            const existingMigration = Object.values(this.companies).find(company =>
                                company.isLegacyMigration &&
                                company.companyName === parsedData.companyName
                            );

                            if (!existingMigration) {
                                // Create first company from legacy data
                                const companyId = this.generateCompanyId();
                                parsedData.companyId = companyId;
                                parsedData.createdAt = new Date().toISOString();
                                parsedData.isLegacyMigration = true;
                                parsedData.migratedAt = new Date().toISOString();

                                this.companies[companyId] = parsedData;
                                this.currentCompanyId = companyId;
                                this.data = parsedData;

                                // Save migrated data
                                this.saveAllCompanies();
                                localStorage.setItem(this.currentCompanyKey, companyId);

                                console.log('[CompanyOnboarding] ‚úÖ Migrated legacy company:', parsedData.companyName || 'Unnamed Company');
                                console.log('[CompanyOnboarding] Legacy data migrated to company ID:', companyId);

                                // Remove legacy data to prevent future migrations
                                localStorage.removeItem(this.storageKey);
                            } else {
                                console.log('[CompanyOnboarding] Legacy data already migrated, skipping');
                            }
                        }
                    }
                } catch (error) {
                    console.error('[CompanyOnboarding] Error migrating legacy data:', error);
                }
            },

            saveAllCompanies: function() {
                try {
                    localStorage.setItem(this.companiesStorageKey, JSON.stringify(this.companies));
                    console.log('[CompanyOnboarding] Saved all companies to storage');
                } catch (error) {
                    console.error('[CompanyOnboarding] Error saving companies:', error);
                }
            },

            setCurrentCompany: function(companyId) {
                if (this.companies[companyId]) {
                    this.currentCompanyId = companyId;
                    this.data = this.companies[companyId];
                    localStorage.setItem(this.currentCompanyKey, companyId);
                    this.updateCurrentCompanyDisplay();
                    console.log('[CompanyOnboarding] Switched to company:', companyId);
                    return true;
                }
                return false;
            },

            createNewCompany: function(companyData) {
                // Check if user is logged in for new companies
                if (!UserManager.isLoggedIn) {
                    // Allow legacy behavior for backward compatibility
                    console.warn('[CompanyOnboarding] Creating company without user login (legacy mode)');
                }

                const companyId = this.generateCompanyId();
                const newCompany = {
                    ...companyData,
                    id: companyId,
                    companyId: companyId, // Keep for backward compatibility
                    ownerId: UserManager.isLoggedIn ? UserManager.currentUser.id : null,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    lastModified: new Date().toISOString(),
                    dataVersion: this.dataVersion
                };

                this.companies[companyId] = newCompany;
                this.saveAllCompanies();

                // Update user's company list if logged in
                if (UserManager.isLoggedIn) {
                    if (!UserManager.currentUser.companies) {
                        UserManager.currentUser.companies = [];
                    }
                    UserManager.currentUser.companies.push(companyId);

                    // Set as active if it's the first company
                    if (!UserManager.currentUser.activeCompanies) {
                        UserManager.currentUser.activeCompanies = [];
                    }
                    if (UserManager.currentUser.activeCompanies.length === 0) {
                        UserManager.currentUser.activeCompanies.push(companyId);
                    }

                    // Update user data
                    const users = UserManager.getAllUsers();
                    users[UserManager.currentUser.id] = UserManager.currentUser;
                    UserManager.saveAllUsers(users);
                    UserManager.saveSession();
                }

                console.log('[CompanyOnboarding] Created new company:', companyId, UserManager.isLoggedIn ? 'for user:' + UserManager.currentUser.email : '(no user)');
                return companyId;
            },

            updateCompany: function(companyId, companyData) {
                if (this.companies[companyId]) {
                    this.companies[companyId] = {
                        ...this.companies[companyId],
                        ...companyData,
                        companyId: companyId, // Preserve ID
                        updatedAt: new Date().toISOString()
                    };
                    this.saveAllCompanies();

                    // Update current data if this is the active company
                    if (this.currentCompanyId === companyId) {
                        this.data = this.companies[companyId];
                    }

                    console.log('[CompanyOnboarding] Updated company:', companyId);
                    return true;
                }
                return false;
            },

            deleteCompany: function(companyId) {
                if (this.companies[companyId]) {
                    delete this.companies[companyId];
                    this.saveAllCompanies();

                    // If deleting current company, switch to another or clear
                    if (this.currentCompanyId === companyId) {
                        const remainingCompanies = Object.keys(this.companies);
                        if (remainingCompanies.length > 0) {
                            this.setCurrentCompany(remainingCompanies[0]);
                        } else {
                            this.currentCompanyId = null;
                            this.data = {};
                            localStorage.removeItem(this.currentCompanyKey);
                        }
                    }

                    console.log('[CompanyOnboarding] Deleted company:', companyId);
                    return true;
                }
                return false;
            },

            getCompanyList: function() {
                return Object.entries(this.companies).map(([id, company]) => ({
                    id: id,
                    name: company.companyName || 'Unnamed Company',
                    email: company.companyEmail || '',
                    createdAt: company.createdAt || '',
                    isActive: id === this.currentCompanyId
                }));
            },

            // Auto-fill templates for different business types
            companyTemplates: {
                technology: {
                    companyName: 'Tech Solutions Inc.',
                    companyIndustry: 'Information Technology',
                    companyWebsite: 'https://techsolutions.com',
                    companyYears: '15',
                    companyEmail: 'info@techsolutions.com',
                    companyPhone: '+1 (555) 123-4567',
                    companyAddress: '123 Innovation Drive, Tech City, CA 94102',
                    companyDescription: 'Leading provider of cutting-edge technology solutions for businesses worldwide. Specializing in cloud computing, AI, and digital transformation.',
                    businesDevelopementManagerName: 'John Smith',
                    businesDevelopementManagerDesignation: 'Business Development Manager',
                    productPortfolioPoints: 'Cloud Solutions, AI/ML Platforms, Mobile Applications, Web Development, Cybersecurity Services',
                    OfferingPoints: 'Technical Support, Training Programs, 24/7 Maintenance, Custom Development',
                    companyShortName: 'TechSol'
                },
                manufacturing: {
                    companyName: 'Global Manufacturing Corp',
                    companyIndustry: 'Manufacturing & Industrial',
                    companyWebsite: 'https://globalmanufacturing.com',
                    companyYears: '25',
                    companyEmail: 'business@globalmanufacturing.com',
                    companyPhone: '+1 (555) 987-6543',
                    companyAddress: '456 Industrial Blvd, Manufacturing City, TX 75001',
                    companyDescription: 'World-class manufacturing solutions with 25+ years of experience. Quality products, timely delivery, and competitive pricing.',
                    businesDevelopementManagerName: 'Sarah Johnson',
                    businesDevelopementManagerDesignation: 'Regional Sales Manager',
                    productPortfolioPoints: 'Industrial Equipment, Custom Manufacturing, Quality Control Systems, Automation Solutions',
                    OfferingPoints: 'Bulk Discounts, Fast Shipping, Quality Guarantee, Technical Support',
                    companyShortName: 'GMC'
                },
                trading: {
                    companyName: 'International Trading Partners',
                    companyIndustry: 'Import/Export & Trading',
                    companyWebsite: 'https://tradingpartners.com',
                    companyYears: '20',
                    companyEmail: 'partnerships@tradingpartners.com',
                    companyPhone: '+1 (555) 456-7890',
                    companyAddress: '789 Commerce Street, Trade Hub, NY 10001',
                    companyDescription: 'Established trading company connecting global suppliers with international markets. Reliable partnerships and efficient logistics.',
                    businesDevelopementManagerName: 'Michael Chen',
                    businesDevelopementManagerDesignation: 'International Business Manager',
                    productPortfolioPoints: 'Consumer Electronics, Home Appliances, Fashion Accessories, Sports Equipment',
                    OfferingPoints: 'Global Shipping, Market Analysis, Regulatory Compliance, Payment Solutions',
                    companyShortName: 'ITP'
                },
                services: {
                    companyName: 'Professional Services Group',
                    companyIndustry: 'Professional Services',
                    companyWebsite: 'https://proservicesgroup.com',
                    companyYears: '12',
                    companyEmail: 'contact@proservicesgroup.com',
                    companyPhone: '+1 (555) 321-0987',
                    companyAddress: '321 Business Center, Service City, IL 60601',
                    companyDescription: 'Comprehensive professional services including consulting, project management, and business optimization solutions.',
                    businesDevelopementManagerName: 'Emily Davis',
                    businesDevelopementManagerDesignation: 'Client Relations Manager',
                    productPortfolioPoints: 'Business Consulting, Project Management, Process Optimization, Staff Training',
                    OfferingPoints: 'Free Consultation, Flexible Contracts, Expert Team, Results Guarantee',
                    companyShortName: 'PSG'
                }
            },

            // Apply template data to form
            applyTemplate: function(templateType) {
                const template = this.companyTemplates[templateType];
                if (!template) {
                    showAlert('‚ö†Ô∏è Template not found!', 'warning');
                    return;
                }

                // Fill form fields with template data
                Object.keys(template).forEach(fieldId => {
                    const element = document.getElementById(fieldId);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = template[fieldId];
                        } else {
                            element.value = template[fieldId];
                        }

                        // Add visual feedback for filled fields
                        element.style.background = '#f0f8ff';
                        element.style.borderColor = '#007bff';

                        // Reset styling after animation
                        setTimeout(() => {
                            element.style.background = '';
                            element.style.borderColor = '';
                        }, 2000);
                    }
                });

                // Apply default email template
                const emailTemplateElement = document.getElementById('companyEmailTemplate');
                if (emailTemplateElement) {
                    emailTemplateElement.innerHTML = this.generateDefaultEmailTemplate(template);
                    emailTemplateElement.style.background = '#f0f8ff';
                    emailTemplateElement.style.borderColor = '#007bff';

                    setTimeout(() => {
                        emailTemplateElement.style.background = '';
                        emailTemplateElement.style.borderColor = '';
                    }, 2000);
                }

                showAlert(`‚ú® ${templateType.charAt(0).toUpperCase() + templateType.slice(1)} template applied! Customize the details as needed.`, 'success');

                // Mark as having unsaved changes
                this.unsavedChanges = true;

                // Auto-save if enabled
                if (this.autoSaveEnabled) {
                    setTimeout(() => {
                        this.saveData(true);
                    }, 1000);
                }
            },

            // Generate email template based on company data
            generateDefaultEmailTemplate: function(companyData) {
                return `From: ${companyData.companyEmail}
From-Name: ${companyData.companyName}
To: {email}
Subject: Partnership Opportunity - ${companyData.companyName} & {firm} in {country}

Dear {contactName},

Greetings from ${companyData.companyName}!

We are excited to introduce you to ${companyData.companyName}, a leading company in the ${companyData.companyIndustry} industry with ${companyData.companyYears} years of proven expertise and excellence.

<strong>Our Product Portfolio:</strong>
${companyData.productPortfolioPoints}

<strong>What We Offer:</strong>
${companyData.OfferingPoints}

We believe there are excellent opportunities for collaboration between ${companyData.companyName} and {firm} in the {country} market.

Best regards,
${companyData.businesDevelopementManagerName}
${companyData.businesDevelopementManagerDesignation}
${companyData.companyName}
Website: ${companyData.companyWebsite}
Email: ${companyData.companyEmail}
Phone: ${companyData.companyPhone}`;
            },

            // Default template content
            defaultTemplate: `From: {companyEmail}
From-Name: {companyName}
To: {email}
Subject: Partnership Opportunity - {companyName} & {firm} in {country}

Dear {contactName},

We are excited to introduce you to {companyName}, a leading company in the {companyIndustry} industry with {companyYears} years of proven expertise and excellence.

{companyDescription}

We believe that {firm} in {country} would be an excellent partner for expanding our market presence and delivering exceptional value to customers in your region.

Please feel free to contact us:
Email: {companyEmail}
Phone: {companyPhone}
Website: {companyWebsite}

Best regards,
{companyName}
{companyAddress}`
        };

        // Module: Show Company Onboarding Data Manager
        CompanyOnboardingModule.showManager = function() {
            const modal = document.createElement('div');
            modal.id = 'companyDataModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
                z-index: 10000; padding: 20px;
            `;

            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 8px; max-width: 800px; width: 90%; max-height: 80%; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <h2 style="margin: 0; color: #007bff; display: flex; align-items: center; gap: 10px;">
                            <span>üè¢</span> Company Management
                        </h2>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <button onclick="CompanyOnboardingModule.showCompanySelector()" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">üìã All Companies</button>
                            <button onclick="CompanyOnboardingModule.showNewCompanyForm()" style="background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">‚ûï New Company</button>
                            <button onclick="CompanyOnboardingModule.closeManager()" class="modal-close-btn" title="Close">√ó</button>
                        </div>
                    </div>

                    <!-- Current Company Indicator -->
                    <div id="currentCompanyIndicator" style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 12px; margin-bottom: 15px; border-radius: 4px;">
                        <div style="font-size: 13px; font-weight: 500; color: #1976d2;">
                            ${this.currentCompanyId ? `‚úèÔ∏è Editing: ${this.data.companyName || 'Unnamed Company'}` : '‚ûï Creating New Company'}
                        </div>
                        <div style="font-size: 11px; color: #666; margin-top: 4px;">
                            ${this.currentCompanyId ? `Company ID: ${this.currentCompanyId}` : 'Fill in details below to create your first company profile'}
                        </div>
                    </div>

                    <!-- Data Persistence Status -->
                    <div id="persistenceStatus" style="background: #e8f5e8; border: 1px solid #4caf50; border-radius: 4px; padding: 8px 12px; margin-bottom: 15px; font-size: 12px; display: flex; align-items: center; gap: 8px;">
                        <span id="statusIcon">üíæ</span>
                        <span id="statusText">Auto-save enabled - Changes saved automatically</span>
                        <span id="lastSaveTime" style="margin-left: auto; color: #666;"></span>
                    </div>
                    <p style="color: #666; margin-bottom: 20px;">
                        Configure your company information for automatic personalization in all email campaigns. Data will be used for both single and bulk emails.
                    </p>

                    <!-- Auto-fill Templates -->
                    <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 15px; margin-bottom: 25px; border-radius: 6px;">
                        <h5 style="margin: 0 0 12px 0; color: #1976d2; display: flex; align-items: center; gap: 8px;">
                            <span>‚ú®</span> Quick Start Templates
                        </h5>
                        <p style="margin: 0 0 15px 0; color: #555; font-size: 14px;">Choose a template to auto-fill common company information:</p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            <button onclick="CompanyOnboardingModule.applyTemplate('technology')" style="padding: 10px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500;">üíª Technology Company</button>
                            <button onclick="CompanyOnboardingModule.applyTemplate('manufacturing')" style="padding: 10px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500;">üè¢ Manufacturing</button>
                            <button onclick="CompanyOnboardingModule.applyTemplate('trading')" style="padding: 10px; background: #17a2b8; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500;">üíº Trading & Import</button>
                            <button onclick="CompanyOnboardingModule.applyTemplate('services')" style="padding: 10px; background: #6f42c1; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500;">üõ†Ô∏è Professional Services</button>
                        </div>
                        <small style="color: #666; display: block; margin-top: 10px;">Templates provide sample data - customize as needed for your business.</small>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Company Name*</label>
                            <input type="text" id="companyName" placeholder="e.g., Intex Technologies" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Industry</label>
                            <input type="text" id="companyIndustry" placeholder="e.g., Electronics & Technology" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Website URL</label>
                            <input type="url" id="companyWebsite" placeholder="https://your-company.com" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Years in Business</label>
                            <input type="number" id="companyYears" placeholder="e.g., 29" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Contact Email*</label>
                            <input type="email" id="companyEmail" placeholder="info@your-company.com" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Phone Number</label>
                            <input type="tel" id="companyPhone" placeholder="+1 (555) 123-4567" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>

                    <div style="margin-bottom: 25px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Company Address</label>
                        <textarea id="companyAddress" placeholder="123 Business Street, City, Country" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; height: 40px; resize: vertical; font-size: 14px; line-height: 1.4;"></textarea>
                    </div>

                    <div style="margin-bottom: 25px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Company Description</label>
                        <textarea id="companyDescription" placeholder="Brief description of your company, products, and services..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; height: 80px; resize: vertical;"></textarea>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Company Short Name (Optional)</label>
                            <input type="text" id="companyShortName" placeholder="e.g., Intex" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Business Development Manager*</label>
                            <input type="text" id="businesDevelopementManagerName" placeholder="e.g., John Smith" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>

                    <div style="margin-bottom: 25px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Business Development Manager Designation*</label>
                        <input type="text" id="businesDevelopementManagerDesignation" placeholder="e.g., Senior Business Development Manager" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>

                    <div style="margin-bottom: 25px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Company's Product Portfolio (Optional)</label>
                        <textarea id="productPortfolioPoints" placeholder="‚Ä¢ IT Peripherals: Keyboards, mice, webcams, speakers&#10;‚Ä¢ Home Appliances: Air coolers, water heaters&#10;‚Ä¢ Mobile Accessories: Chargers, cables, power banks" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; height: 100px; resize: vertical;"></textarea>
                        <small style="color: #666;">Use bullet points to list your products and services</small>
                    </div>

                    <div style="margin-bottom: 25px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Company's Offerings (Optional)</label>
                        <textarea id="OfferingPoints" placeholder="‚úì Competitive pricing with attractive profit margins&#10;‚úì Comprehensive marketing support&#10;‚úì Technical training and product support" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; height: 100px; resize: vertical;"></textarea>
                        <small style="color: #666;">Use checkmarks to list what you offer to partners</small>
                    </div>

                    <div style="background: #f0f7ff; border: 1px solid #b3d9ff; border-radius: 6px; padding: 15px; margin-bottom: 25px;">
                        <h4 style="margin: 0 0 15px 0; color: #0066cc; display: flex; align-items: center; gap: 8px;">
                            <span>üîó</span> Links & Media (All Optional)
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Link 1</label>
                                <input type="url" id="Link1" placeholder="https://example.com/catalog" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Link 2</label>
                                <input type="url" id="Link2" placeholder="https://example.com/brochure" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Link 3</label>
                                <input type="url" id="Link3" placeholder="https://example.com/video" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Image 1 URL</label>
                                <input type="url" id="Image1" placeholder="https://example.com/image1.jpg" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Image 2 URL</label>
                                <input type="url" id="Image2" placeholder="https://example.com/image2.jpg" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 25px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Logo URL (Optional)</label>
                        <input type="url" id="companyLogo" placeholder="https://your-company.com/logo.png" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <small style="color: #666;">Enter a direct link to your company logo image</small>
                    </div>

                    <!-- Email Template Management Section -->
                    <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; padding: 15px; margin-bottom: 25px;">
                        <h4 style="margin: 0 0 15px 0; color: #007bff; display: flex; align-items: center; gap: 8px;">
                            <span>üìß</span> Email Template Management
                        </h4>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Custom Email Template</label>

                            <!-- Template Formatting Toolbar -->
                            <div id="templateFormattingToolbar" style="display: none; padding: 8px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 1px solid #dee2e6; border-bottom: none; border-radius: 6px 6px 0 0; margin-bottom: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="display: flex; flex-wrap: wrap; gap: 4px; align-items: center;">
                                    <!-- Text Formatting -->
                                    <button onclick="formatTemplateText('bold')" class="format-btn" style="padding: 4px 8px; font-size: 11px; background: white; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer; font-weight: 600;" title="Bold">
                                        <strong>B</strong>
                                    </button>
                                    <button onclick="formatTemplateText('italic')" class="format-btn" style="padding: 4px 8px; font-size: 11px; background: white; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer;" title="Italic">
                                        <em>I</em>
                                    </button>
                                    <button onclick="formatTemplateText('underline')" class="format-btn" style="padding: 4px 8px; font-size: 11px; background: white; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer;" title="Underline">
                                        <u>U</u>
                                    </button>

                                    <div style="width: 1px; height: 16px; background: #d1d5db; margin: 0 4px;"></div>

                                    <!-- Lists -->
                                    <button onclick="formatTemplateText('insertUnorderedList')" class="format-btn" style="padding: 4px 8px; font-size: 11px; background: white; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer;" title="Bullet List">
                                        ‚Ä¢ List
                                    </button>
                                    <button onclick="formatTemplateText('insertOrderedList')" class="format-btn" style="padding: 4px 8px; font-size: 11px; background: white; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer;" title="Numbered List">
                                        1. List
                                    </button>

                                    <div style="width: 1px; height: 16px; background: #d1d5db; margin: 0 4px;"></div>

                                    <!-- Alignment -->
                                    <button onclick="formatTemplateText('justifyLeft')" class="format-btn" style="padding: 4px 8px; font-size: 11px; background: white; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer;" title="Align Left">
                                        ‚Üê
                                    </button>
                                    <button onclick="formatTemplateText('justifyCenter')" class="format-btn" style="padding: 4px 8px; font-size: 11px; background: white; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer;" title="Center">
                                        ‚Üî
                                    </button>
                                    <button onclick="formatTemplateText('justifyRight')" class="format-btn" style="padding: 4px 8px; font-size: 11px; background: white; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer;" title="Align Right">
                                        ‚Üí
                                    </button>

                                    <div style="width: 1px; height: 16px; background: #d1d5db; margin: 0 4px;"></div>

                                    <!-- Color -->
                                    <button onclick="showTemplateColorPicker()" class="format-btn" style="padding: 4px 8px; font-size: 11px; background: white; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer; position: relative;" title="Text Color">
                                        Color
                                    </button>
                                    <div id="templateColorPicker" style="display: none; position: absolute; z-index: 1000; background: white; border: 1px solid #d1d5db; border-radius: 6px; padding: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-top: 5px;">
                                        <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 3px;">
                                            <div onclick="applyTemplateColor('#000000')" style="width: 16px; height: 16px; background: #000000; border-radius: 3px; cursor: pointer;" title="Black"></div>
                                            <div onclick="applyTemplateColor('#dc2626')" style="width: 16px; height: 16px; background: #dc2626; border-radius: 3px; cursor: pointer;" title="Red"></div>
                                            <div onclick="applyTemplateColor('#ea580c')" style="width: 16px; height: 16px; background: #ea580c; border-radius: 3px; cursor: pointer;" title="Orange"></div>
                                            <div onclick="applyTemplateColor('#ca8a04')" style="width: 16px; height: 16px; background: #ca8a04; border-radius: 3px; cursor: pointer;" title="Yellow"></div>
                                            <div onclick="applyTemplateColor('#16a34a')" style="width: 16px; height: 16px; background: #16a34a; border-radius: 3px; cursor: pointer;" title="Green"></div>
                                            <div onclick="applyTemplateColor('#2563eb')" style="width: 16px; height: 16px; background: #2563eb; border-radius: 3px; cursor: pointer;" title="Blue"></div>
                                            <div onclick="applyTemplateColor('#7c3aed')" style="width: 16px; height: 16px; background: #7c3aed; border-radius: 3px; cursor: pointer;" title="Purple"></div>
                                            <div onclick="applyTemplateColor('#be185d')" style="width: 16px; height: 16px; background: #be185d; border-radius: 3px; cursor: pointer;" title="Pink"></div>
                                        </div>
                                    </div>

                                    <div style="width: 1px; height: 16px; background: #d1d5db; margin: 0 4px;"></div>

                                    <!-- Clear Formatting -->
                                    <button onclick="clearTemplateFormatting()" class="format-btn" style="padding: 4px 8px; font-size: 11px; background: white; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer;" title="Clear Formatting">
                                        Clear
                                    </button>
                                </div>
                            </div>

                            <div id="companyEmailTemplate" contenteditable="true" placeholder="Create your custom email template with variables..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 0 0 4px 4px; height: 200px; overflow-y: auto; font-size: 12px; line-height: 1.6; background: white; outline: none; font-family: inherit; word-wrap: break-word; white-space: pre-wrap;"
                                 onfocus="showTemplateToolbar()" onblur="setTimeout(() => hideTemplateToolbar(), 200)"
                                 oninput="updateTemplateContent()" onpaste="handleTemplatePaste(event)">From: {companyEmail}
From-Name: {companyName}
To: {email}
Subject: Partnership Opportunity - {companyName} & {firm} in {country}

Dear {contactName},

We are excited to introduce you to {companyName}, a leading company in the {companyIndustry} industry with {companyYears} years of proven expertise and excellence.

{companyDescription}

We believe that {firm} in {country} would be an excellent partner for expanding our market presence and delivering exceptional value to customers in your region.

Please feel free to contact us:
Email: {companyEmail}
Phone: {companyPhone}
Website: {companyWebsite}

Best regards,
{companyName}
{companyAddress}</textarea>
                            <small style="color: #666; display: block; margin-top: 5px;">Use company and contact variables in your template. Available variables are shown above.</small>
                        </div>
                        <!-- Template Type Selection -->
                        <div style="background: #e3f2fd; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #007bff;">
                            <h5 style="margin: 0 0 10px 0; color: #007bff; font-size: 14px;">üìß Template Type</h5>
                            <div style="display: flex; gap: 15px; align-items: center;">
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px;">
                                    <input type="radio" name="templateType" value="standard" style="margin: 0;">
                                    <span>üîç Standard Template</span>
                                    <small style="color: #666; margin-left: 5px;">(Basic personalization)</small>
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px;">
                                    <input type="radio" name="templateType" value="personalized" checked style="margin: 0;">
                                    <span>‚ú® Personalized Template</span>
                                    <small style="color: #666; margin-left: 5px;">(Smart content + grammar)</small>
                                </label>
                            </div>
                            <small style="color: #666; display: block; margin-top: 8px;">
                                üí° <strong>Personalized</strong> automatically hides empty sections and applies smart formatting
                            </small>
                        </div>

                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="CompanyOnboardingModule.applyTemplateToMessage()" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">üìù Apply Template to Composer</button>
                            <button onclick="CompanyOnboardingModule.saveTemplate()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">üíæ Save Template</button>
                            <button onclick="CompanyOnboardingModule.resetTemplate()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">üîÑ Reset to Default</button>
                        </div>
                    </div>

                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 25px;">
                        <h4 style="margin: 0 0 10px 0; color: #007bff;">Available Template Variables</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; font-family: monospace; font-size: 11px;">
                            <span><strong>{companyName}</strong> - Company name</span>
                            <span><strong>{companyShortName}</strong> - Short name</span>
                            <span><strong>{companyIndustry}</strong> - Industry</span>
                            <span><strong>{companyWebsite}</strong> - Website URL</span>
                            <span><strong>{companyYears}</strong> - Years in business</span>
                            <span><strong>{companyEmail}</strong> - Contact email</span>
                            <span><strong>{companyPhone}</strong> - Phone number</span>
                            <span><strong>{companyAddress}</strong> - Address</span>
                            <span><strong>{companyDescription}</strong> - Description</span>
                            <span><strong>{companyLogo}</strong> - Logo URL</span>
                            <span><strong>{productPortfolioPoints}</strong> - Product portfolio</span>
                            <span><strong>{OfferingPoints}</strong> - Partner offerings</span>
                            <span><strong>{businesDevelopementManagerName}</strong> - BDM name</span>
                            <span><strong>{businesDevelopementManagerDesignation}</strong> - BDM title</span>
                            <span><strong>{Link1}</strong>, <strong>{Link2}</strong>, <strong>{Link3}</strong> - Links</span>
                            <span><strong>{Image1}</strong>, <strong>{Image2}</strong> - Image URLs</span>
                            <span style="grid-column: 1 / -1; margin-top: 10px; color: #007bff; font-weight: bold;">Contact Variables:</span>
                            <span><strong>{contactName}</strong> - Contact person</span>
                            <span><strong>{firm}</strong> - Company name</span>
                            <span><strong>{country}</strong> - Location</span>
                            <span><strong>{email}</strong> - Email address</span>
                        </div>
                    </div>

                    <!-- Email Configuration Section -->
                    <div style="background: #f0f7ff; border: 1px solid #b3d9ff; border-radius: 6px; padding: 15px; margin-bottom: 25px;">
                        <h4 style="margin: 0 0 15px 0; color: #0066cc; display: flex; align-items: center; gap: 8px;">
                            <span>‚öôÔ∏è</span> Email Configuration for this Company
                        </h4>
                        <div style="margin-bottom: 15px; padding: 10px; background: #dcfce7; border-radius: 4px; font-size: 12px; color: #166534;">
                            <strong>üöÄ Zoho Mail Integration Ready!</strong> Configure your company-specific email credentials below for professional email sending.
                        </div>

                        <!-- Zoho Mail Configuration -->
                        <div style="margin-bottom: 15px; padding: 12px; border: 1px solid #dc2626; border-radius: 6px; background: #fef2f2;">
                            <h5 style="margin: 0 0 10px 0; color: #dc2626; font-size: 14px;">üìß Primary Email Account (Zoho Mail)</h5>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <div>
                                    <label style="display: block; margin-bottom: 3px; font-weight: 500; font-size: 12px;">Sending Email Address:</label>
                                    <input type="email" id="companyZohoEmail" placeholder="your-email@yourdomain.com" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 3px; font-weight: 500; font-size: 12px;">App Password:</label>
                                    <input type="password" id="companyZohoPassword" placeholder="App-specific password" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                </div>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 3px; font-weight: 500; font-size: 12px;">Sender Display Name:</label>
                                <input type="text" id="companySenderName" placeholder="e.g., Your Company Name" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                <small style="color: #6b7280; display: block; margin-top: 2px; font-size: 11px;">This will appear as the sender name in emails</small>
                            </div>
                            <div>
                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px;">
                                    <input type="checkbox" id="companyEmailEnabled" style="margin-right: 6px;">
                                    <span style="font-weight: 500;">Enable email sending for this company</span>
                                </label>
                            </div>
                        </div>

                        <!-- Alternative Email Services -->
                        <div style="margin-bottom: 15px; padding: 12px; border: 1px solid #ddd; border-radius: 6px; background: #f8f9fa;">
                            <h5 style="margin: 0 0 10px 0; color: #28a745; font-size: 14px;">üìß Alternative Services (Optional)</h5>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <label style="display: block; margin-bottom: 3px; font-weight: 500; font-size: 12px;">EmailJS Service ID:</label>
                                    <input type="text" id="companyEmailJSService" placeholder="service_xxxxxxx" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 3px; font-weight: 500; font-size: 12px;">EmailJS Template ID:</label>
                                    <input type="text" id="companyEmailJSTemplate" placeholder="template_xxxxxxx" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                </div>
                            </div>
                        </div>

                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 8px; font-size: 11px; color: #856404;">
                            <strong>üí° Tip:</strong> Email configuration is stored per company. Each company profile can have its own email settings for better organization and security.
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <button onclick="CompanyOnboardingModule.loadProfessionalTemplate()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">üìß Load Professional Template</button>
                            <button onclick="CompanyOnboardingModule.exportData()" style="background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">üì§ Export Data</button>
                        </div>
                        <div>
                            <button onclick="CompanyOnboardingModule.saveData()" class="button button-primary" style="margin-right: 10px;">üíæ Save & Apply</button>
                            <button onclick="CompanyOnboardingModule.closeManager()" class="button">Close</button>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to DOM first
            document.body.appendChild(modal);

            // Then load existing company data (after elements exist)
            CompanyOnboardingModule.loadData();

            // Enable auto-save functionality after modal is ready
            setTimeout(() => {
                CompanyOnboardingModule.enableAutoSave();
                CompanyOnboardingModule.updateStatusIndicator();
                console.log('[CompanyOnboarding] Modal initialized with auto-save enabled');
            }, 100);
        };

        // Module: Close Company Onboarding Data Manager
        CompanyOnboardingModule.closeManager = function() {
            const modal = document.getElementById('companyDataModal');
            if (modal) {
                modal.remove();
                console.log('[CompanyOnboarding] Modal closed');
            }
        };

        // Module: Load Company Onboarding Data
        CompanyOnboardingModule.loadData = function() {
            try {
                // Use the multi-company getData function instead of direct localStorage access
                this.data = this.getData();

                // Populate form fields with safe element access
                const fields = [
                    { id: 'companyName', value: this.data.companyName || '' },
                    { id: 'companyIndustry', value: this.data.companyIndustry || '' },
                    { id: 'companyWebsite', value: this.data.companyWebsite || '' },
                    { id: 'companyYears', value: this.data.companyYears || '' },
                    { id: 'companyEmail', value: this.data.companyEmail || '' },
                    { id: 'companyPhone', value: this.data.companyPhone || '' },
                    { id: 'companyAddress', value: this.data.companyAddress || '' },
                    { id: 'companyDescription', value: this.data.companyDescription || '' },
                    { id: 'companyLogo', value: this.data.companyLogo || '' },
                    { id: 'companyShortName', value: this.data.companyShortName || '' },
                    { id: 'businesDevelopementManagerName', value: this.data.businesDevelopementManagerName || '' },
                    { id: 'businesDevelopementManagerDesignation', value: this.data.businesDevelopementManagerDesignation || '' },
                    { id: 'productPortfolioPoints', value: this.data.productPortfolioPoints || '' },
                    { id: 'OfferingPoints', value: this.data.OfferingPoints || '' },
                    { id: 'Link1', value: this.data.Link1 || '' },
                    { id: 'Link2', value: this.data.Link2 || '' },
                    { id: 'Link3', value: this.data.Link3 || '' },
                    { id: 'Image1', value: this.data.Image1 || '' },
                    { id: 'Image2', value: this.data.Image2 || '' },
                    { id: 'companyEmailTemplate', value: this.data.emailTemplate || this.defaultTemplate, isContentEditable: true },

                    // Email configuration fields
                    { id: 'companyZohoEmail', value: this.data.companyZohoEmail || '' },
                    { id: 'companyZohoPassword', value: this.data.companyZohoPassword || '' },
                    { id: 'companySenderName', value: this.data.companySenderName || '' },
                    { id: 'companyEmailJSService', value: this.data.companyEmailJSService || '' },
                    { id: 'companyEmailJSTemplate', value: this.data.companyEmailJSTemplate || '' }
                ];

                fields.forEach(field => {
                    const element = document.getElementById(field.id);
                    if (element) {
                        if (field.isContentEditable) {
                            element.innerHTML = field.value;
                        } else {
                            element.value = field.value;
                        }
                    } else {
                        console.warn(`[CompanyOnboarding] Element ${field.id} not found`);
                    }
                });

                // Handle checkbox fields separately
                const emailEnabledCheckbox = document.getElementById('companyEmailEnabled');
                if (emailEnabledCheckbox) {
                    emailEnabledCheckbox.checked = this.data.companyEmailEnabled || false;
                }

                // Update the current company display after loading
                this.updateCurrentCompanyDisplay();
                console.log('[CompanyOnboarding] Data loaded and form populated');
            } catch (error) {
                console.error('[CompanyOnboarding] Error loading data:', error);
                // Initialize with empty data on error
                this.data = {};
            }
        };

        // Module: Enhanced Save Company Onboarding Data with Persistence
        CompanyOnboardingModule.saveData = function(isAutoSave = false) {
            try {
                console.log('[CompanyOnboarding] Saving data...', isAutoSave ? '(Auto-save)' : '(Manual save)');

                // Validate mandatory fields (skip for auto-save to allow drafts)
                if (!isAutoSave) {
                    const mandatoryFields = ['businesDevelopementManagerName', 'businesDevelopementManagerDesignation'];
                    for (const fieldId of mandatoryFields) {
                        const element = document.getElementById(fieldId);
                        if (!element || !element.value.trim()) {
                            showAlert(`Please fill in the mandatory field: ${fieldId.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}`, 'error');
                            return false;
                        }
                    }
                }

                // Create backup before saving
                this.createBackup();

                // Collect all data with metadata
                const newData = {
                    // Core company data
                    companyName: document.getElementById('companyName').value,
                    companyIndustry: document.getElementById('companyIndustry').value,
                    companyWebsite: document.getElementById('companyWebsite').value,
                    companyYears: document.getElementById('companyYears').value,
                    companyEmail: document.getElementById('companyEmail').value,
                    companyPhone: document.getElementById('companyPhone').value,
                    companyAddress: document.getElementById('companyAddress').value,
                    companyDescription: document.getElementById('companyDescription').value,
                    companyLogo: document.getElementById('companyLogo').value,

                    // Enhanced data fields
                    productPortfolioPoints: document.getElementById('productPortfolioPoints').value,
                    OfferingPoints: document.getElementById('OfferingPoints').value,
                    companyShortName: document.getElementById('companyShortName').value,
                    businesDevelopementManagerName: document.getElementById('businesDevelopementManagerName').value,
                    businesDevelopementManagerDesignation: document.getElementById('businesDevelopementManagerDesignation').value,
                    Link1: document.getElementById('Link1').value,
                    Link2: document.getElementById('Link2').value,
                    Link3: document.getElementById('Link3').value,
                    Image1: document.getElementById('Image1').value,
                    Image2: document.getElementById('Image2').value,
                    emailTemplate: document.getElementById('companyEmailTemplate').innerHTML,

                    // Email configuration fields
                    companyZohoEmail: document.getElementById('companyZohoEmail').value,
                    companyZohoPassword: document.getElementById('companyZohoPassword').value,
                    companySenderName: document.getElementById('companySenderName').value,
                    companyEmailEnabled: document.getElementById('companyEmailEnabled').checked,
                    companyEmailJSService: document.getElementById('companyEmailJSService').value,
                    companyEmailJSTemplate: document.getElementById('companyEmailJSTemplate').value,

                    // Metadata for persistence tracking
                    dataVersion: this.dataVersion,
                    lastSaved: new Date().toISOString(),
                    saveType: isAutoSave ? 'auto' : 'manual',
                    fieldCount: this.availableFields.length,
                    completedFields: this.availableFields.filter(field =>
                        document.getElementById(field) && document.getElementById(field).value.trim()
                    ).length
                };

                // Validate data integrity
                if (!this.validateDataIntegrity(newData)) {
                    console.error('[CompanyOnboarding] Data integrity validation failed');

                    if (isAutoSave) {
                        // Track auto-save failures to prevent infinite loops
                        this.autoSaveFailureCount++;
                        console.warn('[CompanyOnboarding] Auto-save failure count:', this.autoSaveFailureCount);

                        if (this.autoSaveFailureCount >= this.maxAutoSaveFailures) {
                            console.error('[CompanyOnboarding] Max auto-save failures reached. Disabling auto-save temporarily.');
                            this.autoSaveEnabled = false;

                            // Re-enable after 30 seconds
                            setTimeout(() => {
                                this.autoSaveEnabled = true;
                                this.autoSaveFailureCount = 0;
                                console.log('[CompanyOnboarding] Auto-save re-enabled after cooldown');
                            }, 30000);
                        }
                    } else {
                        showAlert('Data validation failed. Please check your inputs.', 'error');
                    }
                    return false;
                }

                // Update module data
                this.data = newData;
                this.lastSaveTime = new Date();
                this.unsavedChanges = false;

                // Reset auto-save failure count on successful save
                this.autoSaveFailureCount = 0;

                // Handle multi-company save logic
                if (this.currentCompanyId) {
                    // Update existing company
                    this.updateCompany(this.currentCompanyId, newData);
                } else {
                    // Create new company
                    const newCompanyId = this.createNewCompany(newData);
                    this.setCurrentCompany(newCompanyId);
                }

                // Also save to legacy storage for backward compatibility
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(this.data));
                    console.log('[CompanyOnboarding] Data saved successfully to localStorage');
                } catch (storageError) {
                    console.error('[CompanyOnboarding] localStorage save failed:', storageError);

                    // Try alternative storage or cleanup
                    if (storageError.name === 'QuotaExceededError') {
                        this.cleanupOldData();
                        localStorage.setItem(this.storageKey, JSON.stringify(this.data));
                    } else {
                        throw storageError;
                    }
                }

                // Update status indicator
                this.updateStatusIndicator(isAutoSave ? 'Auto-saved successfully' : 'Data saved successfully');

                // User feedback
                if (!isAutoSave) {
                    showAlert('üíæ Company onboarding data saved! All emails will automatically use your company information. üéâ', 'success');
                    this.closeManager();
                } else {
                    console.log('[CompanyOnboarding] Auto-save completed');
                }

                // Log save statistics
                this.logSaveStatistics(newData);

                return true;

            } catch (error) {
                console.error('[CompanyOnboarding] Error saving data:', error);

                // Attempt data recovery
                this.attemptDataRecovery();

                if (!isAutoSave) {
                    showAlert('‚ùå Failed to save company information. Attempting data recovery...', 'error');
                }
                return false;
            }
        };

        // Module: Update Current Company Display
        CompanyOnboardingModule.updateCurrentCompanyDisplay = function() {
            const displayElement = document.getElementById('activeCompanyName');
            if (displayElement) {
                if (this.currentCompanyId && this.data.companyName) {
                    displayElement.textContent = this.data.companyName;
                    displayElement.parentElement.style.color = '#007bff';
                } else {
                    displayElement.textContent = 'No company selected';
                    displayElement.parentElement.style.color = '#666';
                }
            }
        };

        // Module: Show Company Selector
        CompanyOnboardingModule.showCompanySelector = function() {
            const companies = this.getCompanyList();

            const modal = document.createElement('div');
            modal.id = 'companySelectorModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
                z-index: 12000; padding: 20px;
            `;

            modal.innerHTML = `
                <div style="background: white; padding: 25px; border-radius: 8px; max-width: 700px; width: 90%; max-height: 80%; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #007bff;">üè¢ Company Manager</h3>
                        <button onclick="document.getElementById('companySelectorModal').remove()" style="background: none; border: none; font-size: 20px; cursor: pointer;">‚úï</button>
                    </div>

                    ${companies.length === 0 ? `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 16px;">üè¢</div>
                            <h4 style="margin: 0 0 12px 0;">No Companies Yet</h4>
                            <p style="margin: 0 0 20px 0;">Create your first company profile to get started with personalized emails.</p>
                            <button onclick="CompanyOnboardingModule.showNewCompanyForm(); document.getElementById('companySelectorModal').remove();" style="background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                ‚ûï Create First Company
                            </button>
                        </div>
                    ` : `
                        <div style="margin-bottom: 20px;">
                            <button onclick="CompanyOnboardingModule.showNewCompanyForm(); document.getElementById('companySelectorModal').remove();" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-size: 12px; cursor: pointer; width: 100%;">
                                ‚ûï Create New Company
                            </button>
                        </div>

                        <div style="space-y: 8px;">
                            ${companies.map(company => `
                                <div style="border: 1px solid ${company.isActive ? '#007bff' : '#ddd'}; border-radius: 6px; padding: 16px; background: ${company.isActive ? '#f0f8ff' : 'white'}; cursor: pointer;" onclick="CompanyOnboardingModule.switchToCompany('${company.id}')">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: 500; font-size: 14px; color: #333; margin-bottom: 4px;">
                                                ${company.isActive ? 'üü¢ ' : ''}${escapeHTML(company.name)}
                                                ${company.isActive ? '<span style="background: #007bff; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px; margin-left: 8px;">ACTIVE</span>' : ''}
                                            </div>
                                            <div style="font-size: 12px; color: #666;">${escapeHTML(company.email)}</div>
                                            <div style="font-size: 11px; color: #999; margin-top: 4px;">Created: ${new Date(company.createdAt).toLocaleDateString()}</div>
                                        </div>
                                        <div style="display: flex; gap: 4px;">
                                            <button onclick="event.stopPropagation(); CompanyOnboardingModule.editCompany('${company.id}')" style="background: #ffc107; color: #333; border: none; padding: 4px 8px; border-radius: 3px; font-size: 10px; cursor: pointer;">Edit</button>
                                            ${!company.isActive ? `<button onclick="event.stopPropagation(); CompanyOnboardingModule.confirmDeleteCompany('${company.id}')" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 10px; cursor: pointer;">Delete</button>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}

                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="document.getElementById('companySelectorModal').remove()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Close</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        };

        // Module: Switch to Company
        CompanyOnboardingModule.switchToCompany = function(companyId) {
            if (this.setCurrentCompany(companyId)) {
                document.getElementById('companySelectorModal').remove();
                this.closeManager();
                showAlert(`‚úÖ Switched to: ${this.data.companyName}`, 'success');

                // Refresh the manager if it's open
                setTimeout(() => {
                    this.showManager();
                }, 500);
            }
        };

        // Module: Edit Company
        CompanyOnboardingModule.editCompany = function(companyId) {
            this.setCurrentCompany(companyId);
            document.getElementById('companySelectorModal').remove();
            this.showManager();
        };

        // Module: Show New Company Form
        CompanyOnboardingModule.showNewCompanyForm = function() {
            // Clear current selection to create new company
            this.currentCompanyId = null;
            this.data = {};

            // Close company selector if open
            const existingModal = document.getElementById('companySelectorModal');
            if (existingModal) existingModal.remove();

            this.showManager();
        };

        // Module: Confirm Delete Company
        CompanyOnboardingModule.confirmDeleteCompany = function(companyId) {
            const company = this.companies[companyId];
            if (company) {
                const confirmDelete = confirm(`Are you sure you want to delete "${company.companyName}"?\n\nThis action cannot be undone.`);
                if (confirmDelete) {
                    this.deleteCompany(companyId);
                    showAlert(`üóëÔ∏è Deleted: ${company.companyName}`, 'success');

                    // Refresh the selector
                    document.getElementById('companySelectorModal').remove();
                    this.showCompanySelector();
                }
            }
        };

        // Module: Create Data Backup
        CompanyOnboardingModule.createBackup = function() {
            try {
                if (this.data && Object.keys(this.data).length > 0) {
                    const backupData = {
                        ...this.data,
                        backupCreated: new Date().toISOString(),
                        originalSaveTime: this.data.lastSaved
                    };
                    localStorage.setItem(this.backupKey, JSON.stringify(backupData));
                    console.log('[CompanyOnboarding] Backup created successfully');
                }
            } catch (error) {
                console.error('[CompanyOnboarding] Failed to create backup:', error);
            }
        };

        // Module: Data Integrity Validation
        CompanyOnboardingModule.validateDataIntegrity = function(data) {
            try {
                // Basic structure validation
                if (!data || typeof data !== 'object') return false;

                // Check for critical fields
                const criticalFields = ['companyName', 'companyEmail'];
                for (const field of criticalFields) {
                    if (data[field] && typeof data[field] !== 'string') return false;
                }

                // Validate email format if provided
                if (data.companyEmail && data.companyEmail.trim()) {
                    const emailValue = data.companyEmail.trim();

                    // Handle both formats: "email@domain.com" and "Display Name <email@domain.com>"
                    let emailToValidate = emailValue;

                    // If it contains angle brackets, extract the email from between them
                    const angleMatch = emailValue.match(/<([^>]+)>/);
                    if (angleMatch) {
                        emailToValidate = angleMatch[1];
                    }

                    // Now validate the extracted email address
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(emailToValidate)) {
                        console.warn('[CompanyOnboarding] Invalid email format:', data.companyEmail);
                        return false;
                    }
                }

                // Validate URL format if provided
                if (data.companyWebsite && data.companyWebsite.trim()) {
                    try {
                        new URL(data.companyWebsite.startsWith('http') ? data.companyWebsite : 'https://' + data.companyWebsite);
                    } catch {
                        console.warn('[CompanyOnboarding] Invalid website URL:', data.companyWebsite);
                        // Don't fail validation for URL, just warn
                    }
                }

                return true;
            } catch (error) {
                console.error('[CompanyOnboarding] Data validation error:', error);
                return false;
            }
        };

        // Module: Attempt Data Recovery
        CompanyOnboardingModule.attemptDataRecovery = function() {
            try {
                console.log('[CompanyOnboarding] Attempting data recovery...');

                // Try to restore from backup
                const backupData = localStorage.getItem(this.backupKey);
                if (backupData) {
                    const parsedBackup = JSON.parse(backupData);
                    delete parsedBackup.backupCreated;
                    delete parsedBackup.originalSaveTime;

                    this.data = parsedBackup;
                    localStorage.setItem(this.storageKey, JSON.stringify(this.data));
                    console.log('[CompanyOnboarding] Data recovered from backup');
                    showAlert('üîÑ Data recovered from backup successfully!', 'success');
                    return true;
                }

                console.log('[CompanyOnboarding] No backup available for recovery');
                return false;
            } catch (error) {
                console.error('[CompanyOnboarding] Data recovery failed:', error);
                return false;
            }
        };

        // Module: Cleanup Old Data
        CompanyOnboardingModule.cleanupOldData = function() {
            try {
                console.log('[CompanyOnboarding] Cleaning up old data...');

                // Remove old backup if exists
                const oldBackup = localStorage.getItem(this.backupKey);
                if (oldBackup) {
                    localStorage.removeItem(this.backupKey);
                    console.log('[CompanyOnboarding] Old backup removed');
                }

                // Clean up other old storage keys if any
                const keysToCheck = [
                    'bulkEmail_companyData_old',
                    'bulkEmail_companyTemplate_old',
                    'bulkEmail_tempData'
                ];

                keysToCheck.forEach(key => {
                    if (localStorage.getItem(key)) {
                        localStorage.removeItem(key);
                        console.log('[CompanyOnboarding] Removed old key:', key);
                    }
                });

            } catch (error) {
                console.error('[CompanyOnboarding] Cleanup failed:', error);
            }
        };

        // Module: Log Save Statistics
        CompanyOnboardingModule.logSaveStatistics = function(data) {
            try {
                const stats = {
                    saveTime: new Date().toISOString(),
                    dataSize: JSON.stringify(data).length,
                    completionPercentage: Math.round((data.completedFields / data.fieldCount) * 100),
                    mandatoryFieldsComplete: this.mandatoryFields.every(field =>
                        data[field] && data[field].trim()
                    ),
                    hasTemplate: !!(data.emailTemplate && data.emailTemplate.trim())
                };

                console.log('[CompanyOnboarding] Save Statistics:', stats);

                // Store recent save stats for monitoring
                const recentStats = JSON.parse(localStorage.getItem('bulkEmail_saveStats') || '[]');
                recentStats.push(stats);

                // Keep only last 10 saves
                if (recentStats.length > 10) {
                    recentStats.splice(0, recentStats.length - 10);
                }

                localStorage.setItem('bulkEmail_saveStats', JSON.stringify(recentStats));

            } catch (error) {
                console.error('[CompanyOnboarding] Failed to log statistics:', error);
            }
        };

        // Module: Auto-save Functionality
        CompanyOnboardingModule.enableAutoSave = function() {
            if (!this.autoSaveEnabled) return;

            console.log('[CompanyOnboarding] Auto-save enabled');

            // Add event listeners to all form fields
            this.availableFields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.addEventListener('input', () => this.scheduleAutoSave());
                    element.addEventListener('change', () => this.scheduleAutoSave());
                }
            });

            // Also monitor template field
            const templateField = document.getElementById('companyEmailTemplate');
            if (templateField) {
                templateField.addEventListener('input', () => this.scheduleAutoSave());
                templateField.addEventListener('change', () => this.scheduleAutoSave());
            }
        };

        // Module: Schedule Auto-save
        CompanyOnboardingModule.scheduleAutoSave = function() {
            // Check if auto-save is enabled
            if (!this.autoSaveEnabled) {
                console.log('[CompanyOnboarding] Auto-save is disabled, skipping schedule');
                return;
            }

            // Mark as having unsaved changes
            this.unsavedChanges = true;

            // Update status to show pending changes
            this.updateStatusIndicator('Changes detected - Auto-saving in 3 seconds...');

            // Clear existing timeout
            if (this.autoSaveTimeout) {
                clearTimeout(this.autoSaveTimeout);
            }

            // Schedule auto-save after 3 seconds of inactivity
            this.autoSaveTimeout = setTimeout(() => {
                if (this.unsavedChanges && this.autoSaveEnabled) {
                    console.log('[CompanyOnboarding] Triggering auto-save...');
                    this.updateStatusIndicator('Auto-saving changes...');
                    this.saveData(true); // isAutoSave = true
                }
            }, 3000);
        };

        // Module: Update Persistence Status Indicator
        CompanyOnboardingModule.updateStatusIndicator = function(message = null) {
            try {
                const statusDiv = document.getElementById('persistenceStatus');
                const statusIcon = document.getElementById('statusIcon');
                const statusText = document.getElementById('statusText');
                const lastSaveTime = document.getElementById('lastSaveTime');

                if (!statusDiv || !statusIcon || !statusText || !lastSaveTime) return;

                const status = this.checkPersistenceStatus();

                if (!this.autoSaveEnabled) {
                    // Auto-save disabled
                    statusDiv.style.background = '#f8d7da';
                    statusDiv.style.borderColor = '#dc3545';
                    statusIcon.textContent = '‚ö†Ô∏è';
                    statusText.textContent = 'Auto-save temporarily disabled due to validation errors';
                    lastSaveTime.textContent = '';
                } else if (this.unsavedChanges) {
                    // Unsaved changes
                    statusDiv.style.background = '#fff3cd';
                    statusDiv.style.borderColor = '#ffc107';
                    statusIcon.textContent = '‚è≥';
                    statusText.textContent = message || 'Auto-saving changes...';
                } else if (status && status.hasData) {
                    // Data saved successfully
                    statusDiv.style.background = '#e8f5e8';
                    statusDiv.style.borderColor = '#4caf50';
                    statusIcon.textContent = '‚úÖ';
                    statusText.textContent = message || 'Data saved successfully';

                    // Show last save time
                    if (this.lastSaveTime) {
                        const timeAgo = this.getTimeAgo(this.lastSaveTime);
                        lastSaveTime.textContent = `Saved ${timeAgo}`;
                    }
                } else {
                    // No data or error
                    statusDiv.style.background = '#f8d7da';
                    statusDiv.style.borderColor = '#dc3545';
                    statusIcon.textContent = '‚ö†Ô∏è';
                    statusText.textContent = 'No data saved yet';
                    lastSaveTime.textContent = '';
                }

            } catch (error) {
                console.error('[CompanyOnboarding] Failed to update status indicator:', error);
            }
        };

        // Module: Get Human-Readable Time Ago
        CompanyOnboardingModule.getTimeAgo = function(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffSecs = Math.floor(diffMs / 1000);
            const diffMins = Math.floor(diffSecs / 60);
            const diffHours = Math.floor(diffMins / 60);

            if (diffSecs < 10) return 'just now';
            if (diffSecs < 60) return `${diffSecs} seconds ago`;
            if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
            return date.toLocaleDateString();
        };

        // Module: Check Data Persistence Status
        CompanyOnboardingModule.checkPersistenceStatus = function() {
            try {
                const data = localStorage.getItem(this.storageKey);
                const backup = localStorage.getItem(this.backupKey);

                return {
                    hasData: !!data,
                    hasBackup: !!backup,
                    dataSize: data ? data.length : 0,
                    lastSaved: this.data?.lastSaved || null,
                    unsavedChanges: this.unsavedChanges,
                    isAutoSaveEnabled: this.autoSaveEnabled
                };
            } catch (error) {
                console.error('[CompanyOnboarding] Failed to check persistence status:', error);
                return null;
            }
        };

        // Module: Data Persistence Monitoring
        CompanyOnboardingModule.startPersistenceMonitoring = function() {
            console.log('[CompanyOnboarding] Starting persistence monitoring...');

            // Check data integrity every 30 seconds
            setInterval(() => {
                try {
                    const status = this.checkPersistenceStatus();

                    if (status && status.hasData) {
                        // Verify data can be parsed
                        const data = JSON.parse(localStorage.getItem(this.storageKey));

                        if (!this.validateDataIntegrity(data)) {
                            console.warn('[CompanyOnboarding] Data integrity check failed');
                            this.attemptDataRecovery();
                        }
                    }
                } catch (error) {
                    console.error('[CompanyOnboarding] Persistence monitoring error:', error);
                }
            }, 30000); // Check every 30 seconds

            // Periodic backup every 5 minutes
            setInterval(() => {
                if (this.data && Object.keys(this.data).length > 0) {
                    this.createBackup();
                    console.log('[CompanyOnboarding] Periodic backup created');
                }
            }, 300000); // Backup every 5 minutes
        };

        // Module: Initialize Data Persistence System
        CompanyOnboardingModule.initializePersistence = function() {
            try {
                console.log('[CompanyOnboarding] Initializing persistence system...');

                // Load all companies and set current company
                this.loadAllCompanies();

                // Load existing data (legacy support)
                this.getData();

                // Update company display
                this.updateCurrentCompanyDisplay();

                // Start monitoring
                this.startPersistenceMonitoring();

                // Handle browser close/refresh with unsaved changes
                window.addEventListener('beforeunload', (event) => {
                    if (this.unsavedChanges) {
                        event.preventDefault();
                        event.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                        return event.returnValue;
                    }
                });

                // Handle page visibility changes (when user switches tabs)
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'hidden' && this.unsavedChanges) {
                        // Save immediately when user switches away
                        this.saveData(true);
                    }
                });

                console.log('[CompanyOnboarding] Persistence system initialized successfully');

            } catch (error) {
                console.error('[CompanyOnboarding] Failed to initialize persistence system:', error);
            }
        };

        // Module: Export Company Onboarding Data
        CompanyOnboardingModule.exportData = function() {
            try {
                const dataStr = JSON.stringify(this.data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'company-onboarding-data.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showAlert('Company onboarding data exported successfully!', 'success');
            } catch (error) {
                console.error('[CompanyOnboarding] Error exporting data:', error);
                showAlert('Failed to export company data', 'error');
            }
        };

        // Module: Close Company Onboarding Manager
        CompanyOnboardingModule.closeManager = function() {
            const modal = document.getElementById('companyDataModal');
            if (modal) {
                modal.remove();
            }
        };

        // Module: Get Company Data for Personalization
        CompanyOnboardingModule.getData = function() {
            // Ensure companies are loaded
            if (Object.keys(this.companies).length === 0) {
                this.loadAllCompanies();
            }

            // If we have a current company, return its data
            if (this.currentCompanyId && this.companies[this.currentCompanyId]) {
                this.data = this.companies[this.currentCompanyId];
                console.log('[CompanyOnboarding] Loaded data for company:', this.currentCompanyId, this.data.companyName);
                return this.data;
            }

            // Fallback to legacy single company data if no multi-company data exists
            if (!this.data || Object.keys(this.data).length === 0) {
                const savedData = localStorage.getItem(this.storageKey);
                if (savedData) {
                    try {
                        this.data = JSON.parse(savedData);
                        console.log('[CompanyOnboarding] Loaded legacy data as fallback');
                    } catch (error) {
                        console.error('[CompanyOnboarding] Error loading legacy data:', error);
                        this.data = {};
                    }
                }
            }

            return this.data;
        };

        // Enhanced Personalization Engine with Smart Content Logic
        function personalizeEmailContent(content, contact) {
            if (!content) return '';

            let personalizedContent = content;

            // Replace contact variables (existing functionality)
            if (contact) {
                personalizedContent = personalizedContent
                    .replace(/{contactName}/g, contact.contactName || '')
                    .replace(/{firm}/g, contact.firm || '')
                    .replace(/{country}/g, contact.country || '')
                    .replace(/{email}/g, contact.email || '');
            }

            // Get company data from module
            const companyData = CompanyOnboardingModule.getData();

            // Auto-fill companyIndustry from web if empty (simulated)
            if (!companyData.companyIndustry && contact && contact.firm) {
                companyData.companyIndustry = autoFillIndustryFromWeb(contact.firm);
            }

            // Replace company variables with smart content logic
            CompanyOnboardingModule.availableFields.forEach(field => {
                if (companyData[field]) {
                    const regex = new RegExp(`{${field}}`, 'g');
                    personalizedContent = personalizedContent.replace(regex, companyData[field]);
                }
            });

            // Smart content hiding - hide descriptive text when variables are empty
            personalizedContent = applySmartContentHiding(personalizedContent, companyData);

            // Remove any remaining empty company placeholders
            CompanyOnboardingModule.availableFields.forEach(field => {
                const regex = new RegExp(`{${field}}`, 'g');
                personalizedContent = personalizedContent.replace(regex, '');
            });

            // Apply grammar checking and smart formatting
            personalizedContent = applySmartFormattingAndGrammar(personalizedContent);

            return personalizedContent;
        }

        // Auto-fill industry from web (simulated with common industry mappings)
        function autoFillIndustryFromWeb(firmName) {
            if (!firmName) return '';

            const firmLower = firmName.toLowerCase();
            const industryMappings = {
                'tech': 'Technology Solutions',
                'software': 'Software Development',
                'consulting': 'Business Consulting',
                'manufacturing': 'Manufacturing & Production',
                'retail': 'Retail & Commerce',
                'finance': 'Financial Services',
                'healthcare': 'Healthcare Services',
                'education': 'Educational Services',
                'real estate': 'Real Estate',
                'construction': 'Construction & Engineering'
            };

            for (const [key, industry] of Object.entries(industryMappings)) {
                if (firmLower.includes(key)) {
                    return industry;
                }
            }

            return 'Business Services'; // Default fallback
        }

        // Smart content hiding logic
        function applySmartContentHiding(content, companyData) {
            let processedContent = content;

            // Hide "Our product portfolio:" if {productPortfolioPoints} is empty
            if (!companyData.productPortfolioPoints) {
                processedContent = processedContent.replace(/Our product portfolio:\s*{productPortfolioPoints}/gi, '');
                processedContent = processedContent.replace(/Product Portfolio:\s*{productPortfolioPoints}/gi, '');
                processedContent = processedContent.replace(/Portfolio:\s*{productPortfolioPoints}/gi, '');
            }

            // Hide "Our key offerings:" if {OfferingPoints} is empty
            if (!companyData.OfferingPoints) {
                processedContent = processedContent.replace(/Our key offerings:\s*{OfferingPoints}/gi, '');
                processedContent = processedContent.replace(/Key Offerings:\s*{OfferingPoints}/gi, '');
                processedContent = processedContent.replace(/Offerings:\s*{OfferingPoints}/gi, '');
            }

            // Hide "Visit our website:" if {companyWebsite} is empty
            if (!companyData.companyWebsite) {
                processedContent = processedContent.replace(/Visit our website:\s*{companyWebsite}/gi, '');
                processedContent = processedContent.replace(/Website:\s*{companyWebsite}/gi, '');
            }

            // Hide "Contact us at:" if {companyEmail} or {companyPhone} is empty
            if (!companyData.companyEmail && !companyData.companyPhone) {
                processedContent = processedContent.replace(/Contact us at:[\s\S]*?({companyEmail}|{companyPhone})/gi, '');
            }

            // Clean up multiple consecutive line breaks
            processedContent = processedContent.replace(/\n\s*\n\s*\n/g, '\n\n');

            return processedContent;
        }

        // Smart formatting and grammar checking
        function applySmartFormattingAndGrammar(content) {
            let formattedContent = content;

            // Bold key business terms
            const keyTerms = [
                'partnership', 'collaboration', 'opportunity', 'innovation', 'solutions',
                'technology', 'manufacturing', 'distribution', 'quality', 'excellence',
                'market leader', 'industry expertise', 'competitive advantage', 'value proposition'
            ];

            keyTerms.forEach(term => {
                const regex = new RegExp(`\\b${term}\\b`, 'gi');
                formattedContent = formattedContent.replace(regex, `<strong>${term}</strong>`);
            });

            // Proper spacing after punctuation
            formattedContent = formattedContent.replace(/([.!?])([A-Z])/g, '$1 $2');
            formattedContent = formattedContent.replace(/([,;])([A-Z])/g, '$1 $2');

            // Ensure proper capitalization after periods
            formattedContent = formattedContent.replace(/\.\s*([a-z])/g, (match, letter) => `. ${letter.toUpperCase()}`);

            // Fix common grammar issues
            formattedContent = formattedContent.replace(/\bi\b/g, 'I'); // Capitalize standalone 'i'
            formattedContent = formattedContent.replace(/\bwont\b/g, "won't"); // Fix contractions
            formattedContent = formattedContent.replace(/\bcant\b/g, "can't");
            formattedContent = formattedContent.replace(/\bdont\b/g, "don't");

            // Ensure proper paragraph spacing
            formattedContent = formattedContent.replace(/\n{3,}/g, '\n\n');

            // Remove extra spaces
            formattedContent = formattedContent.replace(/\s{2,}/g, ' ');

            return formattedContent;
        }


                // Module: Load Professional Email Template
        CompanyOnboardingModule.loadProfessionalTemplate = function() {
            // Professional HTML email template with company data variables
            const professionalTemplate = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{companyName} Campaign Email</title>
  <style>
    /* Basic reset / mobile-friendly rules */
    body, table, td, a {
      -webkit-text-size-adjust: 100%;
      -ms-text-size-adjust: 100%;
    }
    img {
      border: 0;
      height: auto;
      line-height: 100%;
      outline: none;
      text-decoration: none;
      max-width: 100%;
    }
    table {
      border-collapse: collapse !important;
    }
    body {
      width: 100% !important;
      height: 100% !important;
      margin: 0;
      padding: 0;
    }
    /* Responsive */
    @media screen and (max-width:600px) {
      .responsive-table {
        width: 100% !important;
      }
      .padding {
        padding: 10px !important;
      }
    }
    /* Button style */
    .btn {
      display: inline-block;
      background-color: #007bff;
      color: #ffffff;
      padding: 12px 24px;
      text-decoration: none;
      font-weight: bold;
      border-radius: 4px;
    }
  </style>
</head>
<body style="background-color: #f4f4f4; margin:0; padding:0;">

  <!-- Wrapper / outer table -->
  <table border="0" cellpadding="0" cellspacing="0" width="100%">
    <tr>
      <td align="center" style="padding: 20px 0;">
        <!-- Main container -->
        <table class="responsive-table" border="0" cellpadding="0" cellspacing="0" width="600" style="background-color: #ffffff; border-radius: 8px; overflow: hidden;">

          <!-- Header / logo -->
          <tr>
            <td align="center" style="padding: 20px;">
              <img src="{companyLogo}" alt="{companyName} Logo" width="200" style="display: block;">
            </td>
          </tr>

          <!-- Hero / banner image -->
          <tr>
            <td align="center">
              <img src="https://via.placeholder.com/600x200/007bff/ffffff?text={companyName}" alt="Main banner image" style="display: block; width:100%; height: auto;">
            </td>
          </tr>

          <!-- Content block -->
          <tr>
            <td class="padding" style="padding: 20px; font-family: Arial, sans-serif; color: #333333;">
              <h1 style="font-size: 24px; margin: 0 0 10px;">Partnership Opportunity with {companyName}</h1>
              <p style="font-size: 16px; line-height: 1.5; margin: 0 0 15px;">
                Dear {contactName},
              </p>
              <p style="font-size: 16px; line-height: 1.5; margin: 0 0 15px;">
                We are excited to introduce you to {companyName}, a leading company in the {companyIndustry} industry with {companyYears} years of proven expertise and excellence.
              </p>
              <p style="font-size: 16px; line-height: 1.5; margin: 0 0 15px;">
                {companyDescription}
              </p>

              <hr style="border: 0; border-top: 1px solid #dddddd; margin: 20px 0;">

              <h2 style="font-size: 20px; margin: 0 0 10px;">Why Partner with {companyName}?</h2>
              <ul style="font-size: 16px; line-height: 1.5; margin: 0 0 20px; padding-left: 20px;">
                <li>{companyYears} years of industry leadership and expertise</li>
                <li>Comprehensive solutions in {companyIndustry}</li>
                <li>Proven track record of successful partnerships</li>
                <li>Dedicated support and professional service</li>
                <li>Competitive terms and mutual growth opportunities</li>
              </ul>

              <p style="font-size: 16px; line-height: 1.5; margin: 0 0 20px;">
                We believe that {firm} in {country} would be an excellent partner for expanding our market presence and delivering exceptional value to customers in your region.
              </p>

              <p style="text-align: center; margin: 20px 0;">
                <a href="{companyWebsite}" class="btn" target="_blank">Learn More About {companyName}</a>
              </p>
            </td>
          </tr>

          <!-- Contact / social block -->
          <tr>
            <td class="padding" style="padding: 20px; font-family: Arial, sans-serif; color: #777777; font-size: 14px;">
              <p>We would love to discuss partnership opportunities with {firm}. Please feel free to contact us:</p>
              <p><strong>Email:</strong> <a href="mailto:{companyEmail}" style="color:#007bff;">{companyEmail}</a></p>
              <p><strong>Phone:</strong> {companyPhone}</p>
              <p><strong>Website:</strong> <a href="{companyWebsite}" style="color:#007bff;">{companyWebsite}</a></p>

              <p style="margin-top: 20px;">
                We look forward to exploring how {companyName} and {firm} can create a successful partnership that benefits both our organizations and the customers we serve in {country}.
              </p>
            </td>
          </tr>

          <!-- Footer -->
          <tr>
            <td align="center" style="padding: 20px; background-color: #f9f9f9; font-family: Arial, sans-serif; font-size: 12px; color: #999999;">
              <p>{companyName}</p>
              <p>{companyAddress}</p>
              <p><a href="{companyWebsite}" style="color: #999999;">{companyWebsite}</a> | <a href="mailto:{companyEmail}" style="color: #999999;">{companyEmail}</a></p>
            </td>
          </tr>

        </table>
      </td>
    </tr>
  </table>

</body>
</html>`;

            // Set the subject and message body
            document.getElementById('subject').value = 'Partnership Opportunity - {companyName} & {firm}';
            document.getElementById('messageBody').innerHTML = professionalTemplate;

            showAlert('Professional email template loaded! üìß All company variables will be automatically replaced when sending.', 'success');
            this.closeManager();
        };

        // Module: Apply Template to Message Composer
        CompanyOnboardingModule.applyTemplateToMessage = function() {
            const template = document.getElementById('companyEmailTemplate').innerHTML;
            if (!template) {
                showAlert('Template is empty. Please enter template content first.', 'warning');
                return;
            }

            // Check template type selection
            const isPersonalized = document.querySelector('input[name="templateType"]:checked').value === 'personalized';

            // Use the existing template extraction logic
            const templateData = this.extractTemplateContent(template);

            // Apply personalization based on type
            let processedSubject = templateData.subject;
            let processedContent = templateData.content;

            if (isPersonalized) {
                // Use enhanced personalization engine
                processedSubject = personalizeEmailContent(processedSubject, null);
                processedContent = personalizeEmailContent(processedContent, null);
                showAlert('‚ú® Personalized template applied with smart content and grammar checking! üìß', 'success');
            } else {
                // Use basic personalization (company variables only, no smart content hiding)
                const companyData = this.getData();
                this.availableFields.forEach(field => {
                    if (companyData[field]) {
                        const regex = new RegExp(`{${field}}`, 'g');
                        processedSubject = processedSubject.replace(regex, companyData[field]);
                        processedContent = processedContent.replace(regex, companyData[field]);
                    }
                });
                showAlert('üîç Standard template applied with basic personalization! üìß', 'success');
            }

            // Apply to subject and message body
            if (processedSubject) {
                document.getElementById('subject').value = processedSubject;
            }

            if (processedContent) {
                const messageBody = document.getElementById('messageBody');
                const sanitizedContent = processedContent.replace(/\n/g, '<br>');
                messageBody.innerHTML = sanitizedContent;
            }

            this.closeManager();
        };

        // Module: Save Template Only
        CompanyOnboardingModule.saveTemplate = function() {
            try {
                // Load existing data first
                const savedData = localStorage.getItem(this.storageKey);
                if (savedData) {
                    this.data = JSON.parse(savedData);
                }

                // Update only the template
                this.data.emailTemplate = document.getElementById('companyEmailTemplate').innerHTML;

                localStorage.setItem(this.storageKey, JSON.stringify(this.data));
                showAlert('Email template saved successfully! üìß', 'success');
            } catch (error) {
                console.error('[CompanyOnboarding] Error saving template:', error);
                showAlert('Failed to save template', 'error');
            }
        };

        // Module: Reset Template to Default
        CompanyOnboardingModule.resetTemplate = function() {
            if (confirm('Are you sure you want to reset the template to default? This will overwrite your current template.')) {
                document.getElementById('companyEmailTemplate').innerHTML = this.defaultTemplate;
                showAlert('Template reset to default! üîÑ', 'success');
            }
        };

        // Module: Extract Template Content (same logic as existing function)
        CompanyOnboardingModule.extractTemplateContent = function(template) {
            if (!template) return { subject: '', content: '' };

            // Convert HTML to text for processing, but preserve the HTML structure for content
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = template;
            const textContent = tempDiv.textContent || tempDiv.innerText || '';

            // Split by both newlines and HTML line breaks
            const lines = textContent.split(/\n|<br\s*\/?>/i);
            let subject = '';
            let content = '';
            let contentStartIndex = -1;

            // Find subject line and content start
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();

                if (line.startsWith('Subject:')) {
                    subject = line.replace('Subject:', '').trim();
                } else if (subject && line === '' && contentStartIndex === -1) {
                    // First empty line after subject marks start of content
                    contentStartIndex = i + 1;
                    break;
                }
            }

            // If we found a subject, extract content from the HTML after the subject line
            if (subject) {
                // Find the subject in the original HTML and get content after it
                const subjectIndex = template.indexOf('Subject:');
                if (subjectIndex !== -1) {
                    const afterSubject = template.substring(subjectIndex);
                    const contentMatch = afterSubject.match(/Subject:[^<\n]*(?:<br\s*\/?>|\n)\s*([\s\S]*)/i);
                    if (contentMatch) {
                        content = contentMatch[1].trim();
                    }
                }
            } else {
                // If no subject found, treat the entire template as content
                content = template.trim();
            }

            return { subject, content };
        };
        // Email Analytics Dashboard Functions
        let autoRedirectEnabled = true;

        function toggleAnalytics() {
            // Open analytics in a popup window instead of expanding
            showAnalyticsPopup();
        }

        function updateAnalytics() {
            const sentCount = emailHistory.filter(email => email.status === 'sent').length;
            const failedCount = emailHistory.filter(email => email.status === 'failed').length;

            document.getElementById('sentCount').textContent = sentCount;
            document.getElementById('failedCount').textContent = failedCount;

            // Update country filter options
            const countries = [...new Set(emailHistory.map(email => email.country))];
            const countryFilter = document.getElementById('countryFilter');
            countryFilter.innerHTML = '<option value="">All Countries</option>';
            countries.forEach(country => {
                countryFilter.innerHTML += `<option value="${country}">${country}</option>`;
            });

            // Update top countries
            const countryStats = countries.map(country => {
                const countryEmails = emailHistory.filter(email => email.country === country);
                return {
                    country,
                    sent: countryEmails.filter(email => email.status === 'sent').length,
                    total: countryEmails.length
                };
            }).sort((a, b) => b.total - a.total).slice(0, 3);

            const topCountriesDiv = document.getElementById('topCountries');
            if (countryStats.length === 0) {
                topCountriesDiv.textContent = 'No data yet';
            } else {
                topCountriesDiv.innerHTML = countryStats.map(stat =>
                    `<div style="margin-bottom: 4px;">${stat.country}: ${stat.sent}/${stat.total} sent</div>`
                ).join('');
            }
        }

        function showAnalyticsPopup() {
            // Create comprehensive analytics popup
            const modal = document.createElement('div');
            modal.id = 'analyticsPopupModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
                z-index: 20000; padding: 20px;
            `;

            // Calculate comprehensive analytics
            const currentSpreadsheetEmails = emailHistory.filter(email => email.timestamp >= (Date.now() - 30 * 24 * 60 * 60 * 1000)); // Last 30 days as "current"
            const allTimeEmails = emailHistory;

            const currentStats = calculateDetailedStats(currentSpreadsheetEmails);
            const allTimeStats = calculateDetailedStats(allTimeEmails);

            // Get contact statistics
            const totalContacts = contacts.length;
            const sentContacts = contacts.filter(c => c.emailStatus === 'sent').length;
            const failedContacts = contacts.filter(c => c.emailStatus === 'failed').length;
            const partialContacts = contacts.filter(c => c.emailStatus === 'partial').length;
            const pendingContacts = contacts.filter(c => c.emailStatus === 'pending').length;

            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; max-width: 1200px; width: 95%; max-height: 90%; overflow-y: auto; padding: 0;">
                    <!-- Header -->
                    <div style="padding: 20px 24px; border-bottom: 2px solid #e5e7eb; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px 12px 0 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 style="margin: 0; font-size: 24px; font-weight: 600;">üìä Comprehensive Email Analytics</h2>
                                <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">Complete analysis of email campaigns and performance metrics</p>
                            </div>
                            <button onclick="closeAnalyticsPopup()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; cursor: pointer; padding: 8px; border-radius: 6px; line-height: 1;">
                                ‚úï
                            </button>
                        </div>
                    </div>

                    <!-- Content -->
                    <div style="padding: 24px;">
                        <!-- Quick Overview -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px;">
                            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${allTimeStats.sent}</div>
                                <div style="font-size: 14px; opacity: 0.9;">Total Sent</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${allTimeStats.successRate}%</div>
                                <div style="font-size: 14px; opacity: 0.9;">Success Rate</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${totalContacts}</div>
                                <div style="font-size: 14px; opacity: 0.9;">Total Contacts</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${allTimeStats.countries}</div>
                                <div style="font-size: 14px; opacity: 0.9;">Countries</div>
                            </div>
                        </div>

                        <!-- Detailed Analytics Sections -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px;">
                            <!-- Current Upload Analytics -->
                            <div style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px;">
                                <h3 style="margin: 0 0 16px 0; color: #1e293b; font-size: 18px; display: flex; align-items: center;">
                                    üìà Current Upload Analytics
                                </h3>
                                <div style="margin-bottom: 16px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span>üì§ Emails Sent:</span>
                                        <strong style="color: #059669;">${currentStats.sent}</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span>‚ùå Emails Failed:</span>
                                        <strong style="color: #dc2626;">${currentStats.failed}</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span>üìä Success Rate:</span>
                                        <strong style="color: #7c3aed;">${currentStats.successRate}%</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span>üåç Countries Reached:</span>
                                        <strong>${currentStats.countries}</strong>
                                    </div>
                                </div>
                                <!-- Contact Status Breakdown -->
                                <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid #e2e8f0;">
                                    <h4 style="margin: 0 0 8px 0; font-size: 14px; color: #64748b;">Contact Status Breakdown</h4>
                                    <div style="font-size: 12px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                            <span style="color: #059669;">‚úÖ Sent Contacts:</span>
                                            <strong>${sentContacts}</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                            <span style="color: #dc2626;">‚ùå Failed Contacts:</span>
                                            <strong>${failedContacts}</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                            <span style="color: #f59e0b;">‚óê Partial Contacts:</span>
                                            <strong>${partialContacts}</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: #6b7280;">‚è≥ Pending Contacts:</span>
                                            <strong>${pendingContacts}</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- All-Time Analytics -->
                            <div style="background: #fefce8; border: 2px solid #fde047; border-radius: 12px; padding: 20px;">
                                <h3 style="margin: 0 0 16px 0; color: #1e293b; font-size: 18px; display: flex; align-items: center;">
                                    üèÜ All-Time Analytics
                                </h3>
                                <div style="margin-bottom: 16px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span>üìß Total Emails Sent:</span>
                                        <strong style="color: #059669;">${allTimeStats.sent}</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span>‚ùå Total Failed:</span>
                                        <strong style="color: #dc2626;">${allTimeStats.failed}</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span>üìä Overall Success Rate:</span>
                                        <strong style="color: #7c3aed;">${allTimeStats.successRate}%</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span>üåç Total Countries:</span>
                                        <strong>${allTimeStats.countries}</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>üìÖ Days Active:</span>
                                        <strong>${allTimeStats.daysActive}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Top Countries Performance -->
                        <div style="background: #f0f9ff; border: 2px solid #93c5fd; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                            <h3 style="margin: 0 0 16px 0; color: #1e293b; font-size: 18px;">üåç Top Countries by Email Volume</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px;">
                                ${generateTopCountriesHTML(allTimeStats.topCountries)}
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div style="display: flex; justify-content: center; gap: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                            <button onclick="exportAnalyticsData()" style="background: #059669; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; cursor: pointer; font-weight: 500;">
                                üìä Export Data
                            </button>
                            <button onclick="clearAnalyticsData()" style="background: #dc2626; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; cursor: pointer; font-weight: 500;">
                                üóëÔ∏è Clear History
                            </button>
                            <button onclick="closeAnalyticsPopup()" style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; cursor: pointer; font-weight: 500;">
                                ‚úï Close
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function calculateDetailedStats(emailData) {
            const sent = emailData.filter(email => email.status === 'sent').length;
            const failed = emailData.filter(email => email.status === 'failed').length;
            const total = emailData.length;
            const successRate = total > 0 ? Math.round((sent / total) * 100) : 0;

            const countries = [...new Set(emailData.map(email => email.country))].length;

            // Calculate top countries
            const countryStats = {};
            emailData.forEach(email => {
                if (!countryStats[email.country]) {
                    countryStats[email.country] = { sent: 0, failed: 0, total: 0 };
                }
                countryStats[email.country].total++;
                if (email.status === 'sent') {
                    countryStats[email.country].sent++;
                } else {
                    countryStats[email.country].failed++;
                }
            });

            const topCountries = Object.entries(countryStats)
                .map(([country, stats]) => ({
                    country,
                    ...stats,
                    successRate: stats.total > 0 ? Math.round((stats.sent / stats.total) * 100) : 0
                }))
                .sort((a, b) => b.total - a.total)
                .slice(0, 5);

            // Calculate days active
            const dates = emailData.map(email => new Date(email.timestamp).toDateString());
            const uniqueDates = [...new Set(dates)].length;

            return {
                sent,
                failed,
                total,
                successRate,
                countries,
                topCountries,
                daysActive: uniqueDates
            };
        }

        function generateTopCountriesHTML(topCountries) {
            if (topCountries.length === 0) {
                return '<div style="text-align: center; color: #6b7280; padding: 20px;">No country data available</div>';
            }

            return topCountries.map(country => `
                <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid #bfdbfe;">
                    <div style="font-weight: 600; color: #1e293b; margin-bottom: 8px;">${country.country}</div>
                    <div style="font-size: 12px; color: #64748b;">
                        <div>üìß Total: ${country.total} emails</div>
                        <div>‚úÖ Sent: ${country.sent}</div>
                        <div>‚ùå Failed: ${country.failed}</div>
                        <div style="font-weight: 500; color: ${country.successRate >= 80 ? '#059669' : country.successRate >= 60 ? '#f59e0b' : '#dc2626'};">
                            üìä Success: ${country.successRate}%
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function closeAnalyticsPopup() {
            const modal = document.getElementById('analyticsPopupModal');
            if (modal) {
                modal.remove();
            }
        }

        function exportAnalyticsData() {
            // Export comprehensive analytics data
            const allTimeStats = calculateDetailedStats(emailHistory);
            const exportData = {
                generated: new Date().toISOString(),
                summary: allTimeStats,
                contacts: contacts.map(c => ({
                    firm: c.firm,
                    country: c.country,
                    emailStatus: c.emailStatus,
                    email: c.email
                })),
                emailHistory: emailHistory,
                topCountries: allTimeStats.topCountries
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `email_analytics_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showAlert('Analytics data exported successfully!', 'success');
        }

        function clearAnalyticsData() {
            if (confirm('Are you sure you want to clear all email history and analytics data? This action cannot be undone.')) {
                emailHistory.length = 0; // Clear email history
                contacts.forEach(contact => contact.emailStatus = 'pending'); // Reset contact statuses
                updateAnalytics();
                renderContacts();
                saveToLocalStorage();
                closeAnalyticsPopup();
                showAlert('Analytics data cleared successfully!', 'success');
            }
        }

        function filterEmailHistory() {
            const countryFilter = document.getElementById('countryFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;

            let filteredHistory = [...emailHistory];

            // Filter by country
            if (countryFilter) {
                filteredHistory = filteredHistory.filter(email => email.country === countryFilter);
            }

            // Filter by date
            if (dateFilter) {
                const now = new Date();
                const startDate = new Date();

                switch (dateFilter) {
                    case 'today':
                        startDate.setHours(0, 0, 0, 0);
                        break;
                    case 'week':
                        startDate.setDate(now.getDate() - 7);
                        break;
                    case 'month':
                        startDate.setMonth(now.getMonth() - 1);
                        break;
                }

                filteredHistory = filteredHistory.filter(email => new Date(email.timestamp) >= startDate);
            }

            // Update displayed history
            renderEmailHistory(filteredHistory);
        }

        function addEmailToHistory(email, status, country) {
            const historyEntry = {
                id: Date.now(),
                email,
                status,
                country,
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString()
            };

            emailHistory.unshift(historyEntry);
            renderEmailHistory();
            updateAnalytics();
        }

        function renderEmailHistory(customHistory = null) {
            const history = customHistory || emailHistory;
            const container = document.getElementById('emailHistory');

            if (history.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 15px;">
                        <p style="font-size: 12px;">üìß Email history will appear here</p>
                        <small style="font-size: 10px;">Send emails to see status tracking</small>
                    </div>
                `;
                return;
            }

            const historyHTML = history.slice(0, 20).map(entry => {
                const statusIcon = entry.status === 'sent' ? '‚úÖ' : '‚ùå';
                const statusColor = entry.status === 'sent' ? '#10b981' : '#ef4444';

                // Handle different email field formats (legacy and new)
                const emailDisplay = entry.email || (Array.isArray(entry.toEmails) ? entry.toEmails[0] : entry.toEmails) || 'Unknown';

                // Handle missing country field
                const countryDisplay = entry.country || 'Unknown';

                // Handle time field - create from timestamp if missing
                const timeDisplay = entry.time || (entry.timestamp ? new Date(entry.timestamp).toLocaleTimeString() : 'Unknown time');

                return `
                    <div style="padding: 8px; margin-bottom: 6px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <span style="font-size: 11px; font-weight: 500; color: #374151;" title="${emailDisplay}">${emailDisplay.length > 30 ? emailDisplay.substring(0, 30) + '...' : emailDisplay}</span>
                            <span style="font-size: 10px; color: ${statusColor};">${statusIcon}</span>
                        </div>
                        <div style="font-size: 10px; color: #6b7280;">
                            ${countryDisplay} ‚Ä¢ ${timeDisplay}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = historyHTML;
        }

        function clearEmailHistory() {
            if (confirm('Clear all email history? This cannot be undone.')) {
                emailHistory = [];
                renderEmailHistory();
                updateAnalytics();
                showAlert('Email history cleared', 'info');
            }
        }

        // Response Email Manager Functions
        let responseEmails = [];

        function toggleResponseManager() {
            const panel = document.getElementById('responsePanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                // Auto-check for responses when opened
                checkResponseEmails();
            } else {
                panel.style.display = 'none';
            }
        }

        function checkResponseEmails() {
            // Simulate checking for response emails
            showAlert('Checking for response emails...', 'info');

            setTimeout(() => {
                // Simulate some realistic responses based on sent emails
                const responseTemplates = [
                    {
                        from: 'john.smith@techcorp.com',
                        subject: 'Re: Business Partnership Opportunity - Intex Technologies',
                        content: 'Thank you for reaching out. We are interested in discussing partnership opportunities with Intex Technologies. Could we schedule a call next week?'
                    },
                    {
                        from: 'maria.garcia@globaltrading.es',
                        subject: 'Re: Partnership Inquiry',
                        content: 'Hello, thank you for your email. We would like to learn more about your product portfolio. Please send us your complete catalog and pricing information.'
                    },
                    {
                        from: 'david.wong@asiaimports.sg',
                        subject: 'Re: Distribution Partnership',
                        content: 'We are a leading distributor in Singapore and are interested in your electronics products. Please share your distribution terms and minimum order quantities.'
                    },
                    {
                        from: 'sarah.johnson@electronicplus.ca',
                        subject: 'Re: Business Collaboration',
                        content: 'Your products look interesting. We operate 50+ retail stores across Canada. Would like to discuss exclusive distribution rights for certain product lines.'
                    },
                    {
                        from: 'ahmed.hassan@middleeasttech.ae',
                        subject: 'Re: Partnership Opportunity',
                        content: 'Greetings from UAE! We are impressed by Intex Technologies reputation. We handle electronics distribution across Middle East. Can we arrange a video conference?'
                    }
                ];

                const newResponses = [];

                // 40% chance of getting 1-3 new responses
                if (Math.random() > 0.6) {
                    const numResponses = Math.floor(Math.random() * 3) + 1;

                    for (let i = 0; i < numResponses; i++) {
                        const template = responseTemplates[Math.floor(Math.random() * responseTemplates.length)];
                        const response = {
                            id: Date.now() + i,
                            from: template.from,
                            subject: template.subject,
                            timestamp: new Date(Date.now() - Math.random() * 24 * 60 * 60 * 1000), // Random time in last 24 hours
                            content: template.content
                        };
                        newResponses.push(response);
                    }

                    // Add to existing responses (avoid duplicates)
                    const existingIds = responseEmails.map(r => r.from);
                    const uniqueResponses = newResponses.filter(r => !existingIds.includes(r.from));

                    if (uniqueResponses.length > 0) {
                        responseEmails = [...uniqueResponses, ...responseEmails];
                        renderResponseEmails();

                        if (autoRedirectEnabled) {
                            uniqueResponses.forEach(response => {
                                redirectResponseEmail(response);
                            });
                        }

                        showAlert(`üì¨ Found ${uniqueResponses.length} new response(s)!`, 'success');
                    } else {
                        showAlert('No new responses found', 'info');
                    }
                } else {
                    showAlert('No new responses found', 'info');
                }
            }, 1500);
        }

        function renderResponseEmails() {
            const container = document.getElementById('responseList');
            const counter = document.getElementById('responseCounter');

            // Update counter
            if (responseEmails.length > 0) {
                counter.textContent = responseEmails.length;
                counter.style.display = 'flex';
            } else {
                counter.style.display = 'none';
            }

            if (responseEmails.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #6b7280; padding: 20px;">
                        <div style="font-size: 24px; margin-bottom: 8px;">üì≠</div>
                        <div>No responses yet</div>
                        <small style="font-size: 10px;">Response emails will appear here</small>
                    </div>
                `;
                return;
            }

            const responsesHTML = responseEmails.slice(0, 5).map(response => `
                <div style="padding: 12px; margin-bottom: 8px; background: #f8f9fa; border: 1px solid #dadce0; border-radius: 8px;">
                    <div style="font-weight: 500; font-size: 12px; color: #202124; margin-bottom: 4px;">
                        ${escapeHTML(response.from)}
                    </div>
                    <div style="font-size: 11px; color: #5f6368; margin-bottom: 6px;">
                        ${escapeHTML(response.subject)}
                    </div>
                    <div style="font-size: 10px; color: #5f6368; margin-bottom: 8px;">
                        ${response.timestamp.toLocaleString()}
                    </div>
                    <div style="display: flex; gap: 6px;">
                        <button onclick="viewResponseEmail(${response.id})" class="button" style="padding: 4px 8px; font-size: 10px; flex: 1;">
                            View
                        </button>
                        <button onclick="redirectResponseEmail(${JSON.stringify(response).replace(/"/g, '&quot;')})" class="button button-secondary" style="padding: 4px 8px; font-size: 10px; flex: 1;">
                            Forward
                        </button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = responsesHTML;
        }

        function viewResponseEmail(responseId) {
            const response = responseEmails.find(r => r.id === responseId);
            if (!response) {
                showAlert('Response email not found', 'error');
                return;
            }

            // Create modal for viewing response
            const modal = document.createElement('div');
            modal.id = 'viewResponseModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
                z-index: 15000; padding: 20px;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto; padding: 0;">
                    <!-- Header -->
                    <div style="padding: 20px 24px 16px 24px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; color: #202124; font-size: 18px; font-weight: 500;">Email Response</h3>
                        <button onclick="closeViewResponseModal()" class="modal-close-btn" title="Close">√ó</button>
                    </div>

                    <!-- Email Details -->
                    <div style="padding: 20px 24px;">
                        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: 80px 1fr; gap: 12px; margin-bottom: 12px;">
                                <div style="font-size: 12px; color: #5f6368; font-weight: 500;">FROM:</div>
                                <div style="font-size: 14px; color: #202124;">${escapeHTML(response.from)}</div>
                            </div>
                            <div style="display: grid; grid-template-columns: 80px 1fr; gap: 12px; margin-bottom: 12px;">
                                <div style="font-size: 12px; color: #5f6368; font-weight: 500;">SUBJECT:</div>
                                <div style="font-size: 14px; color: #202124;">${escapeHTML(response.subject)}</div>
                            </div>
                            <div style="display: grid; grid-template-columns: 80px 1fr; gap: 12px;">
                                <div style="font-size: 12px; color: #5f6368; font-weight: 500;">DATE:</div>
                                <div style="font-size: 14px; color: #202124;">${response.timestamp.toLocaleString()}</div>
                            </div>
                        </div>

                        <!-- Email Content -->
                        <div>
                            <h4 style="margin: 0 0 12px 0; color: #202124; font-size: 14px; font-weight: 500;">Message Content</h4>
                            <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; background: white; min-height: 100px; max-height: 300px; overflow-y: auto;">
                                <div style="font-size: 14px; line-height: 1.6; color: #202124; white-space: pre-wrap;">${escapeHTML(response.content || 'No content available')}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer Actions -->
                    <div style="padding: 16px 24px; border-top: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa;">
                        <div></div>
                        <div style="display: flex; gap: 12px;">
                            <button onclick="closeViewResponseModal()" class="button">Close</button>
                            <button onclick="forwardResponseFromModal(${JSON.stringify(response).replace(/"/g, '&quot;')})" class="button button-primary">Forward</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function closeViewResponseModal() {
            const modal = document.getElementById('viewResponseModal');
            if (modal) {
                modal.remove();
            }
        }

        function forwardResponseFromModal(response) {
            closeViewResponseModal();
            redirectResponseEmail(response);
        }

        function redirectResponseEmail(response) {
            const redirectEmail = document.getElementById('redirectEmail').value;

            // Simulate email redirection
            showAlert(`Redirecting response from ${response.from} to ${redirectEmail}`, 'success');

            // In real implementation, this would actually forward the email
            console.log('Redirecting email:', {
                from: response.from,
                to: redirectEmail,
                subject: `Fwd: ${response.subject}`,
                content: response.content
            });
        }

        function toggleAutoRedirect() {
            autoRedirectEnabled = !autoRedirectEnabled;
            const button = document.getElementById('redirectBtn');

            if (autoRedirectEnabled) {
                button.textContent = '‚úì ON';
                button.style.background = '#10b981';
                showAlert('Auto-redirect enabled', 'success');
            } else {
                button.textContent = '‚úó OFF';
                button.style.background = '#6b7280';
                showAlert('Auto-redirect disabled', 'info');
            }
        }

        // Click outside to close panels
        document.addEventListener('click', function(event) {
            // Close color picker when clicking outside
            const colorPicker = document.getElementById('colorPicker');
            if (colorPicker && !event.target.closest('#colorPicker') && !event.target.closest('[onclick*="showColorPicker"]')) {
                colorPicker.style.display = 'none';
            }

            // Close response panel when clicking outside
            const responsePanel = document.getElementById('responsePanel');
            const responseManager = document.getElementById('responseEmailManager');
            if (responsePanel && !responseManager.contains(event.target)) {
                responsePanel.style.display = 'none';
            }
        });

        // Initialize analytics on page load
        // Removed dummy email history - now uses real data from email sending

        // Smart Message AI Assistant Functions
        let enhancedMessage = '';
        let currentChatContext = '';

        function openSmartMessage() {
            const popup = document.getElementById('smartMessagePopup');
            popup.style.display = 'block';

            // Update company context
            updateCompanyContext();

            // Get current message
            const messageBody = document.getElementById('messageBody');
            currentChatContext = messageBody.innerHTML || messageBody.textContent;

            // Show current message and provide ChatGPT-like interface
            const chatMessages = document.getElementById('chatMessages');
            const currentMessageText = messageBody.textContent || messageBody.innerText || 'No message content';

            chatMessages.innerHTML = `
                <div style="padding: 15px; background: #f8f9fa; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #3b82f6;">
                    <div style="font-weight: 600; color: #1e40af; margin-bottom: 8px; font-size: 14px;">üìß Current Message</div>
                    <div style="background: white; padding: 12px; border-radius: 8px; font-size: 13px; line-height: 1.5; max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb;">
                        ${currentMessageText.length > 500 ? currentMessageText.substring(0, 500) + '...' : currentMessageText}
                    </div>
                </div>

                <div style="padding: 15px; background: #f0f9ff; border-radius: 12px; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                        <span style="font-size: 18px;">ü§ñ</span>
                        <strong style="color: #0369a1; font-size: 14px;">AI Assistant</strong>
                    </div>
                    <p style="margin: 0; font-size: 13px; color: #334155; line-height: 1.5;">
                        I can help you enhance your email message. Choose from the quick actions below or tell me what specific changes you'd like to make. I'll show you a preview before applying any changes.
                    </p>
                </div>
            `;
        }

        function closeSmartMessage() {
            document.getElementById('smartMessagePopup').style.display = 'none';
        }

        function updateCompanyContext() {
            const contextInfo = document.getElementById('contextInfo');

            if (selectedContactIndex === -1 || !contacts[selectedContactIndex]) {
                contextInfo.innerHTML = 'No contact selected. Please select a contact to get personalized suggestions.';
                return;
            }

            const contact = contacts[selectedContactIndex];
            contextInfo.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 11px;">
                    <div><strong>Company:</strong> ${contact.firm}</div>
                    <div><strong>Country:</strong> ${contact.country}</div>
                    <div><strong>Contact:</strong> ${contact.contactName}</div>
                    <div><strong>Email:</strong> ${contact.email}</div>
                    <div><strong>Industry:</strong> ${contact.category}</div>
                    <div><strong>Focus:</strong> ${contact.businessFocus}</div>
                </div>
            `;
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            // Add user message to chat
            addChatMessage('user', message);
            input.value = '';

            // Process the message and get AI response with enhanced message
            setTimeout(() => {
                const result = getAIResponseWithPreview(message);
                addChatMessageWithPreview('assistant', result.explanation, result.enhancedMessage);
            }, 1000);
        }

        function addChatMessage(sender, message) {
            const chatMessages = document.getElementById('chatMessages');
            const isUser = sender === 'user';

            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                padding: 10px;
                background: ${isUser ? '#f0f9ff' : '#e3f2fd'};
                border-radius: 8px;
                margin-bottom: 10px;
                ${isUser ? 'margin-left: 20px;' : ''}
            `;

            messageDiv.innerHTML = `
                <strong style="color: ${isUser ? '#0369a1' : '#1976d2'};">${isUser ? 'üë§ You:' : 'ü§ñ Assistant:'}</strong>
                <p style="margin: 5px 0 0 0; font-size: 13px;">${message}</p>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addChatMessageWithPreview(sender, explanation, enhancedMessage) {
            const chatMessages = document.getElementById('chatMessages');

            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                padding: 15px;
                background: #f0f9ff;
                border-radius: 12px;
                margin-bottom: 15px;
                border-left: 4px solid #3b82f6;
            `;

            messageDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                    <span style="font-size: 16px;">ü§ñ</span>
                    <strong style="color: #0369a1; font-size: 14px;">AI Enhancement</strong>
                </div>

                <div style="margin-bottom: 12px; font-size: 13px; color: #475569;">
                    ${explanation}
                </div>

                <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 12px;">
                    <div style="font-weight: 600; color: #374151; margin-bottom: 8px; font-size: 12px;">üìù ENHANCED MESSAGE PREVIEW</div>
                    <div style="font-size: 13px; line-height: 1.5; color: #1f2937; max-height: 300px; overflow-y: auto;">
                        ${enhancedMessage.replace(/\n/g, '<br>')}
                    </div>
                </div>

                <div style="display: flex; gap: 8px;">
                    <button onclick="applyEnhancedMessage(\`${enhancedMessage.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)"
                            style="padding: 8px 16px; background: #16a34a; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500;">
                        Apply Changes
                    </button>
                    <button onclick="rejectEnhancement()"
                            style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500;">
                        Keep Original
                    </button>
                </div>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function applyEnhancedMessage(enhancedMessage) {
            const messageBody = document.getElementById('messageBody');
            // Sanitize enhanced message before applying
            const sanitizedMessage = sanitizeHTML(enhancedMessage.replace(/\n/g, '<br>'));
            messageBody.innerHTML = sanitizedMessage;
            updateHiddenTextarea();
            showAlert('Enhanced message applied successfully!', 'success');
            closeSmartMessage();
        }

        function rejectEnhancement() {
            showAlert('Enhancement rejected. Original message kept.', 'info');
        }

        function getAIResponseWithPreview(userMessage) {
            const contact = selectedContactIndex !== -1 ? contacts[selectedContactIndex] : null;
            const currentMessage = document.getElementById('messageBody').textContent || '';

            // Generate enhanced message based on request
            const lowerMessage = userMessage.toLowerCase();
            let enhancedMessage = currentMessage;
            let explanation = '';

            if (lowerMessage.includes('professional') || lowerMessage.includes('formal')) {
                explanation = "I've made your message more professional by adding formal language and business etiquette.";
                enhancedMessage = generateProfessionalVersion(currentMessage, contact);
            } else if (lowerMessage.includes('compelling') || lowerMessage.includes('persuasive')) {
                explanation = "I've made your message more compelling by adding urgency and value propositions.";
                enhancedMessage = generateCompellingVersion(currentMessage, contact);
            } else if (lowerMessage.includes('concise') || lowerMessage.includes('shorter')) {
                explanation = "I've made your message more concise while keeping the key points.";
                enhancedMessage = generateConciseVersion(currentMessage, contact);
            } else if (lowerMessage.includes('personal') || lowerMessage.includes('friendly')) {
                explanation = "I've made your message more personal and friendly while maintaining professionalism.";
                enhancedMessage = generatePersonalVersion(currentMessage, contact);
            } else {
                explanation = "I've enhanced your message with better structure and professional language.";
                enhancedMessage = generateGeneralEnhancement(currentMessage, contact);
            }

            return {
                explanation: explanation,
                enhancedMessage: enhancedMessage
            };
        }

        function generateProfessionalVersion(message, contact) {
            if (!contact) return message;

            return `Dear ${contact.contactName},

I hope this message finds you well. I am writing to introduce Intex Technologies and explore potential partnership opportunities with ${contact.firm}.

Since our establishment in 1996, Intex Technologies has maintained a leadership position in the consumer electronics and technology sectors. We believe that ${contact.firm}, with its established market presence in ${contact.country}, would represent an ideal strategic partner for expanding our operations.

Our comprehensive product portfolio includes:
‚Ä¢ Professional IT peripherals and computer accessories
‚Ä¢ Advanced home appliances and climate solutions
‚Ä¢ Premium mobile accessories and charging solutions
‚Ä¢ High-quality audio systems and entertainment products

We are currently seeking qualified distribution partners in ${contact.country} who share our commitment to delivering exceptional products and customer service.

Our partnership program offers:
‚úì Competitive wholesale pricing with attractive margin structures
‚úì Comprehensive marketing support and co-branding opportunities
‚úì Technical training programs and ongoing product support
‚úì Flexible payment terms and credit facilities
‚úì Exclusive territorial rights (subject to mutual agreement)

I would welcome the opportunity to discuss how we might collaborate to bring Intex Technologies' innovative solutions to the ${contact.country} market through ${contact.firm}.

Thank you for your time and consideration. I look forward to your response.

Best regards,

Vishwas Agarwal
Business Development Manager
Intex Technologies
Email: vishwas.agarwal@gmail.com`;
        }

        function generateCompellingVersion(message, contact) {
            if (!contact) return message;

            return `üî• EXCLUSIVE PARTNERSHIP OPPORTUNITY - Limited Time!

Dear ${contact.contactName},

What if I told you that ${contact.firm} could increase revenue by 30-40% in the next 12 months with the RIGHT technology partner?

Intex Technologies (Est. 1996) is offering ${contact.firm} an EXCLUSIVE opportunity to become our primary distributor in ${contact.country}.

‚ö° HERE'S WHAT MAKES THIS URGENT:
‚Üí We're only selecting ONE partner per region
‚Üí The ${contact.country} market is experiencing 25% growth in tech products
‚Üí Our current partners report average 35% profit margins
‚Üí First-mover advantage in your market is CRITICAL

üéØ WHAT YOU GET IMMEDIATELY:
‚úÖ Instant access to 500+ high-demand products
‚úÖ Marketing budget of $10,000 for launch campaigns
‚úÖ 60-day exclusive territory protection
‚úÖ Direct factory pricing (no middleman markup)
‚úÖ Same-day technical support guarantee

üí∞ REAL NUMBERS FROM OUR PARTNERS:
‚Ä¢ TechMart (UAE): $2.3M revenue in first year
‚Ä¢ ElectroWorld (Malaysia): 400% growth in 18 months
‚Ä¢ Digital Plus (Thailand): Became market leader in 2 years

‚è∞ TIME-SENSITIVE: This offer expires in 7 days. After that, we'll approach your competitors.

The question isn't whether you can afford this opportunity...
The question is: Can ${contact.firm} afford to MISS it?

Ready to dominate the ${contact.country} tech market?

Call me NOW: +91-XXXXXXXXXX

Vishwas Agarwal
Business Development Manager
Intex Technologies

P.S. I have authorization to offer a 15% first-order discount, but only if you respond within 48 hours.`;
        }

        function generateConciseVersion(message, contact) {
            if (!contact) return message;

            return `Hi ${contact.contactName},

Intex Technologies (1996-present) seeks distribution partner in ${contact.country}.

Our Products: IT peripherals, home appliances, mobile accessories, audio systems.

Partnership Benefits:
‚Ä¢ Competitive pricing + attractive margins
‚Ä¢ Marketing support + training
‚Ä¢ Flexible payment terms
‚Ä¢ Exclusive territory rights

Interested in discussing how ${contact.firm} can benefit from this partnership?

Best regards,
Vishwas Agarwal
Business Development Manager
Intex Technologies
vishwas.agarwal@gmail.com`;
        }

        function generatePersonalVersion(message, contact) {
            if (!contact) return message;

            return `Hello ${contact.contactName}!

I hope you're having a great day. I came across ${contact.firm} and was really impressed by what you've built in ${contact.country}.

I'm Vishwas from Intex Technologies, and I think there might be a fantastic opportunity for us to work together. We've been in the tech business since 1996, and I genuinely believe ${contact.firm} would be perfect for what we have in mind.

Here's what caught my attention about your company - you clearly understand your market in ${contact.country}, and that's exactly the kind of local expertise we value in a partner.

What we bring to the table:
‚Ä¢ A diverse range of products (IT gear, home appliances, mobile accessories, audio equipment)
‚Ä¢ Really competitive pricing that lets our partners succeed
‚Ä¢ Hands-on support (we're not the "sell and disappear" type!)
‚Ä¢ Marketing help that actually works
‚Ä¢ Payment terms designed for real businesses

I'd love to have a friendly chat about how we could help ${contact.firm} grow even more. No pressure, no pushy sales tactics - just two business people exploring possibilities.

Would you be open to a quick call next week? I think you'll find our partnership model refreshingly straightforward.

Looking forward to potentially working together!

Warm regards,
Vishwas Agarwal
Business Development Manager
Intex Technologies
vishwas.agarwal@gmail.com

P.S. - I'm happy to send over some references from our other partners if that would be helpful.`;
        }

        function generateGeneralEnhancement(message, contact) {
            if (!contact) return message;

            return `Dear ${contact.contactName},

I trust this message finds you well. I am reaching out regarding a strategic partnership opportunity between Intex Technologies and ${contact.firm}.

Intex Technologies, established in 1996, is a leading innovator in consumer electronics and technology solutions. We have identified ${contact.firm} as a potential strategic partner due to your strong market position in ${contact.country}.

Our Product Excellence:
‚Ä¢ Premium IT peripherals and computer accessories
‚Ä¢ Innovative home appliances and climate control solutions
‚Ä¢ Cutting-edge mobile accessories and power solutions
‚Ä¢ Superior audio systems and entertainment technology

Partnership Value Proposition:
‚úì Competitive pricing with substantial profit margins
‚úì Comprehensive marketing and promotional support
‚úì Technical training and ongoing partnership support
‚úì Flexible financial terms and credit arrangements
‚úì Market exclusivity opportunities

We believe this partnership would create significant value for both organizations and establish a strong foundation for long-term success in the ${contact.country} market.

I would appreciate the opportunity to discuss this proposal in detail at your convenience.

Thank you for your consideration.

Professional regards,

Vishwas Agarwal
Business Development Manager
Intex Technologies
Email: vishwas.agarwal@gmail.com
Phone: +91-XXXXXXXXXX`;
        }

        function getAIResponse(userMessage) {
            const contact = selectedContactIndex !== -1 ? contacts[selectedContactIndex] : null;
            const currentMessage = document.getElementById('messageBody').innerHTML || document.getElementById('messageBody').textContent;

            // Simulate AI responses based on keywords and context
            const responses = {
                professional: generateProfessionalResponse(contact, currentMessage),
                compelling: generateCompellingResponse(contact, currentMessage),
                concise: generateConciseResponse(contact, currentMessage),
                industry: generateIndustryResponse(contact, currentMessage),
                grammar: generateGrammarResponse(currentMessage),
                general: generateGeneralResponse(userMessage, contact, currentMessage)
            };

            // Determine response type based on user message
            const messageType = determineMessageType(userMessage);
            return responses[messageType] || responses.general;
        }

        function determineMessageType(message) {
            const msg = message.toLowerCase();
            if (msg.includes('professional') || msg.includes('formal')) return 'professional';
            if (msg.includes('compelling') || msg.includes('persuasive') || msg.includes('convince')) return 'compelling';
            if (msg.includes('shorter') || msg.includes('concise') || msg.includes('brief')) return 'concise';
            if (msg.includes('industry') || msg.includes('specific') || msg.includes('technical')) return 'industry';
            if (msg.includes('grammar') || msg.includes('correct') || msg.includes('fix')) return 'grammar';
            return 'general';
        }

        function generateProfessionalResponse(contact, currentMessage) {
            if (!contact) return "I'd be happy to make your message more professional. Please select a contact first so I can provide personalized suggestions.";

            enhancedMessage = `
Dear ${contact.contactName},

I hope this message finds you well. I am writing to introduce Intex Technologies and explore potential partnership opportunities with ${contact.firm}.

As a leading technology company with 29 years of industry experience, Intex Technologies has established itself as a trusted partner for businesses seeking innovative consumer electronics solutions. We believe that ${contact.firm}'s reputation and market presence in ${contact.country} aligns perfectly with our expansion goals.

Our comprehensive product portfolio includes:
‚Ä¢ Advanced IT peripherals and computing accessories
‚Ä¢ Smart home appliances and IoT solutions
‚Ä¢ Mobile technology and charging solutions
‚Ä¢ Professional audio and communication systems

We would value the opportunity to discuss how our strategic partnership could drive mutual growth and deliver exceptional value to customers in ${contact.country}.

I would be delighted to schedule a conversation at your convenience to explore this opportunity further.

Thank you for your time and consideration.

Best regards,

Vishwas Agarwal
Business Development Manager
Intex Technologies
vishwas.agarwal@gmail.com
            `;

            document.getElementById('applyMessageBtn').disabled = false;
            return "I've created a more professional version of your message with formal language, structured content, and proper business etiquette. The message now includes a clear value proposition and professional closing. Would you like me to apply this enhanced version?";
        }

        function generateCompellingResponse(contact, currentMessage) {
            if (!contact) return "I'd be happy to make your message more compelling. Please select a contact first for personalized suggestions.";

            enhancedMessage = `
Dear ${contact.contactName},

üöÄ **Exclusive Partnership Opportunity** - Limited Time Offer for ${contact.firm}

Imagine increasing your product portfolio by 300% while capturing the rapidly growing consumer electronics market in ${contact.country}. That's exactly what our strategic partners have achieved with Intex Technologies.

**Here's what makes this opportunity irresistible:**

‚úÖ **Immediate Market Advantage**: Get exclusive access to 29 years of proven technology innovation
‚úÖ **Profit Acceleration**: Our partners typically see 40-60% profit margins on our product lines
‚úÖ **Zero Risk Entry**: Comprehensive support, training, and marketing assistance included
‚úÖ **Growing Demand**: Consumer electronics market in ${contact.country} is projected to grow 25% annually

**Your Success is Guaranteed Because:**
‚Ä¢ We've successfully partnered with 500+ companies globally
‚Ä¢ Our products have 95% customer satisfaction rates
‚Ä¢ We provide complete end-to-end support from inventory to after-sales

**Limited Time**: We're only selecting 3 partners in ${contact.country} this quarter, and ${contact.firm} is our #1 choice.

Ready to transform your business? Let's schedule a 15-minute call to discuss your guaranteed success plan.

Best regards,
Vishwas Agarwal
üìû Schedule Your Success Call: [Contact Link]
            `;

            document.getElementById('applyMessageBtn').disabled = false;
            return "I've transformed your message into a highly compelling proposition with urgency, specific benefits, social proof, and a clear call-to-action. This version focuses on the value and opportunity for the recipient. Ready to apply this enhanced version?";
        }

        function generateConciseResponse(contact, currentMessage) {
            if (!contact) return "I'd be happy to make your message more concise. Please select a contact first.";

            enhancedMessage = `
Hi ${contact.contactName},

Intex Technologies (29 years, global leader) seeks partnership with ${contact.firm} for ${contact.country} market expansion.

**Our Offer:**
‚Ä¢ Consumer electronics & IT peripherals
‚Ä¢ Competitive margins + full support
‚Ä¢ Proven success in 40+ countries

**Why ${contact.firm}:**
Perfect market fit + established presence in ${contact.country}

**Next Step:**
15-minute call to discuss partnership details?

Best regards,
Vishwas Agarwal
Intex Technologies
vishwas.agarwal@gmail.com
            `;

            document.getElementById('applyMessageBtn').disabled = false;
            return "I've condensed your message to the essential points while maintaining all key information. This concise version gets straight to the point and respects the recipient's time. Would you like to apply this version?";
        }

        function generateIndustryResponse(contact, currentMessage) {
            if (!contact) return "I'd be happy to add industry-specific insights. Please select a contact first.";

            const industryInsights = getIndustryInsights(contact.category, contact.country);

            enhancedMessage = `
Dear ${contact.contactName},

The ${contact.category} sector in ${contact.country} is experiencing unprecedented growth, creating significant opportunities for forward-thinking companies like ${contact.firm}.

**Market Intelligence:**
${industryInsights}

**Strategic Partnership Opportunity:**
Intex Technologies, with 29 years of deep industry expertise, offers ${contact.firm} a competitive advantage through:

‚Ä¢ **Technology Leadership**: Industry 4.0 solutions and IoT integration
‚Ä¢ **Market Penetration**: Proven strategies that have driven 40% market share growth for partners
‚Ä¢ **Regulatory Compliance**: Full adherence to ${contact.country} standards and certifications
‚Ä¢ **Supply Chain Excellence**: Resilient global supply network with local support

**Specific Value for ${contact.firm}:**
Based on your market position in ${contact.country}, we project 25-35% revenue growth within the first 12 months through our partnership.

I'd welcome the opportunity to present our comprehensive market analysis and partnership framework tailored specifically for ${contact.firm}.

Best regards,
Vishwas Agarwal
Industry Partnership Specialist
Intex Technologies
            `;

            document.getElementById('applyMessageBtn').disabled = false;
            return `I've enhanced your message with industry-specific insights for the ${contact.category} sector in ${contact.country}. This version demonstrates market knowledge and positions the partnership as strategically beneficial. Ready to apply these industry insights?`;
        }

        function getIndustryInsights(category, country) {
            const insights = {
                'technology': `The technology sector in ${country} is projected to grow 22% annually, driven by digital transformation and IoT adoption.`,
                'retail': `Retail innovation in ${country} shows 35% consumer preference for smart electronic products and connected devices.`,
                'manufacturing': `Manufacturing digitization in ${country} creates 40% efficiency gains through smart technology integration.`,
                'healthcare': `Healthcare technology adoption in ${country} is accelerating, with 60% of facilities upgrading their electronic systems.`,
                'default': `The consumer electronics market in ${country} demonstrates strong growth potential with increasing demand for innovative solutions.`
            };

            return insights[category.toLowerCase()] || insights['default'];
        }

        function generateGrammarResponse(currentMessage) {
            enhancedMessage = currentMessage; // In a real implementation, this would use grammar checking
            document.getElementById('applyMessageBtn').disabled = false;
            return "I've reviewed your message for grammar and clarity improvements. The text has been optimized for better readability and professional presentation. Would you like to apply these corrections?";
        }

        function generateGeneralResponse(userMessage, contact, currentMessage) {
            const responses = [
                "I can help you enhance your message in several ways. Would you like me to make it more professional, compelling, or concise?",
                "I've analyzed your message and can suggest improvements based on the selected contact's profile. What specific aspect would you like me to focus on?",
                "I can customize your message for better engagement with the selected company. Would you like me to add industry-specific insights or improve the overall tone?",
                "I see you'd like to improve your message. I can help with tone, structure, personalization, or adding compelling elements. What's your priority?"
            ];

            return responses[Math.floor(Math.random() * responses.length)];
        }

        function quickAction(action) {
            const contact = selectedContactIndex !== -1 ? contacts[selectedContactIndex] : null;

            let response = '';
            switch (action) {
                case 'professional':
                    response = generateProfessionalResponse(contact, '');
                    break;
                case 'compelling':
                    response = generateCompellingResponse(contact, '');
                    break;
                case 'concise':
                    response = generateConciseResponse(contact, '');
                    break;
                case 'industry':
                    response = generateIndustryResponse(contact, '');
                    break;
                case 'grammar':
                    response = generateGrammarResponse('');
                    break;
            }

            addChatMessage('assistant', response);
        }

        function applySmartMessage() {
            if (enhancedMessage) {
                const messageBody = document.getElementById('messageBody');
                // Sanitize enhanced message before applying
                const sanitizedMessage = sanitizeHTML(enhancedMessage.trim());
                messageBody.innerHTML = sanitizedMessage;
                updateHiddenTextarea();
                closeSmartMessage();
                showAlert('Enhanced message applied successfully!', 'success');
            }
        }

        // Update validation function to work with contenteditable
        function validateMessage(element) {
            const content = element.innerHTML || element.textContent;
            const errorDiv = document.getElementById('messageError');

            if (!content || content.trim() === '') {
                showError(errorDiv, 'Message is required');
                element.style.borderColor = '#dc3545';
                return false;
            }

            if (content.length < 10) {
                showError(errorDiv, 'Message must be at least 10 characters long');
                element.style.borderColor = '#dc3545';
                return false;
            }

            hideError(errorDiv);
            element.style.borderColor = '#28a745';

            // Update hidden textarea
            updateHiddenTextarea();
            return true;
        }

    </script>
</body>
</html>