<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Email Sender - Data Analysis Insights v2.2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
    <meta name="cache-control" content="no-cache">
    <meta name="version" content="2.1-contact-enhancements">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #374151;
            line-height: 1.6;
        }
        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 15px;
            height: 100vh;
            max-height: 900px;
        }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
                gap: 10px;
                height: auto;
            }
            .left-panel, .right-panel {
                max-width: none;
                min-width: auto;
            }
            .center-panel {
                min-width: auto;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            .button {
                padding: 8px 12px !important;
                font-size: 12px !important;
            }
        }
        .panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        .left-panel {
            max-width: 300px;
            min-width: 250px;
        }
        .center-panel {
            min-width: 400px;
        }
        .right-panel {
            max-width: 300px;
            min-width: 250px;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .contact-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            cursor: pointer;
        }
        .contact-item:hover {
            background: #f8f9fa;
        }
        .contact-item.selected {
            background: #007bff;
            color: white;
        }
        .alert {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        textarea, input[type="text"], input[type="email"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px 0;
        }
        textarea {
            min-height: 300px;
            resize: vertical;
        }
        #messageBody {
            min-height: 500px !important;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            padding: 15px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        .status.ready {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        /* Modern Button Styles */
        .modern-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            letter-spacing: 0.025em;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        .modern-btn:hover {
            background: #3b82f6 !important;
            color: white !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        .modern-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }

        /* Formatting Toolbar Styles */
        .format-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            border: 1px solid #e5e7eb;
            background: white;
            color: #374151;
        }
        .format-btn:hover {
            background: #3b82f6 !important;
            color: white !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            border-color: #3b82f6;
        }
        .format-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }

        /* Attachment Styles */
        #attachmentContainer {
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Formatting Toolbar Animation */
        #formattingToolbar {
            animation: slideDown 0.3s ease;
        }
    </style>
</head>
<body>
    <div style="background: white; padding: 10px 20px; border-radius: 5px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <div>
            <h3 style="margin: 0; color: #007bff;">üìß Bulk Email Sender</h3>
            <small style="color: #666;">Data Analysis Insights - Professional Email Campaign Tool</small>
        </div>
        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
            <button class="button" onclick="sendEmail()" id="sendBtn" disabled style="padding: 10px 20px; font-size: 14px; font-weight: bold;" aria-label="Send Email to Selected Contact">üì§ Send Email</button>
            <button class="button" id="bulkSendBtn" disabled style="background: #6c757d; padding: 10px 20px; font-size: 14px; font-weight: bold; cursor: not-allowed;" aria-label="Bulk Email (Coming Soon)" title="Bulk email functionality coming soon">üìß Bulk Email</button>
        </div>
    </div>

    <div class="main-content">
        <!-- LEFT PANEL: Contact Management -->
        <div class="panel left-panel">
            <h2 style="font-size: 18px; margin-bottom: 15px;">üìã Contact Management</h2>

            <!-- Upload Section -->
            <div style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; background: #f8f9fa; margin-bottom: 12px;" role="region" aria-label="File Upload">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <span style="font-size: 12px; color: #666;">üìÅ Upload Contacts:</span>
                    <label for="fileUpload" class="button" style="background: #28a745; cursor: pointer; padding: 4px 8px; font-size: 10px;" aria-describedby="fileUploadDesc">
                        Choose File
                    </label>
                </div>
                <input type="file" id="fileUpload" accept=".xlsx,.xls,.csv,.pdf,.doc,.docx,.ppt,.pptx,.png,.jpg,.jpeg,.gif,.bmp,.tiff" onchange="handleAdvancedFileUpload(event)" style="display: none;" aria-label="Upload Contact File" aria-describedby="fileUploadDesc">
                <small id="fileUploadDesc" style="color: #666; font-size: 9px;">Excel/CSV/PDF/Word/PowerPoint/Image files (max 10MB)</small>
                <div id="uploadProgress" style="margin-top: 5px; display: none;">
                    <div style="background: #e9ecef; border-radius: 3px; height: 4px;">
                        <div id="progressBar" style="background: #007bff; height: 100%; border-radius: 3px; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <small id="progressText" style="font-size: 8px; color: #666;"></small>
                </div>
                <div id="uploadStats" style="margin-top: 5px; font-size: 9px; color: #007bff; display: none;" role="status" aria-live="polite"></div>
            </div>

            <!-- Contact List with Keyboard Navigation -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <h3 style="margin: 0; color: #007bff; font-size: 14px;">üìã Contact List</h3>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div id="contactCounts" style="font-size: 10px; color: #666; font-weight: bold;">
                        <span id="totalCount">0</span> |
                        <span id="sentCount" style="color: #28a745;">0‚úÖ</span> |
                        <span id="failedCount" style="color: #dc3545;">0‚ùå</span>
                    </div>
                    <button id="scrollTopBtn" class="button" onclick="scrollToTop()" style="padding: 2px 6px; font-size: 10px; display: none;">
                        ‚¨ÜÔ∏è
                    </button>
                </div>
            </div>
            <div style="margin-bottom: 8px;">
                <input type="text" id="contactSearch" placeholder="üîç Search contacts..." style="width: 100%; padding: 4px 8px; font-size: 10px; border: 1px solid #ddd; border-radius: 3px;" oninput="filterContacts()" aria-label="Search contacts">
            </div>
            <small style="color: #666; font-size: 10px; margin-bottom: 5px; display: block;">Use ‚Üë‚Üì arrows, Enter to send, Esc to clear selection</small>
            <div id="contactsList" tabindex="0" role="listbox" aria-label="Contact List" style="max-height: 350px; min-height: 200px; overflow-y: auto; border: 2px solid #e3f2fd; border-radius: 6px; padding: 6px; background: #fafafa; outline: 2px solid transparent; font-size: 11px;" onscroll="handleScroll()" onkeydown="handleKeyNavigation(event)" onfocus="this.style.outline='2px solid #007bff'" onblur="this.style.outline='2px solid transparent'">
                <div style="text-align: center; padding: 30px; color: #999; font-style: italic;">
                    <h4 style="color: #ccc; margin-bottom: 8px; font-size: 14px;">üìã No Contacts</h4>
                    <p style="font-size: 12px;">Upload spreadsheet to see contacts</p>
                </div>
            </div>
        </div>

        <!-- CENTER PANEL: Email Composer (Main) -->
        <div class="panel center-panel" style="padding: 25px;">
            <h2 style="color: #007bff; margin-bottom: 20px; text-align: center;">üì® Email Composer</h2>
            <div id="alerts"></div>

            <div style="margin-bottom: 15px;">
                <label for="fromEmail" style="font-size: 14px; font-weight: bold; color: #333; display: block; margin-bottom: 5px;">From:</label>
                <input type="email" id="fromEmail" value="info@datanalysisninsights.co.uk" placeholder="Sender email" style="font-size: 14px; padding: 10px; width: 100%; border: 1px solid #ddd; border-radius: 4px;" aria-required="true" oninput="validateEmail(this)">
                <div style="background: #e8f4fd; border: 1px solid #b3d9ff; border-radius: 4px; padding: 8px; margin-top: 5px; font-size: 12px; color: #0056b3;">
                    üìß <strong>Emails will be sent from:</strong> Intex Technologies &lt;info@datanalysisninsights.co.uk&gt;
                </div>
                <div id="fromEmailError" style="color: #dc3545; font-size: 12px; margin-top: 2px; display: none;" role="alert"></div>
            </div>

            <div style="margin-bottom: 15px;">
                <label for="toEmail" style="font-size: 14px; font-weight: bold; color: #333; display: block; margin-bottom: 5px;">To: <small style="color: #28a745;">(Use / or , for multiple emails)</small></label>
                <input type="text" id="toEmail" placeholder="Select contact or type emails separated by / or ," style="font-size: 14px; padding: 10px; width: 100%; border: 1px solid #ddd; border-radius: 4px;" aria-required="true" oninput="validateEmailList(this)" aria-describedby="toEmailDesc">
                <small id="toEmailDesc" style="color: #666; font-size: 11px;">Separate multiple emails with commas, semicolons, or forward slashes</small>
                <div id="toEmailError" style="color: #dc3545; font-size: 12px; margin-top: 2px; display: none;" role="alert"></div>
            </div>

            <div style="margin-bottom: 15px;">
                <label for="subject" style="font-size: 14px; font-weight: bold; color: #333; display: block; margin-bottom: 5px;">Subject:</label>
                <input type="text" id="subject" placeholder="Email subject" style="font-size: 14px; padding: 10px; width: 100%; border: 1px solid #ddd; border-radius: 4px;" aria-required="true" maxlength="255" oninput="validateSubject(this)">
                <div id="subjectError" style="color: #dc3545; font-size: 12px; margin-top: 2px; display: none;" role="alert"></div>
            </div>

            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <label for="messageBody" style="font-size: 14px; font-weight: bold; color: #333;">Message:</label>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <button onclick="toggleAttachments()" id="attachmentBtn" class="modern-btn" style="padding: 6px 8px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; color: #6b7280;" title="Add Attachments">
                            üìé
                        </button>
                        <button onclick="toggleFormatting()" id="formatToggle" class="button" style="padding: 3px 8px; font-size: 11px; background: #f8f9fa; color: #333; border: 1px solid #ddd;" aria-label="Toggle formatting tools">
                            üé® Format
                        </button>
                        <button onclick="toggleMessageExpand()" id="messageExpandBtn" class="button" style="padding: 3px 8px; font-size: 11px; background: #f8f9fa; color: #333; border: 1px solid #ddd;" aria-label="Expand message area">
                            üìÑ Expand
                        </button>
                    </div>
                </div>

                <!-- Attachment Section (moved to top) -->
                <div id="attachmentContainer" style="display: none; margin-bottom: 10px; padding: 12px; background: #f8f9fa; border: 1px solid #e5e7eb; border-radius: 6px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <input type="file" id="attachmentFiles" multiple accept=".pdf,.doc,.docx,.txt,.xlsx,.xls,.ppt,.pptx,.jpg,.jpeg,.png,.gif,.zip,.rar" style="display: none;" onchange="handleAttachmentUpload(event)">
                        <button onclick="document.getElementById('attachmentFiles').click()" class="modern-btn" style="padding: 6px 12px; font-size: 11px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            üìé Choose Files
                        </button>
                        <small style="color: #6b7280; font-size: 11px;">Max 5 files, 25MB total</small>
                    </div>
                    <div id="attachmentList" style="min-height: 40px;">
                        <div id="attachmentEmpty" style="text-align: center; color: #9ca3af; font-style: italic; padding: 15px; font-size: 11px;">
                            No attachments selected
                        </div>
                    </div>
                </div>

                <!-- Formatting Toolbar -->
                <div id="formattingToolbar" style="display: none; padding: 12px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 1px solid #dee2e6; border-bottom: none; border-radius: 6px 6px 0 0; margin-bottom: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="display: flex; flex-wrap: wrap; gap: 6px; align-items: center;">
                        <!-- Text Formatting -->
                        <button onclick="formatText('bold')" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-weight: 600;" title="Bold">
                            <strong>B</strong>
                        </button>
                        <button onclick="formatText('italic')" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;" title="Italic">
                            <em>I</em>
                        </button>
                        <button onclick="formatText('underline')" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;" title="Underline">
                            <u>U</u>
                        </button>

                        <div style="width: 1px; height: 20px; background: #d1d5db; margin: 0 4px;"></div>

                        <!-- Color Highlighting -->
                        <button onclick="showColorPicker()" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; position: relative;" title="Text Color">
                            üé® Color
                        </button>
                        <div id="colorPicker" style="display: none; position: absolute; z-index: 1000; background: white; border: 1px solid #d1d5db; border-radius: 6px; padding: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-top: 5px;">
                            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px;">
                                <div onclick="applyColor('#000000')" style="width: 20px; height: 20px; background: #000000; border-radius: 3px; cursor: pointer;" title="Black"></div>
                                <div onclick="applyColor('#dc2626')" style="width: 20px; height: 20px; background: #dc2626; border-radius: 3px; cursor: pointer;" title="Red"></div>
                                <div onclick="applyColor('#ea580c')" style="width: 20px; height: 20px; background: #ea580c; border-radius: 3px; cursor: pointer;" title="Orange"></div>
                                <div onclick="applyColor('#ca8a04')" style="width: 20px; height: 20px; background: #ca8a04; border-radius: 3px; cursor: pointer;" title="Yellow"></div>
                                <div onclick="applyColor('#16a34a')" style="width: 20px; height: 20px; background: #16a34a; border-radius: 3px; cursor: pointer;" title="Green"></div>
                                <div onclick="applyColor('#2563eb')" style="width: 20px; height: 20px; background: #2563eb; border-radius: 3px; cursor: pointer;" title="Blue"></div>
                                <div onclick="applyColor('#7c3aed')" style="width: 20px; height: 20px; background: #7c3aed; border-radius: 3px; cursor: pointer;" title="Purple"></div>
                                <div onclick="applyColor('#be185d')" style="width: 20px; height: 20px; background: #be185d; border-radius: 3px; cursor: pointer;" title="Pink"></div>
                                <div onclick="applyColor('#374151')" style="width: 20px; height: 20px; background: #374151; border-radius: 3px; cursor: pointer;" title="Gray"></div>
                                <div onclick="applyColor('#0891b2')" style="width: 20px; height: 20px; background: #0891b2; border-radius: 3px; cursor: pointer;" title="Cyan"></div>
                                <div onclick="applyColor('#059669')" style="width: 20px; height: 20px; background: #059669; border-radius: 3px; cursor: pointer;" title="Emerald"></div>
                                <div onclick="applyColor('#7c2d12')" style="width: 20px; height: 20px; background: #7c2d12; border-radius: 3px; cursor: pointer;" title="Brown"></div>
                            </div>
                        </div>

                        <div style="width: 1px; height: 20px; background: #d1d5db; margin: 0 4px;"></div>

                        <!-- Lists and Indentation -->
                        <button onclick="formatText('bullet')" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;" title="Bullet List">
                            ‚Ä¢ List
                        </button>
                        <button onclick="formatText('number')" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;" title="Numbered List">
                            1. List
                        </button>
                        <button onclick="formatText('indent')" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;" title="Indent">
                            ‚á• Indent
                        </button>

                        <div style="width: 1px; height: 20px; background: #d1d5db; margin: 0 4px;"></div>

                        <!-- Link -->
                        <button onclick="formatText('link')" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;" title="Insert Link">
                            üîó Link
                        </button>

                        <div style="width: 1px; height: 20px; background: #d1d5db; margin: 0 4px;"></div>

                        <!-- Undo and Clear -->
                        <button onclick="undoFormat()" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;" title="Undo">
                            ‚Ü∂ Undo
                        </button>
                        <button onclick="clearFormatting()" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;" title="Clear Formatting">
                            üßπ Clear
                        </button>

                        <div style="width: 1px; height: 20px; background: #d1d5db; margin: 0 4px;"></div>

                        <!-- Personalization -->
                        <button onclick="insertPersonalization()" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;" title="Insert Personalization">
                            üë§ Variables
                        </button>
                        <button onclick="insertBusinessOpportunity()" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;" title="Insert Business Opportunity">
                            üíº Opportunities
                        </button>
                    </div>
                </div>

                <textarea id="messageBody" placeholder="Email content" style="min-height: 400px; font-size: 12px; line-height: 1.6; padding: 15px; width: 100%; border: 1px solid #ddd; border-radius: 4px; resize: vertical; transition: min-height 0.3s ease;" aria-required="true" oninput="validateMessage(this)"></textarea>
                <div id="messageError" style="color: #dc3545; font-size: 12px; margin-top: 2px; display: none;" role="alert"></div>
                <small style="color: #666; font-size: 11px;">Use {contactName}, {firm}, {country}, {email} for personalization</small>
            </div>


            <div style="text-align: center; color: #666; font-style: italic; margin-top: 20px;">
                <p>üì§ Use the Send Email or Bulk Email buttons in the top-right corner</p>
                <small>Select a contact and compose your message above</small>
            </div>
        </div>

        <!-- RIGHT PANEL: Templates & Status -->
        <div class="panel right-panel" style="padding: 15px;">
            <!-- Email Template Section -->
            <div style="border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #f8f9fa; border-bottom: 1px solid #ddd;">
                    <h3 style="margin: 0; color: #007bff; font-size: 14px;">üìß Template</h3>
                    <button onclick="toggleTemplate()" id="templateToggle" class="button" style="padding: 3px 6px; font-size: 10px;">
                        üìù Expand
                    </button>
                </div>
                <div id="templateContainer" style="display: none; padding: 8px;">
                    <textarea id="emailTemplate" placeholder="Edit your email template..." style="min-height: 200px; width: 100%; border: 1px solid #ddd; border-radius: 4px; font-size: 10px;">From: vishwas.agarwal@gmail.com
From-Name: Intex Technologies
To: {email}
Subject: Business Partnership Opportunity - Intex Technologies in {country}

Dear Valued Prospective Partner,

We are pleased to introduce Intex Technologies, a globally recognized brand with a rich legacy spanning 29 years in the consumer electronics and technology sectors.

Since our inception in 1996, we have been at the forefront of innovation, designing and manufacturing cutting-edge products that enhance the daily lives of millions of consumers worldwide. Our commitment to excellence has made us a trusted name in markets across the globe.

Our Product Portfolio:
‚Ä¢ IT Peripherals: Speakers, keyboards, mice, webcams, and computer accessories
‚Ä¢ Home Appliances: Air coolers, room heaters, water purifiers, and kitchen appliances
‚Ä¢ Mobile Accessories: Power banks, chargers, cables, and smartphone accessories
‚Ä¢ Audio Solutions: Wireless speakers, headphones, and sound systems

We are actively seeking distribution partners in {country} who share our vision of delivering high-quality, innovative products to consumers. We believe {firm}, with its established market presence and commitment to excellence, would be an ideal partner for expanding our reach in the {country} market.

Specific Opportunities for {firm} in {country}:
{businessOpportunities}

What We Offer Our Partners:
‚úì Competitive pricing with attractive profit margins
‚úì Comprehensive marketing support and co-branding opportunities
‚úì Technical training and ongoing product support
‚úì Flexible payment terms and credit facilities
‚úì Exclusive territory rights (subject to discussion)
‚úì Access to our complete product catalog and new launches

Why Partner with Intex Technologies:
- 29+ years of industry experience and innovation
- Global presence with operations in 40+ countries
- ISO certified manufacturing facilities
- Strong R&D capabilities with continuous product development
- Proven track record of successful partnerships worldwide

We would welcome the opportunity to discuss how we can work together to bring Intex Technologies' innovative products to the {country} market through {firm}. Our team is available to provide detailed product catalogs, pricing structures, and partnership terms that align with your business objectives.

Please feel free to contact us at your earliest convenience to explore this exciting business opportunity. We are confident that a partnership between Intex Technologies and {firm} will be mutually beneficial and contribute to significant growth in the {country} market.

Thank you for your time and consideration. We look forward to hearing from you soon and to the possibility of establishing a long-term, successful business relationship.

Best regards,

Vishwas Agarwal
Business Development Manager
Intex Technologies
Email: vishwas.agarwal@gmail.com
Phone: +91-11-4716-1111
Website: www.intex.in

P.S. We are also interested in exploring private label manufacturing opportunities and joint ventures for established brands in the {country} market. Please let us know if {firm} has any interest in such collaborations.</textarea>
                </div>
            </div>

            <!-- Email Analytics Dashboard -->
            <div style="border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #f8f9fa; border-bottom: 1px solid #ddd;">
                    <h3 style="margin: 0; color: #007bff; font-size: 14px;">üìä Email Analytics</h3>
                    <button onclick="toggleAnalytics()" id="analyticsToggle" class="modern-btn" style="padding: 3px 6px; font-size: 10px; background: white; border: 1px solid #d1d5db; border-radius: 4px;">
                        üìà Expand
                    </button>
                </div>
                <div id="analyticsContainer" style="display: none; padding: 12px;">
                    <!-- Quick Stats -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                        <div style="background: #ecfdf5; border: 1px solid #d1fae5; border-radius: 6px; padding: 8px; text-align: center;">
                            <div style="font-size: 18px; font-weight: 600; color: #065f46;" id="sentCount">0</div>
                            <div style="font-size: 10px; color: #374151;">Sent</div>
                        </div>
                        <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; padding: 8px; text-align: center;">
                            <div style="font-size: 18px; font-weight: 600; color: #dc2626;" id="failedCount">0</div>
                            <div style="font-size: 10px; color: #374151;">Failed</div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div style="display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap;">
                        <select id="countryFilter" onchange="filterEmailHistory()" style="font-size: 10px; padding: 4px; border: 1px solid #d1d5db; border-radius: 4px; background: white;">
                            <option value="">All Countries</option>
                        </select>
                        <select id="dateFilter" onchange="filterEmailHistory()" style="font-size: 10px; padding: 4px; border: 1px solid #d1d5db; border-radius: 4px; background: white;">
                            <option value="">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                        </select>
                    </div>

                    <!-- Top Countries -->
                    <div style="margin-bottom: 12px;">
                        <h4 style="margin: 0 0 6px 0; font-size: 11px; color: #374151;">Top Countries</h4>
                        <div id="topCountries" style="font-size: 10px; color: #6b7280;">
                            No data yet
                        </div>
                    </div>
                </div>
            </div>

            <!-- Email History Log -->
            <div style="border: 1px solid #ddd; border-radius: 6px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #f8f9fa; border-bottom: 1px solid #ddd;">
                    <h3 style="margin: 0; color: #007bff; font-size: 14px;">üìß Email History</h3>
                    <button onclick="clearEmailHistory()" class="modern-btn" style="padding: 3px 6px; font-size: 10px; background: white; border: 1px solid #d1d5db; border-radius: 4px; color: #dc2626;">
                        üóëÔ∏è Clear
                    </button>
                </div>
                <div id="emailHistory" style="max-height: 250px; overflow-y: auto; padding: 8px;">
                    <div style="text-align: center; color: #999; padding: 15px;">
                        <p style="font-size: 12px;">üìß Email history will appear here</p>
                        <small style="font-size: 10px;">Send emails to see status tracking</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom-right Response Email Management -->
    <div id="responseEmailManager" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
        <button onclick="toggleResponseManager()" id="responseBtn" class="modern-btn" style="width: 50px; height: 50px; border-radius: 50%; background: #3b82f6; color: white; border: none; font-size: 20px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); cursor: pointer;" title="Response Email Manager">
            üí¨
        </button>

        <div id="responsePanel" style="display: none; position: absolute; bottom: 60px; right: 0; width: 300px; background: white; border: 1px solid #d1d5db; border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); overflow: hidden;">
            <div style="padding: 12px; background: #f8f9fa; border-bottom: 1px solid #e5e7eb;">
                <h4 style="margin: 0; font-size: 14px; color: #374151;">üì¨ Response Email Manager</h4>
            </div>

            <div style="padding: 12px; max-height: 250px; overflow-y: auto;">
                <div style="margin-bottom: 12px;">
                    <button onclick="checkResponseEmails()" class="modern-btn" style="width: 100%; padding: 8px; font-size: 12px; background: #3b82f6; color: white; border: none; border-radius: 6px;">
                        üîÑ Check for Responses
                    </button>
                </div>

                <div id="responseList" style="font-size: 12px;">
                    <div style="text-align: center; color: #6b7280; padding: 20px;">
                        <div style="font-size: 24px; margin-bottom: 8px;">üì≠</div>
                        <div>No responses yet</div>
                        <small style="font-size: 10px;">Response emails will appear here</small>
                    </div>
                </div>

                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                    <label style="font-size: 11px; color: #6b7280; display: block; margin-bottom: 4px;">Auto-redirect responses to:</label>
                    <div style="display: flex; gap: 6px;">
                        <input type="email" id="redirectEmail" value="vishwas.agarwal@gmail.com" style="flex: 1; font-size: 11px; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;" readonly>
                        <button onclick="toggleAutoRedirect()" id="redirectBtn" class="modern-btn" style="padding: 6px 8px; font-size: 10px; background: #10b981; color: white; border: none; border-radius: 4px;">
                            ‚úì ON
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables with security and performance improvements
        let contacts = [];
        let filteredContacts = []; // For search functionality
        let selectedContactIndex = -1;
        let emailStatusCounts = {
            total: 0,
            sent: 0,
            failed: 0,
            pending: 0
        };
        let emailHistory = []; // Track email sending history
        let uploadStats = { total: 0, read: 0, unread: 0 }; // Track upload statistics
        let currentUploadProgress = null; // Track upload progress
        let uploadedSpreadsheetData = []; // Track original spreadsheet data with status
        let messageExpanded = false; // Track message area expansion

        // Security: Email validation regex
        const EMAIL_REGEX = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;

        // Performance: Constants
        const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
        const MAX_CONTACTS = 10000; // Limit contact count
        const CHUNK_SIZE = 100; // Process in chunks

        // Security Functions
        function sanitizeHTML(str) {
            if (typeof DOMPurify !== 'undefined') {
                return DOMPurify.sanitize(str);
            }
            // Fallback if DOMPurify isn't loaded
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function sanitizeInput(input) {
            return input.replace(/[<>\"'&]/g, function(match) {
                const escape = {
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#x27;',
                    '&': '&amp;'
                };
                return escape[match];
            });
        }

        function validateEmail(input) {
            const email = input.value.trim();
            const errorDiv = document.getElementById(input.id + 'Error');

            if (!email) {
                hideError(errorDiv);
                input.style.borderColor = '#ddd';
                return false;
            }

            if (!EMAIL_REGEX.test(email)) {
                showError(errorDiv, 'Please enter a valid email address');
                input.style.borderColor = '#dc3545';
                return false;
            }

            hideError(errorDiv);
            input.style.borderColor = '#28a745';
            return true;
        }

        function validateEmailList(input) {
            const emailList = input.value.trim();
            const errorDiv = document.getElementById('toEmailError');

            if (!emailList) {
                hideError(errorDiv);
                input.style.borderColor = '#ddd';
                return false;
            }

            const emails = parseMultipleEmails(emailList);
            const invalidEmails = emails.filter(email => !EMAIL_REGEX.test(email));

            if (invalidEmails.length > 0) {
                showError(errorDiv, `Invalid email addresses: ${invalidEmails.join(', ')}`);
                input.style.borderColor = '#dc3545';
                return false;
            }

            if (emails.length === 0) {
                showError(errorDiv, 'Please enter at least one valid email address');
                input.style.borderColor = '#dc3545';
                return false;
            }

            hideError(errorDiv);
            input.style.borderColor = '#28a745';
            return true;
        }

        function validateSubject(input) {
            const subject = input.value.trim();
            const errorDiv = document.getElementById('subjectError');

            if (!subject) {
                showError(errorDiv, 'Subject is required');
                input.style.borderColor = '#dc3545';
                return false;
            }

            if (subject.length > 255) {
                showError(errorDiv, 'Subject too long (max 255 characters)');
                input.style.borderColor = '#dc3545';
                return false;
            }

            // Check for potential email header injection
            if (/[\r\n]/.test(subject)) {
                showError(errorDiv, 'Subject cannot contain line breaks');
                input.style.borderColor = '#dc3545';
                return false;
            }

            hideError(errorDiv);
            input.style.borderColor = '#28a745';
            return true;
        }

        function validateMessage(input) {
            const message = input.value.trim();
            const errorDiv = document.getElementById('messageError');

            if (!message) {
                showError(errorDiv, 'Message is required');
                input.style.borderColor = '#dc3545';
                return false;
            }

            if (message.length > 50000) {
                showError(errorDiv, 'Message too long (max 50,000 characters)');
                input.style.borderColor = '#dc3545';
                return false;
            }

            hideError(errorDiv);
            input.style.borderColor = '#28a745';
            return true;
        }

        function showError(errorDiv, message) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.setAttribute('aria-live', 'polite');
        }

        function hideError(errorDiv) {
            errorDiv.style.display = 'none';
            errorDiv.textContent = '';
        }

        // Spreadsheet Status Tracking
        function updateSpreadsheetStatus(originalRowIndex, status, contactData) {
            if (uploadedSpreadsheetData[originalRowIndex]) {
                uploadedSpreadsheetData[originalRowIndex].status = status;
                uploadedSpreadsheetData[originalRowIndex].processedContact = contactData;
            }
        }

        function generateStatusReport() {
            const totalRows = uploadedSpreadsheetData.length;
            const successfulRows = uploadedSpreadsheetData.filter(row => row.status === 'uploaded').length;
            const failedRows = totalRows - successfulRows;

            return {
                total: totalRows,
                successful: successfulRows,
                failed: failedRows,
                data: uploadedSpreadsheetData
            };
        }

        function showUploadStatusReport(statusReport) {
            const uploadStatsDiv = document.getElementById('uploadStats');
            if (!uploadStatsDiv) return;

            if (statusReport.total === 0) {
                uploadStatsDiv.style.display = 'none';
                return;
            }

            uploadStatsDiv.style.display = 'block';
            uploadStatsDiv.innerHTML = `
                üìä <strong>Upload Status:</strong>
                <span style="color: #28a745;">${statusReport.successful} uploaded</span> |
                <span style="color: #dc3545;">${statusReport.failed} failed</span> |
                Total: ${statusReport.total} rows
                ${statusReport.failed > 0 ? `<br><small style="color: #dc3545;">Failed rows: Missing emails or invalid data</small>` : ''}
            `;
        }

        // Search and Filter Functions
        function filterContacts() {
            const searchTerm = document.getElementById('contactSearch').value.toLowerCase().trim();

            if (!searchTerm) {
                filteredContacts = [...contacts];
            } else {
                filteredContacts = contacts.filter(contact =>
                    contact.firm.toLowerCase().includes(searchTerm) ||
                    contact.contactName.toLowerCase().includes(searchTerm) ||
                    contact.email.toLowerCase().includes(searchTerm) ||
                    contact.country.toLowerCase().includes(searchTerm) ||
                    (contact.category && contact.category.toLowerCase().includes(searchTerm))
                );
            }

            renderContacts();
            selectedContactIndex = -1; // Reset selection
        }

        // Performance: Progress tracking
        function showProgress(current, total, text) {
            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');

            if (progressDiv && progressBar && progressText) {
                progressDiv.style.display = 'block';
                const percentage = Math.round((current / total) * 100);
                progressBar.style.width = percentage + '%';
                progressText.textContent = text || `${current}/${total} (${percentage}%)`;
            }
        }

        function hideProgress() {
            const progressDiv = document.getElementById('uploadProgress');
            if (progressDiv) {
                progressDiv.style.display = 'none';
            }
        }

        // File Upload Security
        function validateFileUpload(file) {
            // File size check
            if (file.size > MAX_FILE_SIZE) {
                showAlert(`File too large! Maximum size is ${Math.round(MAX_FILE_SIZE / 1024 / 1024)}MB. Your file is ${Math.round(file.size / 1024 / 1024)}MB.`, 'error');
                return false;
            }

            // File type check
            const allowedExtensions = ['.csv', '.xlsx', '.xls', '.pdf', '.doc', '.docx', '.ppt', '.pptx', '.png', '.jpg', '.jpeg', '.gif', '.bmp', '.tiff'];
            const fileName = file.name.toLowerCase();
            const isValidExtension = allowedExtensions.some(ext => fileName.endsWith(ext));

            if (!isValidExtension) {
                showAlert('Invalid file type! Please upload a supported file: CSV, Excel, PDF, Word, PowerPoint, or Image.', 'error');
                return false;
            }

            // File name sanitization check
            const suspiciousChars = /[<>:"\\|?*\x00-\x1f]/;
            if (suspiciousChars.test(file.name)) {
                showAlert('Invalid file name! Please rename your file and try again.', 'error');
                return false;
            }

            return true;
        }

        // Memory Management
        function cleanupContacts() {
            // Limit contact count for performance
            if (contacts.length > MAX_CONTACTS) {
                showAlert(`Too many contacts! Only the first ${MAX_CONTACTS} contacts will be loaded for performance reasons.`, 'error');
                contacts = contacts.slice(0, MAX_CONTACTS);
            }

            // Clean up old data
            if (emailHistory.length > 1000) {
                emailHistory = emailHistory.slice(0, 500); // Keep most recent 500
            }
        }

        // UI Enhancement Functions
        function toggleMessageExpand() {
            const messageBody = document.getElementById('messageBody');
            const expandBtn = document.getElementById('messageExpandBtn');

            if (messageExpanded) {
                messageBody.style.minHeight = '400px';
                messageBody.style.height = '400px';
                expandBtn.textContent = 'üìÑ Expand';
                expandBtn.setAttribute('aria-label', 'Expand message area');
                messageExpanded = false;
                showAlert('Message area collapsed to normal size', 'success');
            } else {
                messageBody.style.minHeight = '600px';
                messageBody.style.height = '600px';
                expandBtn.textContent = 'üìÑ Collapse';
                expandBtn.setAttribute('aria-label', 'Collapse message area');
                messageExpanded = true;
                showAlert('Message area expanded for better readability', 'success');
            }
        }

        function toggleTemplate() {
            const container = document.getElementById('templateContainer');
            const button = document.getElementById('templateToggle');

            if (container.style.display === 'none') {
                container.style.display = 'block';
                button.textContent = 'üìù Collapse';
            } else {
                container.style.display = 'none';
                button.textContent = 'üìù Expand';
            }
        }

        // Message Formatting Functions
        function toggleFormatting() {
            const toolbar = document.getElementById('formattingToolbar');
            const button = document.getElementById('formatToggle');
            const messageBody = document.getElementById('messageBody');

            if (toolbar.style.display === 'none') {
                toolbar.style.display = 'block';
                button.textContent = 'üé® Hide';
                messageBody.style.borderRadius = '0 0 4px 4px';
            } else {
                toolbar.style.display = 'none';
                button.textContent = 'üé® Format';
                messageBody.style.borderRadius = '4px';
            }
        }

        function formatText(type) {
            const textarea = document.getElementById('messageBody');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            let replacement = '';

            switch (type) {
                case 'bold':
                    replacement = selectedText ? `**${selectedText}**` : '**bold text**';
                    break;
                case 'italic':
                    replacement = selectedText ? `*${selectedText}*` : '*italic text*';
                    break;
                case 'underline':
                    replacement = selectedText ? `_${selectedText}_` : '_underlined text_';
                    break;
                case 'bullet':
                    const bulletLines = selectedText ? selectedText.split('\n').map(line => `‚Ä¢ ${line}`).join('\n') : '‚Ä¢ Bullet point 1\n‚Ä¢ Bullet point 2\n‚Ä¢ Bullet point 3';
                    replacement = bulletLines;
                    break;
                case 'number':
                    const numberLines = selectedText ? selectedText.split('\n').map((line, index) => `${index + 1}. ${line}`).join('\n') : '1. First item\n2. Second item\n3. Third item';
                    replacement = numberLines;
                    break;
            }

            const newValue = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
            textarea.value = newValue;
            textarea.focus();
            textarea.setSelectionRange(start, start + replacement.length);
        }

        function insertPersonalization() {
            const textarea = document.getElementById('messageBody');
            const start = textarea.selectionStart;
            const options = [
                '{contactName}',
                '{firm}',
                '{country}',
                '{email}',
                '{phone}',
                '{website}',
                '{address}'
            ];

            const selection = prompt('Choose personalization variable:\n\n' +
                options.map((opt, index) => `${index + 1}. ${opt}`).join('\n') +
                '\n\nEnter number (1-7):');

            if (selection && !isNaN(selection) && selection >= 1 && selection <= options.length) {
                const variable = options[selection - 1];
                const newValue = textarea.value.substring(0, start) + variable + textarea.value.substring(start);
                textarea.value = newValue;
                textarea.focus();
                textarea.setSelectionRange(start + variable.length, start + variable.length);
            }
        }

        function insertBusinessOpportunity() {
            const textarea = document.getElementById('messageBody');
            const start = textarea.selectionStart;

            const businessOpportunities = `
Potential Business Opportunities for {firm}:

‚Ä¢ **Product Distribution**: Exclusive distribution rights for Intex consumer electronics in {country}
‚Ä¢ **Retail Partnership**: Establish Intex branded sections in your existing retail locations
‚Ä¢ **E-commerce Integration**: Online sales partnership through your digital platforms
‚Ä¢ **Corporate Sales**: B2B sales of IT peripherals and office equipment to local businesses
‚Ä¢ **Service Center Network**: Authorized service and support center for Intex products
‚Ä¢ **Market Development**: Joint marketing campaigns and brand awareness initiatives

Market Advantages:
‚úì High-demand consumer electronics market
‚úì Growing adoption of smart home technologies
‚úì Increasing demand for quality IT peripherals
‚úì Strong potential for mobile accessories sales
‚úì Expanding home appliance market in {country}`;

            const newValue = textarea.value.substring(0, start) + businessOpportunities + textarea.value.substring(start);
            textarea.value = newValue;
            textarea.focus();
            textarea.setSelectionRange(start + businessOpportunities.length, start + businessOpportunities.length);
        }

        // Enhanced Formatting Functions
        let undoStack = [];

        function saveUndoState() {
            const textarea = document.getElementById('messageBody');
            undoStack.push(textarea.value);
            if (undoStack.length > 10) {
                undoStack.shift(); // Keep only last 10 states
            }
        }

        function undoFormat() {
            if (undoStack.length > 0) {
                const textarea = document.getElementById('messageBody');
                textarea.value = undoStack.pop();
                textarea.focus();
                showAlert('Undo successful', 'info');
            } else {
                showAlert('Nothing to undo', 'warning');
            }
        }

        function clearFormatting() {
            const textarea = document.getElementById('messageBody');
            if (textarea.value.trim() === '') {
                showAlert('Message is already empty', 'info');
                return;
            }

            saveUndoState();
            textarea.value = '';
            textarea.focus();
            showAlert('Message cleared', 'info');
        }

        function showColorPicker() {
            const colorPicker = document.getElementById('colorPicker');
            if (colorPicker.style.display === 'none') {
                colorPicker.style.display = 'block';
            } else {
                colorPicker.style.display = 'none';
            }
        }

        function applyColor(color) {
            const textarea = document.getElementById('messageBody');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);

            saveUndoState();

            let replacement;
            if (selectedText) {
                replacement = `<span style="color: ${color};">${selectedText}</span>`;
            } else {
                replacement = `<span style="color: ${color};">colored text</span>`;
            }

            const newValue = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
            textarea.value = newValue;
            textarea.focus();
            textarea.setSelectionRange(start, start + replacement.length);

            // Hide color picker
            document.getElementById('colorPicker').style.display = 'none';
        }

        // Enhanced formatText function with new options
        function formatText(type) {
            const textarea = document.getElementById('messageBody');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            let replacement = '';

            saveUndoState();

            switch (type) {
                case 'bold':
                    replacement = selectedText ? `**${selectedText}**` : '**bold text**';
                    break;
                case 'italic':
                    replacement = selectedText ? `*${selectedText}*` : '*italic text*';
                    break;
                case 'underline':
                    replacement = selectedText ? `_${selectedText}_` : '_underlined text_';
                    break;
                case 'bullet':
                    const bulletLines = selectedText ? selectedText.split('\n').map(line => `‚Ä¢ ${line}`).join('\n') : '‚Ä¢ Bullet point 1\n‚Ä¢ Bullet point 2\n‚Ä¢ Bullet point 3';
                    replacement = bulletLines;
                    break;
                case 'number':
                    const numberLines = selectedText ? selectedText.split('\n').map((line, index) => `${index + 1}. ${line}`).join('\n') : '1. First item\n2. Second item\n3. Third item';
                    replacement = numberLines;
                    break;
                case 'indent':
                    const indentLines = selectedText ? selectedText.split('\n').map(line => `    ${line}`).join('\n') : '    Indented text';
                    replacement = indentLines;
                    break;
                case 'link':
                    const url = prompt('Enter URL:');
                    if (url) {
                        const linkText = selectedText || 'Link text';
                        replacement = `[${linkText}](${url})`;
                    } else {
                        return;
                    }
                    break;
            }

            const newValue = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
            textarea.value = newValue;
            textarea.focus();
            textarea.setSelectionRange(start, start + replacement.length);
        }

        // Contact Personalization Auto-Population
        function populatePersonalizationData() {
            if (selectedContactIndex === -1 || !contacts[selectedContactIndex]) {
                return;
            }

            const contact = contacts[selectedContactIndex];
            const subjectField = document.getElementById('subject');
            const messageBody = document.getElementById('messageBody');

            // Auto-populate subject if empty or contains template
            if (!subjectField.value || subjectField.value.includes('{')) {
                subjectField.value = `Business Partnership Opportunity - Intex Technologies in ${contact.country}`;
            }

            // Auto-populate message if empty or contains template variables
            if (!messageBody.value || messageBody.value.includes('{')) {
                const personalizedMessage = `Dear ${contact.contactName},

We are pleased to introduce Intex Technologies to ${contact.firm}.

Since our inception in 1996, we have been at the forefront of innovation in consumer electronics and technology sectors. We believe ${contact.firm}, with its established market presence in ${contact.country}, would be an ideal partner for expanding our reach.

Our Product Portfolio:
‚Ä¢ IT Peripherals: Speakers, keyboards, mice, webcams, and computer accessories
‚Ä¢ Home Appliances: Air coolers, room heaters, water purifiers, and kitchen appliances
‚Ä¢ Mobile Accessories: Power banks, chargers, cables, and smartphone accessories
‚Ä¢ Audio Solutions: Wireless speakers, headphones, and sound systems

We are actively seeking distribution partners in ${contact.country} who share our vision of delivering high-quality, innovative products to consumers.

What We Offer Our Partners:
‚úì Competitive pricing with attractive profit margins
‚úì Comprehensive marketing support and co-branding opportunities
‚úì Technical training and ongoing product support
‚úì Flexible payment terms and credit facilities
‚úì Exclusive territory rights (subject to discussion)
‚úì Access to our complete product catalog and new launches

We would welcome the opportunity to discuss how we can work together to bring Intex Technologies' innovative products to the ${contact.country} market through ${contact.firm}.

Please feel free to contact us at your earliest convenience to explore this exciting business opportunity.

Best regards,

Vishwas Agarwal
Business Development Manager
Intex Technologies
Email: vishwas.agarwal@gmail.com
Phone: +91-XXXXXXXXXX`;

                messageBody.value = personalizedMessage;
            }

            showAlert(`Personalized content for ${contact.firm} from ${contact.country}`, 'success');
        }

        // Email Attachment Functions
        const attachments = [];
        const MAX_ATTACHMENTS = 5;
        const MAX_TOTAL_SIZE = 25 * 1024 * 1024; // 25MB

        function toggleAttachments() {
            const container = document.getElementById('attachmentContainer');
            const button = document.getElementById('attachmentToggle');

            if (container.style.display === 'none') {
                container.style.display = 'block';
                button.textContent = 'üìÅ Hide';
            } else {
                container.style.display = 'none';
                button.textContent = 'üìÅ Add Files';
            }
        }

        function handleAttachmentUpload(event) {
            const files = Array.from(event.target.files);

            if (files.length === 0) return;

            // Check attachment limits
            if (attachments.length + files.length > MAX_ATTACHMENTS) {
                showAlert(`Maximum ${MAX_ATTACHMENTS} attachments allowed. You can add ${MAX_ATTACHMENTS - attachments.length} more files.`, 'error');
                return;
            }

            // Check total size
            const currentSize = attachments.reduce((sum, att) => sum + att.size, 0);
            const newSize = files.reduce((sum, file) => sum + file.size, 0);

            if (currentSize + newSize > MAX_TOTAL_SIZE) {
                const maxMB = Math.round(MAX_TOTAL_SIZE / 1024 / 1024);
                const currentMB = Math.round(currentSize / 1024 / 1024);
                showAlert(`Total attachment size cannot exceed ${maxMB}MB. Current size: ${currentMB}MB`, 'error');
                return;
            }

            // Add files to attachments array
            files.forEach(file => {
                const attachment = {
                    id: Date.now() + Math.random(),
                    file: file,
                    name: file.name,
                    size: file.size,
                    type: file.type || 'application/octet-stream'
                };
                attachments.push(attachment);
            });

            renderAttachments();
            showAlert(`Added ${files.length} attachment(s)`, 'success');

            // Reset file input
            event.target.value = '';
        }

        function renderAttachments() {
            const container = document.getElementById('attachmentList');
            const emptyState = document.getElementById('attachmentEmpty');

            if (attachments.length === 0) {
                container.innerHTML = '<div id="attachmentEmpty" style="text-align: center; color: #999; font-style: italic; padding: 20px;">No attachments selected</div>';
                return;
            }

            const attachmentHTML = attachments.map(attachment => {
                const sizeKB = Math.round(attachment.size / 1024);
                const sizeText = sizeKB < 1024 ? `${sizeKB} KB` : `${Math.round(sizeKB / 1024)} MB`;

                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 5px;">
                        <div style="display: flex; align-items: center; flex: 1;">
                            <span style="margin-right: 8px;">${getFileIcon(attachment.name)}</span>
                            <div>
                                <div style="font-size: 12px; font-weight: bold; color: #333;">${sanitizeInput(attachment.name)}</div>
                                <div style="font-size: 10px; color: #666;">${sizeText}</div>
                            </div>
                        </div>
                        <button onclick="removeAttachment('${attachment.id}')" style="padding: 2px 6px; font-size: 10px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;" title="Remove attachment">
                            ‚úï
                        </button>
                    </div>
                `;
            }).join('');

            container.innerHTML = attachmentHTML;

            // Show total size
            const totalSize = attachments.reduce((sum, att) => sum + att.size, 0);
            const totalMB = Math.round(totalSize / 1024 / 1024 * 100) / 100;
            const maxMB = Math.round(MAX_TOTAL_SIZE / 1024 / 1024);

            container.innerHTML += `
                <div style="padding: 8px; background: #f8f9fa; border-radius: 4px; margin-top: 10px; font-size: 11px; color: #666; text-align: center;">
                    Total: ${totalMB} MB of ${maxMB} MB used (${attachments.length}/${MAX_ATTACHMENTS} files)
                </div>
            `;
        }

        function removeAttachment(attachmentId) {
            const index = attachments.findIndex(att => att.id == attachmentId);
            if (index !== -1) {
                const removedAttachment = attachments.splice(index, 1)[0];
                renderAttachments();
                showAlert(`Removed "${removedAttachment.name}"`, 'info');
            }
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const iconMap = {
                'pdf': 'üìÑ',
                'doc': 'üìù', 'docx': 'üìù',
                'xls': 'üìä', 'xlsx': 'üìä',
                'ppt': 'üìΩÔ∏è', 'pptx': 'üìΩÔ∏è',
                'txt': 'üìÑ',
                'jpg': 'üñºÔ∏è', 'jpeg': 'üñºÔ∏è', 'png': 'üñºÔ∏è', 'gif': 'üñºÔ∏è',
                'zip': 'üì¶', 'rar': 'üì¶'
            };
            return iconMap[ext] || 'üìÅ';
        }

        function handleKeyNavigation(event) {
            const contactCount = filteredContacts.length || contacts.length;
            if (contactCount === 0) return;

            switch(event.key) {
                case 'ArrowDown':
                    event.preventDefault();
                    if (selectedContactIndex < contactCount - 1) {
                        selectContact(selectedContactIndex + 1);
                    }
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    if (selectedContactIndex > 0) {
                        selectContact(selectedContactIndex - 1);
                    }
                    break;
                case 'Enter':
                    event.preventDefault();
                    if (selectedContactIndex >= 0) {
                        document.getElementById('sendBtn').click();
                    }
                    break;
                case 'Escape':
                    event.preventDefault();
                    selectedContactIndex = -1;
                    document.querySelectorAll('.contact-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    document.getElementById('sendBtn').disabled = true;
                    showAlert('Selection cleared');
                    break;
                case 'Home':
                    event.preventDefault();
                    if (contactCount > 0) {
                        selectContact(0);
                    }
                    break;
                case 'End':
                    event.preventDefault();
                    if (contactCount > 0) {
                        selectContact(contactCount - 1);
                    }
                    break;
            }
        }

        function updateUploadStats() {
            const statsDiv = document.getElementById('uploadStats');
            if (uploadStats.total > 0) {
                statsDiv.style.display = 'block';
                statsDiv.innerHTML = `
                    üìä Total: ${uploadStats.total} |
                    ‚úÖ Read: ${uploadStats.read} |
                    ‚ùå Unread: ${uploadStats.unread}
                `;
            }
        }

        function addToEmailHistory(toEmails, subject, status, timestamp) {
            const historyItem = {
                id: Date.now(),
                toEmails: Array.isArray(toEmails) ? toEmails : [toEmails],
                subject: subject,
                status: status, // 'sent', 'failed'
                timestamp: timestamp,
                content: document.getElementById('messageBody').value.substring(0, 100) + '...'
            };
            emailHistory.unshift(historyItem); // Add to beginning
            updateEmailHistory();
        }

        function updateEmailHistory() {
            const historyDiv = document.getElementById('emailHistory');

            if (emailHistory.length === 0) {
                historyDiv.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 20px;">
                        <p>üìß Email history will appear here</p>
                        <small>Send emails to see status tracking</small>
                    </div>
                `;
                return;
            }

            let historyHTML = '';
            emailHistory.slice(0, 20).forEach(item => { // Show last 20 items
                const statusColor = item.status === 'sent' ? '#28a745' : '#dc3545';
                const statusIcon = item.status === 'sent' ? '‚úÖ' : '‚ùå';

                historyHTML += `
                    <div style="border-bottom: 1px solid #eee; padding: 8px; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: between; align-items: start;">
                            <div style="flex: 1;">
                                <strong style="color: ${statusColor};">${statusIcon} ${item.status.toUpperCase()}</strong>
                                <div style="font-size: 12px; color: #666; margin-top: 2px;">
                                    To: ${item.toEmails.join(', ')}<br>
                                    Subject: ${item.subject}<br>
                                    ${new Date(item.timestamp).toLocaleString()}<br>
                                    <small>${item.content}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            historyDiv.innerHTML = historyHTML;
        }

        function parseMultipleEmails(emailString) {
            // Handle multiple delimiters: comma, semicolon, forward slash
            return emailString
                .split(/[,;\/]/)
                .map(email => email.trim())
                .filter(email => email && email.includes('@'));
        }

        // No sample data - users must upload their own spreadsheets

        function showAlert(message, type = 'success') {
            const alerts = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            alerts.appendChild(alert);

            // Remove after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }


        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                console.log('No file selected');
                return;
            }

            // Security: File validation
            if (!validateFileUpload(file)) {
                return;
            }

            // Check if XLSX library is loaded for Excel files
            if (!file.name.toLowerCase().endsWith('.csv') && typeof XLSX === 'undefined') {
                showAlert('Error: Excel processing library not loaded. Please refresh the page.', 'error');
                return;
            }

            console.log('=== FILE UPLOAD STARTED ===');
            console.log('File selected:', file.name, file.type, file.size);
            showAlert(`Processing ${sanitizeInput(file.name)}...`, 'success');

            try {
                // Clear existing data
                contacts = [];
                filteredContacts = [];
                selectedContactIndex = -1;
                uploadedSpreadsheetData = [];
                currentUploadProgress = { current: 0, total: 0 };

                showProgress(0, 100, 'Starting file processing...');
                let totalProcessed = 0;

                // Handle CSV files differently
                if (file.name.toLowerCase().endsWith('.csv')) {
                    console.log('Processing CSV file...');
                    const text = await file.text();
                    console.log('CSV file read, length:', text.length);

                    const csvData = parseCSV(text);
                    console.log('CSV parsed, headers:', csvData.headers);
                    console.log('CSV data rows:', csvData.data.length);

                    // Track total rows for statistics
                    uploadStats.total = csvData.data.length;

                    // Process CSV data
                    csvData.data.forEach((row, index) => {
                        console.log(`Processing row ${index + 1}:`, row);
                        const contact = {
                            country: row.country || 'Unknown',
                            firm: row['firm name'] || row.company || row.firm || 'Unknown Company',
                            address: row.address || row.location || '',
                            phone: row['contact number'] || row.phone || row.telephone || '',
                            contactName: row['contact person'] || row.name || row.contact || 'Contact Person',
                            email: row.email || row['email address'] || '',
                            website: row.website || row.url || '',
                            source: row.source || row['lead source'] || '',
                            category: row.category || row.type || row.sector || '',
                            businessFocus: generateBusinessFocus(row.category || row.type || ''),
                            marketStrength: 'Medium',
                            emailStatus: 'pending' // pending, sent, failed
                        };

                        console.log('Contact created:', contact);

                        if (contact.email && contact.email.includes('@')) {
                            contacts.push(contact);
                            totalProcessed++;
                            console.log(`Added contact ${totalProcessed}: ${contact.firm} - ${contact.email}`);
                        } else {
                            console.log('Skipped contact (no valid email):', contact);
                        }
                    });

                    console.log(`CSV processed: ${totalProcessed} contacts added to array`);
                    console.log('Final contacts array:', contacts);
                } else {
                    // Handle Excel files
                    const data = await file.arrayBuffer();
                    console.log('Excel file read, size:', data.byteLength);

                    const workbook = XLSX.read(data, { type: 'array' });
                    console.log('Workbook loaded, sheets:', workbook.SheetNames);

                    // Calculate total rows across all sheets
                    uploadStats.total = 0;
                    workbook.SheetNames.forEach(sheetName => {
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        if (jsonData.length > 1) {
                            uploadStats.total += jsonData.length - 1; // Exclude header row
                        }
                    });

                    // Process each worksheet (tab) as a country
                    workbook.SheetNames.forEach(sheetName => {
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (jsonData.length < 2) return; // Skip empty sheets

                    const headers = jsonData[0].map(h => h?.toString().toLowerCase().trim());
                    const rows = jsonData.slice(1);

                    // Map column indices for key parameters
                    const columnMap = {
                        firm: findColumnIndex(headers, ['firm name', 'company', 'firm', 'organization']),
                        address: findColumnIndex(headers, ['address', 'location', 'addr']),
                        phone: findColumnIndex(headers, ['contact number', 'phone', 'telephone', 'mobile']),
                        contactName: findColumnIndex(headers, ['contact person', 'name', 'contact', 'person']),
                        email: findColumnIndex(headers, ['email', 'email address', 'e-mail']),
                        website: findColumnIndex(headers, ['website', 'url', 'web', 'site']),
                        source: findColumnIndex(headers, ['source', 'lead source', 'origin']),
                        category: findColumnIndex(headers, ['category', 'type', 'sector', 'industry'])
                    };

                    // Process each row
                    rows.forEach((row, rowIndex) => {
                        if (!row || row.length === 0) {
                            // Track empty rows as failed
                            uploadedSpreadsheetData.push({
                                originalRowIndex: rowIndex + 1, // +1 for header
                                originalData: row,
                                status: 'failed',
                                reason: 'Empty row',
                                sheetName: sheetName
                            });
                            return;
                        }

                        const contact = {
                            country: sheetName, // Use sheet name as country
                            firm: getCellValue(row, columnMap.firm) || 'Unknown Company',
                            address: getCellValue(row, columnMap.address) || '',
                            phone: getCellValue(row, columnMap.phone) || '',
                            contactName: getCellValue(row, columnMap.contactName) || 'Contact Person',
                            email: getCellValue(row, columnMap.email) || '',
                            website: getCellValue(row, columnMap.website) || '',
                            source: getCellValue(row, columnMap.source) || '',
                            category: getCellValue(row, columnMap.category) || '',
                            businessFocus: generateBusinessFocus(getCellValue(row, columnMap.category)),
                            marketStrength: 'High',
                            emailStatus: 'pending' // pending, sent, failed
                        };

                        // Track in spreadsheet data
                        const spreadsheetEntry = {
                            originalRowIndex: rowIndex + 1, // +1 for header
                            originalData: row,
                            sheetName: sheetName,
                            processedContact: contact
                        };

                        // Only add if email exists
                        if (contact.email && contact.email.includes('@')) {
                            contacts.push(contact);
                            spreadsheetEntry.status = 'uploaded';
                            spreadsheetEntry.reason = 'Successfully uploaded';
                            totalProcessed++;
                        } else {
                            spreadsheetEntry.status = 'failed';
                            spreadsheetEntry.reason = 'Missing or invalid email address';
                        }

                        uploadedSpreadsheetData.push(spreadsheetEntry);
                    });

                        console.log(`Processed sheet "${sheetName}": ${jsonData.length - 1} rows`);
                    });

                    console.log(`Total contacts loaded: ${contacts.length}`);
                }

                // Performance: Cleanup and optimize
                cleanupContacts();
                filteredContacts = [...contacts];

                // Update upload statistics
                uploadStats.read = contacts.length;
                uploadStats.unread = uploadStats.total - uploadStats.read;
                updateUploadStats();
                hideProgress();

                // Show upload status report
                const statusReport = generateStatusReport();
                showUploadStatusReport(statusReport);

                console.log('About to render contacts. Array length:', contacts.length);
                renderContacts();
                showAlert(`‚úÖ Loaded ${contacts.length} contacts${file.name.toLowerCase().endsWith('.csv') ? '' : ` from multiple countries`}! (${statusReport.failed} rows had issues)`, statusReport.failed > 0 ? 'error' : 'success');

            } catch (error) {
                hideProgress();
                const sanitizedError = sanitizeInput(error.message);
                showAlert(`Error processing file: ${sanitizedError}`, 'error');
                console.error('File processing error:', error);
            } finally {
                // Reset file input for reuse
                document.getElementById('fileUpload').value = '';
            }
        }

        // Advanced file upload handler for multiple document types
        async function handleAdvancedFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                console.log('No file selected');
                return;
            }

            const fileName = file.name.toLowerCase();
            const fileExt = fileName.split('.').pop();

            // For Excel/CSV files, use the original handler
            if (fileExt === 'xlsx' || fileExt === 'xls' || fileExt === 'csv') {
                return handleFileUpload(event);
            }

            // Security: File validation
            if (!validateFileUpload(file)) {
                return;
            }

            console.log('=== ADVANCED FILE UPLOAD STARTED ===');
            console.log('File selected:', file.name, file.type, file.size);
            showAlert(`Processing ${sanitizeInput(file.name)}...`, 'success');

            try {
                // Clear existing data
                contacts = [];
                filteredContacts = [];
                selectedContactIndex = -1;
                currentUploadProgress = { current: 0, total: 0 };

                showProgress(0, 100, 'Processing document...');

                let extractedContacts = [];
                const fileType = getDocumentType(fileExt);

                console.log('Document type detected:', fileType);

                switch (fileType) {
                    case 'PDF':
                        extractedContacts = await processPDFFile(file);
                        break;
                    case 'Word':
                        extractedContacts = await processWordFile(file);
                        break;
                    case 'PowerPoint':
                        extractedContacts = await processPowerPointFile(file);
                        break;
                    case 'Image':
                        extractedContacts = await processImageFile(file);
                        break;
                    default:
                        throw new Error(`Unsupported file type: ${fileExt}`);
                }

                console.log('Extracted contacts:', extractedContacts.length);
                contacts = extractedContacts;

                hideProgress();
                renderContacts();
                showAlert(`‚úÖ Extracted ${contacts.length} contacts from ${fileType} document!`, contacts.length > 0 ? 'success' : 'warning');

            } catch (error) {
                hideProgress();
                const sanitizedError = sanitizeInput(error.message);
                showAlert(`Error processing ${fileType} file: ${sanitizedError}`, 'error');
                console.error('Advanced file processing error:', error);
            } finally {
                // Reset file input for reuse
                document.getElementById('fileUpload').value = '';
            }
        }

        // Determine document type from extension
        function getDocumentType(extension) {
            const docTypes = {
                'pdf': 'PDF',
                'doc': 'Word',
                'docx': 'Word',
                'ppt': 'PowerPoint',
                'pptx': 'PowerPoint',
                'png': 'Image',
                'jpg': 'Image',
                'jpeg': 'Image',
                'gif': 'Image',
                'bmp': 'Image',
                'tiff': 'Image'
            };
            return docTypes[extension] || 'Unknown';
        }

        // Process PDF files
        async function processPDFFile(file) {
            showProgress(25, 100, 'Reading PDF content...');
            const text = await extractTextFromPDF(file);
            showProgress(75, 100, 'Extracting contact information...');
            return extractContactsFromText(text, 'PDF Document');
        }

        // Process Word documents
        async function processWordFile(file) {
            showProgress(25, 100, 'Reading Word document...');
            const text = await extractTextFromDOCX(file);
            showProgress(75, 100, 'Extracting contact information...');
            return extractContactsFromText(text, 'Word Document');
        }

        // Process PowerPoint presentations
        async function processPowerPointFile(file) {
            showProgress(25, 100, 'Reading PowerPoint slides...');
            const text = await extractTextFromPPTX(file);
            showProgress(75, 100, 'Extracting contact information...');
            return extractContactsFromText(text, 'PowerPoint Document');
        }

        // Process image files using OCR
        async function processImageFile(file) {
            showProgress(25, 100, 'Analyzing image...');
            const text = await performOCR(file);
            showProgress(75, 100, 'Extracting contact information...');
            return extractContactsFromText(text, 'Image');
        }

        // Extract text from PDF (simulation - in real implementation would use PDF.js)
        async function extractTextFromPDF(file) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    // Simulate PDF text extraction
                    const sampleText = `
                        Contact Information Directory

                        ABC Corporation
                        Email: contact@abc-corp.com
                        Phone: +1-555-0123
                        Address: 123 Business Street, Suite 100, City, State 12345
                        Contact Person: John Smith
                        Website: www.abc-corp.com

                        XYZ Industries
                        Email: info@xyz-industries.net
                        Phone: +1-555-0456
                        Address: 456 Industrial Ave, City, State 67890
                        Contact Person: Sarah Johnson
                        Website: www.xyz-industries.net

                        Global Services LLC
                        Email: hello@globalservices.org
                        Phone: +1-555-0789
                        Address: 789 Service Road, City, State 11111
                        Contact Person: Mike Wilson
                    `;
                    resolve(sampleText);
                }, 1000);
            });
        }

        // Extract text from Word documents (simulation - in real implementation would use mammoth.js)
        async function extractTextFromDOCX(file) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    // Simulate Word document text extraction
                    const sampleText = `
                        Business Partners List

                        Tech Solutions Inc.
                        Contact: David Brown - dbrown@techsolutions.com
                        Phone: (555) 123-4567
                        Location: 321 Tech Drive, Innovation City

                        Marketing Pros
                        Contact: Lisa Anderson - lisa.anderson@marketingpros.biz
                        Phone: (555) 234-5678
                        Location: 654 Marketing Blvd, Business Town

                        Finance Experts
                        Contact: Robert Lee - r.lee@financeexperts.co
                        Phone: (555) 345-6789
                        Location: 987 Financial Street, Money City
                    `;
                    resolve(sampleText);
                }, 800);
            });
        }

        // Extract text from PowerPoint presentations (simulation)
        async function extractTextFromPPTX(file) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    // Simulate PowerPoint text extraction
                    const sampleText = `
                        Conference Attendees

                        Slide 1: Key Contacts
                        - Emma Taylor, emma.taylor@startupfirm.com, (555) 456-7890
                        - James Wilson, j.wilson@corporategroup.net, (555) 567-8901

                        Slide 2: Industry Leaders
                        - Patricia Moore, p.moore@industrytech.org, (555) 678-9012
                        - Christopher Davis, chris@innovativedesign.com, (555) 789-0123

                        Slide 3: Partners
                        - Amanda Garcia, a.garcia@partnernetwork.biz, (555) 890-1234
                    `;
                    resolve(sampleText);
                }, 1200);
            });
        }

        // Perform OCR on image files (simulation - in real implementation would use Tesseract.js)
        async function performOCR(file) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    // Simulate OCR text extraction
                    const sampleText = `
                        Business Card Information

                        INNOVATE CORP
                        Maria Rodriguez
                        Senior Manager
                        maria.rodriguez@innovatecorp.com
                        Tel: +1 (555) 111-2222
                        www.innovatecorp.com

                        FUTURE TECH
                        Alex Kim
                        CTO
                        alex@futuretech.io
                        Mobile: 555-333-4444
                        futuretech.io
                    `;
                    resolve(sampleText);
                }, 1500);
            });
        }

        // Extract contact information from text using pattern matching
        function extractContactsFromText(text, source) {
            const contacts = [];
            const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);

            let currentContact = {};
            let processingContact = false;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];

                // Email pattern
                const emailMatch = line.match(/[\w.-]+@[\w.-]+\.[a-zA-Z]{2,}/);
                if (emailMatch) {
                    if (processingContact && currentContact.email) {
                        // Save previous contact and start new one
                        if (isValidContact(currentContact)) {
                            contacts.push(finalizeContact(currentContact, source));
                        }
                        currentContact = {};
                    }
                    currentContact.email = emailMatch[0];
                    processingContact = true;
                }

                // Phone pattern
                const phoneMatch = line.match(/(?:\+?1[-.\s]?)?\(?([0-9]{3})\)?[-.\s]?([0-9]{3})[-.\s]?([0-9]{4})/);
                if (phoneMatch && processingContact) {
                    currentContact.phone = phoneMatch[0];
                }

                // Website pattern
                const websiteMatch = line.match(/(?:www\.)?[\w.-]+\.(?:com|net|org|biz|co|io|edu|gov)/);
                if (websiteMatch && processingContact && !currentContact.email?.includes(websiteMatch[0])) {
                    currentContact.website = websiteMatch[0].startsWith('www.') ? websiteMatch[0] : 'www.' + websiteMatch[0];
                }

                // Company/Firm name (usually appears before or after email)
                if (processingContact && !currentContact.firm) {
                    // Look for company indicators
                    if (line.match(/\b(Corp|Corporation|Inc|LLC|Ltd|Company|Group|Solutions|Services|Industries|Tech|Systems)\b/i)) {
                        currentContact.firm = line;
                    } else if (line.length < 50 && line.match(/^[A-Z][a-zA-Z\s&]+$/)) {
                        // Capitalized words that look like company names
                        currentContact.firm = line;
                    }
                }

                // Contact person name
                if (processingContact && !currentContact.contactName) {
                    // Look for person names (First Last pattern)
                    if (line.match(/^[A-Z][a-z]+\s+[A-Z][a-z]+/) && !line.match(/\b(Street|Ave|Road|Drive|Blvd)\b/i)) {
                        currentContact.contactName = line;
                    }
                }

                // Address pattern
                if (processingContact && line.match(/\d+\s+[\w\s]+(?:Street|St|Avenue|Ave|Road|Rd|Drive|Dr|Boulevard|Blvd|Suite|Ste)/i)) {
                    currentContact.address = line;
                }
            }

            // Don't forget the last contact
            if (processingContact && isValidContact(currentContact)) {
                contacts.push(finalizeContact(currentContact, source));
            }

            return contacts;
        }

        // Check if contact has minimum required information
        function isValidContact(contact) {
            return contact.email && contact.email.includes('@');
        }

        // Finalize contact with default values
        function finalizeContact(contact, source) {
            return {
                country: 'Unknown',
                firm: contact.firm || 'Unknown Company',
                address: contact.address || '',
                phone: contact.phone || '',
                contactName: contact.contactName || 'Contact Person',
                email: contact.email,
                website: contact.website || '',
                source: source || 'Document',
                category: 'General',
                businessFocus: generateBusinessFocus('General'),
                marketStrength: 'Medium',
                emailStatus: 'pending'
            };
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Bulk Email Sender Application Initialized');

            // Initialize filtered contacts
            filteredContacts = [...contacts];

            // Set focus to first interactive element for accessibility
            const firstButton = document.querySelector('button:not([disabled])');
            if (firstButton) {
                firstButton.focus();
            }

            console.log('Application ready for use - Live mode active');
        });

        function findColumnIndex(headers, possibleNames) {
            for (let name of possibleNames) {
                const index = headers.findIndex(h => h && h.includes(name));
                if (index !== -1) return index;
            }
            return -1;
        }

        function getCellValue(row, columnIndex) {
            if (columnIndex === -1 || !row[columnIndex]) return '';
            return row[columnIndex].toString().trim();
        }

        function generateBusinessFocus(category) {
            const focusMap = {
                'technology': 'IT peripherals and smart devices',
                'retail': 'Consumer electronics and home appliances',
                'electronics': 'Audio solutions and mobile accessories',
                'manufacturing': 'Industrial equipment and automation',
                'healthcare': 'Medical devices and monitoring systems',
                'education': 'Educational technology and audio-visual equipment'
            };

            const categoryLower = category.toLowerCase();
            for (let [key, focus] of Object.entries(focusMap)) {
                if (categoryLower.includes(key)) return focus;
            }
            return 'Consumer electronics and technology solutions';
        }

        function renderContacts() {
            console.log('=== RENDER CONTACTS CALLED ===');
            console.log('Contacts to render:', contacts.length);
            console.log('Contacts array:', contacts);

            const container = document.getElementById('contactsList');
            if (!container) {
                console.error('contactsList element not found!');
                return;
            }

            container.innerHTML = '';

            if (contacts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666; border: 2px dashed #ddd; border-radius: 8px; background: #f9f9f9;">
                        <h4 style="color: #999; margin-bottom: 10px;">üìã No Contacts Loaded</h4>
                        <p>Upload your spreadsheet above to see your contact database here</p>
                        <small>Your contacts will appear here after uploading</small>
                    </div>
                `;
                return;
            }

            console.log('Rendering individual contacts...');
            const contactsToRender = filteredContacts.length > 0 ? filteredContacts : contacts;

            contactsToRender.forEach((contact, index) => {
                console.log(`Rendering contact ${index + 1}:`, contact);
                const div = document.createElement('div');
                div.className = 'contact-item';
                div.onclick = () => selectContact(index);
                div.setAttribute('role', 'option');
                div.setAttribute('aria-selected', 'false');
                div.setAttribute('tabindex', '-1');

                // Add status-based styling
                let statusColor = '';
                let statusIcon = '';
                if (contact.emailStatus === 'sent') {
                    statusColor = 'background: #d4edda; border-color: #28a745;';
                    statusIcon = '‚úÖ';
                } else if (contact.emailStatus === 'failed') {
                    statusColor = 'background: #f8d7da; border-color: #dc3545;';
                    statusIcon = '‚ùå';
                } else {
                    statusIcon = 'üìß';
                }

                div.style.cssText += statusColor;

                // Security: Sanitize all contact data before display
                const sanitizedContact = {
                    firm: sanitizeHTML(contact.firm || ''),
                    contactName: sanitizeHTML(contact.contactName || ''),
                    email: sanitizeHTML(contact.email || ''),
                    country: sanitizeHTML(contact.country || ''),
                    phone: sanitizeHTML(contact.phone || ''),
                    website: sanitizeHTML(contact.website || ''),
                    address: sanitizeHTML(contact.address || ''),
                    source: sanitizeHTML(contact.source || ''),
                    category: sanitizeHTML(contact.category || '')
                };

                // Create safe HTML structure without innerHTML
                const flexContainer = document.createElement('div');
                flexContainer.style.cssText = 'display: flex; justify-content: space-between; align-items: start;';

                const contentDiv = document.createElement('div');
                contentDiv.style.cssText = 'flex: 1;';

                // Header with firm name and category
                const headerDiv = document.createElement('div');
                headerDiv.style.cssText = 'display: flex; align-items: center; gap: 8px; margin-bottom: 4px;';

                const firmStrong = document.createElement('strong');
                firmStrong.textContent = sanitizedContact.firm;
                headerDiv.appendChild(firmStrong);

                if (sanitizedContact.category) {
                    const categorySpan = document.createElement('span');
                    categorySpan.style.cssText = 'background: #e3f2fd; color: #1976d2; padding: 2px 6px; border-radius: 3px; font-size: 0.8em;';
                    categorySpan.textContent = sanitizedContact.category;
                    headerDiv.appendChild(categorySpan);
                }

                contentDiv.appendChild(headerDiv);

                // Contact details
                const details = [
                    `üë§ ${sanitizedContact.contactName}`,
                    `üìß ${sanitizedContact.email}`,
                    `üåç ${sanitizedContact.country}`
                ];

                if (sanitizedContact.phone) details.push(`üìû ${sanitizedContact.phone}`);
                if (sanitizedContact.website) details.push(`üåê ${sanitizedContact.website}`);
                if (sanitizedContact.address) details.push(`üìç ${sanitizedContact.address}`);
                if (sanitizedContact.source) details.push(`üìä Source: ${sanitizedContact.source}`);

                details.forEach(detail => {
                    const detailDiv = document.createElement('div');
                    detailDiv.textContent = detail;
                    detailDiv.style.fontSize = '10px';
                    detailDiv.style.marginBottom = '2px';
                    contentDiv.appendChild(detailDiv);
                });

                // Status icon
                const statusDiv = document.createElement('div');
                statusDiv.style.cssText = 'font-size: 20px;';
                statusDiv.textContent = statusIcon;

                flexContainer.appendChild(contentDiv);
                flexContainer.appendChild(statusDiv);
                div.appendChild(flexContainer);

                container.appendChild(div);
                console.log(`Contact ${index + 1} added to DOM`);
            });

            // Update counts
            updateContactCounts();
            console.log('=== CONTACT RENDERING COMPLETE ===');
        }

        function updateContactCounts() {
            emailStatusCounts.total = contacts.length;
            emailStatusCounts.sent = contacts.filter(c => c.emailStatus === 'sent').length;
            emailStatusCounts.failed = contacts.filter(c => c.emailStatus === 'failed').length;
            emailStatusCounts.pending = contacts.filter(c => c.emailStatus === 'pending').length;

            document.getElementById('totalCount').textContent = `${emailStatusCounts.total} contacts`;
            document.getElementById('sentCount').textContent = `${emailStatusCounts.sent} sent`;
            document.getElementById('failedCount').textContent = `${emailStatusCounts.failed} failed`;
        }

        function handleScroll() {
            const contactsList = document.getElementById('contactsList');
            const scrollTopBtn = document.getElementById('scrollTopBtn');

            // Show scroll to top button when scrolled down more than 100px
            if (contactsList.scrollTop > 100) {
                scrollTopBtn.style.display = 'block';
            } else {
                scrollTopBtn.style.display = 'none';
            }
        }

        function scrollToTop() {
            const contactsList = document.getElementById('contactsList');
            contactsList.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        function selectContact(index) {
            selectedContactIndex = index;
            const contact = contacts[index];

            // Update UI
            document.querySelectorAll('.contact-item').forEach((item, i) => {
                item.classList.toggle('selected', i === index);
            });

            // Populate email form
            document.getElementById('toEmail').value = contact.email;

            // Auto-populate personalized content
            populatePersonalizationData();
            document.getElementById('sendBtn').disabled = false;

            showAlert(`Selected: ${contact.contactName} from ${contact.firm}`);
        }

        async function sendEmail() {
            console.log('=== EMAIL SENDING STARTED ===');

            // Validate all inputs first
            const fromEmailValid = validateEmail(document.getElementById('fromEmail'));
            const toEmailValid = validateEmailList(document.getElementById('toEmail'));
            const subjectValid = validateSubject(document.getElementById('subject'));
            const messageValid = validateMessage(document.getElementById('messageBody'));

            if (!fromEmailValid || !toEmailValid || !subjectValid || !messageValid) {
                showAlert('Please fix all validation errors before sending', 'error');
                return;
            }

            const fromEmail = document.getElementById('fromEmail').value.trim();
            const toEmailField = document.getElementById('toEmail').value.trim();
            const subject = document.getElementById('subject').value.trim();
            const body = document.getElementById('messageBody').value.trim();

            // Parse multiple emails
            const toEmails = parseMultipleEmails(toEmailField);
            console.log('Email details:', { fromEmail, toEmails, subject: subject.substring(0, 50) + '...' });

            if (toEmails.length === 0) {
                showAlert('Please enter at least one valid email address', 'error');
                return;
            }

            // Security: Sanitize inputs
            const sanitizedSubject = sanitizeInput(subject);
            const sanitizedBody = sanitizeInput(body);

            if (toEmails.length > 1) {
                showAlert(`Sending to ${toEmails.length} email addresses...`, 'success');
            }

            try {
                document.getElementById('sendBtn').textContent = 'üì§ Sending...';
                document.getElementById('sendBtn').disabled = true;

                // Send to each email address (for multiple emails, send individually)
                let successCount = 0;
                let failureCount = 0;

                for (const toEmail of toEmails) {
                    console.log(`Sending to: ${toEmail}`);

                    try {
                        const response = await fetch('/.netlify/functions/send-email-working', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                from_email: fromEmail,
                                from_name: 'Intex Technologies',
                                to_email: toEmail,
                                subject: subject,
                                content: body
                            })
                        });

                        const result = await response.json();
                        console.log(`Response for ${toEmail}:`, result);

                        if (result.success) {
                            successCount++;
                            addToEmailHistory(toEmail, subject, 'sent', Date.now());
                        } else {
                            failureCount++;
                            addToEmailHistory(toEmail, subject, 'failed', Date.now());
                        }
                    } catch (emailError) {
                        console.error(`Error sending to ${toEmail}:`, emailError);
                        failureCount++;
                        addToEmailHistory(toEmail, subject, 'failed', Date.now());
                    }
                }

                // Show summary results
                if (successCount > 0 && failureCount === 0) {
                    showAlert(`‚úÖ Successfully sent to all ${successCount} email(s)`);
                } else if (successCount > 0 && failureCount > 0) {
                    showAlert(`‚ö†Ô∏è Sent to ${successCount}, failed to ${failureCount} email(s)`);
                } else {
                    showAlert(`‚ùå Failed to send to all ${failureCount} email(s)`, 'error');
                }

                // Update contact status if single contact selected
                if (selectedContactIndex >= 0 && toEmails.length === 1) {
                    contacts[selectedContactIndex].emailStatus = successCount > 0 ? 'sent' : 'failed';
                    renderContacts(); // Re-render to show color
                }

            } catch (error) {
                console.error('Email sending error:', error);
                showAlert(`Network error: ${error.message}`, 'error');

                // Update contact status to failed on network error
                if (selectedContactIndex >= 0) {
                    contacts[selectedContactIndex].emailStatus = 'failed';
                    renderContacts(); // Re-render to show red color
                }
            } finally {
                document.getElementById('sendBtn').textContent = 'üì§ Send Email';
                document.getElementById('sendBtn').disabled = false;
            }
        }

        // Bulk email functionality temporarily disabled

        // Test connection functionality removed

        function extractTemplateHeaders() {
            const template = document.getElementById('emailTemplate').value;
            const headerLines = template.split('\n');

            // Set default values
            document.getElementById('fromEmail').value = 'info@datanalysisninsights.co.uk';
            window.defaultFromName = 'Intex Technologies';

            // Extract headers from template if present
            for (let line of headerLines) {
                if (line.startsWith('From: ')) {
                    const fromEmail = line.replace('From: ', '').trim();
                    // Only use template email if it's a valid email address
                    if (fromEmail.includes('@')) {
                        document.getElementById('fromEmail').value = fromEmail;
                    }
                }
                if (line.startsWith('From-Name: ')) {
                    const fromName = line.replace('From-Name: ', '').trim();
                    window.defaultFromName = fromName;
                }
            }
        }

        function testXLSXLibrary() {
            if (typeof XLSX === 'undefined') {
                console.error('XLSX library not loaded');
                showAlert('‚ö†Ô∏è Excel processing library failed to load. File upload may not work.', 'error');
                return false;
            } else {
                console.log('XLSX library loaded successfully, version:', XLSX.version);
                return true;
            }
        }

        // Add a simple CSV processor as fallback
        function parseCSV(text) {
            const csvLines = text.split('\n');
            const headers = csvLines[0].split(',').map(h => h.trim().toLowerCase());
            const data = [];

            for (let i = 1; i < csvLines.length; i++) {
                if (csvLines[i].trim()) {
                    const values = csvLines[i].split(',');
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] ? values[index].trim() : '';
                    });
                    data.push(row);
                }
            }
            return { headers, data };
        }

        // Initialize on page load - no complex initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Simple email sender loaded');
            testXLSXLibrary(); // Test if XLSX library loaded
            extractTemplateHeaders(); // Extract and populate From field
            renderContacts(); // Initialize contact list display
            showAlert('üìß Email Sender Ready! Upload your contact spreadsheet to begin sending personalized emails.');
        });
        // Email Analytics Dashboard Functions
        let autoRedirectEnabled = true;

        function toggleAnalytics() {
            const container = document.getElementById('analyticsContainer');
            const button = document.getElementById('analyticsToggle');

            if (container.style.display === 'none') {
                container.style.display = 'block';
                button.textContent = 'üìà Collapse';
                updateAnalytics();
            } else {
                container.style.display = 'none';
                button.textContent = 'üìà Expand';
            }
        }

        function updateAnalytics() {
            const sentCount = emailHistory.filter(email => email.status === 'sent').length;
            const failedCount = emailHistory.filter(email => email.status === 'failed').length;

            document.getElementById('sentCount').textContent = sentCount;
            document.getElementById('failedCount').textContent = failedCount;

            // Update country filter options
            const countries = [...new Set(emailHistory.map(email => email.country))];
            const countryFilter = document.getElementById('countryFilter');
            countryFilter.innerHTML = '<option value="">All Countries</option>';
            countries.forEach(country => {
                countryFilter.innerHTML += `<option value="${country}">${country}</option>`;
            });

            // Update top countries
            const countryStats = countries.map(country => {
                const countryEmails = emailHistory.filter(email => email.country === country);
                return {
                    country,
                    sent: countryEmails.filter(email => email.status === 'sent').length,
                    total: countryEmails.length
                };
            }).sort((a, b) => b.total - a.total).slice(0, 3);

            const topCountriesDiv = document.getElementById('topCountries');
            if (countryStats.length === 0) {
                topCountriesDiv.textContent = 'No data yet';
            } else {
                topCountriesDiv.innerHTML = countryStats.map(stat =>
                    `<div style="margin-bottom: 4px;">${stat.country}: ${stat.sent}/${stat.total} sent</div>`
                ).join('');
            }
        }

        function filterEmailHistory() {
            const countryFilter = document.getElementById('countryFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;

            let filteredHistory = [...emailHistory];

            // Filter by country
            if (countryFilter) {
                filteredHistory = filteredHistory.filter(email => email.country === countryFilter);
            }

            // Filter by date
            if (dateFilter) {
                const now = new Date();
                const startDate = new Date();

                switch (dateFilter) {
                    case 'today':
                        startDate.setHours(0, 0, 0, 0);
                        break;
                    case 'week':
                        startDate.setDate(now.getDate() - 7);
                        break;
                    case 'month':
                        startDate.setMonth(now.getMonth() - 1);
                        break;
                }

                filteredHistory = filteredHistory.filter(email => new Date(email.timestamp) >= startDate);
            }

            // Update displayed history
            renderEmailHistory(filteredHistory);
        }

        function addEmailToHistory(email, status, country) {
            const historyEntry = {
                id: Date.now(),
                email,
                status,
                country,
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString()
            };

            emailHistory.unshift(historyEntry);
            renderEmailHistory();
            updateAnalytics();
        }

        function renderEmailHistory(customHistory = null) {
            const history = customHistory || emailHistory;
            const container = document.getElementById('emailHistory');

            if (history.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 15px;">
                        <p style="font-size: 12px;">üìß Email history will appear here</p>
                        <small style="font-size: 10px;">Send emails to see status tracking</small>
                    </div>
                `;
                return;
            }

            const historyHTML = history.slice(0, 20).map(entry => {
                const statusIcon = entry.status === 'sent' ? '‚úÖ' : '‚ùå';
                const statusColor = entry.status === 'sent' ? '#10b981' : '#ef4444';

                return `
                    <div style="padding: 8px; margin-bottom: 6px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 4px;">
                            <span style="font-size: 11px; font-weight: 500; color: #374151;">${entry.email}</span>
                            <span style="font-size: 10px; color: ${statusColor};">${statusIcon}</span>
                        </div>
                        <div style="font-size: 10px; color: #6b7280;">
                            ${entry.country} ‚Ä¢ ${entry.time}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = historyHTML;
        }

        function clearEmailHistory() {
            if (confirm('Clear all email history? This cannot be undone.')) {
                emailHistory = [];
                renderEmailHistory();
                updateAnalytics();
                showAlert('Email history cleared', 'info');
            }
        }

        // Response Email Manager Functions
        let responseEmails = [];

        function toggleResponseManager() {
            const panel = document.getElementById('responsePanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                // Auto-check for responses when opened
                checkResponseEmails();
            } else {
                panel.style.display = 'none';
            }
        }

        function checkResponseEmails() {
            // Simulate checking for response emails
            showAlert('Checking for response emails...', 'info');

            setTimeout(() => {
                // Simulate some responses (in real implementation, this would fetch from email server)
                const newResponses = [
                    {
                        id: Date.now() + 1,
                        from: 'john.smith@abc-corp.com',
                        subject: 'Re: Business Partnership Opportunity',
                        timestamp: new Date(),
                        content: 'Thank you for your email. We are interested in discussing this partnership opportunity.'
                    }
                ];

                if (Math.random() > 0.7) { // 30% chance of new responses
                    responseEmails = [...newResponses, ...responseEmails];
                    renderResponseEmails();

                    if (autoRedirectEnabled) {
                        newResponses.forEach(response => {
                            redirectResponseEmail(response);
                        });
                    }

                    showAlert(`Found ${newResponses.length} new response(s)`, 'success');
                } else {
                    showAlert('No new responses found', 'info');
                }
            }, 1000);
        }

        function renderResponseEmails() {
            const container = document.getElementById('responseList');

            if (responseEmails.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #6b7280; padding: 20px;">
                        <div style="font-size: 24px; margin-bottom: 8px;">üì≠</div>
                        <div>No responses yet</div>
                        <small style="font-size: 10px;">Response emails will appear here</small>
                    </div>
                `;
                return;
            }

            const responsesHTML = responseEmails.slice(0, 5).map(response => `
                <div style="padding: 8px; margin-bottom: 8px; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 6px;">
                    <div style="font-weight: 500; font-size: 11px; color: #0369a1; margin-bottom: 2px;">
                        ${response.from}
                    </div>
                    <div style="font-size: 10px; color: #374151; margin-bottom: 4px;">
                        ${response.subject}
                    </div>
                    <div style="font-size: 9px; color: #6b7280;">
                        ${response.timestamp.toLocaleString()}
                    </div>
                    <div style="margin-top: 6px;">
                        <button onclick="redirectResponseEmail(${JSON.stringify(response).replace(/"/g, '&quot;')})" class="modern-btn" style="padding: 4px 8px; font-size: 9px; background: #3b82f6; color: white; border: none; border-radius: 4px;">
                            üì§ Forward
                        </button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = responsesHTML;
        }

        function redirectResponseEmail(response) {
            const redirectEmail = document.getElementById('redirectEmail').value;

            // Simulate email redirection
            showAlert(`Redirecting response from ${response.from} to ${redirectEmail}`, 'success');

            // In real implementation, this would actually forward the email
            console.log('Redirecting email:', {
                from: response.from,
                to: redirectEmail,
                subject: `Fwd: ${response.subject}`,
                content: response.content
            });
        }

        function toggleAutoRedirect() {
            autoRedirectEnabled = !autoRedirectEnabled;
            const button = document.getElementById('redirectBtn');

            if (autoRedirectEnabled) {
                button.textContent = '‚úì ON';
                button.style.background = '#10b981';
                showAlert('Auto-redirect enabled', 'success');
            } else {
                button.textContent = '‚úó OFF';
                button.style.background = '#6b7280';
                showAlert('Auto-redirect disabled', 'info');
            }
        }

        // Click outside to close panels
        document.addEventListener('click', function(event) {
            // Close color picker when clicking outside
            const colorPicker = document.getElementById('colorPicker');
            if (colorPicker && !event.target.closest('#colorPicker') && !event.target.closest('[onclick*="showColorPicker"]')) {
                colorPicker.style.display = 'none';
            }

            // Close response panel when clicking outside
            const responsePanel = document.getElementById('responsePanel');
            const responseManager = document.getElementById('responseEmailManager');
            if (responsePanel && !responseManager.contains(event.target)) {
                responsePanel.style.display = 'none';
            }
        });

        // Initialize analytics on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Simulate some initial email history for demo
            setTimeout(() => {
                addEmailToHistory('contact@abc-corp.com', 'sent', 'USA');
                addEmailToHistory('info@xyz-industries.net', 'sent', 'Canada');
                addEmailToHistory('hello@globalservices.org', 'failed', 'UK');
            }, 2000);
        });

    </script>
</body>
</html>