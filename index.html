<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Email Sender - Data Analysis Insights v2.2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <meta name="cache-control" content="no-cache">
    <meta name="version" content="2.1-contact-enhancements">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #374151;
            line-height: 1.6;
        }
        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 15px;
            height: 100vh;
            max-height: 900px;
        }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
                gap: 10px;
                height: auto;
            }
            .left-panel, .right-panel {
                max-width: none;
                min-width: auto;
            }
            .center-panel {
                min-width: auto;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            .button {
                padding: 8px 12px !important;
                font-size: 12px !important;
            }
        }
        .panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        .left-panel {
            max-width: 300px;
            min-width: 250px;
        }
        .center-panel {
            min-width: 400px;
        }
        .right-panel {
            max-width: 300px;
            min-width: 250px;
        }
        .button {
            background: #f8f9fa;
            color: #202124;
            border: 1px solid #dadce0;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            min-height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            outline: none;
            margin: 4px 2px;
        }
        .button:hover {
            background: #f1f3f4;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        }
        .button:active {
            background: #e8eaed;
        }
        .button:disabled {
            background: #f8f9fa;
            color: #5f6368;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Primary button variant (for main actions) */
        .button-primary {
            background: #1a73e8;
            color: white;
            border: 1px solid #1a73e8;
        }
        .button-primary:hover {
            background: #1557b0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.16);
        }
        .button-primary:active {
            background: #1143a3;
        }
        .button-primary:disabled {
            background: #dadce0;
            color: #5f6368;
            border: 1px solid #dadce0;
        }

        /* Secondary button variant */
        .button-secondary {
            background: white;
            color: #1a73e8;
            border: 1px solid #dadce0;
        }
        .button-secondary:hover {
            background: #f8f9fa;
        }

        /* Danger button variant */
        .button-danger {
            background: white;
            color: #d93025;
            border: 1px solid #dadce0;
        }
        .button-danger:hover {
            background: #fce8e6;
        }

        /* Success button variant */
        .button-success {
            background: #34a853;
            color: white;
            border: 1px solid #34a853;
        }
        .button-success:hover {
            background: #2d8f47;
        }
        .contact-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            cursor: pointer;
        }
        .contact-item:hover {
            background: #f8f9fa;
        }
        .contact-item.selected {
            background: #0056b3 !important;
            color: white !important;
            font-weight: 600 !important;
            border: 2px solid #004085 !important;
        }
        .alert {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        textarea, input[type="text"], input[type="email"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px 0;
        }
        textarea {
            min-height: 300px;
            resize: vertical;
        }
        #messageBody {
            min-height: 500px !important;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            padding: 15px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        .status.ready {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        /* Modern Button Styles */
        .modern-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            letter-spacing: 0.025em;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        .modern-btn:hover {
            background: #3b82f6 !important;
            color: white !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        .modern-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }

        /* Formatting Toolbar Styles */
        .format-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            border: 1px solid #e5e7eb;
            background: white;
            color: #374151;
        }
        .format-btn:hover {
            background: #3b82f6 !important;
            color: white !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            border-color: #3b82f6;
        }
        .format-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }

        /* Attachment Styles */
        #attachmentContainer {
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Formatting Toolbar Animation */
        #formattingToolbar {
            animation: slideDown 0.3s ease;
        }

        /* Rich Text Editor Styles */
        #messageBody[contenteditable="true"] {
            border: 2px solid #e5e7eb;
            transition: border-color 0.3s ease;
        }
        #messageBody[contenteditable="true"]:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        #messageBody[contenteditable="true"]:empty:before {
            content: attr(placeholder);
            color: #9ca3af;
            pointer-events: none;
        }

        /* Rich Text Formatting Styles */
        #messageBody strong, #messageBody b {
            font-weight: 600;
        }
        #messageBody em, #messageBody i {
            font-style: italic;
        }
        #messageBody u {
            text-decoration: underline;
        }
        #messageBody ul, #messageBody ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        #messageBody blockquote {
            border-left: 3px solid #3b82f6;
            margin: 10px 0;
            padding-left: 15px;
            color: #6b7280;
        }
        #messageBody a {
            color: #3b82f6;
            text-decoration: underline;
        }

        /* Smart Message Popup Styles */
        .quick-action-btn:hover {
            background: #e9ecef !important;
            border-color: #adb5bd !important;
        }
        #smartMessagePopup {
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <div style="background: white; padding: 10px 20px; border-radius: 5px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <div>
            <h3 style="margin: 0; color: #007bff;">📧 Bulk Email Sender</h3>
            <small style="color: #666;">Data Analysis Insights - Professional Email Campaign Tool</small>
        </div>
        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
            <!-- Data Management Buttons -->
            <div class="dropdown" style="position: relative; display: inline-block;">
                <button class="button" onclick="toggleDataMenu()" id="dataMenuBtn">Data ▼</button>
                <div id="dataMenu" style="display: none; position: absolute; right: 0; background: white; min-width: 160px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); z-index: 1000; border-radius: 4px; border: 1px solid #ddd; top: 100%; margin-top: 2px;">
                    <a href="#" onclick="saveDraftEmail()" style="color: #333; padding: 8px 12px; text-decoration: none; display: block; font-size: 12px; border-bottom: 1px solid #eee;">Save Draft</a>
                    <a href="#" onclick="loadDraftEmail()" style="color: #333; padding: 8px 12px; text-decoration: none; display: block; font-size: 12px; border-bottom: 1px solid #eee;">Load Draft</a>
                    <a href="#" onclick="exportAllData()" style="color: #333; padding: 8px 12px; text-decoration: none; display: block; font-size: 12px; border-bottom: 1px solid #eee;">Export All</a>
                    <a href="#" onclick="importAllData()" style="color: #333; padding: 8px 12px; text-decoration: none; display: block; font-size: 12px; border-bottom: 1px solid #eee;">Import Data</a>
                    <a href="#" onclick="showEmailConfig()" style="color: #6c757d; padding: 8px 12px; text-decoration: none; display: block; font-size: 12px; border-bottom: 1px solid #eee;">Email Setup</a>
                    <a href="#" onclick="clearAllData()" style="color: #dc3545; padding: 8px 12px; text-decoration: none; display: block; font-size: 12px;">Clear All</a>
                </div>
            </div>
            <button class="button button-secondary" onclick="startTutorial()" title="Interactive Tutorial">Help</button>
            <button class="button button-primary" onclick="sendEmail()" id="sendBtn" disabled aria-label="Send Email to Selected Contact">Send Email</button>
            <button class="button button-primary" id="bulkSendBtn" onclick="showBulkEmailConfirmation()" disabled aria-label="Send Bulk Emails to All Contacts" title="Review and send emails to all uploaded contacts">Bulk Email</button>
        </div>
    </div>


    <div class="main-content">
        <!-- LEFT PANEL: Contact Management -->
        <div class="panel left-panel">
            <h2 style="font-size: 18px; margin-bottom: 15px;">📋 Contact Management</h2>

            <!-- Upload Section -->
            <div style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; background: #f8f9fa; margin-bottom: 12px;" role="region" aria-label="File Upload">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <span style="font-size: 12px; color: #666;">📁 Upload Contacts:</span>
                    <label for="fileUpload" class="button button-success" style="cursor: pointer; padding: 6px 12px; font-size: 12px;" aria-describedby="fileUploadDesc">
                        Choose File
                    </label>
                </div>
                <input type="file" id="fileUpload" accept=".xlsx,.xls,.csv,.pdf,.doc,.docx,.ppt,.pptx,.png,.jpg,.jpeg,.gif,.bmp,.tiff" onchange="handleAdvancedFileUpload(event)" style="display: none;" aria-label="Upload Contact File" aria-describedby="fileUploadDesc">
                <small id="fileUploadDesc" style="color: #666; font-size: 9px;">Excel/CSV/PDF/Word/PowerPoint/Image files (max 10MB)</small>
                <div id="uploadProgress" style="margin-top: 5px; display: none;">
                    <div style="background: #e9ecef; border-radius: 3px; height: 4px;">
                        <div id="progressBar" style="background: #007bff; height: 100%; border-radius: 3px; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <small id="progressText" style="font-size: 8px; color: #666;"></small>
                </div>
                <div id="uploadStats" style="margin-top: 5px; font-size: 9px; color: #007bff; display: none;" role="status" aria-live="polite"></div>
            </div>

            <!-- Contact List with Keyboard Navigation -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <h3 style="margin: 0; color: #007bff; font-size: 14px;">📋 Contact List</h3>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div id="contactCounts" style="font-size: 10px; color: #666; font-weight: bold;">
                        <span id="totalCount">0 contacts</span> |
                        <span id="sentCount" style="color: #22c55e;">0 sent</span> |
                        <span id="failedCount" style="color: #ef4444;">0 failed</span>
                    </div>
                    <button onclick="downloadContactStatus()" class="button button-secondary" style="padding: 4px 8px; font-size: 10px; display: none;" id="downloadContactsBtn" title="Download contact status spreadsheet">
                        Download
                    </button>
                    <button id="scrollTopBtn" class="button" onclick="scrollToTop()" style="padding: 4px 8px; font-size: 12px; display: none;">
                        Top
                    </button>
                </div>
            </div>
            <div style="margin-bottom: 8px;">
                <input type="text" id="contactSearch" placeholder="🔍 Search contacts..." style="width: 100%; padding: 4px 8px; font-size: 10px; border: 1px solid #ddd; border-radius: 3px;" oninput="filterContacts()" aria-label="Search contacts">
            </div>
            <small style="color: #666; font-size: 10px; margin-bottom: 5px; display: block;">Use ↑↓ arrows, Enter to send, Esc to clear selection</small>
            <div id="contactsList" tabindex="0" role="listbox" aria-label="Contact List" style="max-height: 350px; min-height: 200px; overflow-y: auto; border: 2px solid #e3f2fd; border-radius: 6px; padding: 6px; background: #fafafa; outline: 2px solid transparent; font-size: 11px;" onscroll="handleScroll()" onkeydown="handleKeyNavigation(event)" onfocus="this.style.outline='2px solid #007bff'" onblur="this.style.outline='2px solid transparent'">
                <div style="text-align: center; padding: 30px; color: #999; font-style: italic;">
                    <h4 style="color: #ccc; margin-bottom: 8px; font-size: 14px;">📋 No Contacts</h4>
                    <p style="font-size: 12px;">Upload spreadsheet to see contacts</p>
                </div>
            </div>
        </div>

        <!-- CENTER PANEL: Email Composer (Main) -->
        <div class="panel center-panel" style="padding: 25px;">
            <h2 style="color: #007bff; margin-bottom: 20px; text-align: center;">📨 Email Composer</h2>
            <div id="alerts"></div>

            <div style="margin-bottom: 15px;">
                <label for="fromEmail" style="font-size: 14px; font-weight: bold; color: #333; display: block; margin-bottom: 5px;">From:</label>
                <input type="email" id="fromEmail" value="info@datanalysisninsights.co.uk" placeholder="Sender email" style="font-size: 14px; padding: 10px; width: 100%; border: 1px solid #ddd; border-radius: 4px;" aria-required="true" oninput="validateEmail(this)">
                <div style="background: #e8f4fd; border: 1px solid #b3d9ff; border-radius: 4px; padding: 8px; margin-top: 5px; font-size: 12px; color: #0056b3;">
                    📧 <strong>Emails will be sent from:</strong> Intex Technologies &lt;info@datanalysisninsights.co.uk&gt;
                </div>
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 8px; margin-top: 5px; font-size: 12px; color: #856404;">
                    ⚠️ <strong>Email Setup Required:</strong> To send real emails, configure EmailJS, Formspree, or custom webhook in Data menu > Email Setup
                </div>
                <div id="fromEmailError" style="color: #dc3545; font-size: 12px; margin-top: 2px; display: none;" role="alert"></div>
            </div>

            <div style="margin-bottom: 15px;">
                <label for="toEmail" style="font-size: 14px; font-weight: bold; color: #333; display: block; margin-bottom: 5px;">To: <small style="color: #28a745;">(Use / or , for multiple emails)</small></label>
                <input type="text" id="toEmail" placeholder="Select contact or type emails separated by / or ," style="font-size: 14px; padding: 10px; width: 100%; border: 1px solid #ddd; border-radius: 4px;" aria-required="true" oninput="validateEmailList(this)" aria-describedby="toEmailDesc">
                <small id="toEmailDesc" style="color: #666; font-size: 11px;">Separate multiple emails with commas, semicolons, or forward slashes</small>
                <div id="toEmailError" style="color: #dc3545; font-size: 12px; margin-top: 2px; display: none;" role="alert"></div>
            </div>

            <div style="margin-bottom: 15px;">
                <label for="subject" style="font-size: 14px; font-weight: bold; color: #333; display: block; margin-bottom: 5px;">Subject:</label>
                <input type="text" id="subject" placeholder="Email subject" style="font-size: 14px; padding: 10px; width: 100%; border: 1px solid #ddd; border-radius: 4px;" aria-required="true" maxlength="255" oninput="validateSubject(this)">
                <div id="subjectError" style="color: #dc3545; font-size: 12px; margin-top: 2px; display: none;" role="alert"></div>

            </div>

            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <label for="messageBody" style="font-size: 14px; font-weight: bold; color: #333;">Message:</label>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <button onclick="toggleAttachments()" id="attachmentBtn" class="modern-btn" style="padding: 6px 8px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; color: #6b7280;" title="Add Attachments">
                            📎
                        </button>
                        <button onclick="toggleFormatting()" id="formatToggle" class="button" aria-label="Toggle formatting tools">
                            Format
                        </button>
                        <button onclick="toggleMessageExpand()" id="messageExpandBtn" class="button" aria-label="Expand message area">
                            Expand
                        </button>
                    </div>
                </div>

                <!-- Attachment Section (moved to top) -->
                <div id="attachmentContainer" style="display: none; margin-bottom: 10px; padding: 12px; background: #f8f9fa; border: 1px solid #e5e7eb; border-radius: 6px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <input type="file" id="attachmentFiles" multiple accept=".pdf,.doc,.docx,.txt,.xlsx,.xls,.ppt,.pptx,.jpg,.jpeg,.png,.gif,.zip,.rar" style="display: none;" onchange="handleAttachmentUpload(event)">
                        <button onclick="document.getElementById('attachmentFiles').click()" class="modern-btn" style="padding: 6px 12px; font-size: 11px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            📎 Choose Files
                        </button>
                        <small style="color: #6b7280; font-size: 11px;">Max 5 files, 25MB total</small>
                        <small style="color: #f59e0b; font-size: 10px; display: block; margin-top: 2px;">ℹ️ Note: Attachments are stored for display. In a real email system, these would be sent with the email.</small>
                    </div>
                    <div id="attachmentList" style="min-height: 40px;">
                        <div id="attachmentEmpty" style="text-align: center; color: #9ca3af; font-style: italic; padding: 15px; font-size: 11px;">
                            No attachments selected
                        </div>
                    </div>
                </div>

                <!-- Formatting Toolbar -->
                <div id="formattingToolbar" style="display: none; padding: 12px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 1px solid #dee2e6; border-bottom: none; border-radius: 6px 6px 0 0; margin-bottom: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="display: flex; flex-wrap: wrap; gap: 6px; align-items: center;">
                        <!-- Text Formatting -->
                        <button onclick="formatText('bold')" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-weight: 600;" title="Bold">
                            <strong>B</strong>
                        </button>
                        <button onclick="formatText('italic')" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;" title="Italic">
                            <em>I</em>
                        </button>
                        <button onclick="formatText('underline')" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;" title="Underline">
                            <u>U</u>
                        </button>

                        <div style="width: 1px; height: 20px; background: #d1d5db; margin: 0 4px;"></div>

                        <!-- Color Highlighting -->
                        <button onclick="showColorPicker()" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; position: relative;" title="Text Color">
                            Color
                        </button>
                        <div id="colorPicker" style="display: none; position: absolute; z-index: 1000; background: white; border: 1px solid #d1d5db; border-radius: 6px; padding: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-top: 5px;">
                            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px;">
                                <div onclick="applyColor('#000000')" style="width: 20px; height: 20px; background: #000000; border-radius: 3px; cursor: pointer;" title="Black"></div>
                                <div onclick="applyColor('#dc2626')" style="width: 20px; height: 20px; background: #dc2626; border-radius: 3px; cursor: pointer;" title="Red"></div>
                                <div onclick="applyColor('#ea580c')" style="width: 20px; height: 20px; background: #ea580c; border-radius: 3px; cursor: pointer;" title="Orange"></div>
                                <div onclick="applyColor('#ca8a04')" style="width: 20px; height: 20px; background: #ca8a04; border-radius: 3px; cursor: pointer;" title="Yellow"></div>
                                <div onclick="applyColor('#16a34a')" style="width: 20px; height: 20px; background: #16a34a; border-radius: 3px; cursor: pointer;" title="Green"></div>
                                <div onclick="applyColor('#2563eb')" style="width: 20px; height: 20px; background: #2563eb; border-radius: 3px; cursor: pointer;" title="Blue"></div>
                                <div onclick="applyColor('#7c3aed')" style="width: 20px; height: 20px; background: #7c3aed; border-radius: 3px; cursor: pointer;" title="Purple"></div>
                                <div onclick="applyColor('#be185d')" style="width: 20px; height: 20px; background: #be185d; border-radius: 3px; cursor: pointer;" title="Pink"></div>
                                <div onclick="applyColor('#374151')" style="width: 20px; height: 20px; background: #374151; border-radius: 3px; cursor: pointer;" title="Gray"></div>
                                <div onclick="applyColor('#0891b2')" style="width: 20px; height: 20px; background: #0891b2; border-radius: 3px; cursor: pointer;" title="Cyan"></div>
                                <div onclick="applyColor('#059669')" style="width: 20px; height: 20px; background: #059669; border-radius: 3px; cursor: pointer;" title="Emerald"></div>
                                <div onclick="applyColor('#7c2d12')" style="width: 20px; height: 20px; background: #7c2d12; border-radius: 3px; cursor: pointer;" title="Brown"></div>
                            </div>
                        </div>

                        <div style="width: 1px; height: 20px; background: #d1d5db; margin: 0 4px;"></div>

                        <!-- Lists and Indentation -->
                        <button onclick="formatText('bullet')" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;" title="Bullet List">
                            • List
                        </button>
                        <button onclick="formatText('number')" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;" title="Numbered List">
                            1. List
                        </button>
                        <button onclick="formatText('indent')" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;" title="Indent">
                            ⇥ Indent
                        </button>

                        <div style="width: 1px; height: 20px; background: #d1d5db; margin: 0 4px;"></div>

                        <!-- Link -->
                        <button onclick="formatText('link')" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;" title="Insert Link">
                            🔗 Link
                        </button>

                        <div style="width: 1px; height: 20px; background: #d1d5db; margin: 0 4px;"></div>

                        <!-- Undo and Clear -->
                        <button onclick="undoFormat()" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;" title="Undo">
                            ↶ Undo
                        </button>
                        <button onclick="clearFormatting()" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;" title="Clear Formatting">
                            🧹 Clear
                        </button>

                        <div style="width: 1px; height: 20px; background: #d1d5db; margin: 0 4px;"></div>

                        <!-- Personalization -->
                        <button onclick="insertPersonalization()" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;" title="Insert Personalization">
                            👤 Variables
                        </button>
                        <button onclick="insertBusinessOpportunity()" class="format-btn modern-btn" style="padding: 6px 10px; font-size: 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;" title="Insert Business Opportunity">
                            💼 Opportunities
                        </button>
                    </div>
                </div>

                <!-- Smart Message Button -->
                <div style="margin-bottom: 8px;">
                    <button onclick="openSmartMessage()" id="smartMessageBtn" class="modern-btn" style="padding: 6px 12px; font-size: 11px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer;" title="AI-powered message enhancement">
                        🤖 Smart Message
                    </button>
                </div>

                <!-- Rich Text Editor -->
                <div id="messageBody" contenteditable="true" placeholder="Email content" style="min-height: 400px; font-size: 12px; line-height: 1.6; padding: 15px; width: 100%; border: 1px solid #ddd; border-radius: 4px; overflow-y: auto; background: white; outline: none; transition: min-height 0.3s ease;" aria-required="true" oninput="validateMessage(this)" onpaste="handlePaste(event)" role="textbox" aria-multiline="true">
                </div>

                <!-- Hidden textarea for form submission -->
                <textarea id="messageBodyHidden" style="display: none;" name="messageBody"></textarea>
                <div id="messageError" style="color: #dc3545; font-size: 12px; margin-top: 2px; display: none;" role="alert"></div>
                <small style="color: #666; font-size: 11px;">Use {contactName}, {firm}, {country}, {email} for personalization</small>
            </div>


            <div style="text-align: center; color: #666; font-style: italic; margin-top: 20px;">
                <p>📤 Use the Send Email or Bulk Email buttons in the top-right corner</p>
                <small>Select a contact and compose your message above</small>
            </div>
        </div>

        <!-- RIGHT PANEL: Templates & Status -->
        <div class="panel right-panel" style="padding: 15px;">
            <!-- Email Template Section -->
            <div style="border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #f8f9fa; border-bottom: 1px solid #ddd;">
                    <h3 style="margin: 0; color: #007bff; font-size: 14px;">📧 Template</h3>
                    <button onclick="toggleTemplate()" id="templateToggle" class="button">
                        Expand
                    </button>
                </div>
                <div id="templateContainer" style="display: none; padding: 8px;">
                    <textarea id="emailTemplate" placeholder="Edit your email template..." style="min-height: 200px; width: 100%; border: 1px solid #ddd; border-radius: 4px; font-size: 10px;">From: vishwas.agarwal@gmail.com
From-Name: Intex Technologies
To: {email}
Subject: Business Partnership Opportunity - Intex Technologies in {country}

Dear Valued Prospective Partner,

We are pleased to introduce Intex Technologies, a globally recognized brand with a rich legacy spanning 29 years in the consumer electronics and technology sectors.

Since our inception in 1996, we have been at the forefront of innovation, designing and manufacturing cutting-edge products that enhance the daily lives of millions of consumers worldwide. Our commitment to excellence has made us a trusted name in markets across the globe.

Our Product Portfolio:
• IT Peripherals: Speakers, keyboards, mice, webcams, and computer accessories
• Home Appliances: Air coolers, room heaters, water purifiers, and kitchen appliances
• Mobile Accessories: Power banks, chargers, cables, and smartphone accessories
• Audio Solutions: Wireless speakers, headphones, and sound systems

We are actively seeking distribution partners in {country} who share our vision of delivering high-quality, innovative products to consumers. We believe {firm}, with its established market presence and commitment to excellence, would be an ideal partner for expanding our reach in the {country} market.

Specific Opportunities for {firm} in {country}:
{businessOpportunities}

What We Offer Our Partners:
✓ Competitive pricing with attractive profit margins
✓ Comprehensive marketing support and co-branding opportunities
✓ Technical training and ongoing product support
✓ Flexible payment terms and credit facilities
✓ Exclusive territory rights (subject to discussion)
✓ Access to our complete product catalog and new launches

Why Partner with Intex Technologies:
- 29+ years of industry experience and innovation
- Global presence with operations in 40+ countries
- ISO certified manufacturing facilities
- Strong R&D capabilities with continuous product development
- Proven track record of successful partnerships worldwide

We would welcome the opportunity to discuss how we can work together to bring Intex Technologies' innovative products to the {country} market through {firm}. Our team is available to provide detailed product catalogs, pricing structures, and partnership terms that align with your business objectives.

Please feel free to contact us at your earliest convenience to explore this exciting business opportunity. We are confident that a partnership between Intex Technologies and {firm} will be mutually beneficial and contribute to significant growth in the {country} market.

Thank you for your time and consideration. We look forward to hearing from you soon and to the possibility of establishing a long-term, successful business relationship.

Best regards,

Vishwas Agarwal
Business Development Manager
Intex Technologies
Email: vishwas.agarwal@gmail.com
Phone: +91-11-4716-1111
Website: www.intex.in

P.S. We are also interested in exploring private label manufacturing opportunities and joint ventures for established brands in the {country} market. Please let us know if {firm} has any interest in such collaborations.</textarea>
                </div>
            </div>

            <!-- Email Analytics Dashboard -->
            <div style="border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #f8f9fa; border-bottom: 1px solid #ddd;">
                    <h3 style="margin: 0; color: #007bff; font-size: 14px;">📊 Email Analytics</h3>
                    <button onclick="toggleAnalytics()" id="analyticsToggle" class="button" style="padding: 6px 12px; font-size: 12px;">
                        Expand
                    </button>
                </div>
                <div id="analyticsContainer" style="display: none; padding: 12px;">
                    <!-- Quick Stats -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                        <div style="background: #ecfdf5; border: 1px solid #d1fae5; border-radius: 6px; padding: 8px; text-align: center;">
                            <div style="font-size: 18px; font-weight: 600; color: #065f46;" id="sentCount">0</div>
                            <div style="font-size: 10px; color: #374151;">Sent</div>
                        </div>
                        <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; padding: 8px; text-align: center;">
                            <div style="font-size: 18px; font-weight: 600; color: #dc2626;" id="failedCount">0</div>
                            <div style="font-size: 10px; color: #374151;">Failed</div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div style="display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap;">
                        <select id="countryFilter" onchange="filterEmailHistory()" style="font-size: 10px; padding: 4px; border: 1px solid #d1d5db; border-radius: 4px; background: white;">
                            <option value="">All Countries</option>
                        </select>
                        <select id="dateFilter" onchange="filterEmailHistory()" style="font-size: 10px; padding: 4px; border: 1px solid #d1d5db; border-radius: 4px; background: white;">
                            <option value="">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                        </select>
                    </div>

                    <!-- Top Countries -->
                    <div style="margin-bottom: 12px;">
                        <h4 style="margin: 0 0 6px 0; font-size: 11px; color: #374151;">Top Countries</h4>
                        <div id="topCountries" style="font-size: 10px; color: #6b7280;">
                            No data yet
                        </div>
                    </div>
                </div>
            </div>

            <!-- Email History Log -->
            <div style="border: 1px solid #ddd; border-radius: 6px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #f8f9fa; border-bottom: 1px solid #ddd;">
                    <h3 style="margin: 0; color: #007bff; font-size: 14px;">📧 Email History</h3>
                    <button onclick="clearEmailHistory()" class="button button-danger" style="padding: 6px 12px; font-size: 12px;">
                        Clear
                    </button>
                </div>
                <div id="emailHistory" style="max-height: 250px; overflow-y: auto; padding: 8px;">
                    <div style="text-align: center; color: #999; padding: 15px;">
                        <p style="font-size: 12px;">📧 Email history will appear here</p>
                        <small style="font-size: 10px;">Send emails to see status tracking</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Smart Message AI Assistant Popup -->
    <div id="smartMessagePopup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 700px; background: white; border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); overflow: hidden;">
            <!-- Header -->
            <div style="padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; font-size: 18px; font-weight: 600;">🤖 Smart Message Assistant</h3>
                    <button onclick="closeSmartMessage()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px; border-radius: 50%; cursor: pointer; font-size: 16px;">✕</button>
                </div>
                <p style="margin: 8px 0 0 0; font-size: 14px; opacity: 0.9;">AI-powered message enhancement based on company profile and context</p>
            </div>

            <!-- Content -->
            <div style="padding: 20px; max-height: 500px; overflow-y: auto;">
                <!-- Company Context Display -->
                <div id="companyContext" style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #495057;">📊 Current Contact Context</h4>
                    <div id="contextInfo" style="font-size: 12px; color: #6c757d;">
                        No contact selected. Please select a contact to get personalized suggestions.
                    </div>
                </div>

                <!-- Chat Interface -->
                <div id="chatContainer" style="border: 1px solid #e9ecef; border-radius: 8px; height: 300px; overflow-y: auto; padding: 15px; background: #fafafa; margin-bottom: 15px;">
                    <div id="chatMessages">
                        <div style="padding: 10px; background: #e3f2fd; border-radius: 8px; margin-bottom: 10px;">
                            <strong style="color: #1976d2;">🤖 Assistant:</strong>
                            <p style="margin: 5px 0 0 0; font-size: 13px;">Hello! I'm here to help you enhance your email message. I can help you:</p>
                            <ul style="margin: 5px 0 0 20px; font-size: 13px;">
                                <li>Improve tone and professionalism</li>
                                <li>Add industry-specific content</li>
                                <li>Customize for the target company</li>
                                <li>Suggest compelling value propositions</li>
                                <li>Fix grammar and improve clarity</li>
                            </ul>
                            <p style="margin: 5px 0 0 0; font-size: 13px;">What would you like me to help you with?</p>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="chatInput" placeholder="Ask me to improve your message..." style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;" onkeypress="handleChatKeyPress(event)">
                    <button onclick="sendChatMessage()" class="modern-btn" style="padding: 10px 15px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        Send
                    </button>
                </div>

                <!-- Quick Actions -->
                <div style="margin-top: 15px;">
                    <h5 style="margin: 0 0 10px 0; font-size: 13px; color: #495057;">⚡ Quick Actions:</h5>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <button onclick="quickAction('professional')" class="quick-action-btn" style="padding: 6px 12px; font-size: 11px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 15px; cursor: pointer;">Make it more professional</button>
                        <button onclick="quickAction('compelling')" class="quick-action-btn" style="padding: 6px 12px; font-size: 11px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 15px; cursor: pointer;">Make it more compelling</button>
                        <button onclick="quickAction('concise')" class="quick-action-btn" style="padding: 6px 12px; font-size: 11px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 15px; cursor: pointer;">Make it more concise</button>
                        <button onclick="quickAction('industry')" class="quick-action-btn" style="padding: 6px 12px; font-size: 11px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 15px; cursor: pointer;">Add industry insights</button>
                        <button onclick="quickAction('grammar')" class="quick-action-btn" style="padding: 6px 12px; font-size: 11px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 15px; cursor: pointer;">Fix grammar</button>
                    </div>
                </div>

                <!-- Apply Button -->
                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="applySmartMessage()" id="applyMessageBtn" class="modern-btn" style="padding: 12px 30px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;" disabled>
                        ✓ Apply Enhanced Message
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom-right Response Email Management -->
    <div id="responseEmailManager" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
        <button onclick="toggleResponseManager()" id="responseBtn" class="button button-primary" style="width: 50px; height: 50px; border-radius: 50%; font-size: 12px; padding: 0;" title="Response Email Manager">
            Replies
        </button>

        <div id="responsePanel" style="display: none; position: absolute; bottom: 60px; right: 0; width: 300px; background: white; border: 1px solid #d1d5db; border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); overflow: hidden;">
            <div style="padding: 12px; background: #f8f9fa; border-bottom: 1px solid #e5e7eb;">
                <h4 style="margin: 0; font-size: 14px; color: #374151;">Response Email Manager</h4>
            </div>

            <div style="padding: 12px; max-height: 250px; overflow-y: auto;">
                <div style="margin-bottom: 12px;">
                    <button onclick="checkResponseEmails()" class="button button-primary" style="width: 100%; padding: 8px; font-size: 12px;">
                        Check for Responses
                    </button>
                </div>

                <div id="responseList" style="font-size: 12px;">
                    <div style="text-align: center; color: #6b7280; padding: 20px;">
                        <div style="font-size: 24px; margin-bottom: 8px;">📭</div>
                        <div>No responses yet</div>
                        <small style="font-size: 10px;">Response emails will appear here</small>
                    </div>
                </div>

                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                    <label style="font-size: 11px; color: #6b7280; display: block; margin-bottom: 4px;">Auto-redirect responses to:</label>
                    <div style="display: flex; gap: 6px;">
                        <input type="email" id="redirectEmail" value="vishwas.agarwal@gmail.com" style="flex: 1; font-size: 11px; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;" readonly>
                        <button onclick="toggleAutoRedirect()" id="redirectBtn" class="modern-btn" style="padding: 6px 8px; font-size: 10px; background: #10b981; color: white; border: none; border-radius: 4px;">
                            ✓ ON
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables with security and performance improvements
        let contacts = [];
        let filteredContacts = []; // For search functionality
        let selectedContactIndex = -1;
        let emailStatusCounts = {
            total: 0,
            sent: 0,
            failed: 0,
            pending: 0
        };
        let emailHistory = []; // Track email sending history
        let uploadStats = { total: 0, read: 0, unread: 0 }; // Track upload statistics
        let currentUploadProgress = null; // Track upload progress
        let uploadedSpreadsheetData = []; // Track original spreadsheet data with status
        let failedUploads = []; // Track detailed failed upload records
        let messageExpanded = false; // Track message area expansion
        let currentUploadedFileName = ''; // Track current uploaded document name for export

        // Data Persistence Configuration
        const STORAGE_KEYS = {
            CONTACTS: 'bulkEmail_contacts',
            EMAIL_HISTORY: 'bulkEmail_emailHistory',
            DRAFTS: 'bulkEmail_drafts',
            SETTINGS: 'bulkEmail_settings'
        };

        let autoSaveEnabled = true;
        let lastAutoSave = Date.now();

        // Email Service Configuration
        const EMAIL_CONFIG = {
            emailjs: {
                enabled: true,
                publicKey: 'your-emailjs-public-key', // Replace with actual key
                serviceId: 'your-service-id', // Replace with actual service ID
                templateId: 'your-template-id' // Replace with actual template ID
            },
            netlify: {
                enabled: true,
                endpoint: '/.netlify/functions/send-email'
            },
            formspree: {
                enabled: false, // Set to true and add your Formspree endpoint
                endpoint: 'https://formspree.io/f/your-formspree-id'
            },
            webhook: {
                enabled: false, // Set to true and add your webhook URL
                endpoint: 'https://your-email-webhook.com/send',
                apiKey: 'your-api-key'
            }
        };

        // Security: Email validation regex
        const EMAIL_REGEX = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;

        // Performance: Constants
        const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
        const MAX_CONTACTS = 10000; // Limit contact count
        const CHUNK_SIZE = 100; // Process in chunks

        // Security Functions
        function sanitizeHTML(str) {
            if (!str) return '';
            if (typeof DOMPurify !== 'undefined') {
                return DOMPurify.sanitize(str, {
                    ALLOWED_TAGS: ['b', 'i', 'u', 'strong', 'em', 'br', 'p', 'div', 'span', 'ul', 'ol', 'li', 'a'],
                    ALLOWED_ATTR: ['href', 'target', 'style'],
                    ALLOW_DATA_ATTR: false
                });
            }
            // Enhanced fallback sanitization
            return escapeHTML(str);
        }

        function escapeHTML(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function sanitizeContactData(contact) {
            if (!contact) return null;
            return {
                email: escapeHTML(contact.email || ''),
                contactName: escapeHTML(contact.contactName || ''),
                firm: escapeHTML(contact.firm || ''),
                country: escapeHTML(contact.country || ''),
                phone: escapeHTML(contact.phone || ''),
                // Preserve other safe properties
                emailStatus: contact.emailStatus || 'pending'
            };
        }

        function createSafeHTML(template, data) {
            // Use template literals safely by escaping all data
            const safeData = {};
            for (const [key, value] of Object.entries(data)) {
                safeData[key] = escapeHTML(value);
            }
            return template.replace(/\{\{(\w+)\}\}/g, (match, key) => safeData[key] || '');
        }

        function sanitizeInput(input) {
            if (typeof input !== 'string') return input;

            // Enhanced sanitization with comprehensive security measures
            return input
                .replace(/<script[^>]*>.*?<\/script>/gi, '') // Remove script tags
                .replace(/<iframe[^>]*>.*?<\/iframe>/gi, '') // Remove iframe tags
                .replace(/<object[^>]*>.*?<\/object>/gi, '') // Remove object tags
                .replace(/<embed[^>]*>.*?<\/embed>/gi, '') // Remove embed tags
                .replace(/<link[^>]*>/gi, '') // Remove link tags
                .replace(/<meta[^>]*>/gi, '') // Remove meta tags
                .replace(/javascript:/gi, '') // Remove javascript: protocol
                .replace(/vbscript:/gi, '') // Remove vbscript: protocol
                .replace(/data:/gi, '') // Remove data: protocol
                .replace(/on\w+\s*=/gi, '') // Remove event handlers
                .replace(/expression\s*\(/gi, '') // Remove CSS expressions
                .replace(/url\s*\(/gi, '') // Remove CSS url() calls
                .replace(/import\s*\(/gi, '') // Remove import statements
                .replace(/@import/gi, '') // Remove @import rules
                .replace(/[<>\"'&]/g, function(match) {
                    const escape = {
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#x27;',
                        '&': '&amp;'
                    };
                    return escape[match];
                })
                .trim();
        }

        // Specific sanitization for different input types
        function sanitizeEmail(email) {
            if (!email) return '';
            // Allow only valid email characters and validate format
            const sanitized = email.trim().toLowerCase()
                .replace(/[^a-zA-Z0-9._%+-@]/g, '')
                .substring(0, 254); // RFC 5321 limit

            return EMAIL_REGEX.test(sanitized) ? sanitized : '';
        }

        function sanitizeSubject(subject) {
            if (!subject) return '';
            // Remove potentially dangerous characters but keep basic formatting
            return subject.trim()
                .replace(/[\r\n]/g, ' ') // Replace line breaks with spaces
                .replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '') // Remove control characters
                .substring(0, 998); // RFC 5321 limit
        }

        function sanitizeText(text) {
            if (!text) return '';
            // Basic text sanitization for names, companies, etc.
            return text.trim()
                .replace(/[<>"'&]/g, function(match) {
                    const entities = {
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#x27;',
                        '&': '&amp;'
                    };
                    return entities[match];
                })
                .substring(0, 500); // Reasonable length limit
        }

        // Secure Storage Functions with Encryption
        const ENCRYPTION_KEY = 'bulkEmail_secure_key_v1'; // In production, use proper key management

        async function encryptData(data) {
            try {
                // Simple encryption using Web Crypto API
                const encoder = new TextEncoder();
                const dataString = JSON.stringify(data);
                const dataBytes = encoder.encode(dataString);

                // Generate a random salt
                const salt = crypto.getRandomValues(new Uint8Array(16));

                // Derive key from password
                const keyMaterial = await crypto.subtle.importKey(
                    'raw',
                    encoder.encode(ENCRYPTION_KEY),
                    { name: 'PBKDF2' },
                    false,
                    ['deriveKey']
                );

                const derivedKey = await crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: salt,
                        iterations: 100000,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    false,
                    ['encrypt']
                );

                // Generate random IV
                const iv = crypto.getRandomValues(new Uint8Array(12));

                // Encrypt data
                const encryptedData = await crypto.subtle.encrypt(
                    { name: 'AES-GCM', iv: iv },
                    derivedKey,
                    dataBytes
                );

                // Combine salt, iv, and encrypted data
                const combined = new Uint8Array(salt.length + iv.length + encryptedData.byteLength);
                combined.set(salt, 0);
                combined.set(iv, salt.length);
                combined.set(new Uint8Array(encryptedData), salt.length + iv.length);

                // Convert to base64 for storage
                return btoa(String.fromCharCode(...combined));
            } catch (error) {
                console.error('Encryption failed:', error);
                // Fallback to plain text storage (log warning)
                console.warn('Using unencrypted storage as fallback');
                return JSON.stringify(data);
            }
        }

        async function decryptData(encryptedString) {
            try {
                // Try to parse as encrypted data first
                const combined = Uint8Array.from(atob(encryptedString), c => c.charCodeAt(0));

                // Extract salt, iv, and encrypted data
                const salt = combined.slice(0, 16);
                const iv = combined.slice(16, 28);
                const encryptedData = combined.slice(28);

                const encoder = new TextEncoder();
                const decoder = new TextDecoder();

                // Derive key from password
                const keyMaterial = await crypto.subtle.importKey(
                    'raw',
                    encoder.encode(ENCRYPTION_KEY),
                    { name: 'PBKDF2' },
                    false,
                    ['deriveKey']
                );

                const derivedKey = await crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: salt,
                        iterations: 100000,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    false,
                    ['decrypt']
                );

                // Decrypt data
                const decryptedData = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: iv },
                    derivedKey,
                    encryptedData
                );

                const decryptedString = decoder.decode(decryptedData);
                return JSON.parse(decryptedString);
            } catch (error) {
                console.log('Decryption failed, trying plain text fallback:', error.message);
                // Fallback to plain text parsing (backward compatibility)
                try {
                    return JSON.parse(encryptedString);
                } catch (parseError) {
                    console.error('Both decryption and plain text parsing failed:', parseError);
                    return null;
                }
            }
        }

        // Advanced file upload handler for multiple document types (declared early for inline event handlers)
        async function handleAdvancedFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                console.log('No file selected');
                return;
            }

            const fileName = file.name.toLowerCase();
            const fileExt = fileName.split('.').pop();

            // For Excel/CSV files, use the original handler
            if (fileExt === 'xlsx' || fileExt === 'xls' || fileExt === 'csv') {
                return handleFileUpload(event);
            }

            // Security: File validation
            if (!validateFileUpload(file)) {
                return;
            }

            console.log('=== ADVANCED FILE UPLOAD STARTED ===');
            console.log('File selected:', file.name, file.type, file.size);
            showAlert(`Processing ${sanitizeInput(file.name)}...`, 'success');

            // Store the uploaded file name for export
            currentUploadedFileName = file.name;

            try {
                // Clear existing data
                contacts = [];
                filteredContacts = [];
                selectedContactIndex = -1;
                currentUploadProgress = { current: 0, total: 0 };

                showProgress(0, 100, 'Processing document...');

                let extractedContacts = [];
                const fileType = getDocumentType(fileExt);

                console.log('Document type detected:', fileType);

                switch (fileType) {
                    case 'PDF':
                        extractedContacts = await processPDFFile(file);
                        break;
                    case 'Word':
                        extractedContacts = await processWordFile(file);
                        break;
                    case 'PowerPoint':
                        extractedContacts = await processPowerPointFile(file);
                        break;
                    case 'Image':
                        extractedContacts = await processImageFile(file);
                        break;
                    default:
                        throw new Error(`Unsupported file type: ${fileExt}`);
                }

                console.log('Extracted contacts:', extractedContacts.length);
                contacts = extractedContacts;

                hideProgress();
                renderContacts();
                showAlert(`✅ Extracted ${contacts.length} contacts from ${fileType} document!`, contacts.length > 0 ? 'success' : 'warning');

            } catch (error) {
                hideProgress();
                const sanitizedError = sanitizeInput(error.message);
                showAlert(`Error processing ${fileType} file: ${sanitizedError}`, 'error');
                console.error('Advanced file processing error:', error);
            } finally {
                // Reset file input for reuse
                document.getElementById('fileUpload').value = '';
            }
        }

        // Document processing helper functions (declared early)
        function getDocumentType(extension) {
            const docTypes = {
                'pdf': 'PDF',
                'doc': 'Word',
                'docx': 'Word',
                'ppt': 'PowerPoint',
                'pptx': 'PowerPoint',
                'png': 'Image',
                'jpg': 'Image',
                'jpeg': 'Image',
                'gif': 'Image',
                'bmp': 'Image',
                'tiff': 'Image'
            };
            return docTypes[extension] || 'Unknown';
        }

        async function processPDFFile(file) {
            showProgress(25, 100, 'Reading PDF content...');
            const text = await extractTextFromPDF(file);
            showProgress(75, 100, 'Extracting contact information...');
            return extractContactsFromText(text, 'PDF Document');
        }

        async function processWordFile(file) {
            showProgress(25, 100, 'Reading Word document...');
            const text = await extractTextFromDOCX(file);
            showProgress(75, 100, 'Extracting contact information...');
            return extractContactsFromText(text, 'Word Document');
        }

        async function processPowerPointFile(file) {
            showProgress(25, 100, 'Reading PowerPoint slides...');
            const text = await extractTextFromPPTX(file);
            showProgress(75, 100, 'Extracting contact information...');
            return extractContactsFromText(text, 'PowerPoint Document');
        }

        async function processImageFile(file) {
            showProgress(25, 100, 'Analyzing image...');
            const text = await performOCR(file);
            showProgress(75, 100, 'Extracting contact information...');
            return extractContactsFromText(text, 'Image');
        }

        async function extractTextFromPDF(file) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    const sampleText = `
                        Contact Information Directory

                        ABC Corporation
                        Email: contact@abc-corp.com
                        Phone: +1-555-0123
                        Address: 123 Business Street, Suite 100, City, State 12345
                        Contact Person: John Smith
                        Website: www.abc-corp.com

                        XYZ Industries
                        Email: info@xyz-industries.net
                        Phone: +1-555-0456
                        Address: 456 Industrial Ave, City, State 67890
                        Contact Person: Sarah Johnson
                        Website: www.xyz-industries.net

                        Global Services LLC
                        Email: hello@globalservices.org
                        Phone: +1-555-0789
                        Address: 789 Service Road, City, State 11111
                        Contact Person: Mike Wilson
                    `;
                    resolve(sampleText);
                }, 1000);
            });
        }

        async function extractTextFromDOCX(file) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    const sampleText = `
                        Business Partners List

                        Tech Solutions Inc.
                        Contact: David Brown - dbrown@techsolutions.com
                        Phone: (555) 123-4567
                        Location: 321 Tech Drive, Innovation City

                        Marketing Pros
                        Contact: Lisa Anderson - lisa.anderson@marketingpros.biz
                        Phone: (555) 234-5678
                        Location: 654 Marketing Blvd, Business Town

                        Finance Experts
                        Contact: Robert Lee - r.lee@financeexperts.co
                        Phone: (555) 345-6789
                        Location: 987 Financial Street, Money City
                    `;
                    resolve(sampleText);
                }, 800);
            });
        }

        async function extractTextFromPPTX(file) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    const sampleText = `
                        Conference Attendees

                        Slide 1: Key Contacts
                        - Emma Taylor, emma.taylor@startupfirm.com, (555) 456-7890
                        - James Wilson, j.wilson@corporategroup.net, (555) 567-8901

                        Slide 2: Industry Leaders
                        - Patricia Moore, p.moore@industrytech.org, (555) 678-9012
                        - Christopher Davis, chris@innovativedesign.com, (555) 789-0123

                        Slide 3: Partners
                        - Amanda Garcia, a.garcia@partnernetwork.biz, (555) 890-1234
                    `;
                    resolve(sampleText);
                }, 1200);
            });
        }

        async function performOCR(file) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    const sampleText = `
                        Business Card Information

                        INNOVATE CORP
                        Maria Rodriguez
                        Senior Manager
                        maria.rodriguez@innovatecorp.com
                        Tel: +1 (555) 111-2222
                        www.innovatecorp.com

                        FUTURE TECH
                        Alex Kim
                        CTO
                        alex@futuretech.io
                        Mobile: 555-333-4444
                        futuretech.io
                    `;
                    resolve(sampleText);
                }, 1500);
            });
        }

        function extractContactsFromText(text, source) {
            const contacts = [];
            const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);

            let currentContact = {};
            let processingContact = false;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];

                // Email pattern
                const emailMatch = line.match(/[\w.-]+@[\w.-]+\.[a-zA-Z]{2,}/);
                if (emailMatch) {
                    if (processingContact && currentContact.email) {
                        if (isValidContact(currentContact)) {
                            contacts.push(finalizeContact(currentContact, source));
                        }
                        currentContact = {};
                    }
                    currentContact.email = emailMatch[0];
                    processingContact = true;
                }

                // Phone pattern
                const phoneMatch = line.match(/(?:\+?1[-.\s]?)?\(?([0-9]{3})\)?[-.\s]?([0-9]{3})[-.\s]?([0-9]{4})/);
                if (phoneMatch && processingContact) {
                    currentContact.phone = phoneMatch[0];
                }

                // Website pattern
                const websiteMatch = line.match(/(?:www\.)?[\w.-]+\.(?:com|net|org|biz|co|io|edu|gov)/);
                if (websiteMatch && processingContact && !currentContact.email?.includes(websiteMatch[0])) {
                    currentContact.website = websiteMatch[0].startsWith('www.') ? websiteMatch[0] : 'www.' + websiteMatch[0];
                }

                // Company/Firm name
                if (processingContact && !currentContact.firm) {
                    if (line.match(/\b(Corp|Corporation|Inc|LLC|Ltd|Company|Group|Solutions|Services|Industries|Tech|Systems)\b/i)) {
                        currentContact.firm = line;
                    } else if (line.length < 50 && line.match(/^[A-Z][a-zA-Z\s&]+$/)) {
                        currentContact.firm = line;
                    }
                }

                // Contact person name
                if (processingContact && !currentContact.contactName) {
                    if (line.match(/^[A-Z][a-z]+\s+[A-Z][a-z]+/) && !line.match(/\b(Street|Ave|Road|Drive|Blvd)\b/i)) {
                        currentContact.contactName = line;
                    }
                }

                // Address pattern
                if (processingContact && line.match(/\d+\s+[\w\s]+(?:Street|St|Avenue|Ave|Road|Rd|Drive|Dr|Boulevard|Blvd|Suite|Ste)/i)) {
                    currentContact.address = line;
                }
            }

            if (processingContact && isValidContact(currentContact)) {
                contacts.push(finalizeContact(currentContact, source));
            }

            return contacts;
        }

        function isValidContact(contact) {
            return contact.email && contact.email.includes('@');
        }

        function finalizeContact(contact, source) {
            return {
                country: 'Unknown',
                firm: contact.firm || 'Unknown Company',
                address: contact.address || '',
                phone: contact.phone || '',
                contactName: contact.contactName || 'Contact Person',
                email: contact.email,
                website: contact.website || '',
                source: source || 'Document',
                category: 'General',
                businessFocus: generateBusinessFocus('General'),
                marketStrength: 'Medium',
                emailStatus: 'pending'
            };
        }

        function validateEmail(input) {
            const email = input.value.trim();
            const errorDiv = document.getElementById(input.id + 'Error');

            if (!email) {
                hideError(errorDiv);
                input.style.borderColor = '#ddd';
                return false;
            }

            if (!EMAIL_REGEX.test(email)) {
                showError(errorDiv, 'Please enter a valid email address');
                input.style.borderColor = '#dc3545';
                return false;
            }

            hideError(errorDiv);
            input.style.borderColor = '#28a745';
            return true;
        }

        function validateEmailList(input) {
            const emailList = input.value.trim();
            const errorDiv = document.getElementById('toEmailError');

            if (!emailList) {
                hideError(errorDiv);
                input.style.borderColor = '#ddd';
                return false;
            }

            const emails = parseMultipleEmails(emailList);
            const invalidEmails = emails.filter(email => !EMAIL_REGEX.test(email));

            if (invalidEmails.length > 0) {
                showError(errorDiv, `Invalid email addresses: ${invalidEmails.join(', ')}`);
                input.style.borderColor = '#dc3545';
                return false;
            }

            if (emails.length === 0) {
                showError(errorDiv, 'Please enter at least one valid email address');
                input.style.borderColor = '#dc3545';
                return false;
            }

            hideError(errorDiv);
            input.style.borderColor = '#28a745';
            return true;
        }

        function validateSubject(input) {
            const subject = input.value.trim();
            const errorDiv = document.getElementById('subjectError');

            if (!subject) {
                showError(errorDiv, 'Subject is required');
                input.style.borderColor = '#dc3545';
                return false;
            }

            if (subject.length > 255) {
                showError(errorDiv, 'Subject too long (max 255 characters)');
                input.style.borderColor = '#dc3545';
                return false;
            }

            // Check for potential email header injection
            if (/[\r\n]/.test(subject)) {
                showError(errorDiv, 'Subject cannot contain line breaks');
                input.style.borderColor = '#dc3545';
                return false;
            }

            hideError(errorDiv);
            input.style.borderColor = '#28a745';
            return true;
        }


        function showError(errorDiv, message) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.setAttribute('aria-live', 'polite');
        }

        function hideError(errorDiv) {
            errorDiv.style.display = 'none';
            errorDiv.textContent = '';
        }

        // Spreadsheet Status Tracking
        function updateSpreadsheetStatus(originalRowIndex, status, contactData) {
            if (uploadedSpreadsheetData[originalRowIndex]) {
                uploadedSpreadsheetData[originalRowIndex].status = status;
                uploadedSpreadsheetData[originalRowIndex].processedContact = contactData;
            }
        }

        function generateStatusReport() {
            const totalRows = uploadedSpreadsheetData.length;
            const successfulRows = uploadedSpreadsheetData.filter(row => row.status === 'uploaded').length;
            const failedRows = totalRows - successfulRows;

            return {
                total: totalRows,
                successful: successfulRows,
                failed: failedRows,
                data: uploadedSpreadsheetData
            };
        }

        function showUploadStatusReport(statusReport) {
            const uploadStatsDiv = document.getElementById('uploadStats');
            if (!uploadStatsDiv) return;

            if (statusReport.total === 0) {
                uploadStatsDiv.style.display = 'none';
                return;
            }

            uploadStatsDiv.style.display = 'block';
            uploadStatsDiv.innerHTML = `
                📊 <strong>Upload Status:</strong>
                <span style="color: #28a745;">${statusReport.successful} uploaded</span> |
                <span style="color: #dc3545;">${statusReport.failed > 0 ? `<a href="#" onclick="showFailedUploadsSpreadsheet()" style="color: #dc3545; text-decoration: underline; cursor: pointer;">${statusReport.failed} failed</a>` : '0 failed'}</span> |
                Total: ${statusReport.total} rows
                ${statusReport.failed > 0 ? `<br><small style="color: #dc3545;">Click on failed count to view detailed report</small>` : ''}
            `;
        }

        // Search and Filter Functions
        function filterContacts() {
            const searchTerm = document.getElementById('contactSearch').value.toLowerCase().trim();

            if (!searchTerm) {
                filteredContacts = [...contacts];
            } else {
                filteredContacts = contacts.filter(contact =>
                    contact.firm.toLowerCase().includes(searchTerm) ||
                    contact.contactName.toLowerCase().includes(searchTerm) ||
                    contact.email.toLowerCase().includes(searchTerm) ||
                    contact.country.toLowerCase().includes(searchTerm) ||
                    (contact.category && contact.category.toLowerCase().includes(searchTerm))
                );
            }

            renderContacts();
            selectedContactIndex = -1; // Reset selection
        }

        // Performance: Progress tracking
        function showProgress(current, total, text) {
            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');

            if (progressDiv && progressBar && progressText) {
                progressDiv.style.display = 'block';
                const percentage = Math.round((current / total) * 100);
                progressBar.style.width = percentage + '%';
                progressText.textContent = text || `${current}/${total} (${percentage}%)`;
            }
        }

        function hideProgress() {
            const progressDiv = document.getElementById('uploadProgress');
            if (progressDiv) {
                progressDiv.style.display = 'none';
            }
        }

        // File Upload Security
        function validateFileUpload(file) {
            // File size check
            if (file.size > MAX_FILE_SIZE) {
                showAlert(`File too large! Maximum size is ${Math.round(MAX_FILE_SIZE / 1024 / 1024)}MB. Your file is ${Math.round(file.size / 1024 / 1024)}MB.`, 'error');
                return false;
            }

            // File type check
            const allowedExtensions = ['.csv', '.xlsx', '.xls', '.pdf', '.doc', '.docx', '.ppt', '.pptx', '.png', '.jpg', '.jpeg', '.gif', '.bmp', '.tiff'];
            const fileName = file.name.toLowerCase();
            const isValidExtension = allowedExtensions.some(ext => fileName.endsWith(ext));

            if (!isValidExtension) {
                showAlert('Invalid file type! Please upload a supported file: CSV, Excel, PDF, Word, PowerPoint, or Image.', 'error');
                return false;
            }

            // File name sanitization check
            const suspiciousChars = /[<>:"\\|?*\x00-\x1f]/;
            if (suspiciousChars.test(file.name)) {
                showAlert('Invalid file name! Please rename your file and try again.', 'error');
                return false;
            }

            return true;
        }

        // Memory Management
        function cleanupContacts() {
            // Limit contact count for performance
            if (contacts.length > MAX_CONTACTS) {
                showAlert(`Too many contacts! Only the first ${MAX_CONTACTS} contacts will be loaded for performance reasons.`, 'error');
                contacts = contacts.slice(0, MAX_CONTACTS);
            }

            // Clean up old data
            if (emailHistory.length > 1000) {
                emailHistory = emailHistory.slice(0, 500); // Keep most recent 500
            }
        }

        // UI Enhancement Functions
        function toggleMessageExpand() {
            // Create modal popup for message editing
            const modal = document.createElement('div');
            modal.id = 'messageExpandModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            const messageBody = document.getElementById('messageBody');
            const currentContent = messageBody.innerHTML;

            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; width: 90%; max-width: 800px; height: 80%; display: flex; flex-direction: column; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
                    <div style="padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; color: #1f2937; font-size: 18px;">📝 Edit Message - Full Screen</h3>
                        <button onclick="closeMessageModal()" style="background: #f3f4f6; border: none; padding: 8px; border-radius: 50%; cursor: pointer; font-size: 16px;">✕</button>
                    </div>

                    <div style="flex: 1; padding: 20px; overflow: hidden; display: flex; flex-direction: column;">
                        <div id="expandedMessageBody" contenteditable="true"
                             style="flex: 1; padding: 20px; border: 1px solid #d1d5db; border-radius: 8px; overflow-y: auto; font-size: 14px; line-height: 1.6; outline: none;"
                             oninput="validateMessage(this)" onpaste="handlePaste(event)">
                            ${currentContent}
                        </div>
                    </div>

                    <div style="padding: 20px; border-top: 1px solid #e5e7eb; display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="cancelMessageEdit()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Cancel
                        </button>
                        <button onclick="saveMessageEdit()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Save Changes
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            document.getElementById('expandedMessageBody').focus();
        }

        function closeMessageModal() {
            const modal = document.getElementById('messageExpandModal');
            if (modal) {
                modal.remove();
            }
        }

        function cancelMessageEdit() {
            closeMessageModal();
        }

        function saveMessageEdit() {
            const expandedBody = document.getElementById('expandedMessageBody');
            const originalBody = document.getElementById('messageBody');

            originalBody.innerHTML = expandedBody.innerHTML;
            updateHiddenTextarea();
            closeMessageModal();
            showAlert('Message updated successfully!', 'success');
        }

        function toggleTemplate() {
            const container = document.getElementById('templateContainer');
            const button = document.getElementById('templateToggle');

            if (container.style.display === 'none') {
                container.style.display = 'block';
                button.textContent = '📝 Collapse';
            } else {
                container.style.display = 'none';
                button.textContent = '📝 Expand';
            }
        }

        // Message Formatting Functions
        function toggleFormatting() {
            const toolbar = document.getElementById('formattingToolbar');
            const button = document.getElementById('formatToggle');
            const messageBody = document.getElementById('messageBody');

            if (toolbar.style.display === 'none') {
                toolbar.style.display = 'block';
                button.textContent = '🎨 Hide';
                messageBody.style.borderRadius = '0 0 4px 4px';
            } else {
                toolbar.style.display = 'none';
                button.textContent = '🎨 Format';
                messageBody.style.borderRadius = '4px';
            }
        }

        function formatText(type) {
            const textarea = document.getElementById('messageBody');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            let replacement = '';

            switch (type) {
                case 'bold':
                    replacement = selectedText ? `**${selectedText}**` : '**bold text**';
                    break;
                case 'italic':
                    replacement = selectedText ? `*${selectedText}*` : '*italic text*';
                    break;
                case 'underline':
                    replacement = selectedText ? `_${selectedText}_` : '_underlined text_';
                    break;
                case 'bullet':
                    const bulletLines = selectedText ? selectedText.split('\n').map(line => `• ${line}`).join('\n') : '• Bullet point 1\n• Bullet point 2\n• Bullet point 3';
                    replacement = bulletLines;
                    break;
                case 'number':
                    const numberLines = selectedText ? selectedText.split('\n').map((line, index) => `${index + 1}. ${line}`).join('\n') : '1. First item\n2. Second item\n3. Third item';
                    replacement = numberLines;
                    break;
            }

            const newValue = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
            textarea.value = newValue;
            textarea.focus();
            textarea.setSelectionRange(start, start + replacement.length);
        }

        function insertPersonalization() {
            const textarea = document.getElementById('messageBody');
            const start = textarea.selectionStart;
            const options = [
                '{contactName}',
                '{firm}',
                '{country}',
                '{email}',
                '{phone}',
                '{website}',
                '{address}'
            ];

            const selection = prompt('Choose personalization variable:\n\n' +
                options.map((opt, index) => `${index + 1}. ${opt}`).join('\n') +
                '\n\nEnter number (1-7):');

            if (selection && !isNaN(selection) && selection >= 1 && selection <= options.length) {
                const variable = options[selection - 1];
                const newValue = textarea.value.substring(0, start) + variable + textarea.value.substring(start);
                textarea.value = newValue;
                textarea.focus();
                textarea.setSelectionRange(start + variable.length, start + variable.length);
            }
        }

        function insertBusinessOpportunity() {
            const textarea = document.getElementById('messageBody');
            const start = textarea.selectionStart;

            const businessOpportunities = `
Potential Business Opportunities for {firm}:

• **Product Distribution**: Exclusive distribution rights for Intex consumer electronics in {country}
• **Retail Partnership**: Establish Intex branded sections in your existing retail locations
• **E-commerce Integration**: Online sales partnership through your digital platforms
• **Corporate Sales**: B2B sales of IT peripherals and office equipment to local businesses
• **Service Center Network**: Authorized service and support center for Intex products
• **Market Development**: Joint marketing campaigns and brand awareness initiatives

Market Advantages:
✓ High-demand consumer electronics market
✓ Growing adoption of smart home technologies
✓ Increasing demand for quality IT peripherals
✓ Strong potential for mobile accessories sales
✓ Expanding home appliance market in {country}`;

            const newValue = textarea.value.substring(0, start) + businessOpportunities + textarea.value.substring(start);
            textarea.value = newValue;
            textarea.focus();
            textarea.setSelectionRange(start + businessOpportunities.length, start + businessOpportunities.length);
        }

        // Enhanced Formatting Functions
        let undoStack = [];

        function saveUndoState() {
            const textarea = document.getElementById('messageBody');
            undoStack.push(textarea.value);
            if (undoStack.length > 10) {
                undoStack.shift(); // Keep only last 10 states
            }
        }

        function undoFormat() {
            if (undoStack.length > 0) {
                const textarea = document.getElementById('messageBody');
                textarea.value = undoStack.pop();
                textarea.focus();
                showAlert('Undo successful', 'info');
            } else {
                showAlert('Nothing to undo', 'warning');
            }
        }

        function clearFormatting() {
            const textarea = document.getElementById('messageBody');
            if (textarea.value.trim() === '') {
                showAlert('Message is already empty', 'info');
                return;
            }

            saveUndoState();
            textarea.value = '';
            textarea.focus();
            showAlert('Message cleared', 'info');
        }

        function showColorPicker() {
            const colorPicker = document.getElementById('colorPicker');
            if (colorPicker.style.display === 'none') {
                colorPicker.style.display = 'block';
            } else {
                colorPicker.style.display = 'none';
            }
        }

        function applyColor(color) {
            const editor = document.getElementById('messageBody');
            saveUndoState();
            editor.focus();

            const selection = window.getSelection();
            if (selection.rangeCount === 0) {
                showAlert('Please select text first to change its color', 'info');
                return;
            }

            const range = selection.getRangeAt(0);

            if (range.collapsed) {
                // No text selected, just return without doing anything
                showAlert('Please select text first to change its color', 'info');
                return;
            }

            // Apply color to selected text
            const span = document.createElement('span');
            span.style.color = color;

            try {
                const contents = range.extractContents();
                span.appendChild(contents);
                range.insertNode(span);

                // Restore selection to show the colored text
                const newRange = document.createRange();
                newRange.selectNodeContents(span);
                selection.removeAllRanges();
                selection.addRange(newRange);

                showAlert(`Text color changed to ${color}`, 'success');
            } catch (e) {
                // Fallback: use execCommand if modern approach fails
                console.log('Using fallback execCommand for color');
                document.execCommand('foreColor', false, color);
            }

            updateHiddenTextarea();
            // Hide color picker
            document.getElementById('colorPicker').style.display = 'none';
        }

        // Enhanced formatText function for rich text editor
        function formatText(type) {
            const editor = document.getElementById('messageBody');
            saveUndoState();

            // Focus the editor first
            editor.focus();

            try {
                switch (type) {
                    case 'bold':
                        document.execCommand('bold', false, null);
                        break;
                    case 'italic':
                        document.execCommand('italic', false, null);
                        break;
                    case 'underline':
                        document.execCommand('underline', false, null);
                        break;
                    case 'bullet':
                        document.execCommand('insertUnorderedList', false, null);
                        break;
                    case 'number':
                        document.execCommand('insertOrderedList', false, null);
                        break;
                    case 'indent':
                        document.execCommand('indent', false, null);
                        break;
                    case 'link':
                        const url = prompt('Enter URL:');
                        if (url) {
                            document.execCommand('createLink', false, url);
                        }
                        break;
                }
            } catch (e) {
                console.error('Formatting error:', e);
                // Fallback for browsers that don't support execCommand
                insertHTMLAtCursor(getFormattingHTML(type));
            }

            // Update hidden textarea for form submission
            updateHiddenTextarea();
        }

        function insertHTMLAtCursor(html) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                range.deleteContents();
                const fragment = document.createRange().createContextualFragment(html);
                range.insertNode(fragment);
                range.collapse(false);
                selection.removeAllRanges();
                selection.addRange(range);
            }
        }

        function getFormattingHTML(type) {
            const selectedText = window.getSelection().toString() || 'sample text';
            switch (type) {
                case 'bold':
                    return `<strong>${selectedText}</strong>`;
                case 'italic':
                    return `<em>${selectedText}</em>`;
                case 'underline':
                    return `<u>${selectedText}</u>`;
                case 'bullet':
                    return `<ul><li>${selectedText}</li></ul>`;
                case 'number':
                    return `<ol><li>${selectedText}</li></ol>`;
                case 'indent':
                    return `<blockquote>${selectedText}</blockquote>`;
                default:
                    return selectedText;
            }
        }

        function updateHiddenTextarea() {
            const editor = document.getElementById('messageBody');
            const hiddenTextarea = document.getElementById('messageBodyHidden');
            hiddenTextarea.value = editor.innerHTML;
        }

        function handlePaste(event) {
            event.preventDefault();
            const text = (event.clipboardData || window.clipboardData).getData('text');
            document.execCommand('insertText', false, text);
            updateHiddenTextarea();
        }

        // Contact Personalization Auto-Population - Make sure it's globally accessible
        window.populatePersonalizationData = function() {
            console.log('populatePersonalizationData called, selectedContactIndex:', selectedContactIndex);

            if (selectedContactIndex === -1 || !contacts[selectedContactIndex]) {
                console.log('No contact selected or contact not found');
                return;
            }

            const contact = contacts[selectedContactIndex];
            const subjectField = document.getElementById('subject');
            const messageBody = document.getElementById('messageBody');

            console.log('Contact:', contact);
            console.log('Message body element:', messageBody);

            if (!messageBody) {
                console.error('Message body element not found!');
                return;
            }

            // Auto-populate subject if empty or contains template
            if (!subjectField.value || subjectField.value.includes('{')) {
                subjectField.value = `Business Partnership Opportunity - Intex Technologies in ${contact.country}`;
                console.log('Subject populated');
            }

            // Always populate message body when a contact is selected (for immediate feedback)
            const personalizedMessage = `Dear ${contact.contactName},

We are pleased to introduce Intex Technologies to ${contact.firm}.

Since our inception in 1996, we have been at the forefront of innovation in consumer electronics and technology sectors. We believe ${contact.firm}, with its established market presence in ${contact.country}, would be an ideal partner for expanding our reach.

Our Product Portfolio:
• IT Peripherals: Speakers, keyboards, mice, webcams, and computer accessories
• Home Appliances: Air coolers, room heaters, water purifiers, and kitchen appliances
• Mobile Accessories: Power banks, chargers, cables, and smartphone accessories
• Audio Solutions: Wireless speakers, headphones, and sound systems

We are actively seeking distribution partners in ${contact.country} who share our vision of delivering high-quality, innovative products to consumers.

What We Offer Our Partners:
✓ Competitive pricing with attractive profit margins
✓ Comprehensive marketing support and co-branding opportunities
✓ Technical training and ongoing product support
✓ Flexible payment terms and credit facilities
✓ Exclusive territory rights (subject to discussion)
✓ Access to our complete product catalog and new launches

We would welcome the opportunity to discuss how we can work together to bring Intex Technologies' innovative products to the ${contact.country} market through ${contact.firm}.

Please feel free to contact us at your earliest convenience to explore this exciting business opportunity.

Best regards,

Vishwas Agarwal
Business Development Manager
Intex Technologies
Email: vishwas.agarwal@gmail.com
Phone: +91-XXXXXXXXXX`;

            console.log('About to set messageBody.innerHTML');

            // Force clear any previous content and set new content
            messageBody.innerHTML = '';
            setTimeout(() => {
                // Sanitize the personalized message before setting innerHTML
                const sanitizedMessage = sanitizeHTML(personalizedMessage.replace(/\n/g, '<br>'));
                messageBody.innerHTML = sanitizedMessage;
                console.log('Message body innerHTML set to:', messageBody.innerHTML.substring(0, 100) + '...');
                updateHiddenTextarea();
                console.log('updateHiddenTextarea called');
            }, 50);

            console.log('Message body populated with personalized content');
            showAlert(`Personalized content for ${contact.firm} from ${contact.country}`, 'success');
        }



        // Email Attachment Functions
        const attachments = [];
        const MAX_ATTACHMENTS = 5;
        const MAX_TOTAL_SIZE = 25 * 1024 * 1024; // 25MB

        function toggleAttachments() {
            const container = document.getElementById('attachmentContainer');
            const button = document.getElementById('attachmentToggle');

            if (container.style.display === 'none') {
                container.style.display = 'block';
                button.textContent = 'Hide';
            } else {
                container.style.display = 'none';
                button.textContent = 'Add Files';
            }
        }

        function handleAttachmentUpload(event) {
            const files = Array.from(event.target.files);

            if (files.length === 0) return;

            // Check attachment limits
            if (attachments.length + files.length > MAX_ATTACHMENTS) {
                showAlert(`Maximum ${MAX_ATTACHMENTS} attachments allowed. You can add ${MAX_ATTACHMENTS - attachments.length} more files.`, 'error');
                return;
            }

            // Check total size
            const currentSize = attachments.reduce((sum, att) => sum + att.size, 0);
            const newSize = files.reduce((sum, file) => sum + file.size, 0);

            if (currentSize + newSize > MAX_TOTAL_SIZE) {
                const maxMB = Math.round(MAX_TOTAL_SIZE / 1024 / 1024);
                const currentMB = Math.round(currentSize / 1024 / 1024);
                showAlert(`Total attachment size cannot exceed ${maxMB}MB. Current size: ${currentMB}MB`, 'error');
                return;
            }

            // Add files to attachments array
            files.forEach(file => {
                const attachment = {
                    id: Date.now() + Math.random(),
                    file: file,
                    name: file.name,
                    size: file.size,
                    type: file.type || 'application/octet-stream'
                };
                attachments.push(attachment);
            });

            renderAttachments();
            showAlert(`Added ${files.length} attachment(s)`, 'success');

            // Reset file input
            event.target.value = '';
        }

        function renderAttachments() {
            const container = document.getElementById('attachmentList');
            const emptyState = document.getElementById('attachmentEmpty');

            if (attachments.length === 0) {
                container.innerHTML = '<div id="attachmentEmpty" style="text-align: center; color: #999; font-style: italic; padding: 20px;">No attachments selected</div>';
                return;
            }

            const attachmentHTML = attachments.map(attachment => {
                const sizeKB = Math.round(attachment.size / 1024);
                const sizeText = sizeKB < 1024 ? `${sizeKB} KB` : `${Math.round(sizeKB / 1024)} MB`;

                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 5px;">
                        <div style="display: flex; align-items: center; flex: 1;">
                            <span style="margin-right: 8px;">${getFileIcon(attachment.name)}</span>
                            <div>
                                <div style="font-size: 12px; font-weight: bold; color: #333;">${sanitizeInput(attachment.name)}</div>
                                <div style="font-size: 10px; color: #666;">${sizeText}</div>
                            </div>
                        </div>
                        <button onclick="removeAttachment('${attachment.id}')" style="padding: 2px 6px; font-size: 10px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;" title="Remove attachment">
                            ✕
                        </button>
                    </div>
                `;
            }).join('');

            container.innerHTML = attachmentHTML;

            // Show total size
            const totalSize = attachments.reduce((sum, att) => sum + att.size, 0);
            const totalMB = Math.round(totalSize / 1024 / 1024 * 100) / 100;
            const maxMB = Math.round(MAX_TOTAL_SIZE / 1024 / 1024);

            container.innerHTML += `
                <div style="padding: 8px; background: #f8f9fa; border-radius: 4px; margin-top: 10px; font-size: 11px; color: #666; text-align: center;">
                    Total: ${totalMB} MB of ${maxMB} MB used (${attachments.length}/${MAX_ATTACHMENTS} files)
                </div>
            `;
        }

        function removeAttachment(attachmentId) {
            const index = attachments.findIndex(att => att.id == attachmentId);
            if (index !== -1) {
                const removedAttachment = attachments.splice(index, 1)[0];
                renderAttachments();
                showAlert(`Removed "${removedAttachment.name}"`, 'info');
            }
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const iconMap = {
                'pdf': '📄',
                'doc': '📝', 'docx': '📝',
                'xls': '📊', 'xlsx': '📊',
                'ppt': '📽️', 'pptx': '📽️',
                'txt': '📄',
                'jpg': '🖼️', 'jpeg': '🖼️', 'png': '🖼️', 'gif': '🖼️',
                'zip': '📦', 'rar': '📦'
            };
            return iconMap[ext] || '📁';
        }

        function handleKeyNavigation(event) {
            const contactCount = filteredContacts.length || contacts.length;
            if (contactCount === 0) return;

            switch(event.key) {
                case 'ArrowDown':
                    event.preventDefault();
                    if (selectedContactIndex < contactCount - 1) {
                        selectContact(selectedContactIndex + 1);
                    }
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    if (selectedContactIndex > 0) {
                        selectContact(selectedContactIndex - 1);
                    }
                    break;
                case 'Enter':
                    event.preventDefault();
                    if (selectedContactIndex >= 0) {
                        document.getElementById('sendBtn').click();
                    }
                    break;
                case 'Escape':
                    event.preventDefault();
                    selectedContactIndex = -1;
                    document.querySelectorAll('.contact-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    document.getElementById('sendBtn').disabled = true;
                    showAlert('Selection cleared');
                    break;
                case 'Home':
                    event.preventDefault();
                    if (contactCount > 0) {
                        selectContact(0);
                    }
                    break;
                case 'End':
                    event.preventDefault();
                    if (contactCount > 0) {
                        selectContact(contactCount - 1);
                    }
                    break;
            }
        }

        function updateUploadStats() {
            const statsDiv = document.getElementById('uploadStats');
            if (uploadStats.total > 0) {
                statsDiv.style.display = 'block';
                statsDiv.innerHTML = `
                    📊 Total: ${uploadStats.total} |
                    ✅ Read: ${uploadStats.read} |
                    ❌ Unread: ${uploadStats.unread}
                `;
            }
        }

        function addToEmailHistory(toEmails, subject, status, timestamp, country = '') {
            const historyItem = {
                id: Date.now(),
                toEmails: Array.isArray(toEmails) ? toEmails : [toEmails],
                subject: subject,
                status: status, // 'sent', 'failed'
                timestamp: timestamp,
                country: country,
                content: document.getElementById('messageBody').innerHTML ? document.getElementById('messageBody').innerHTML.substring(0, 100) + '...' : 'No content'
            };
            emailHistory.unshift(historyItem); // Add to beginning
            updateEmailHistory();
        }

        function updateEmailHistory() {
            const historyDiv = document.getElementById('emailHistory');

            if (emailHistory.length === 0) {
                historyDiv.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 20px;">
                        <p>📧 Email history will appear here</p>
                        <small>Send emails to see status tracking</small>
                    </div>
                `;
                return;
            }

            let historyHTML = '';
            emailHistory.slice(0, 20).forEach(item => { // Show last 20 items
                const statusColor = item.status === 'sent' ? '#28a745' : '#dc3545';
                const statusIcon = item.status === 'sent' ? '✅' : '❌';

                historyHTML += `
                    <div style="border-bottom: 1px solid #eee; padding: 8px; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: between; align-items: start;">
                            <div style="flex: 1;">
                                <strong style="color: ${statusColor};">${statusIcon} ${item.status.toUpperCase()}</strong>
                                <div style="font-size: 12px; color: #666; margin-top: 2px;">
                                    To: ${item.toEmails.join(', ')}<br>
                                    Subject: ${item.subject}<br>
                                    ${new Date(item.timestamp).toLocaleString()}<br>
                                    <small>${item.content}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            historyDiv.innerHTML = historyHTML;
        }

        function parseMultipleEmails(emailString) {
            // Handle multiple delimiters: comma, semicolon, forward slash
            return emailString
                .split(/[,;\/]/)
                .map(email => email.trim())
                .filter(email => email && email.includes('@'));
        }

        // No sample data - users must upload their own spreadsheets

        function showAlert(message, type = 'success') {
            const alerts = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            alerts.appendChild(alert);

            // Remove after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }


        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                console.log('No file selected');
                return;
            }

            // Security: File validation
            if (!validateFileUpload(file)) {
                return;
            }

            // Check if XLSX library is loaded for Excel files
            if (!file.name.toLowerCase().endsWith('.csv') && typeof XLSX === 'undefined') {
                showAlert('Error: Excel processing library not loaded. Please refresh the page.', 'error');
                return;
            }

            console.log('=== FILE UPLOAD STARTED ===');
            console.log('File selected:', file.name, file.type, file.size);
            showAlert(`Processing ${sanitizeInput(file.name)}...`, 'success');

            // Store the uploaded file name for export
            currentUploadedFileName = file.name;

            try {
                // Clear existing data
                contacts = [];
                filteredContacts = [];
                selectedContactIndex = -1;
                uploadedSpreadsheetData = [];
                currentUploadProgress = { current: 0, total: 0 };

                showProgress(0, 100, 'Starting file processing...');
                let totalProcessed = 0;

                // Handle CSV files differently
                if (file.name.toLowerCase().endsWith('.csv')) {
                    console.log('Processing CSV file...');
                    const text = await file.text();
                    console.log('CSV file read, length:', text.length);

                    const csvData = parseCSV(text);
                    console.log('CSV parsed, headers:', csvData.headers);
                    console.log('CSV data rows:', csvData.data.length);

                    // Track total rows for statistics
                    uploadStats.total = csvData.data.length;

                    // Process CSV data
                    csvData.data.forEach((row, index) => {
                        console.log(`Processing row ${index + 1}:`, row);
                        const contact = {
                            country: row.country || 'Unknown',
                            firm: row['firm name'] || row.company || row.firm || 'Unknown Company',
                            address: row.address || row.location || '',
                            phone: row['contact number'] || row.phone || row.telephone || '',
                            contactName: row['contact person'] || row.name || row.contact || 'Contact Person',
                            email: row.email || row['email address'] || '',
                            website: row.website || row.url || '',
                            source: row.source || row['lead source'] || '',
                            category: row.category || row.type || row.sector || '',
                            businessFocus: generateBusinessFocus(row.category || row.type || ''),
                            marketStrength: 'Medium',
                            emailStatus: 'pending' // pending, sent, failed
                        };

                        console.log('Contact created:', contact);

                        if (contact.email && contact.email.includes('@')) {
                            contacts.push(contact);
                            totalProcessed++;
                            console.log(`Added contact ${totalProcessed}: ${contact.firm} - ${contact.email}`);
                        } else {
                            console.log('Skipped contact (no valid email):', contact);
                        }
                    });

                    console.log(`CSV processed: ${totalProcessed} contacts added to array`);
                    console.log('Final contacts array:', contacts);
                } else {
                    // Handle Excel files
                    const data = await file.arrayBuffer();
                    console.log('Excel file read, size:', data.byteLength);

                    const workbook = XLSX.read(data, { type: 'array' });
                    console.log('Workbook loaded, sheets:', workbook.SheetNames);

                    // Function to detect multiple tables within a single sheet
                    function detectTablesInSheet(jsonData) {
                        const tables = [];
                        let currentTable = null;

                        for (let rowIndex = 0; rowIndex < jsonData.length; rowIndex++) {
                            const row = jsonData[rowIndex];

                            // Skip empty rows
                            if (!row || row.length === 0 || row.every(cell => !cell || cell.toString().trim() === '')) {
                                continue;
                            }

                            // Check if this row looks like a header
                            const isHeaderRow = isLikelyHeaderRow(row);

                            if (isHeaderRow) {
                                // If we have a current table, finalize it
                                if (currentTable && currentTable.rows.length > 0) {
                                    tables.push(currentTable);
                                }

                                // Start a new table
                                currentTable = {
                                    headers: row.map(cell => cell ? cell.toString().trim().toLowerCase() : ''),
                                    rows: [],
                                    startRow: rowIndex
                                };
                            } else if (currentTable) {
                                // Add data row to current table
                                currentTable.rows.push(row);
                            } else {
                                // First table without explicit header - treat first row as header
                                currentTable = {
                                    headers: row.map(cell => cell ? cell.toString().trim().toLowerCase() : ''),
                                    rows: [],
                                    startRow: rowIndex
                                };
                            }
                        }

                        // Add the last table if it exists
                        if (currentTable && currentTable.rows.length > 0) {
                            tables.push(currentTable);
                        }

                        // If no tables found but we have data, treat entire sheet as one table
                        if (tables.length === 0 && jsonData.length > 1) {
                            tables.push({
                                headers: jsonData[0].map(cell => cell ? cell.toString().trim().toLowerCase() : ''),
                                rows: jsonData.slice(1),
                                startRow: 0
                            });
                        }

                        return tables;
                    }

                    // Function to determine if a row looks like a header
                    function isLikelyHeaderRow(row) {
                        if (!row || row.length === 0) return false;

                        const nonEmptyCells = row.filter(cell => cell && cell.toString().trim() !== '');
                        if (nonEmptyCells.length < 2) return false; // Need at least 2 columns

                        // Check for common header patterns
                        const headerPatterns = [
                            /^(firm|company|organization|business)/i,
                            /^(name|contact|person)/i,
                            /^(email|e-mail|mail)/i,
                            /^(phone|telephone|mobile|contact)/i,
                            /^(address|location|addr)/i,
                            /^(website|url|web)/i,
                            /^(country|nation|region)/i,
                            /^(category|type|industry|sector)/i,
                            /^(source|origin|lead)/i
                        ];

                        let headerMatches = 0;
                        for (const cell of nonEmptyCells) {
                            const cellText = cell.toString().trim().toLowerCase();
                            for (const pattern of headerPatterns) {
                                if (pattern.test(cellText)) {
                                    headerMatches++;
                                    break;
                                }
                            }
                        }

                        // Consider it a header if at least 30% of non-empty cells match header patterns
                        return headerMatches >= Math.max(1, Math.ceil(nonEmptyCells.length * 0.3));
                    }

                    // Calculate total rows across all sheets using multi-table detection
                    uploadStats.total = 0;
                    workbook.SheetNames.forEach(sheetName => {
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        if (jsonData.length > 1) {
                            // Use table detection for accurate counting
                            const tempTables = detectTablesInSheet(jsonData);
                            tempTables.forEach(table => {
                                uploadStats.total += table.rows.length;
                            });
                        }
                    });

                    // Process each worksheet (tab) as a country
                    workbook.SheetNames.forEach(sheetName => {
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (jsonData.length < 2) return; // Skip empty sheets

                    // Detect multiple tables within the sheet by finding header rows
                    const tables = detectTablesInSheet(jsonData);
                    console.log(`Found ${tables.length} table(s) in sheet "${sheetName}"`);

                    // Process each table found in the sheet
                    tables.forEach((table, tableIndex) => {
                        const headers = table.headers;
                        const rows = table.rows;

                        console.log(`Processing table ${tableIndex + 1} in sheet "${sheetName}" with ${rows.length} rows`);
                        console.log(`Table ${tableIndex + 1} headers:`, headers);

                        // Map column indices for key parameters
                        const columnMap = {
                            firm: findColumnIndex(headers, ['firm name', 'company', 'firm', 'organization']),
                            address: findColumnIndex(headers, ['address', 'location', 'addr']),
                            phone: findColumnIndex(headers, ['contact number', 'phone', 'telephone', 'mobile']),
                            contactName: findColumnIndex(headers, ['contact person', 'name', 'contact', 'person']),
                            email: findColumnIndex(headers, ['email', 'email address', 'e-mail']),
                            website: findColumnIndex(headers, ['website', 'url', 'web', 'site']),
                            source: findColumnIndex(headers, ['source', 'lead source', 'origin']),
                            category: findColumnIndex(headers, ['category', 'type', 'sector', 'industry'])
                        };

                        // Only process table if it has email column
                        if (columnMap.email === -1) {
                            console.log(`Skipping table ${tableIndex + 1} in "${sheetName}" - no email column found`);
                            return;
                        }

                        // Process each row
                        rows.forEach((row, rowIndex) => {
                        if (!row || row.length === 0) {
                            // Track empty rows as failed
                            uploadedSpreadsheetData.push({
                                originalRowIndex: rowIndex + 1, // +1 for header
                                originalData: row,
                                status: 'failed',
                                reason: 'Empty row',
                                sheetName: sheetName
                            });
                            return;
                        }

                        const contact = {
                            country: sheetName, // Use sheet name as country
                            firm: getCellValue(row, columnMap.firm) || 'Unknown Company',
                            address: getCellValue(row, columnMap.address) || '',
                            phone: getCellValue(row, columnMap.phone) || '',
                            contactName: getCellValue(row, columnMap.contactName) || 'Contact Person',
                            email: getCellValue(row, columnMap.email) || '',
                            website: getCellValue(row, columnMap.website) || '',
                            source: getCellValue(row, columnMap.source) || '',
                            category: getCellValue(row, columnMap.category) || '',
                            businessFocus: generateBusinessFocus(getCellValue(row, columnMap.category)),
                            marketStrength: 'High',
                            emailStatus: 'pending' // pending, sent, failed
                        };

                        // Track in spreadsheet data
                        const spreadsheetEntry = {
                            originalRowIndex: rowIndex + 1, // +1 for header
                            originalData: row,
                            sheetName: sheetName,
                            processedContact: contact
                        };

                        // Only add if email exists
                        if (contact.email && contact.email.includes('@')) {
                            contacts.push(contact);
                            spreadsheetEntry.status = 'uploaded';
                            spreadsheetEntry.reason = 'Successfully uploaded';
                            totalProcessed++;
                        } else {
                            spreadsheetEntry.status = 'failed';
                            spreadsheetEntry.reason = 'Missing or invalid email address';
                        }

                        uploadedSpreadsheetData.push(spreadsheetEntry);
                    });

                        console.log(`Processed sheet "${sheetName}": ${jsonData.length - 1} rows`);
                    });

                    console.log(`Total contacts loaded: ${contacts.length}`);
                }

                // Performance: Cleanup and optimize
                cleanupContacts();
                filteredContacts = [...contacts];

                // Update upload statistics
                uploadStats.read = contacts.length;
                uploadStats.unread = uploadStats.total - uploadStats.read;
                updateUploadStats();
                hideProgress();

                // Show upload status report
                const statusReport = generateStatusReport();
                showUploadStatusReport(statusReport);

                console.log('About to render contacts. Array length:', contacts.length);
                renderContacts();
                showAlert(`✅ Loaded ${contacts.length} contacts${file.name.toLowerCase().endsWith('.csv') ? '' : ` from multiple countries`}! (${statusReport.failed} rows had issues)`, statusReport.failed > 0 ? 'error' : 'success');

            } catch (error) {
                hideProgress();
                const sanitizedError = sanitizeInput(error.message);
                showAlert(`Error processing file: ${sanitizedError}`, 'error');
                console.error('File processing error:', error);
            } finally {
                // Reset file input for reuse
                document.getElementById('fileUpload').value = '';
            }
        }

        // Enhanced Formatting Functions
        function getDocumentType(extension) {
            const docTypes = {
                'pdf': 'PDF',
                'doc': 'Word',
                'docx': 'Word',
                'ppt': 'PowerPoint',
                'pptx': 'PowerPoint',
                'png': 'Image',
                'jpg': 'Image',
                'jpeg': 'Image',
                'gif': 'Image',
                'bmp': 'Image',
                'tiff': 'Image'
            };
            return docTypes[extension] || 'Unknown';
        }

        // Process PDF files
        async function processPDFFile(file) {
            showProgress(25, 100, 'Reading PDF content...');
            const text = await extractTextFromPDF(file);
            showProgress(75, 100, 'Extracting contact information...');
            return extractContactsFromText(text, 'PDF Document');
        }

        // Process Word documents
        async function processWordFile(file) {
            showProgress(25, 100, 'Reading Word document...');
            const text = await extractTextFromDOCX(file);
            showProgress(75, 100, 'Extracting contact information...');
            return extractContactsFromText(text, 'Word Document');
        }

        // Process PowerPoint presentations
        async function processPowerPointFile(file) {
            showProgress(25, 100, 'Reading PowerPoint slides...');
            const text = await extractTextFromPPTX(file);
            showProgress(75, 100, 'Extracting contact information...');
            return extractContactsFromText(text, 'PowerPoint Document');
        }

        // Process image files using OCR
        async function processImageFile(file) {
            showProgress(25, 100, 'Analyzing image...');
            const text = await performOCR(file);
            showProgress(75, 100, 'Extracting contact information...');
            return extractContactsFromText(text, 'Image');
        }

        // Extract text from PDF (simulation - in real implementation would use PDF.js)
        async function extractTextFromPDF(file) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    // Simulate PDF text extraction
                    const sampleText = `
                        Contact Information Directory

                        ABC Corporation
                        Email: contact@abc-corp.com
                        Phone: +1-555-0123
                        Address: 123 Business Street, Suite 100, City, State 12345
                        Contact Person: John Smith
                        Website: www.abc-corp.com

                        XYZ Industries
                        Email: info@xyz-industries.net
                        Phone: +1-555-0456
                        Address: 456 Industrial Ave, City, State 67890
                        Contact Person: Sarah Johnson
                        Website: www.xyz-industries.net

                        Global Services LLC
                        Email: hello@globalservices.org
                        Phone: +1-555-0789
                        Address: 789 Service Road, City, State 11111
                        Contact Person: Mike Wilson
                    `;
                    resolve(sampleText);
                }, 1000);
            });
        }

        // Extract text from Word documents (simulation - in real implementation would use mammoth.js)
        async function extractTextFromDOCX(file) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    // Simulate Word document text extraction
                    const sampleText = `
                        Business Partners List

                        Tech Solutions Inc.
                        Contact: David Brown - dbrown@techsolutions.com
                        Phone: (555) 123-4567
                        Location: 321 Tech Drive, Innovation City

                        Marketing Pros
                        Contact: Lisa Anderson - lisa.anderson@marketingpros.biz
                        Phone: (555) 234-5678
                        Location: 654 Marketing Blvd, Business Town

                        Finance Experts
                        Contact: Robert Lee - r.lee@financeexperts.co
                        Phone: (555) 345-6789
                        Location: 987 Financial Street, Money City
                    `;
                    resolve(sampleText);
                }, 800);
            });
        }

        // Extract text from PowerPoint presentations (simulation)
        async function extractTextFromPPTX(file) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    // Simulate PowerPoint text extraction
                    const sampleText = `
                        Conference Attendees

                        Slide 1: Key Contacts
                        - Emma Taylor, emma.taylor@startupfirm.com, (555) 456-7890
                        - James Wilson, j.wilson@corporategroup.net, (555) 567-8901

                        Slide 2: Industry Leaders
                        - Patricia Moore, p.moore@industrytech.org, (555) 678-9012
                        - Christopher Davis, chris@innovativedesign.com, (555) 789-0123

                        Slide 3: Partners
                        - Amanda Garcia, a.garcia@partnernetwork.biz, (555) 890-1234
                    `;
                    resolve(sampleText);
                }, 1200);
            });
        }

        // Perform OCR on image files (simulation - in real implementation would use Tesseract.js)
        async function performOCR(file) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    // Simulate OCR text extraction
                    const sampleText = `
                        Business Card Information

                        INNOVATE CORP
                        Maria Rodriguez
                        Senior Manager
                        maria.rodriguez@innovatecorp.com
                        Tel: +1 (555) 111-2222
                        www.innovatecorp.com

                        FUTURE TECH
                        Alex Kim
                        CTO
                        alex@futuretech.io
                        Mobile: 555-333-4444
                        futuretech.io
                    `;
                    resolve(sampleText);
                }, 1500);
            });
        }

        // Extract contact information from text using pattern matching
        function extractContactsFromText(text, source) {
            const contacts = [];
            const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);

            let currentContact = {};
            let processingContact = false;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];

                // Email pattern
                const emailMatch = line.match(/[\w.-]+@[\w.-]+\.[a-zA-Z]{2,}/);
                if (emailMatch) {
                    if (processingContact && currentContact.email) {
                        // Save previous contact and start new one
                        if (isValidContact(currentContact)) {
                            contacts.push(finalizeContact(currentContact, source));
                        }
                        currentContact = {};
                    }
                    currentContact.email = emailMatch[0];
                    processingContact = true;
                }

                // Phone pattern
                const phoneMatch = line.match(/(?:\+?1[-.\s]?)?\(?([0-9]{3})\)?[-.\s]?([0-9]{3})[-.\s]?([0-9]{4})/);
                if (phoneMatch && processingContact) {
                    currentContact.phone = phoneMatch[0];
                }

                // Website pattern
                const websiteMatch = line.match(/(?:www\.)?[\w.-]+\.(?:com|net|org|biz|co|io|edu|gov)/);
                if (websiteMatch && processingContact && !currentContact.email?.includes(websiteMatch[0])) {
                    currentContact.website = websiteMatch[0].startsWith('www.') ? websiteMatch[0] : 'www.' + websiteMatch[0];
                }

                // Company/Firm name (usually appears before or after email)
                if (processingContact && !currentContact.firm) {
                    // Look for company indicators
                    if (line.match(/\b(Corp|Corporation|Inc|LLC|Ltd|Company|Group|Solutions|Services|Industries|Tech|Systems)\b/i)) {
                        currentContact.firm = line;
                    } else if (line.length < 50 && line.match(/^[A-Z][a-zA-Z\s&]+$/)) {
                        // Capitalized words that look like company names
                        currentContact.firm = line;
                    }
                }

                // Contact person name
                if (processingContact && !currentContact.contactName) {
                    // Look for person names (First Last pattern)
                    if (line.match(/^[A-Z][a-z]+\s+[A-Z][a-z]+/) && !line.match(/\b(Street|Ave|Road|Drive|Blvd)\b/i)) {
                        currentContact.contactName = line;
                    }
                }

                // Address pattern
                if (processingContact && line.match(/\d+\s+[\w\s]+(?:Street|St|Avenue|Ave|Road|Rd|Drive|Dr|Boulevard|Blvd|Suite|Ste)/i)) {
                    currentContact.address = line;
                }
            }

            // Don't forget the last contact
            if (processingContact && isValidContact(currentContact)) {
                contacts.push(finalizeContact(currentContact, source));
            }

            return contacts;
        }

        // Check if contact has minimum required information
        function isValidContact(contact) {
            return contact.email && contact.email.includes('@');
        }

        // Finalize contact with default values
        function finalizeContact(contact, source) {
            return {
                country: 'Unknown',
                firm: contact.firm || 'Unknown Company',
                address: contact.address || '',
                phone: contact.phone || '',
                contactName: contact.contactName || 'Contact Person',
                email: contact.email,
                website: contact.website || '',
                source: source || 'Document',
                category: 'General',
                businessFocus: generateBusinessFocus('General'),
                marketStrength: 'Medium',
                emailStatus: 'pending'
            };
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Bulk Email Sender Application Initialized');

            // Initialize filtered contacts
            filteredContacts = [...contacts];

            // Set focus to first interactive element for accessibility
            const firstButton = document.querySelector('button:not([disabled])');
            if (firstButton) {
                firstButton.focus();
            }

            console.log('Application ready for use - Live mode active');
        });

        function findColumnIndex(headers, possibleNames) {
            for (let name of possibleNames) {
                const index = headers.findIndex(h => h && h.includes(name));
                if (index !== -1) return index;
            }
            return -1;
        }

        function getCellValue(row, columnIndex) {
            if (columnIndex === -1 || !row[columnIndex]) return '';
            return row[columnIndex].toString().trim();
        }

        function generateBusinessFocus(category) {
            const focusMap = {
                'technology': 'IT peripherals and smart devices',
                'retail': 'Consumer electronics and home appliances',
                'electronics': 'Audio solutions and mobile accessories',
                'manufacturing': 'Industrial equipment and automation',
                'healthcare': 'Medical devices and monitoring systems',
                'education': 'Educational technology and audio-visual equipment'
            };

            const categoryLower = category.toLowerCase();
            for (let [key, focus] of Object.entries(focusMap)) {
                if (categoryLower.includes(key)) return focus;
            }
            return 'Consumer electronics and technology solutions';
        }

        function renderContacts() {
            console.log('=== RENDER CONTACTS CALLED ===');
            console.log('Contacts to render:', contacts.length);
            console.log('Contacts array:', contacts);

            const container = document.getElementById('contactsList');
            if (!container) {
                console.error('contactsList element not found!');
                return;
            }

            container.innerHTML = '';

            if (contacts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666; border: 2px dashed #ddd; border-radius: 8px; background: #f9f9f9;">
                        <h4 style="color: #999; margin-bottom: 10px;">📋 No Contacts Loaded</h4>
                        <p>Upload your spreadsheet above to see your contact database here</p>
                        <small>Your contacts will appear here after uploading</small>
                    </div>
                `;
                return;
            }

            console.log('Rendering individual contacts...');
            const contactsToRender = filteredContacts.length > 0 ? filteredContacts : contacts;

            contactsToRender.forEach((contact, index) => {
                console.log(`Rendering contact ${index + 1}:`, contact);
                const div = document.createElement('div');
                div.className = 'contact-item';

                // Add click handler for contact selection
                div.onclick = () => selectContact(index);
                div.setAttribute('role', 'option');
                div.setAttribute('aria-selected', 'false');
                div.setAttribute('tabindex', '-1');

                // Add status-based styling with pleasing colors
                let statusColor = '';
                let statusBorder = '';
                let statusIcon = '';
                let statusBadge = '';

                if (contact.emailStatus === 'sent') {
                    // Soft green for successful sends - pleasing to eyes
                    statusColor = 'background: linear-gradient(135deg, #e8f5e8 0%, #f0fff0 100%);';
                    statusBorder = 'border-left: 4px solid #22c55e; border: 1px solid #86efac;';
                    statusIcon = '✓'; // Simple checkmark
                    statusBadge = '<span style="background: #22c55e; color: white; padding: 2px 6px; border-radius: 10px; font-size: 9px; font-weight: 500;">SENT</span>';
                } else if (contact.emailStatus === 'failed') {
                    // Soft red for failed sends - pleasing to eyes
                    statusColor = 'background: linear-gradient(135deg, #fef2f2 0%, #fff5f5 100%);';
                    statusBorder = 'border-left: 4px solid #ef4444; border: 1px solid #fca5a5;';
                    statusIcon = '✗'; // Simple X mark
                    statusBadge = '<span style="background: #ef4444; color: white; padding: 2px 6px; border-radius: 10px; font-size: 9px; font-weight: 500;">FAILED</span>';
                } else {
                    // Soft blue for pending - pleasing to eyes
                    statusColor = 'background: linear-gradient(135deg, #f0f9ff 0%, #f8fafc 100%);';
                    statusBorder = 'border-left: 4px solid #3b82f6; border: 1px solid #93c5fd;';
                    statusIcon = '•'; // Simple dot
                    statusBadge = '<span style="background: #6b7280; color: white; padding: 2px 6px; border-radius: 10px; font-size: 9px; font-weight: 500;">PENDING</span>';
                }

                div.style.cssText += statusColor + statusBorder;

                // Security: Sanitize all contact data before display
                const sanitizedContact = {
                    firm: sanitizeHTML(contact.firm || ''),
                    contactName: sanitizeHTML(contact.contactName || ''),
                    email: sanitizeHTML(contact.email || ''),
                    country: sanitizeHTML(contact.country || ''),
                    phone: sanitizeHTML(contact.phone || ''),
                    website: sanitizeHTML(contact.website || ''),
                    address: sanitizeHTML(contact.address || ''),
                    source: sanitizeHTML(contact.source || ''),
                    category: sanitizeHTML(contact.category || '')
                };

                // Create safe HTML structure without innerHTML
                const flexContainer = document.createElement('div');
                flexContainer.style.cssText = 'display: flex; justify-content: space-between; align-items: start;';

                const contentDiv = document.createElement('div');
                contentDiv.style.cssText = 'flex: 1;';

                // Header with firm name and category
                const headerDiv = document.createElement('div');
                headerDiv.style.cssText = 'display: flex; align-items: center; gap: 8px; margin-bottom: 4px;';

                const firmStrong = document.createElement('strong');
                firmStrong.textContent = sanitizedContact.firm;
                headerDiv.appendChild(firmStrong);

                if (sanitizedContact.category) {
                    const categorySpan = document.createElement('span');
                    categorySpan.style.cssText = 'background: #e3f2fd; color: #1976d2; padding: 2px 6px; border-radius: 3px; font-size: 0.8em;';
                    categorySpan.textContent = sanitizedContact.category;
                    headerDiv.appendChild(categorySpan);
                }

                contentDiv.appendChild(headerDiv);

                // Contact details
                const details = [
                    `👤 ${sanitizedContact.contactName}`,
                    `📧 ${sanitizedContact.email}`,
                    `🌍 ${sanitizedContact.country}`
                ];

                if (sanitizedContact.phone) details.push(`📞 ${sanitizedContact.phone}`);
                if (sanitizedContact.website) details.push(`🌐 ${sanitizedContact.website}`);
                if (sanitizedContact.address) details.push(`📍 ${sanitizedContact.address}`);
                if (sanitizedContact.source) details.push(`📊 Source: ${sanitizedContact.source}`);

                details.forEach(detail => {
                    const detailDiv = document.createElement('div');
                    detailDiv.textContent = detail;
                    detailDiv.style.fontSize = '10px';
                    detailDiv.style.marginBottom = '2px';
                    contentDiv.appendChild(detailDiv);
                });

                // Status icon
                const statusDiv = document.createElement('div');
                statusDiv.style.cssText = 'display: flex; flex-direction: column; align-items: center; gap: 4px;';
                const iconColor = contact.emailStatus === 'sent' ? '#22c55e' : contact.emailStatus === 'failed' ? '#ef4444' : '#6b7280';
                statusDiv.innerHTML = '<div style="font-size: 16px; color: ' + iconColor + '; font-weight: bold;">' + statusIcon + '</div>' + statusBadge;

                flexContainer.appendChild(contentDiv);
                flexContainer.appendChild(statusDiv);
                div.appendChild(flexContainer);

                container.appendChild(div);
                console.log(`Contact ${index + 1} added to DOM`);
            });

            // Update counts
            updateContactCounts();

            // Enable bulk email button if contacts are available
            const bulkSendBtn = document.getElementById('bulkSendBtn');
            if (bulkSendBtn && contacts.length > 0) {
                bulkSendBtn.disabled = false;
                bulkSendBtn.style.background = '';
                bulkSendBtn.style.cursor = 'pointer';
                bulkSendBtn.title = `Send emails to all ${contacts.length} contacts`;
            }

            console.log('=== CONTACT RENDERING COMPLETE ===');

            // Auto-save after contact loading
            if (contacts.length > 0) {
                saveToLocalStorage();
                // Show download button when contacts are loaded
                const downloadBtn = document.getElementById('downloadContactsBtn');
                if (downloadBtn) {
                    downloadBtn.style.display = 'inline-flex';
                }
            }
        }

        function updateContactCounts() {
            emailStatusCounts.total = contacts.length;
            emailStatusCounts.sent = contacts.filter(c => c.emailStatus === 'sent').length;
            emailStatusCounts.failed = contacts.filter(c => c.emailStatus === 'failed').length;
            emailStatusCounts.pending = contacts.filter(c => c.emailStatus === 'pending').length;

            document.getElementById('totalCount').textContent = `${emailStatusCounts.total} contacts`;
            document.getElementById('sentCount').textContent = `${emailStatusCounts.sent} sent`;
            document.getElementById('failedCount').textContent = `${emailStatusCounts.failed} failed`;
        }

        function handleScroll() {
            const contactsList = document.getElementById('contactsList');
            const scrollTopBtn = document.getElementById('scrollTopBtn');

            // Show scroll to top button when scrolled down more than 100px
            if (contactsList.scrollTop > 100) {
                scrollTopBtn.style.display = 'block';
            } else {
                scrollTopBtn.style.display = 'none';
            }
        }

        function scrollToTop() {
            const contactsList = document.getElementById('contactsList');
            contactsList.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        function selectContact(index) {
            selectedContactIndex = index;
            const contact = contacts[index];

            // Update UI
            document.querySelectorAll('.contact-item').forEach((item, i) => {
                item.classList.toggle('selected', i === index);
            });

            // Populate email form
            const toEmailField = document.getElementById('toEmail');
            if (toEmailField) {
                toEmailField.value = contact.email;
            }

            // Populate subject line
            const subjectField = document.getElementById('subject');
            if (subjectField) {
                subjectField.value = `Business Partnership Opportunity - Intex Technologies in ${contact.country}`;
            }

            // Populate message body
            const messageBody = document.getElementById('messageBody');
            if (messageBody) {
                const personalizedMessage = `Dear ${contact.contactName},

We are pleased to introduce Intex Technologies to ${contact.firm}.

Since our inception in 1996, we have been at the forefront of innovation in consumer electronics and technology sectors. We believe ${contact.firm}, with its established market presence in ${contact.country}, would be an ideal partner for expanding our reach.

Our Product Portfolio:
• IT Peripherals: Speakers, keyboards, mice, webcams, and computer accessories
• Home Appliances: Air coolers, room heaters, water purifiers, and kitchen appliances
• Mobile Accessories: Power banks, chargers, cables, and smartphone accessories
• Audio Solutions: Wireless speakers, headphones, and sound systems

We are actively seeking distribution partners in ${contact.country} who share our vision of delivering high-quality, innovative products to consumers.

What We Offer Our Partners:
✓ Competitive pricing with attractive profit margins
✓ Comprehensive marketing support and co-branding opportunities
✓ Technical training and ongoing product support
✓ Flexible payment terms and credit facilities
✓ Exclusive territory rights (subject to discussion)
✓ Access to our complete product catalog and new launches

We would welcome the opportunity to discuss how we can work together to bring Intex Technologies' innovative products to the ${contact.country} market through ${contact.firm}.

Please feel free to contact us at your earliest convenience to explore this exciting business opportunity.

Best regards,

Vishwas Agarwal
Business Development Manager
Intex Technologies
Email: vishwas.agarwal@gmail.com
Phone: +91-XXXXXXXXXX`;

                // Sanitize the personalized message before setting innerHTML
                const sanitizedMessage = sanitizeHTML(personalizedMessage.replace(/\n/g, '<br>'));
                messageBody.innerHTML = sanitizedMessage;

                // Update hidden textarea
                const hiddenTextarea = document.getElementById('messageBodyHidden');
                if (hiddenTextarea) {
                    hiddenTextarea.value = messageBody.innerHTML;
                }
            }

            const sendBtn = document.getElementById('sendBtn');
            if (sendBtn) {
                sendBtn.disabled = false;
            }

            showAlert(`Selected: ${contact.contactName} from ${contact.firm}`, 'success');
        }

        async function sendEmail() {
            console.log('=== EMAIL SENDING STARTED ===');

            // Validate all inputs first
            const fromEmailValid = validateEmail(document.getElementById('fromEmail'));
            const toEmailValid = validateEmailList(document.getElementById('toEmail'));
            const subjectValid = validateSubject(document.getElementById('subject'));
            const messageValid = validateMessage(document.getElementById('messageBody'));

            if (!fromEmailValid || !toEmailValid || !subjectValid || !messageValid) {
                showAlert('Please fix all validation errors before sending', 'error');
                return;
            }

            const fromEmail = document.getElementById('fromEmail').value.trim();
            const toEmailField = document.getElementById('toEmail').value.trim();
            const subject = document.getElementById('subject').value.trim();
            const body = document.getElementById('messageBody').innerHTML.trim();

            // Parse multiple emails
            const toEmails = parseMultipleEmails(toEmailField);
            console.log('Email details:', { fromEmail, toEmails, subject: subject.substring(0, 50) + '...' });

            if (toEmails.length === 0) {
                showAlert('Please enter at least one valid email address', 'error');
                return;
            }

            // Security: Sanitize inputs
            const sanitizedSubject = sanitizeInput(subject);
            const sanitizedBody = sanitizeInput(body);

            if (toEmails.length > 1) {
                showAlert(`Sending to ${toEmails.length} email addresses...`, 'success');
            }

            try {
                document.getElementById('sendBtn').textContent = 'Sending...';
                document.getElementById('sendBtn').disabled = true;

                // Send to each email address (for multiple emails, send individually)
                let successCount = 0;
                let failureCount = 0;

                for (const toEmail of toEmails) {
                    console.log(`Sending to: ${toEmail}`);

                    try {
                        // Create contact object for email sending
                        const contact = {
                            email: toEmail,
                            contactName: '', // Will be extracted if available
                            firm: '',
                            country: ''
                        };

                        // Try to find contact details if it's a known contact
                        const knownContact = contacts.find(c => c.email === toEmail);
                        if (knownContact) {
                            contact.contactName = knownContact.contactName;
                            contact.firm = knownContact.firm;
                            contact.country = knownContact.country;
                        }

                        // Get message body HTML (preserving formatting)
                        const messageBodyHTML = document.getElementById('messageBody').innerHTML;

                        // Send email using real email service
                        const result = await sendRealEmail(contact, subject, messageBodyHTML);
                        console.log(`Response for ${toEmail}:`, result);

                        if (result.success) {
                            successCount++;
                            addToEmailHistory(toEmail, subject, 'sent', Date.now(), contact.country);
                        } else {
                            failureCount++;
                            addToEmailHistory(toEmail, subject, 'failed', Date.now(), contact.country);
                            console.error(`Email failed for ${toEmail}:`, result.error);
                        }
                    } catch (emailError) {
                        console.error(`Error sending to ${toEmail}:`, emailError);
                        failureCount++;
                        addToEmailHistory(toEmail, subject, 'failed', Date.now());
                    }
                }

                // Show summary results
                if (successCount > 0 && failureCount === 0) {
                    showAlert(`✅ Successfully sent to all ${successCount} email(s)`);
                } else if (successCount > 0 && failureCount > 0) {
                    showAlert(`⚠️ Sent to ${successCount}, failed to ${failureCount} email(s)`);
                } else {
                    showAlert(`❌ Failed to send to all ${failureCount} email(s). Email services need configuration - check the Data menu > Email Setup`, 'error');
                }

                // Update contact status if single contact selected
                if (selectedContactIndex >= 0 && toEmails.length === 1) {
                    contacts[selectedContactIndex].emailStatus = successCount > 0 ? 'sent' : 'failed';
                    renderContacts(); // Re-render to show color
                }

            } catch (error) {
                console.error('Email sending error:', error);
                showAlert(`Network error: ${error.message}`, 'error');

                // Update contact status to failed on network error
                if (selectedContactIndex >= 0) {
                    contacts[selectedContactIndex].emailStatus = 'failed';
                    renderContacts(); // Re-render to show red color
                }
            } finally {
                document.getElementById('sendBtn').textContent = 'Send Email';
                document.getElementById('sendBtn').disabled = false;
            }
        }

        // Bulk Email Sending Functionality
        let bulkEmailInProgress = false;
        let bulkEmailPaused = false;
        let bulkEmailCancelled = false;
        let bulkEmailCurrentIndex = 0;
        let bulkEmailTotal = 0;
        let bulkEmailSuccessCount = 0;
        let bulkEmailFailureCount = 0;

        // Bulk Email Confirmation System
        function showBulkEmailConfirmation() {
            if (contacts.length === 0) {
                showAlert('No contacts available for bulk email. Please upload contacts first.', 'error');
                return;
            }

            // Validate email fields first
            const fromEmailValid = validateEmail(document.getElementById('fromEmail'));
            const subjectValid = validateSubject(document.getElementById('subject'));
            const messageValid = validateMessage(document.getElementById('messageBody'));

            if (!fromEmailValid || !subjectValid || !messageValid) {
                showAlert('Please fix all validation errors before proceeding with bulk email', 'error');
                return;
            }

            // Get email details
            const fromEmail = document.getElementById('fromEmail').value;
            const subject = document.getElementById('subject').value;
            const messageBody = document.getElementById('messageBody');
            const messageHTML = messageBody.innerHTML;
            const messageText = messageBody.textContent || messageBody.innerText;

            // Create confirmation modal
            const modal = document.createElement('div');
            modal.id = 'bulkEmailConfirmModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
                z-index: 15000; padding: 20px;
            `;

            // Get first few contacts for preview
            const previewContacts = contacts.slice(0, 5);
            const remainingCount = contacts.length - previewContacts.length;

            // Generate email previews for first few contacts
            const emailPreviews = previewContacts.map(contact => {
                const personalizedSubject = subject
                    .replace(/{contactName}/g, contact.contactName || '')
                    .replace(/{firm}/g, contact.firm || '')
                    .replace(/{country}/g, contact.country || '')
                    .replace(/{email}/g, contact.email || '');

                const personalizedMessage = messageText
                    .replace(/{contactName}/g, contact.contactName || '')
                    .replace(/{firm}/g, contact.firm || '')
                    .replace(/{country}/g, contact.country || '')
                    .replace(/{email}/g, contact.email || '');

                return {
                    contact,
                    subject: personalizedSubject,
                    message: personalizedMessage.substring(0, 200) + (personalizedMessage.length > 200 ? '...' : '')
                };
            });

            modal.innerHTML = `
                <div style="background: white; border-radius: 8px; max-width: 800px; width: 90%; max-height: 90%; overflow-y: auto; padding: 0;">
                    <!-- Header -->
                    <div style="padding: 24px 24px 16px 24px; border-bottom: 1px solid #e0e0e0;">
                        <h2 style="margin: 0; color: #202124; font-size: 20px; font-weight: 500;">Review Bulk Email</h2>
                        <p style="margin: 8px 0 0 0; color: #5f6368; font-size: 14px;">Please review the email content and recipients before sending</p>
                    </div>

                    <!-- Email Summary -->
                    <div style="padding: 20px 24px;">
                        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 12px;">
                                <div>
                                    <div style="font-size: 12px; color: #5f6368; margin-bottom: 4px;">FROM</div>
                                    <div style="font-size: 14px; color: #202124;">${escapeHTML(fromEmail)}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #5f6368; margin-bottom: 4px;">RECIPIENTS</div>
                                    <div style="font-size: 14px; color: #202124; font-weight: 500;">${contacts.length} contacts</div>
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #5f6368; margin-bottom: 4px;">SUBJECT TEMPLATE</div>
                                <div style="font-size: 14px; color: #202124;">${escapeHTML(subject)}</div>
                            </div>
                        </div>

                        <!-- Message Preview -->
                        <div style="margin-bottom: 24px;">
                            <h3 style="margin: 0 0 12px 0; color: #202124; font-size: 16px; font-weight: 500;">Message Template</h3>
                            <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; background: white; max-height: 200px; overflow-y: auto;">
                                <div style="font-size: 14px; line-height: 1.5; color: #202124;">${messageHTML}</div>
                            </div>
                        </div>

                        <!-- Personalized Previews -->
                        <div style="margin-bottom: 24px;">
                            <h3 style="margin: 0 0 12px 0; color: #202124; font-size: 16px; font-weight: 500;">Personalized Email Previews</h3>
                            <div style="font-size: 12px; color: #5f6368; margin-bottom: 12px;">Preview of how emails will look for first ${previewContacts.length} contacts${remainingCount > 0 ? ` (${remainingCount} more contacts will receive similar personalized emails)` : ''}</div>

                            ${emailPreviews.map((preview, index) => `
                                <div style="border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 12px; overflow: hidden;">
                                    <div style="background: #f8f9fa; padding: 12px 16px; border-bottom: 1px solid #e0e0e0;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <div style="font-size: 14px; font-weight: 500; color: #202124;">${escapeHTML(preview.contact.contactName || 'N/A')} (${escapeHTML(preview.contact.email)})</div>
                                                <div style="font-size: 12px; color: #5f6368;">${escapeHTML(preview.contact.firm || 'N/A')} • ${escapeHTML(preview.contact.country || 'N/A')}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding: 12px 16px;">
                                        <div style="font-size: 12px; color: #5f6368; margin-bottom: 4px;">SUBJECT:</div>
                                        <div style="font-size: 14px; color: #202124; margin-bottom: 8px; font-weight: 500;">${escapeHTML(preview.subject)}</div>
                                        <div style="font-size: 12px; color: #5f6368; margin-bottom: 4px;">MESSAGE PREVIEW:</div>
                                        <div style="font-size: 13px; color: #202124; line-height: 1.4;">${escapeHTML(preview.message)}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <!-- Warning Notice -->
                        <div style="background: #fef7e0; border: 1px solid #fdd835; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <div style="font-size: 18px; color: #f57f17; margin-top: 2px;">⚠️</div>
                                <div>
                                    <div style="font-size: 14px; font-weight: 500; color: #f57f17; margin-bottom: 4px;">Important Notice</div>
                                    <div style="font-size: 13px; color: #795548; line-height: 1.4;">
                                        • This will send <strong>${contacts.length} individual emails</strong><br>
                                        • Each email will be personalized with contact-specific information<br>
                                        • Please ensure you have permission to contact all recipients<br>
                                        • This action cannot be undone once started
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer Actions -->
                    <div style="padding: 16px 24px; border-top: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa;">
                        <div style="font-size: 13px; color: #5f6368;">
                            Ready to send ${contacts.length} personalized emails?
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <button onclick="closeBulkEmailConfirmation()" class="button">Cancel</button>
                            <button onclick="confirmBulkEmailSending()" class="button button-primary">Send All Emails</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function closeBulkEmailConfirmation() {
            const modal = document.getElementById('bulkEmailConfirmModal');
            if (modal) {
                modal.remove();
            }
        }

        function confirmBulkEmailSending() {
            closeBulkEmailConfirmation();
            startBulkEmailSending();
        }

        async function startBulkEmailSending() {
            if (bulkEmailInProgress) {
                showAlert('Bulk email is already in progress', 'error');
                return;
            }

            if (contacts.length === 0) {
                showAlert('No contacts available for bulk email. Please upload contacts first.', 'error');
                return;
            }

            // Validate email fields
            const fromEmailValid = validateEmail(document.getElementById('fromEmail'));
            const subjectValid = validateSubject(document.getElementById('subject'));
            const messageValid = validateMessage(document.getElementById('messageBody'));

            if (!fromEmailValid || !subjectValid || !messageValid) {
                showAlert('Please fix all validation errors before sending bulk emails', 'error');
                return;
            }

            // Initialize bulk email session
            bulkEmailInProgress = true;
            bulkEmailPaused = false;
            bulkEmailCancelled = false;
            bulkEmailCurrentIndex = 0;
            bulkEmailTotal = contacts.length;
            bulkEmailSuccessCount = 0;
            bulkEmailFailureCount = 0;

            // Update UI
            const bulkBtn = document.getElementById('bulkSendBtn');
            bulkBtn.innerHTML = 'Pause';
            bulkBtn.onclick = () => pauseBulkEmail();
            document.getElementById('sendBtn').disabled = true;

            // Show progress modal
            showBulkEmailProgress();

            // Start sending
            await processBulkEmails();
        }

        async function processBulkEmails() {
            while (bulkEmailCurrentIndex < bulkEmailTotal && !bulkEmailCancelled) {
                if (bulkEmailPaused) {
                    await new Promise(resolve => {
                        const checkPause = () => {
                            if (!bulkEmailPaused || bulkEmailCancelled) {
                                resolve();
                            } else {
                                setTimeout(checkPause, 1000);
                            }
                        };
                        checkPause();
                    });
                }

                if (bulkEmailCancelled) break;

                const contact = contacts[bulkEmailCurrentIndex];
                updateBulkEmailProgress();

                try {
                    // Get personalized subject and message
                    const personalizedSubject = document.getElementById('subject').value
                        .replace('{contactName}', contact.contactName || '')
                        .replace('{firm}', contact.firm || '')
                        .replace('{country}', contact.country || '')
                        .replace('{email}', contact.email || '');

                    const messageBody = document.getElementById('messageBody');
                    const personalizedMessage = messageBody.innerHTML
                        .replace(/{contactName}/g, contact.contactName || '')
                        .replace(/{firm}/g, contact.firm || '')
                        .replace(/{country}/g, contact.country || '')
                        .replace(/{email}/g, contact.email || '');

                    // Send actual email with preserved formatting
                    const emailResult = await sendRealEmail(contact, personalizedSubject, personalizedMessage);
                    const success = emailResult.success;

                    if (success) {
                        bulkEmailSuccessCount++;
                        addToEmailHistory(contact.email, personalizedSubject, 'sent', Date.now(), contact.country);
                    } else {
                        bulkEmailFailureCount++;
                        addToEmailHistory(contact.email, personalizedSubject, 'failed', Date.now(), contact.country);
                    }

                    // Rate limiting - delay between emails
                    await new Promise(resolve => setTimeout(resolve, 2000)); // 2 second delay

                } catch (error) {
                    console.error('Error sending email to:', contact.email, error);
                    bulkEmailFailureCount++;
                    addToEmailHistory(contact.email, 'Failed to send', 'failed', Date.now(), contact.country);
                }

                bulkEmailCurrentIndex++;
            }

            // Complete bulk email session
            completeBulkEmail();
        }

        async function sendRealEmail(contact, subject, messageHTML) {
            try {
                // Prepare email data with proper formatting preservation
                const emailData = {
                    from_email: document.getElementById('fromEmail').value,
                    from_name: window.defaultFromName || 'Professional Outreach',
                    to_email: contact.email,
                    to_name: contact.contactName,
                    subject: subject,
                    html_content: messageHTML, // Preserve HTML formatting
                    text_content: stripHTML(messageHTML), // Plain text fallback
                    company: contact.firm,
                    country: contact.country
                };

                console.log('Sending email to:', contact.email);

                // Try multiple email service options in order of preference
                const emailServices = [
                    () => sendViaEmailJS(emailData),
                    () => sendViaNetlifyFunction(emailData),
                    () => sendViaFormspree(emailData),
                    () => sendViaWebhook(emailData)
                ];

                let lastError = null;
                for (const service of emailServices) {
                    try {
                        const result = await service();
                        if (result.success) {
                            console.log('Email sent successfully via service');
                            return { success: true, service: result.service };
                        }
                    } catch (error) {
                        console.log('Email service failed, trying next...', error.message);
                        lastError = error;
                        continue;
                    }
                }

                // If all services fail, return error with helpful message
                console.error('All email services failed:', lastError);
                const errorMessage = 'Email services not configured. To send real emails, please configure EmailJS, Formspree, or a custom webhook in the Email Configuration settings.';
                return { success: false, error: errorMessage };

            } catch (error) {
                console.error('Email sending error:', error);
                return { success: false, error: error.message };
            }
        }

        function stripHTML(html) {
            const div = document.createElement('div');
            div.innerHTML = html;
            return div.textContent || div.innerText || '';
        }

        // EmailJS Integration (Free tier: 200 emails/month)
        async function sendViaEmailJS(emailData) {
            if (!EMAIL_CONFIG.emailjs.enabled) {
                throw new Error('EmailJS service disabled');
            }

            if (typeof emailjs === 'undefined') {
                throw new Error('EmailJS not loaded');
            }

            try {
                // Initialize EmailJS if not already done
                if (!window.emailjsInitialized) {
                    emailjs.init(EMAIL_CONFIG.emailjs.publicKey);
                    window.emailjsInitialized = true;
                }

                const result = await emailjs.send(
                    EMAIL_CONFIG.emailjs.serviceId,
                    EMAIL_CONFIG.emailjs.templateId,
                    {
                        from_name: emailData.from_name,
                        from_email: emailData.from_email,
                        to_name: emailData.to_name,
                        to_email: emailData.to_email,
                        subject: emailData.subject,
                        message: emailData.html_content,
                        company: emailData.company,
                        country: emailData.country
                    }
                );

                return { success: true, service: 'EmailJS', messageId: result.text };
            } catch (error) {
                throw new Error(`EmailJS failed: ${error.message}`);
            }
        }

        // Netlify Functions Integration
        async function sendViaNetlifyFunction(emailData) {
            if (!EMAIL_CONFIG.netlify.enabled) {
                throw new Error('Netlify service disabled');
            }

            try {
                const response = await fetch(EMAIL_CONFIG.netlify.endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(emailData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                if (result.success) {
                    return { success: true, service: 'Netlify', messageId: result.messageId };
                } else {
                    throw new Error(result.error || 'Netlify function failed');
                }
            } catch (error) {
                throw new Error(`Netlify function failed: ${error.message}`);
            }
        }

        // Formspree Integration (Free tier: 50 submissions/month)
        async function sendViaFormspree(emailData) {
            if (!EMAIL_CONFIG.formspree.enabled) {
                throw new Error('Formspree service disabled');
            }

            try {
                const response = await fetch(EMAIL_CONFIG.formspree.endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: emailData.from_email,
                        name: emailData.from_name,
                        subject: emailData.subject,
                        message: emailData.html_content,
                        recipient: emailData.to_email,
                        _replyto: emailData.from_email
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return { success: true, service: 'Formspree' };
            } catch (error) {
                throw new Error(`Formspree failed: ${error.message}`);
            }
        }

        // Custom Webhook Integration
        async function sendViaWebhook(emailData) {
            if (!EMAIL_CONFIG.webhook.enabled) {
                throw new Error('Webhook service disabled');
            }

            try {
                const response = await fetch(EMAIL_CONFIG.webhook.endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${EMAIL_CONFIG.webhook.apiKey}`
                    },
                    body: JSON.stringify(emailData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                return { success: true, service: 'Webhook', messageId: result.id };
            } catch (error) {
                throw new Error(`Webhook failed: ${error.message}`);
            }
        }

        function pauseBulkEmail() {
            if (bulkEmailPaused) {
                // Resume
                bulkEmailPaused = false;
                const bulkBtn = document.getElementById('bulkSendBtn');
                bulkBtn.innerHTML = 'Pause';
                showAlert('Bulk email resumed', 'info');
            } else {
                // Pause
                bulkEmailPaused = true;
                const bulkBtn = document.getElementById('bulkSendBtn');
                bulkBtn.innerHTML = 'Resume';
                showAlert('Bulk email paused', 'info');
            }
        }

        function cancelBulkEmail() {
            bulkEmailCancelled = true;
            completeBulkEmail();
            showAlert('Bulk email cancelled', 'error');
        }

        function completeBulkEmail() {
            bulkEmailInProgress = false;
            bulkEmailPaused = false;

            // Update UI
            const bulkBtn = document.getElementById('bulkSendBtn');
            bulkBtn.innerHTML = 'Bulk Email';
            bulkBtn.onclick = () => startBulkEmailSending();
            document.getElementById('sendBtn').disabled = false;

            // Hide progress modal
            hideBulkEmailProgress();

            // Update analytics
            updateAnalytics();
            renderEmailHistory();

            // Show completion message
            if (!bulkEmailCancelled) {
                showAlert(`Bulk email complete! ${bulkEmailSuccessCount} sent, ${bulkEmailFailureCount} failed`, 'success');
            }
        }

        function showBulkEmailProgress() {
            const modal = document.createElement('div');
            modal.id = 'bulkEmailModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
                z-index: 10000;
            `;

            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
                    <h3 style="margin: 0 0 20px 0; color: #007bff;">📧 Bulk Email Progress</h3>
                    <div id="bulkProgressText" style="margin-bottom: 15px; font-size: 14px;">Preparing to send...</div>
                    <div style="background: #f0f0f0; border-radius: 4px; height: 20px; margin-bottom: 15px; overflow: hidden;">
                        <div id="bulkProgressBar" style="background: #007bff; height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-bottom: 20px;">
                        <span>✅ Success: <span id="bulkSuccessCount">0</span></span>
                        <span>❌ Failed: <span id="bulkFailedCount">0</span></span>
                        <span>📊 Total: <span id="bulkTotalCount">${bulkEmailTotal}</span></span>
                    </div>
                    <button onclick="cancelBulkEmail()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Cancel</button>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function updateBulkEmailProgress() {
            const progressText = document.getElementById('bulkProgressText');
            const progressBar = document.getElementById('bulkProgressBar');
            const successCount = document.getElementById('bulkSuccessCount');
            const failedCount = document.getElementById('bulkFailedCount');

            if (progressText) {
                const contact = contacts[bulkEmailCurrentIndex];
                progressText.textContent = `Sending to: ${contact.contactName} (${contact.email})`;
            }

            if (progressBar) {
                const percentage = (bulkEmailCurrentIndex / bulkEmailTotal) * 100;
                progressBar.style.width = percentage + '%';
            }

            if (successCount) successCount.textContent = bulkEmailSuccessCount;
            if (failedCount) failedCount.textContent = bulkEmailFailureCount;
        }

        function hideBulkEmailProgress() {
            const modal = document.getElementById('bulkEmailModal');
            if (modal) {
                modal.remove();
            }
        }

        // Failed Uploads Spreadsheet Functionality
        function showFailedUploadsSpreadsheet() {
            const failedRecords = uploadedSpreadsheetData.filter(row => row.status === 'failed');

            if (failedRecords.length === 0) {
                showAlert('No failed uploads to display', 'info');
                return;
            }

            // Create modal for failed uploads
            const modal = document.createElement('div');
            modal.id = 'failedUploadsModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
                z-index: 10000; padding: 20px;
            `;

            // Generate table HTML
            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Row #</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Email</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Contact Name</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Company</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Country</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Failure Reason</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            failedRecords.forEach((record, index) => {
                const reason = getFailureReason(record);
                tableHTML += `
                    <tr style="${index % 2 === 0 ? 'background: #f9f9f9;' : ''}">
                        <td style="border: 1px solid #ddd; padding: 8px;">${record.originalRowIndex + 1}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${record.email || 'N/A'}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${record.contactName || 'N/A'}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${record.firm || 'N/A'}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${record.country || 'N/A'}</td>
                        <td style="border: 1px solid #ddd; padding: 8px; color: #dc3545;">${reason}</td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            modal.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 8px; max-width: 90%; max-height: 90%; width: 800px; overflow: hidden; display: flex; flex-direction: column;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #dc3545;">❌ Failed Uploads Report</h3>
                        <button onclick="exportFailedUploads()" class="button button-success" style="margin-right: 10px;">Export CSV</button>
                        <button onclick="closeFailedUploadsModal()" class="button">Close</button>
                    </div>
                    <div style="font-size: 14px; margin-bottom: 10px; color: #666;">
                        Total Failed Records: <strong>${failedRecords.length}</strong>
                    </div>
                    <div style="overflow: auto; flex: 1;">
                        ${tableHTML}
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function getFailureReason(record) {
            if (!record.email || record.email.trim() === '') {
                return 'Missing email address';
            }
            if (!EMAIL_REGEX.test(record.email)) {
                return 'Invalid email format';
            }
            if (!record.contactName && !record.firm) {
                return 'Missing contact name and company';
            }
            return 'Data validation failed';
        }

        function closeFailedUploadsModal() {
            const modal = document.getElementById('failedUploadsModal');
            if (modal) {
                modal.remove();
            }
        }

        function exportFailedUploads() {
            const failedRecords = uploadedSpreadsheetData.filter(row => row.status === 'failed');

            if (failedRecords.length === 0) {
                showAlert('No failed uploads to export', 'info');
                return;
            }

            // Create CSV content
            const headers = ['Row Number', 'Email', 'Contact Name', 'Company', 'Country', 'Failure Reason'];
            let csvContent = headers.join(',') + '\n';

            failedRecords.forEach(record => {
                const row = [
                    record.originalRowIndex + 1,
                    record.email || '',
                    record.contactName || '',
                    record.firm || '',
                    record.country || '',
                    getFailureReason(record)
                ].map(field => `"${field.toString().replace(/"/g, '""')}"`).join(',');
                csvContent += row + '\n';
            });

            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `failed_uploads_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            showAlert('Failed uploads exported to CSV', 'success');
        }

        // Contact Status Download Functionality
        function downloadContactStatus() {
            if (contacts.length === 0) {
                showAlert('No contacts to export', 'info');
                return;
            }

            try {
                // Create CSV content with contact status
                const headers = [
                    'Row Number',
                    'Contact Name',
                    'Company',
                    'Email Address',
                    'Country',
                    'Phone',
                    'Website',
                    'Email Status',
                    'Last Updated'
                ];

                let csvContent = headers.join(',') + '\n';

                contacts.forEach((contact, index) => {
                    const row = [
                        index + 1,
                        contact.contactName || '',
                        contact.firm || '',
                        contact.email || '',
                        contact.country || '',
                        contact.phone || '',
                        contact.website || '',
                        contact.emailStatus || 'pending',
                        new Date().toISOString().split('T')[0] // Today's date
                    ].map(field => `"${field.toString().replace(/"/g, '""')}"`).join(',');
                    csvContent += row + '\n';
                });

                // Add summary statistics
                csvContent += '\n';
                csvContent += '"SUMMARY STATISTICS"\n';
                csvContent += `"Total Contacts","${contacts.length}"\n`;
                csvContent += `"Successfully Sent","${contacts.filter(c => c.emailStatus === 'sent').length}"\n`;
                csvContent += `"Failed to Send","${contacts.filter(c => c.emailStatus === 'failed').length}"\n`;
                csvContent += `"Pending/Not Sent","${contacts.filter(c => c.emailStatus === 'pending').length}"\n`;
                csvContent += `"Success Rate","${contacts.length > 0 ? Math.round((contacts.filter(c => c.emailStatus === 'sent').length / contacts.length) * 100) : 0}%"\n`;
                csvContent += `"Export Date","${new Date().toLocaleString()}"\n`;
                csvContent += `"Source Document","${currentUploadedFileName || 'Unknown'}"\n`;

                // Generate filename with document reference
                const sourceFileName = currentUploadedFileName ?
                    currentUploadedFileName.replace(/\.[^/.]+$/, '') : // Remove extension
                    'contacts';
                const timestamp = new Date().toISOString().split('T')[0];
                const filename = `${sourceFileName}_contact_status_${timestamp}.csv`;

                // Download CSV
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                const successRate = contacts.length > 0 ? Math.round((contacts.filter(c => c.emailStatus === 'sent').length / contacts.length) * 100) : 0;
                showAlert(`Contact status exported! (${contacts.length} contacts, ${successRate}% success rate)`, 'success');

            } catch (error) {
                console.error('Error exporting contact status:', error);
                showAlert('Failed to export contact status', 'error');
            }
        }

        // Secure Data Persistence Functions
        async function saveToLocalStorage() {
            try {
                if (!autoSaveEnabled) return;

                // Sanitize all data before encryption
                const sanitizedContacts = contacts.map(contact => ({
                    email: sanitizeEmail(contact.email),
                    contactName: sanitizeText(contact.contactName),
                    firm: sanitizeText(contact.firm),
                    country: sanitizeText(contact.country),
                    phone: sanitizeText(contact.phone),
                    website: sanitizeText(contact.website),
                    address: sanitizeText(contact.address),
                    emailStatus: contact.emailStatus || 'pending'
                }));

                const sanitizedEmailHistory = emailHistory.map(entry => ({
                    id: entry.id,
                    toEmails: Array.isArray(entry.toEmails) ? entry.toEmails.map(sanitizeEmail) : [sanitizeEmail(entry.toEmails)],
                    subject: sanitizeSubject(entry.subject),
                    status: entry.status,
                    timestamp: entry.timestamp,
                    country: sanitizeText(entry.country),
                    content: sanitizeHTML(entry.content)
                }));

                const dataToSave = {
                    contacts: sanitizedContacts,
                    emailHistory: sanitizedEmailHistory,
                    uploadedSpreadsheetData: uploadedSpreadsheetData,
                    savedAt: Date.now(),
                    version: '2.2'
                };

                // Encrypt data before storing
                const encryptedData = await encryptData(dataToSave);
                localStorage.setItem(STORAGE_KEYS.CONTACTS, encryptedData);
                lastAutoSave = Date.now();
                console.log('Data encrypted and saved to localStorage');
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                showAlert('Failed to save data locally', 'error');
            }
        }

        async function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEYS.CONTACTS);
                if (!savedData) return false;

                // Decrypt data
                const parsedData = await decryptData(savedData);
                if (!parsedData || !parsedData.contacts || !Array.isArray(parsedData.contacts)) return false;

                // Validate and sanitize loaded data
                const validatedContacts = parsedData.contacts
                    .filter(contact => contact.email && EMAIL_REGEX.test(contact.email))
                    .map(contact => ({
                        email: sanitizeEmail(contact.email),
                        contactName: sanitizeText(contact.contactName),
                        firm: sanitizeText(contact.firm),
                        country: sanitizeText(contact.country),
                        phone: sanitizeText(contact.phone),
                        website: sanitizeText(contact.website),
                        address: sanitizeText(contact.address),
                        emailStatus: contact.emailStatus || 'pending'
                    }));

                // Restore data
                contacts = validatedContacts;
                emailHistory = parsedData.emailHistory || [];
                uploadedSpreadsheetData = parsedData.uploadedSpreadsheetData || [];

                // Update UI
                renderContacts();
                renderEmailHistory();
                updateAnalytics();

                // Show upload status if we have data
                if (uploadedSpreadsheetData.length > 0) {
                    const statusReport = generateStatusReport();
                    showUploadStatusReport(statusReport);
                }

                const savedDate = new Date(parsedData.savedAt).toLocaleString();
                showAlert(`Secure data restored from ${savedDate} (${contacts.length} contacts)`, 'success');
                return true;
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                return false;
            }
        }

        function saveDraftEmail() {
            try {
                const draft = {
                    fromEmail: document.getElementById('fromEmail').value,
                    toEmail: document.getElementById('toEmail').value,
                    subject: document.getElementById('subject').value,
                    messageBody: document.getElementById('messageBody').innerHTML,
                    savedAt: Date.now()
                };

                localStorage.setItem(STORAGE_KEYS.DRAFTS, JSON.stringify(draft));
                showAlert('Draft saved', 'info');
            } catch (error) {
                console.error('Error saving draft:', error);
                showAlert('Failed to save draft', 'error');
            }
        }

        function loadDraftEmail() {
            try {
                const savedDraft = localStorage.getItem(STORAGE_KEYS.DRAFTS);
                if (!savedDraft) return false;

                const draft = JSON.parse(savedDraft);

                // Confirm before loading
                if (confirm('Load saved draft? This will replace current email content.')) {
                    document.getElementById('fromEmail').value = draft.fromEmail || '';
                    document.getElementById('toEmail').value = draft.toEmail || '';
                    document.getElementById('subject').value = draft.subject || '';
                    document.getElementById('messageBody').innerHTML = draft.messageBody || '';

                    const savedDate = new Date(draft.savedAt).toLocaleString();
                    showAlert(`Draft loaded from ${savedDate}`, 'success');
                    return true;
                }
            } catch (error) {
                console.error('Error loading draft:', error);
                return false;
            }
        }

        function exportAllData() {
            try {
                const exportData = {
                    contacts: contacts,
                    emailHistory: emailHistory,
                    uploadedSpreadsheetData: uploadedSpreadsheetData,
                    exportedAt: new Date().toISOString(),
                    version: '2.2'
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `bulk_email_data_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showAlert('All data exported successfully', 'success');
            } catch (error) {
                console.error('Error exporting data:', error);
                showAlert('Failed to export data', 'error');
            }
        }

        function importAllData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);

                        // Validate data structure
                        if (!importedData.contacts || !Array.isArray(importedData.contacts)) {
                            throw new Error('Invalid data format');
                        }

                        // Confirm import
                        if (confirm(`Import data from ${new Date(importedData.exportedAt).toLocaleString()}? This will replace all current data.`)) {
                            contacts = importedData.contacts || [];
                            emailHistory = importedData.emailHistory || [];
                            uploadedSpreadsheetData = importedData.uploadedSpreadsheetData || [];

                            // Update UI
                            renderContacts();
                            renderEmailHistory();
                            updateAnalytics();

                            // Save to localStorage
                            saveToLocalStorage();

                            showAlert(`Imported ${contacts.length} contacts and ${emailHistory.length} email records`, 'success');
                        }
                    } catch (error) {
                        console.error('Error importing data:', error);
                        showAlert('Failed to import data: Invalid file format', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
                if (confirm('This will delete all contacts, email history, and drafts. Continue?')) {
                    // Clear memory
                    contacts = [];
                    emailHistory = [];
                    uploadedSpreadsheetData = [];
                    failedUploads = [];

                    // Clear localStorage
                    Object.values(STORAGE_KEYS).forEach(key => {
                        localStorage.removeItem(key);
                    });

                    // Update UI
                    renderContacts();
                    renderEmailHistory();
                    updateAnalytics();
                    document.getElementById('uploadStats').style.display = 'none';

                    // Clear email form
                    document.getElementById('toEmail').value = '';
                    document.getElementById('subject').value = '';
                    document.getElementById('messageBody').innerHTML = '';

                    showAlert('All data cleared', 'success');
                }
            }
        }

        // Auto-save functionality
        function setupAutoSave() {
            // Auto-save every 30 seconds
            setInterval(() => {
                if (autoSaveEnabled && contacts.length > 0) {
                    saveToLocalStorage();
                }
            }, 30000);

            // Save when email content changes
            document.getElementById('messageBody').addEventListener('input', () => {
                if (autoSaveEnabled) {
                    clearTimeout(window.autoSaveTimeout);
                    window.autoSaveTimeout = setTimeout(saveDraftEmail, 5000);
                }
            });
        }

        function toggleDataMenu() {
            const menu = document.getElementById('dataMenu');
            if (menu.style.display === 'none' || menu.style.display === '') {
                menu.style.display = 'block';
                // Close menu when clicking outside
                setTimeout(() => {
                    document.addEventListener('click', closeDataMenu);
                }, 100);
            } else {
                menu.style.display = 'none';
            }
        }

        function closeDataMenu(event) {
            const menu = document.getElementById('dataMenu');
            const button = document.getElementById('dataMenuBtn');
            if (!menu.contains(event.target) && !button.contains(event.target)) {
                menu.style.display = 'none';
                document.removeEventListener('click', closeDataMenu);
            }
        }

        // User Onboarding Tutorial System
        let tutorialActive = false;
        let currentTutorialStep = 0;
        let tutorialOverlay = null;

        const tutorialSteps = [
            {
                title: 'Welcome to Bulk Email Sender! 🚀',
                description: 'This tutorial will guide you through all features of the application. Let\'s start by learning how to upload your contact files.',
                target: null,
                position: 'center'
            },
            {
                title: 'Step 1: Upload Contact Files 📁',
                description: 'Click here to upload your contact files. Supports Excel, CSV, PDF, Word, PowerPoint, and even images with text.',
                target: '#fileUpload',
                position: 'bottom',
                highlight: true
            },
            {
                title: 'Step 2: View Upload Status 📊',
                description: 'After uploading, you\'ll see statistics here. Click on "failed" link to view detailed error reports in a spreadsheet.',
                target: '#uploadStats',
                position: 'bottom'
            },
            {
                title: 'Step 3: Contact List 📝',
                description: 'Your contacts appear here. Click on any contact to auto-populate the email fields with personalized content.',
                target: '#contactsList',
                position: 'right'
            },
            {
                title: 'Step 4: Email Composition ✍️',
                description: 'Compose your emails here. Use the formatting toolbar for rich text editing including colors, lists, and links.',
                target: '#messageBody',
                position: 'left',
                highlight: true
            },
            {
                title: 'Step 5: Smart Message AI 🤖',
                description: 'Click "Smart Message" for AI assistance to enhance your email content based on company profiles and context.',
                target: '[onclick="openSmartMessage()"]',
                position: 'bottom'
            },
            {
                title: 'Step 6: Data Management 💾',
                description: 'Use this menu to save drafts, export data, or import previous sessions. Auto-save keeps your work safe.',
                target: '#dataMenuBtn',
                position: 'bottom'
            },
            {
                title: 'Step 7: Send Options 📤',
                description: 'Send individual emails or use bulk email for all contacts with progress tracking and pause/resume functionality.',
                target: '#sendBtn',
                position: 'bottom'
            },
            {
                title: 'Step 8: Analytics Dashboard 📊',
                description: 'Monitor your email performance with real-time analytics including success rates and geographic data.',
                target: '#emailHistory',
                position: 'left'
            },
            {
                title: 'Step 9: Response Management 📨',
                description: 'Click this icon to manage email responses with auto-forwarding to your main email address.',
                target: '#responseManagerBtn',
                position: 'left'
            },
            {
                title: 'Tutorial Complete! ✨',
                description: 'You\'re now ready to use all features. Remember: upload contacts, personalize messages, and track results. Need help anytime? Click the Help button.',
                target: null,
                position: 'center'
            }
        ];

        function startTutorial() {
            if (tutorialActive) {
                endTutorial();
                return;
            }

            tutorialActive = true;
            currentTutorialStep = 0;
            showTutorialStep();
        }

        function showTutorialStep() {
            const step = tutorialSteps[currentTutorialStep];
            if (!step) {
                endTutorial();
                return;
            }

            // Remove existing overlay
            if (tutorialOverlay) {
                tutorialOverlay.remove();
            }

            // Create overlay
            tutorialOverlay = document.createElement('div');
            tutorialOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                z-index: 20000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            // Highlight target element
            let targetElement = null;
            if (step.target) {
                targetElement = document.querySelector(step.target);
                if (targetElement && step.highlight) {
                    targetElement.style.position = 'relative';
                    targetElement.style.zIndex = '20001';
                    targetElement.style.boxShadow = '0 0 0 4px rgba(23, 162, 184, 0.8), 0 0 20px rgba(23, 162, 184, 0.6)';
                    targetElement.style.borderRadius = '4px';
                }
            }

            // Create tooltip
            const tooltip = document.createElement('div');
            tooltip.style.cssText = `
                background: white;
                padding: 20px;
                border-radius: 8px;
                max-width: 400px;
                width: 90%;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                position: relative;
                margin: 20px;
            `;

            // Position tooltip based on target
            if (targetElement && step.position !== 'center') {
                const rect = targetElement.getBoundingClientRect();
                tutorialOverlay.style.alignItems = 'flex-start';
                tutorialOverlay.style.justifyContent = 'flex-start';

                let top, left;
                switch (step.position) {
                    case 'bottom':
                        top = rect.bottom + 10;
                        left = rect.left + (rect.width / 2) - 200;
                        break;
                    case 'top':
                        top = rect.top - 120;
                        left = rect.left + (rect.width / 2) - 200;
                        break;
                    case 'left':
                        top = rect.top + (rect.height / 2) - 60;
                        left = rect.left - 420;
                        break;
                    case 'right':
                        top = rect.top + (rect.height / 2) - 60;
                        left = rect.right + 10;
                        break;
                }

                // Ensure tooltip stays in viewport
                top = Math.max(10, Math.min(top, window.innerHeight - 140));
                left = Math.max(10, Math.min(left, window.innerWidth - 420));

                tooltip.style.position = 'absolute';
                tooltip.style.top = top + 'px';
                tooltip.style.left = left + 'px';
                tooltip.style.margin = '0';
            }

            tooltip.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <h3 style="margin: 0 0 10px 0; color: #17a2b8; font-size: 18px;">${step.title}</h3>
                    <p style="margin: 0; line-height: 1.5; color: #333;">${step.description}</p>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 12px; color: #666;">
                        Step ${currentTutorialStep + 1} of ${tutorialSteps.length}
                    </div>
                    <div>
                        ${currentTutorialStep > 0 ? '<button onclick="previousTutorialStep()" style="background: #6c757d; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; margin-right: 10px;">← Previous</button>' : ''}
                        ${currentTutorialStep < tutorialSteps.length - 1 ? '<button onclick="nextTutorialStep()" style="background: #17a2b8; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Next →</button>' : ''}
                        <button onclick="endTutorial()" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">${currentTutorialStep === tutorialSteps.length - 1 ? 'Finish' : 'Skip'}</button>
                    </div>
                </div>
            `;

            tutorialOverlay.appendChild(tooltip);
            document.body.appendChild(tutorialOverlay);

            // Auto-advance for center-positioned steps after 5 seconds
            if (step.position === 'center' && currentTutorialStep < tutorialSteps.length - 1) {
                setTimeout(() => {
                    if (tutorialActive && currentTutorialStep < tutorialSteps.length - 1) {
                        nextTutorialStep();
                    }
                }, 5000);
            }
        }

        function nextTutorialStep() {
            clearHighlight();
            currentTutorialStep++;
            showTutorialStep();
        }

        function previousTutorialStep() {
            clearHighlight();
            currentTutorialStep--;
            showTutorialStep();
        }

        function endTutorial() {
            tutorialActive = false;
            clearHighlight();
            if (tutorialOverlay) {
                tutorialOverlay.remove();
                tutorialOverlay = null;
            }
            showAlert('Tutorial ended. Click Help anytime to restart!', 'info');
        }

        function clearHighlight() {
            // Clear any highlighted elements
            document.querySelectorAll('*').forEach(el => {
                if (el.style.zIndex === '20001') {
                    el.style.position = '';
                    el.style.zIndex = '';
                    el.style.boxShadow = '';
                    el.style.borderRadius = '';
                }
            });
        }

        // Check if user is new and show tutorial
        function checkFirstVisit() {
            const hasVisited = localStorage.getItem('bulkEmail_hasVisited');
            if (!hasVisited) {
                localStorage.setItem('bulkEmail_hasVisited', 'true');
                setTimeout(() => {
                    if (confirm('Welcome to Bulk Email Sender! Would you like to take a quick tutorial to learn all the features?')) {
                        startTutorial();
                    }
                }, 2000);
            }
        }

        // Test connection functionality removed

        function extractTemplateHeaders() {
            const template = document.getElementById('emailTemplate').value;
            const headerLines = template.split('\n');

            // Set default values
            document.getElementById('fromEmail').value = 'info@datanalysisninsights.co.uk';
            window.defaultFromName = 'Intex Technologies';

            // Extract headers from template if present
            for (let line of headerLines) {
                if (line.startsWith('From: ')) {
                    const fromEmail = line.replace('From: ', '').trim();
                    // Only use template email if it's a valid email address
                    if (fromEmail.includes('@')) {
                        document.getElementById('fromEmail').value = fromEmail;
                    }
                }
                if (line.startsWith('From-Name: ')) {
                    const fromName = line.replace('From-Name: ', '').trim();
                    window.defaultFromName = fromName;
                }
            }
        }

        function testXLSXLibrary() {
            if (typeof XLSX === 'undefined') {
                console.error('XLSX library not loaded');
                showAlert('⚠️ Excel processing library failed to load. File upload may not work.', 'error');
                return false;
            } else {
                console.log('XLSX library loaded successfully, version:', XLSX.version);
                return true;
            }
        }

        // Add a simple CSV processor as fallback
        function parseCSV(text) {
            const csvLines = text.split('\n');
            const headers = csvLines[0].split(',').map(h => h.trim().toLowerCase());
            const data = [];

            for (let i = 1; i < csvLines.length; i++) {
                if (csvLines[i].trim()) {
                    const values = csvLines[i].split(',');
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] ? values[index].trim() : '';
                    });
                    data.push(row);
                }
            }
            return { headers, data };
        }

        // Initialize on page load - no complex initialization
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Secure email sender loaded');
            testXLSXLibrary(); // Test if XLSX library loaded
            extractTemplateHeaders(); // Extract and populate From field

            // Initialize data persistence
            setupAutoSave();

            // Try to load saved data (now async with encryption)
            try {
                const dataLoaded = await loadFromLocalStorage();

                if (!dataLoaded) {
                    renderContacts(); // Initialize contact list display if no saved data
                    showAlert('🔒 Secure Email Sender Ready! Upload your contact spreadsheet to begin sending personalized emails.');
                }
            } catch (error) {
                console.error('Failed to load saved data:', error);
                renderContacts();
                showAlert('🔒 Secure Email Sender Ready! Upload your contact spreadsheet to begin sending personalized emails.');
            }

            // Load email service configuration
            await loadEmailServiceConfig();

            // Check if this is the user's first visit
            checkFirstVisit();
        });

        async function loadEmailServiceConfig() {
            try {
                const savedConfig = localStorage.getItem(STORAGE_KEYS.SETTINGS);
                if (savedConfig) {
                    const config = await decryptData(savedConfig);
                    if (config && config.emailConfig) {
                        Object.assign(EMAIL_CONFIG, config.emailConfig);
                        console.log('Email service configuration loaded');
                    }
                }
            } catch (error) {
                console.error('Error loading email service config:', error);
            }
        }

        // Email Service Configuration
        function showEmailConfig() {
            const modal = document.createElement('div');
            modal.id = 'emailConfigModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
                z-index: 10000; padding: 20px;
            `;

            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;">
                    <h3 style="margin: 0 0 20px 0; color: #007bff;">⚙️ Email Service Configuration</h3>

                    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px; border-left: 4px solid #17a2b8;">
                        <strong>Setup Instructions:</strong>
                        <p style="margin: 5px 0; font-size: 14px;">Configure at least one email service to enable real email sending. All credentials are stored securely with encryption.</p>
                    </div>

                    <!-- EmailJS Configuration -->
                    <div style="margin-bottom: 25px; padding: 15px; border: 1px solid #ddd; border-radius: 6px;">
                        <h4 style="margin: 0 0 15px 0; color: #28a745;">📧 EmailJS (Recommended - Free Tier)</h4>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Public Key:</label>
                            <input type="text" id="emailjsPublicKey" placeholder="Your EmailJS public key" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Service ID:</label>
                            <input type="text" id="emailjsServiceId" placeholder="Your EmailJS service ID" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Template ID:</label>
                            <input type="text" id="emailjsTemplateId" placeholder="Your EmailJS template ID" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <label style="display: flex; align-items: center; margin-top: 10px;">
                            <input type="checkbox" id="emailjsEnabled" style="margin-right: 8px;">
                            <span>Enable EmailJS</span>
                        </label>
                        <p style="margin: 10px 0 0 0; font-size: 12px; color: #666;">Get free API keys at <a href="https://emailjs.com" target="_blank">emailjs.com</a> (200 emails/month free)</p>
                    </div>

                    <!-- Netlify Functions -->
                    <div style="margin-bottom: 25px; padding: 15px; border: 1px solid #ddd; border-radius: 6px;">
                        <h4 style="margin: 0 0 15px 0; color: #6366f1;">⚡ Netlify Functions</h4>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Function Endpoint:</label>
                            <input type="text" id="netlifyEndpoint" value="/.netlify/functions/send-email" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <label style="display: flex; align-items: center; margin-top: 10px;">
                            <input type="checkbox" id="netlifyEnabled" checked style="margin-right: 8px;">
                            <span>Enable Netlify Functions</span>
                        </label>
                        <p style="margin: 10px 0 0 0; font-size: 12px; color: #666;">Requires Netlify function deployment</p>
                    </div>

                    <!-- Custom Webhook -->
                    <div style="margin-bottom: 25px; padding: 15px; border: 1px solid #ddd; border-radius: 6px;">
                        <h4 style="margin: 0 0 15px 0; color: #f59e0b;">🔗 Custom Webhook</h4>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Webhook URL:</label>
                            <input type="text" id="webhookEndpoint" placeholder="https://your-email-webhook.com/send" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">API Key:</label>
                            <input type="password" id="webhookApiKey" placeholder="Your API key" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <label style="display: flex; align-items: center; margin-top: 10px;">
                            <input type="checkbox" id="webhookEnabled" style="margin-right: 8px;">
                            <span>Enable Custom Webhook</span>
                        </label>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px;">
                        <button onclick="testEmailConfig()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">🧪 Test Configuration</button>
                        <div>
                            <button onclick="saveEmailConfig()" class="button button-primary" style="margin-right: 10px;">Save</button>
                            <button onclick="closeEmailConfig()" class="button">Close</button>
                        </div>
                    </div>
                </div>
            `;

            // Load current configuration
            loadCurrentEmailConfig();

            document.body.appendChild(modal);
        }

        async function loadCurrentEmailConfig() {
            try {
                const savedConfig = localStorage.getItem(STORAGE_KEYS.SETTINGS);
                if (savedConfig) {
                    const config = await decryptData(savedConfig);
                    if (config && config.emailConfig) {
                        const emailConfig = config.emailConfig;

                        // Load EmailJS config
                        if (emailConfig.emailjs) {
                            document.getElementById('emailjsPublicKey').value = emailConfig.emailjs.publicKey || '';
                            document.getElementById('emailjsServiceId').value = emailConfig.emailjs.serviceId || '';
                            document.getElementById('emailjsTemplateId').value = emailConfig.emailjs.templateId || '';
                            document.getElementById('emailjsEnabled').checked = emailConfig.emailjs.enabled || false;
                        }

                        // Load Netlify config
                        if (emailConfig.netlify) {
                            document.getElementById('netlifyEndpoint').value = emailConfig.netlify.endpoint || '/.netlify/functions/send-email';
                            document.getElementById('netlifyEnabled').checked = emailConfig.netlify.enabled !== false;
                        }

                        // Load Webhook config
                        if (emailConfig.webhook) {
                            document.getElementById('webhookEndpoint').value = emailConfig.webhook.endpoint || '';
                            document.getElementById('webhookApiKey').value = emailConfig.webhook.apiKey || '';
                            document.getElementById('webhookEnabled').checked = emailConfig.webhook.enabled || false;
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading email config:', error);
            }
        }

        async function saveEmailConfig() {
            try {
                const newConfig = {
                    emailjs: {
                        enabled: document.getElementById('emailjsEnabled').checked,
                        publicKey: document.getElementById('emailjsPublicKey').value.trim(),
                        serviceId: document.getElementById('emailjsServiceId').value.trim(),
                        templateId: document.getElementById('emailjsTemplateId').value.trim()
                    },
                    netlify: {
                        enabled: document.getElementById('netlifyEnabled').checked,
                        endpoint: document.getElementById('netlifyEndpoint').value.trim()
                    },
                    webhook: {
                        enabled: document.getElementById('webhookEnabled').checked,
                        endpoint: document.getElementById('webhookEndpoint').value.trim(),
                        apiKey: document.getElementById('webhookApiKey').value.trim()
                    }
                };

                // Update global config
                Object.assign(EMAIL_CONFIG, newConfig);

                // Save encrypted config
                const configToSave = {
                    emailConfig: newConfig,
                    savedAt: Date.now()
                };
                const encryptedConfig = await encryptData(configToSave);
                localStorage.setItem(STORAGE_KEYS.SETTINGS, encryptedConfig);

                showAlert('Email configuration saved successfully!', 'success');
                closeEmailConfig();
            } catch (error) {
                console.error('Error saving email config:', error);
                showAlert('Failed to save email configuration', 'error');
            }
        }

        async function testEmailConfig() {
            const testContact = {
                email: document.getElementById('fromEmail').value,
                contactName: 'Test User',
                firm: 'Test Company',
                country: 'Test Country'
            };

            const testSubject = 'Email Configuration Test';
            const testMessage = 'This is a test email to verify your email configuration is working correctly.';

            try {
                showAlert('Testing email configuration...', 'info');
                const result = await sendRealEmail(testContact, testSubject, testMessage);

                if (result.success) {
                    showAlert(`✅ Email test successful via ${result.service}!`, 'success');
                } else {
                    showAlert(`❌ Email test failed: ${result.error}`, 'error');
                }
            } catch (error) {
                showAlert(`❌ Email test failed: ${error.message}`, 'error');
            }
        }

        function closeEmailConfig() {
            const modal = document.getElementById('emailConfigModal');
            if (modal) {
                modal.remove();
            }
        }
        // Email Analytics Dashboard Functions
        let autoRedirectEnabled = true;

        function toggleAnalytics() {
            const container = document.getElementById('analyticsContainer');
            const button = document.getElementById('analyticsToggle');

            if (container.style.display === 'none') {
                container.style.display = 'block';
                button.textContent = '📈 Collapse';
                updateAnalytics();
            } else {
                container.style.display = 'none';
                button.textContent = '📈 Expand';
            }
        }

        function updateAnalytics() {
            const sentCount = emailHistory.filter(email => email.status === 'sent').length;
            const failedCount = emailHistory.filter(email => email.status === 'failed').length;

            document.getElementById('sentCount').textContent = sentCount;
            document.getElementById('failedCount').textContent = failedCount;

            // Update country filter options
            const countries = [...new Set(emailHistory.map(email => email.country))];
            const countryFilter = document.getElementById('countryFilter');
            countryFilter.innerHTML = '<option value="">All Countries</option>';
            countries.forEach(country => {
                countryFilter.innerHTML += `<option value="${country}">${country}</option>`;
            });

            // Update top countries
            const countryStats = countries.map(country => {
                const countryEmails = emailHistory.filter(email => email.country === country);
                return {
                    country,
                    sent: countryEmails.filter(email => email.status === 'sent').length,
                    total: countryEmails.length
                };
            }).sort((a, b) => b.total - a.total).slice(0, 3);

            const topCountriesDiv = document.getElementById('topCountries');
            if (countryStats.length === 0) {
                topCountriesDiv.textContent = 'No data yet';
            } else {
                topCountriesDiv.innerHTML = countryStats.map(stat =>
                    `<div style="margin-bottom: 4px;">${stat.country}: ${stat.sent}/${stat.total} sent</div>`
                ).join('');
            }
        }

        function filterEmailHistory() {
            const countryFilter = document.getElementById('countryFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;

            let filteredHistory = [...emailHistory];

            // Filter by country
            if (countryFilter) {
                filteredHistory = filteredHistory.filter(email => email.country === countryFilter);
            }

            // Filter by date
            if (dateFilter) {
                const now = new Date();
                const startDate = new Date();

                switch (dateFilter) {
                    case 'today':
                        startDate.setHours(0, 0, 0, 0);
                        break;
                    case 'week':
                        startDate.setDate(now.getDate() - 7);
                        break;
                    case 'month':
                        startDate.setMonth(now.getMonth() - 1);
                        break;
                }

                filteredHistory = filteredHistory.filter(email => new Date(email.timestamp) >= startDate);
            }

            // Update displayed history
            renderEmailHistory(filteredHistory);
        }

        function addEmailToHistory(email, status, country) {
            const historyEntry = {
                id: Date.now(),
                email,
                status,
                country,
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString()
            };

            emailHistory.unshift(historyEntry);
            renderEmailHistory();
            updateAnalytics();
        }

        function renderEmailHistory(customHistory = null) {
            const history = customHistory || emailHistory;
            const container = document.getElementById('emailHistory');

            if (history.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 15px;">
                        <p style="font-size: 12px;">📧 Email history will appear here</p>
                        <small style="font-size: 10px;">Send emails to see status tracking</small>
                    </div>
                `;
                return;
            }

            const historyHTML = history.slice(0, 20).map(entry => {
                const statusIcon = entry.status === 'sent' ? '✅' : '❌';
                const statusColor = entry.status === 'sent' ? '#10b981' : '#ef4444';

                return `
                    <div style="padding: 8px; margin-bottom: 6px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 4px;">
                            <span style="font-size: 11px; font-weight: 500; color: #374151;">${entry.email}</span>
                            <span style="font-size: 10px; color: ${statusColor};">${statusIcon}</span>
                        </div>
                        <div style="font-size: 10px; color: #6b7280;">
                            ${entry.country} • ${entry.time}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = historyHTML;
        }

        function clearEmailHistory() {
            if (confirm('Clear all email history? This cannot be undone.')) {
                emailHistory = [];
                renderEmailHistory();
                updateAnalytics();
                showAlert('Email history cleared', 'info');
            }
        }

        // Response Email Manager Functions
        let responseEmails = [];

        function toggleResponseManager() {
            const panel = document.getElementById('responsePanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                // Auto-check for responses when opened
                checkResponseEmails();
            } else {
                panel.style.display = 'none';
            }
        }

        function checkResponseEmails() {
            // Simulate checking for response emails
            showAlert('Checking for response emails...', 'info');

            setTimeout(() => {
                // Simulate some responses (in real implementation, this would fetch from email server)
                const newResponses = [
                    {
                        id: Date.now() + 1,
                        from: 'john.smith@abc-corp.com',
                        subject: 'Re: Business Partnership Opportunity',
                        timestamp: new Date(),
                        content: 'Thank you for your email. We are interested in discussing this partnership opportunity.'
                    }
                ];

                if (Math.random() > 0.7) { // 30% chance of new responses
                    responseEmails = [...newResponses, ...responseEmails];
                    renderResponseEmails();

                    if (autoRedirectEnabled) {
                        newResponses.forEach(response => {
                            redirectResponseEmail(response);
                        });
                    }

                    showAlert(`Found ${newResponses.length} new response(s)`, 'success');
                } else {
                    showAlert('No new responses found', 'info');
                }
            }, 1000);
        }

        function renderResponseEmails() {
            const container = document.getElementById('responseList');

            if (responseEmails.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #6b7280; padding: 20px;">
                        <div style="font-size: 24px; margin-bottom: 8px;">📭</div>
                        <div>No responses yet</div>
                        <small style="font-size: 10px;">Response emails will appear here</small>
                    </div>
                `;
                return;
            }

            const responsesHTML = responseEmails.slice(0, 5).map(response => `
                <div style="padding: 12px; margin-bottom: 8px; background: #f8f9fa; border: 1px solid #dadce0; border-radius: 8px;">
                    <div style="font-weight: 500; font-size: 12px; color: #202124; margin-bottom: 4px;">
                        ${escapeHTML(response.from)}
                    </div>
                    <div style="font-size: 11px; color: #5f6368; margin-bottom: 6px;">
                        ${escapeHTML(response.subject)}
                    </div>
                    <div style="font-size: 10px; color: #5f6368; margin-bottom: 8px;">
                        ${response.timestamp.toLocaleString()}
                    </div>
                    <div style="display: flex; gap: 6px;">
                        <button onclick="viewResponseEmail(${response.id})" class="button" style="padding: 4px 8px; font-size: 10px; flex: 1;">
                            View
                        </button>
                        <button onclick="redirectResponseEmail(${JSON.stringify(response).replace(/"/g, '&quot;')})" class="button button-secondary" style="padding: 4px 8px; font-size: 10px; flex: 1;">
                            Forward
                        </button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = responsesHTML;
        }

        function viewResponseEmail(responseId) {
            const response = responseEmails.find(r => r.id === responseId);
            if (!response) {
                showAlert('Response email not found', 'error');
                return;
            }

            // Create modal for viewing response
            const modal = document.createElement('div');
            modal.id = 'viewResponseModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
                z-index: 15000; padding: 20px;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto; padding: 0;">
                    <!-- Header -->
                    <div style="padding: 20px 24px 16px 24px; border-bottom: 1px solid #e0e0e0;">
                        <h3 style="margin: 0; color: #202124; font-size: 18px; font-weight: 500;">Email Response</h3>
                    </div>

                    <!-- Email Details -->
                    <div style="padding: 20px 24px;">
                        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: 80px 1fr; gap: 12px; margin-bottom: 12px;">
                                <div style="font-size: 12px; color: #5f6368; font-weight: 500;">FROM:</div>
                                <div style="font-size: 14px; color: #202124;">${escapeHTML(response.from)}</div>
                            </div>
                            <div style="display: grid; grid-template-columns: 80px 1fr; gap: 12px; margin-bottom: 12px;">
                                <div style="font-size: 12px; color: #5f6368; font-weight: 500;">SUBJECT:</div>
                                <div style="font-size: 14px; color: #202124;">${escapeHTML(response.subject)}</div>
                            </div>
                            <div style="display: grid; grid-template-columns: 80px 1fr; gap: 12px;">
                                <div style="font-size: 12px; color: #5f6368; font-weight: 500;">DATE:</div>
                                <div style="font-size: 14px; color: #202124;">${response.timestamp.toLocaleString()}</div>
                            </div>
                        </div>

                        <!-- Email Content -->
                        <div>
                            <h4 style="margin: 0 0 12px 0; color: #202124; font-size: 14px; font-weight: 500;">Message Content</h4>
                            <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; background: white; min-height: 100px; max-height: 300px; overflow-y: auto;">
                                <div style="font-size: 14px; line-height: 1.6; color: #202124; white-space: pre-wrap;">${escapeHTML(response.content || 'No content available')}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer Actions -->
                    <div style="padding: 16px 24px; border-top: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa;">
                        <div></div>
                        <div style="display: flex; gap: 12px;">
                            <button onclick="closeViewResponseModal()" class="button">Close</button>
                            <button onclick="forwardResponseFromModal(${JSON.stringify(response).replace(/"/g, '&quot;')})" class="button button-primary">Forward</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function closeViewResponseModal() {
            const modal = document.getElementById('viewResponseModal');
            if (modal) {
                modal.remove();
            }
        }

        function forwardResponseFromModal(response) {
            closeViewResponseModal();
            redirectResponseEmail(response);
        }

        function redirectResponseEmail(response) {
            const redirectEmail = document.getElementById('redirectEmail').value;

            // Simulate email redirection
            showAlert(`Redirecting response from ${response.from} to ${redirectEmail}`, 'success');

            // In real implementation, this would actually forward the email
            console.log('Redirecting email:', {
                from: response.from,
                to: redirectEmail,
                subject: `Fwd: ${response.subject}`,
                content: response.content
            });
        }

        function toggleAutoRedirect() {
            autoRedirectEnabled = !autoRedirectEnabled;
            const button = document.getElementById('redirectBtn');

            if (autoRedirectEnabled) {
                button.textContent = '✓ ON';
                button.style.background = '#10b981';
                showAlert('Auto-redirect enabled', 'success');
            } else {
                button.textContent = '✗ OFF';
                button.style.background = '#6b7280';
                showAlert('Auto-redirect disabled', 'info');
            }
        }

        // Click outside to close panels
        document.addEventListener('click', function(event) {
            // Close color picker when clicking outside
            const colorPicker = document.getElementById('colorPicker');
            if (colorPicker && !event.target.closest('#colorPicker') && !event.target.closest('[onclick*="showColorPicker"]')) {
                colorPicker.style.display = 'none';
            }

            // Close response panel when clicking outside
            const responsePanel = document.getElementById('responsePanel');
            const responseManager = document.getElementById('responseEmailManager');
            if (responsePanel && !responseManager.contains(event.target)) {
                responsePanel.style.display = 'none';
            }
        });

        // Initialize analytics on page load
        // Removed dummy email history - now uses real data from email sending

        // Smart Message AI Assistant Functions
        let enhancedMessage = '';
        let currentChatContext = '';

        function openSmartMessage() {
            const popup = document.getElementById('smartMessagePopup');
            popup.style.display = 'block';

            // Update company context
            updateCompanyContext();

            // Get current message
            const messageBody = document.getElementById('messageBody');
            currentChatContext = messageBody.innerHTML || messageBody.textContent;

            // Show current message and provide ChatGPT-like interface
            const chatMessages = document.getElementById('chatMessages');
            const currentMessageText = messageBody.textContent || messageBody.innerText || 'No message content';

            chatMessages.innerHTML = `
                <div style="padding: 15px; background: #f8f9fa; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #3b82f6;">
                    <div style="font-weight: 600; color: #1e40af; margin-bottom: 8px; font-size: 14px;">📧 Current Message</div>
                    <div style="background: white; padding: 12px; border-radius: 8px; font-size: 13px; line-height: 1.5; max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb;">
                        ${currentMessageText.length > 500 ? currentMessageText.substring(0, 500) + '...' : currentMessageText}
                    </div>
                </div>

                <div style="padding: 15px; background: #f0f9ff; border-radius: 12px; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                        <span style="font-size: 18px;">🤖</span>
                        <strong style="color: #0369a1; font-size: 14px;">AI Assistant</strong>
                    </div>
                    <p style="margin: 0; font-size: 13px; color: #334155; line-height: 1.5;">
                        I can help you enhance your email message. Choose from the quick actions below or tell me what specific changes you'd like to make. I'll show you a preview before applying any changes.
                    </p>
                </div>
            `;
        }

        function closeSmartMessage() {
            document.getElementById('smartMessagePopup').style.display = 'none';
        }

        function updateCompanyContext() {
            const contextInfo = document.getElementById('contextInfo');

            if (selectedContactIndex === -1 || !contacts[selectedContactIndex]) {
                contextInfo.innerHTML = 'No contact selected. Please select a contact to get personalized suggestions.';
                return;
            }

            const contact = contacts[selectedContactIndex];
            contextInfo.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 11px;">
                    <div><strong>Company:</strong> ${contact.firm}</div>
                    <div><strong>Country:</strong> ${contact.country}</div>
                    <div><strong>Contact:</strong> ${contact.contactName}</div>
                    <div><strong>Email:</strong> ${contact.email}</div>
                    <div><strong>Industry:</strong> ${contact.category}</div>
                    <div><strong>Focus:</strong> ${contact.businessFocus}</div>
                </div>
            `;
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            // Add user message to chat
            addChatMessage('user', message);
            input.value = '';

            // Process the message and get AI response with enhanced message
            setTimeout(() => {
                const result = getAIResponseWithPreview(message);
                addChatMessageWithPreview('assistant', result.explanation, result.enhancedMessage);
            }, 1000);
        }

        function addChatMessage(sender, message) {
            const chatMessages = document.getElementById('chatMessages');
            const isUser = sender === 'user';

            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                padding: 10px;
                background: ${isUser ? '#f0f9ff' : '#e3f2fd'};
                border-radius: 8px;
                margin-bottom: 10px;
                ${isUser ? 'margin-left: 20px;' : ''}
            `;

            messageDiv.innerHTML = `
                <strong style="color: ${isUser ? '#0369a1' : '#1976d2'};">${isUser ? '👤 You:' : '🤖 Assistant:'}</strong>
                <p style="margin: 5px 0 0 0; font-size: 13px;">${message}</p>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addChatMessageWithPreview(sender, explanation, enhancedMessage) {
            const chatMessages = document.getElementById('chatMessages');

            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                padding: 15px;
                background: #f0f9ff;
                border-radius: 12px;
                margin-bottom: 15px;
                border-left: 4px solid #3b82f6;
            `;

            messageDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                    <span style="font-size: 16px;">🤖</span>
                    <strong style="color: #0369a1; font-size: 14px;">AI Enhancement</strong>
                </div>

                <div style="margin-bottom: 12px; font-size: 13px; color: #475569;">
                    ${explanation}
                </div>

                <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 12px;">
                    <div style="font-weight: 600; color: #374151; margin-bottom: 8px; font-size: 12px;">📝 ENHANCED MESSAGE PREVIEW</div>
                    <div style="font-size: 13px; line-height: 1.5; color: #1f2937; max-height: 300px; overflow-y: auto;">
                        ${enhancedMessage.replace(/\n/g, '<br>')}
                    </div>
                </div>

                <div style="display: flex; gap: 8px;">
                    <button onclick="applyEnhancedMessage(\`${enhancedMessage.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)"
                            style="padding: 8px 16px; background: #16a34a; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500;">
                        Apply Changes
                    </button>
                    <button onclick="rejectEnhancement()"
                            style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500;">
                        Keep Original
                    </button>
                </div>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function applyEnhancedMessage(enhancedMessage) {
            const messageBody = document.getElementById('messageBody');
            // Sanitize enhanced message before applying
            const sanitizedMessage = sanitizeHTML(enhancedMessage.replace(/\n/g, '<br>'));
            messageBody.innerHTML = sanitizedMessage;
            updateHiddenTextarea();
            showAlert('Enhanced message applied successfully!', 'success');
            closeSmartMessage();
        }

        function rejectEnhancement() {
            showAlert('Enhancement rejected. Original message kept.', 'info');
        }

        function getAIResponseWithPreview(userMessage) {
            const contact = selectedContactIndex !== -1 ? contacts[selectedContactIndex] : null;
            const currentMessage = document.getElementById('messageBody').textContent || '';

            // Generate enhanced message based on request
            const lowerMessage = userMessage.toLowerCase();
            let enhancedMessage = currentMessage;
            let explanation = '';

            if (lowerMessage.includes('professional') || lowerMessage.includes('formal')) {
                explanation = "I've made your message more professional by adding formal language and business etiquette.";
                enhancedMessage = generateProfessionalVersion(currentMessage, contact);
            } else if (lowerMessage.includes('compelling') || lowerMessage.includes('persuasive')) {
                explanation = "I've made your message more compelling by adding urgency and value propositions.";
                enhancedMessage = generateCompellingVersion(currentMessage, contact);
            } else if (lowerMessage.includes('concise') || lowerMessage.includes('shorter')) {
                explanation = "I've made your message more concise while keeping the key points.";
                enhancedMessage = generateConciseVersion(currentMessage, contact);
            } else if (lowerMessage.includes('personal') || lowerMessage.includes('friendly')) {
                explanation = "I've made your message more personal and friendly while maintaining professionalism.";
                enhancedMessage = generatePersonalVersion(currentMessage, contact);
            } else {
                explanation = "I've enhanced your message with better structure and professional language.";
                enhancedMessage = generateGeneralEnhancement(currentMessage, contact);
            }

            return {
                explanation: explanation,
                enhancedMessage: enhancedMessage
            };
        }

        function generateProfessionalVersion(message, contact) {
            if (!contact) return message;

            return `Dear ${contact.contactName},

I hope this message finds you well. I am writing to introduce Intex Technologies and explore potential partnership opportunities with ${contact.firm}.

Since our establishment in 1996, Intex Technologies has maintained a leadership position in the consumer electronics and technology sectors. We believe that ${contact.firm}, with its established market presence in ${contact.country}, would represent an ideal strategic partner for expanding our operations.

Our comprehensive product portfolio includes:
• Professional IT peripherals and computer accessories
• Advanced home appliances and climate solutions
• Premium mobile accessories and charging solutions
• High-quality audio systems and entertainment products

We are currently seeking qualified distribution partners in ${contact.country} who share our commitment to delivering exceptional products and customer service.

Our partnership program offers:
✓ Competitive wholesale pricing with attractive margin structures
✓ Comprehensive marketing support and co-branding opportunities
✓ Technical training programs and ongoing product support
✓ Flexible payment terms and credit facilities
✓ Exclusive territorial rights (subject to mutual agreement)

I would welcome the opportunity to discuss how we might collaborate to bring Intex Technologies' innovative solutions to the ${contact.country} market through ${contact.firm}.

Thank you for your time and consideration. I look forward to your response.

Best regards,

Vishwas Agarwal
Business Development Manager
Intex Technologies
Email: vishwas.agarwal@gmail.com`;
        }

        function generateCompellingVersion(message, contact) {
            if (!contact) return message;

            return `🔥 EXCLUSIVE PARTNERSHIP OPPORTUNITY - Limited Time!

Dear ${contact.contactName},

What if I told you that ${contact.firm} could increase revenue by 30-40% in the next 12 months with the RIGHT technology partner?

Intex Technologies (Est. 1996) is offering ${contact.firm} an EXCLUSIVE opportunity to become our primary distributor in ${contact.country}.

⚡ HERE'S WHAT MAKES THIS URGENT:
→ We're only selecting ONE partner per region
→ The ${contact.country} market is experiencing 25% growth in tech products
→ Our current partners report average 35% profit margins
→ First-mover advantage in your market is CRITICAL

🎯 WHAT YOU GET IMMEDIATELY:
✅ Instant access to 500+ high-demand products
✅ Marketing budget of $10,000 for launch campaigns
✅ 60-day exclusive territory protection
✅ Direct factory pricing (no middleman markup)
✅ Same-day technical support guarantee

💰 REAL NUMBERS FROM OUR PARTNERS:
• TechMart (UAE): $2.3M revenue in first year
• ElectroWorld (Malaysia): 400% growth in 18 months
• Digital Plus (Thailand): Became market leader in 2 years

⏰ TIME-SENSITIVE: This offer expires in 7 days. After that, we'll approach your competitors.

The question isn't whether you can afford this opportunity...
The question is: Can ${contact.firm} afford to MISS it?

Ready to dominate the ${contact.country} tech market?

Call me NOW: +91-XXXXXXXXXX

Vishwas Agarwal
Business Development Manager
Intex Technologies

P.S. I have authorization to offer a 15% first-order discount, but only if you respond within 48 hours.`;
        }

        function generateConciseVersion(message, contact) {
            if (!contact) return message;

            return `Hi ${contact.contactName},

Intex Technologies (1996-present) seeks distribution partner in ${contact.country}.

Our Products: IT peripherals, home appliances, mobile accessories, audio systems.

Partnership Benefits:
• Competitive pricing + attractive margins
• Marketing support + training
• Flexible payment terms
• Exclusive territory rights

Interested in discussing how ${contact.firm} can benefit from this partnership?

Best regards,
Vishwas Agarwal
Business Development Manager
Intex Technologies
vishwas.agarwal@gmail.com`;
        }

        function generatePersonalVersion(message, contact) {
            if (!contact) return message;

            return `Hello ${contact.contactName}!

I hope you're having a great day. I came across ${contact.firm} and was really impressed by what you've built in ${contact.country}.

I'm Vishwas from Intex Technologies, and I think there might be a fantastic opportunity for us to work together. We've been in the tech business since 1996, and I genuinely believe ${contact.firm} would be perfect for what we have in mind.

Here's what caught my attention about your company - you clearly understand your market in ${contact.country}, and that's exactly the kind of local expertise we value in a partner.

What we bring to the table:
• A diverse range of products (IT gear, home appliances, mobile accessories, audio equipment)
• Really competitive pricing that lets our partners succeed
• Hands-on support (we're not the "sell and disappear" type!)
• Marketing help that actually works
• Payment terms designed for real businesses

I'd love to have a friendly chat about how we could help ${contact.firm} grow even more. No pressure, no pushy sales tactics - just two business people exploring possibilities.

Would you be open to a quick call next week? I think you'll find our partnership model refreshingly straightforward.

Looking forward to potentially working together!

Warm regards,
Vishwas Agarwal
Business Development Manager
Intex Technologies
vishwas.agarwal@gmail.com

P.S. - I'm happy to send over some references from our other partners if that would be helpful.`;
        }

        function generateGeneralEnhancement(message, contact) {
            if (!contact) return message;

            return `Dear ${contact.contactName},

I trust this message finds you well. I am reaching out regarding a strategic partnership opportunity between Intex Technologies and ${contact.firm}.

Intex Technologies, established in 1996, is a leading innovator in consumer electronics and technology solutions. We have identified ${contact.firm} as a potential strategic partner due to your strong market position in ${contact.country}.

Our Product Excellence:
• Premium IT peripherals and computer accessories
• Innovative home appliances and climate control solutions
• Cutting-edge mobile accessories and power solutions
• Superior audio systems and entertainment technology

Partnership Value Proposition:
✓ Competitive pricing with substantial profit margins
✓ Comprehensive marketing and promotional support
✓ Technical training and ongoing partnership support
✓ Flexible financial terms and credit arrangements
✓ Market exclusivity opportunities

We believe this partnership would create significant value for both organizations and establish a strong foundation for long-term success in the ${contact.country} market.

I would appreciate the opportunity to discuss this proposal in detail at your convenience.

Thank you for your consideration.

Professional regards,

Vishwas Agarwal
Business Development Manager
Intex Technologies
Email: vishwas.agarwal@gmail.com
Phone: +91-XXXXXXXXXX`;
        }

        function getAIResponse(userMessage) {
            const contact = selectedContactIndex !== -1 ? contacts[selectedContactIndex] : null;
            const currentMessage = document.getElementById('messageBody').innerHTML || document.getElementById('messageBody').textContent;

            // Simulate AI responses based on keywords and context
            const responses = {
                professional: generateProfessionalResponse(contact, currentMessage),
                compelling: generateCompellingResponse(contact, currentMessage),
                concise: generateConciseResponse(contact, currentMessage),
                industry: generateIndustryResponse(contact, currentMessage),
                grammar: generateGrammarResponse(currentMessage),
                general: generateGeneralResponse(userMessage, contact, currentMessage)
            };

            // Determine response type based on user message
            const messageType = determineMessageType(userMessage);
            return responses[messageType] || responses.general;
        }

        function determineMessageType(message) {
            const msg = message.toLowerCase();
            if (msg.includes('professional') || msg.includes('formal')) return 'professional';
            if (msg.includes('compelling') || msg.includes('persuasive') || msg.includes('convince')) return 'compelling';
            if (msg.includes('shorter') || msg.includes('concise') || msg.includes('brief')) return 'concise';
            if (msg.includes('industry') || msg.includes('specific') || msg.includes('technical')) return 'industry';
            if (msg.includes('grammar') || msg.includes('correct') || msg.includes('fix')) return 'grammar';
            return 'general';
        }

        function generateProfessionalResponse(contact, currentMessage) {
            if (!contact) return "I'd be happy to make your message more professional. Please select a contact first so I can provide personalized suggestions.";

            enhancedMessage = `
Dear ${contact.contactName},

I hope this message finds you well. I am writing to introduce Intex Technologies and explore potential partnership opportunities with ${contact.firm}.

As a leading technology company with 29 years of industry experience, Intex Technologies has established itself as a trusted partner for businesses seeking innovative consumer electronics solutions. We believe that ${contact.firm}'s reputation and market presence in ${contact.country} aligns perfectly with our expansion goals.

Our comprehensive product portfolio includes:
• Advanced IT peripherals and computing accessories
• Smart home appliances and IoT solutions
• Mobile technology and charging solutions
• Professional audio and communication systems

We would value the opportunity to discuss how our strategic partnership could drive mutual growth and deliver exceptional value to customers in ${contact.country}.

I would be delighted to schedule a conversation at your convenience to explore this opportunity further.

Thank you for your time and consideration.

Best regards,

Vishwas Agarwal
Business Development Manager
Intex Technologies
vishwas.agarwal@gmail.com
            `;

            document.getElementById('applyMessageBtn').disabled = false;
            return "I've created a more professional version of your message with formal language, structured content, and proper business etiquette. The message now includes a clear value proposition and professional closing. Would you like me to apply this enhanced version?";
        }

        function generateCompellingResponse(contact, currentMessage) {
            if (!contact) return "I'd be happy to make your message more compelling. Please select a contact first for personalized suggestions.";

            enhancedMessage = `
Dear ${contact.contactName},

🚀 **Exclusive Partnership Opportunity** - Limited Time Offer for ${contact.firm}

Imagine increasing your product portfolio by 300% while capturing the rapidly growing consumer electronics market in ${contact.country}. That's exactly what our strategic partners have achieved with Intex Technologies.

**Here's what makes this opportunity irresistible:**

✅ **Immediate Market Advantage**: Get exclusive access to 29 years of proven technology innovation
✅ **Profit Acceleration**: Our partners typically see 40-60% profit margins on our product lines
✅ **Zero Risk Entry**: Comprehensive support, training, and marketing assistance included
✅ **Growing Demand**: Consumer electronics market in ${contact.country} is projected to grow 25% annually

**Your Success is Guaranteed Because:**
• We've successfully partnered with 500+ companies globally
• Our products have 95% customer satisfaction rates
• We provide complete end-to-end support from inventory to after-sales

**Limited Time**: We're only selecting 3 partners in ${contact.country} this quarter, and ${contact.firm} is our #1 choice.

Ready to transform your business? Let's schedule a 15-minute call to discuss your guaranteed success plan.

Best regards,
Vishwas Agarwal
📞 Schedule Your Success Call: [Contact Link]
            `;

            document.getElementById('applyMessageBtn').disabled = false;
            return "I've transformed your message into a highly compelling proposition with urgency, specific benefits, social proof, and a clear call-to-action. This version focuses on the value and opportunity for the recipient. Ready to apply this enhanced version?";
        }

        function generateConciseResponse(contact, currentMessage) {
            if (!contact) return "I'd be happy to make your message more concise. Please select a contact first.";

            enhancedMessage = `
Hi ${contact.contactName},

Intex Technologies (29 years, global leader) seeks partnership with ${contact.firm} for ${contact.country} market expansion.

**Our Offer:**
• Consumer electronics & IT peripherals
• Competitive margins + full support
• Proven success in 40+ countries

**Why ${contact.firm}:**
Perfect market fit + established presence in ${contact.country}

**Next Step:**
15-minute call to discuss partnership details?

Best regards,
Vishwas Agarwal
Intex Technologies
vishwas.agarwal@gmail.com
            `;

            document.getElementById('applyMessageBtn').disabled = false;
            return "I've condensed your message to the essential points while maintaining all key information. This concise version gets straight to the point and respects the recipient's time. Would you like to apply this version?";
        }

        function generateIndustryResponse(contact, currentMessage) {
            if (!contact) return "I'd be happy to add industry-specific insights. Please select a contact first.";

            const industryInsights = getIndustryInsights(contact.category, contact.country);

            enhancedMessage = `
Dear ${contact.contactName},

The ${contact.category} sector in ${contact.country} is experiencing unprecedented growth, creating significant opportunities for forward-thinking companies like ${contact.firm}.

**Market Intelligence:**
${industryInsights}

**Strategic Partnership Opportunity:**
Intex Technologies, with 29 years of deep industry expertise, offers ${contact.firm} a competitive advantage through:

• **Technology Leadership**: Industry 4.0 solutions and IoT integration
• **Market Penetration**: Proven strategies that have driven 40% market share growth for partners
• **Regulatory Compliance**: Full adherence to ${contact.country} standards and certifications
• **Supply Chain Excellence**: Resilient global supply network with local support

**Specific Value for ${contact.firm}:**
Based on your market position in ${contact.country}, we project 25-35% revenue growth within the first 12 months through our partnership.

I'd welcome the opportunity to present our comprehensive market analysis and partnership framework tailored specifically for ${contact.firm}.

Best regards,
Vishwas Agarwal
Industry Partnership Specialist
Intex Technologies
            `;

            document.getElementById('applyMessageBtn').disabled = false;
            return `I've enhanced your message with industry-specific insights for the ${contact.category} sector in ${contact.country}. This version demonstrates market knowledge and positions the partnership as strategically beneficial. Ready to apply these industry insights?`;
        }

        function getIndustryInsights(category, country) {
            const insights = {
                'technology': `The technology sector in ${country} is projected to grow 22% annually, driven by digital transformation and IoT adoption.`,
                'retail': `Retail innovation in ${country} shows 35% consumer preference for smart electronic products and connected devices.`,
                'manufacturing': `Manufacturing digitization in ${country} creates 40% efficiency gains through smart technology integration.`,
                'healthcare': `Healthcare technology adoption in ${country} is accelerating, with 60% of facilities upgrading their electronic systems.`,
                'default': `The consumer electronics market in ${country} demonstrates strong growth potential with increasing demand for innovative solutions.`
            };

            return insights[category.toLowerCase()] || insights['default'];
        }

        function generateGrammarResponse(currentMessage) {
            enhancedMessage = currentMessage; // In a real implementation, this would use grammar checking
            document.getElementById('applyMessageBtn').disabled = false;
            return "I've reviewed your message for grammar and clarity improvements. The text has been optimized for better readability and professional presentation. Would you like to apply these corrections?";
        }

        function generateGeneralResponse(userMessage, contact, currentMessage) {
            const responses = [
                "I can help you enhance your message in several ways. Would you like me to make it more professional, compelling, or concise?",
                "I've analyzed your message and can suggest improvements based on the selected contact's profile. What specific aspect would you like me to focus on?",
                "I can customize your message for better engagement with the selected company. Would you like me to add industry-specific insights or improve the overall tone?",
                "I see you'd like to improve your message. I can help with tone, structure, personalization, or adding compelling elements. What's your priority?"
            ];

            return responses[Math.floor(Math.random() * responses.length)];
        }

        function quickAction(action) {
            const contact = selectedContactIndex !== -1 ? contacts[selectedContactIndex] : null;

            let response = '';
            switch (action) {
                case 'professional':
                    response = generateProfessionalResponse(contact, '');
                    break;
                case 'compelling':
                    response = generateCompellingResponse(contact, '');
                    break;
                case 'concise':
                    response = generateConciseResponse(contact, '');
                    break;
                case 'industry':
                    response = generateIndustryResponse(contact, '');
                    break;
                case 'grammar':
                    response = generateGrammarResponse('');
                    break;
            }

            addChatMessage('assistant', response);
        }

        function applySmartMessage() {
            if (enhancedMessage) {
                const messageBody = document.getElementById('messageBody');
                // Sanitize enhanced message before applying
                const sanitizedMessage = sanitizeHTML(enhancedMessage.trim());
                messageBody.innerHTML = sanitizedMessage;
                updateHiddenTextarea();
                closeSmartMessage();
                showAlert('Enhanced message applied successfully!', 'success');
            }
        }

        // Update validation function to work with contenteditable
        function validateMessage(element) {
            const content = element.innerHTML || element.textContent;
            const errorDiv = document.getElementById('messageError');

            if (!content || content.trim() === '') {
                showError(errorDiv, 'Message is required');
                element.style.borderColor = '#dc3545';
                return false;
            }

            if (content.length < 10) {
                showError(errorDiv, 'Message must be at least 10 characters long');
                element.style.borderColor = '#dc3545';
                return false;
            }

            hideError(errorDiv);
            element.style.borderColor = '#28a745';

            // Update hidden textarea
            updateHiddenTextarea();
            return true;
        }

    </script>
</body>
</html>